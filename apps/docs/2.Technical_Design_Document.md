---
title: "FitVibe Technical Design Document (TDD)"
version: "v2.0"
status: "Accepted"
owner: "Konstantinos Pilpilidis (Dr.)"
date: "2025-10-21"
links:
  - PRD: docs/1.Product Requirements Document.md
  - QA: docs/3.Testing and Quality Assurance Plan.md
  - ADR Index: docs/adr/README.md
license: "MIT"
---

# 0. Introduction

## 0.1 Purpose & Scope

This TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).

## 0.2 Audience & Reading Guide

- **Engineers** implement according to specs, contracts, and runbooks.
- **QA** uses RTM links to derive tests and quality gates.
- **Security/Compliance** verifies controls, data classification, GDPR flows.
- **Product/Design** confirms that behavior matches PRD intent.

## 0.3 Assumptions & Constraints

- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL â‰¥ 14 (target 16-18 locally).
- All external calls (email, AI translation) are **adapterized** and mockable for tests.
- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.
- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.

## 0.4 Versioning & Changelog

- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.

---

# 1. Traceability & Scope Mapping

This section provides a **mini RTM** that maps PRD **FR/NFR** - **TDD sections** (where the design lives) - **QA** acceptance and gates (where it is verified). The full RTM remains in the QA Plan; this table ensures the TDD is self-contained.

## 1.1 Mini RTM (FR focus)

| PRD FR | Summary              | TDD Sections (design anchors)                             | QA References (tests/gates)                        |
| ------ | -------------------- | --------------------------------------------------------- | -------------------------------------------------- |
| FR-1   | Auth & Authorization | §3 (standards), §4.1 (modules), §5.1 (security), §7 (API) | Login/Reg/Verify, 2FA, lockout, brute-force limits |
| FR-2   | Users & Profiles     | §4.2, §6 (schema), §7 (API)                               | Profile CRUD, alias uniqueness, privacy defaults   |
| FR-3   | Exercise Library     | §4.3, §6 (schema & indexing), §7 (API)                    | Owner/global admin library, search/perf            |
| FR-4   | Planning & Sessions  | §4.4, §6 (relations), §7                                  | Create/plan/log, recurrence, idempotency           |
| FR-5   | Progress & Analytics | §4.5, §6 (views/matlzd), §7                               | Aggregations accuracy/perf budgets                 |
| FR-6   | Points & Badges      | §4.6, §6, §7                                              | Deterministic rules, anti-cheat                    |
| FR-7   | Feed & Sharing       | §4.7, §5.1/§5.2, §7                                       | Privacy-by-default, link sharing                   |
| FR-8   | i18n (static MVP)    | §4.8, §3.5, §5.5                                          | Locale switch, fallback, token coverage            |

## 1.2 Mini RTM (NFR focus)

| NFR           | Target                                      | Design Anchor                      | QA Gate                                 |
| ------------- | ------------------------------------------- | ---------------------------------- | --------------------------------------- |
| Performance   | API p95 < 300 ms; LCP < 2.5 s               | §5.3 perf, §6 indexes, §2 topology | k6 thresholds; Lighthouse budget        |
| Security      | RS256 JWT, refresh rotation, CSRF, CSP/HSTS | §5.1                               | ZAP/OWASP checks; headers verified      |
| Privacy/GDPR  | DSR export/delete; log redaction            | §5.2; §12 runbooks (later)         | DSR E2E tests; retention checks         |
| Observability | Logs, metrics, tracing                      | §5.4                               | Prometheus alerts, sampling/cardinality |
| Accessibility | WCAG 2.1 AA                                 | §5.5                               | Automated checks (CI)                   |
| Reliability   | Backups; RPO≤24h, RTO≤4h                    | §9 (later), §12 (runbooks later)   | DR drill scripts                        |

## 1.3 In/Out of Scope (MVP)

- **In:** static i18n; basic media upload with AV scan; RBAC roles (user/admin); email delivery; feed with privacy controls.
- **Out:** dynamic AI translation; wearable sync; nutrition; heavy real-time comments; org/multi-tenant features.

---

# 2. System Architecture

## 2.1 Context Diagram

The [Context Diagramm](./diagrams/tdd-2-1-context-diagram.mmd) can be found in the diagrams.

**Rationale:**

- Reverse proxy terminates TLS and enforces security headers.
- Stateless BE with JWT; DB as single write authority.
- Observability collects logs/metrics/traces; no PII in labels or logs.

## 2.2 Container / Runtime View

The [Container / Runtime Diagram](.\diagrams\tdd-2-2-container-runtime-view.mmd) can be found in the documentation.

**Key responsibilities**

- **NGINX:** TLS, rate-limiting at edge, CSP/HSTS, gzip/brotli.
- **API:** REST, RBAC, validation, idempotency, audit logging.
- **Worker:** async tasks (email, cleanup, aggregation), scheduled with cron-like triggers.
- **DB:** normalized schema; partitions for large tables; materialized views for analytics.

## 2.3 Deployment Topology & Environments

- **Local:** Docker Compose (API, DB, NGINX, MailHog), seeded demo data.
- **Staging:** Same composition; points to staging SMTP; feature flags enabled for preview.
- **Production:** NGINX at edge with TLS; API behind private network; managed or self-hosted PostgreSQL with automated backups; Prometheus/Grafana/Loki stack.

**Ports & ingress**

- 443 (HTTPS) at edge; 80 only for ACME challenge; internal service ports not exposed publicly.
  **Certificates** via Let's Encrypt (auto-renew).

## 2.4 Principal Data Flows

- **Auth:** Email verification → Login (access + refresh) → Refresh rotation & revoke on use.
- **Sessions:** Client submits planned/actual session; server validates DTO → writes transactional rowset; idempotency key avoids duplicates.
- **Media Upload:** Client → API → AV scan → object stored (disk or S3-compatible) → metadata row; reject on malware.
- **Telemetry:** Structured logs and metrics emitted; correlation IDs propagate across layers.

---

# 3. Technology

The technology stack is summarized in the Table.
The high-level architecture is illustrated in [High Level Architecture](.\diagrams\prd-high-level-architecture.mmd).

This section describes the technology choices that underpin **FitVibe's architecture**.
It is divided into four subsections for clarity and separation of concerns:

1. **Backend Technology** - Application runtime, frameworks, libraries, and server-side logic.
2. **Frontend Technology** - User interface stack, styling, and accessibility libraries.
3. **Data Technology** - Database engine, schema design, and persistence tooling.
4. **Infrastructure Technology** - Deployment, CI/CD, monitoring, and scaling.

The objective is to define a **developer-ready technology baseline**, ensuring consistency across the stack, maintainability, and scalability.

## 3.1 Technology → Purpose Map (canonical)

### Technology Stack (Master Table)

| Category                          | Technologies & Details                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Frontend (Runtime & UI)**       | - **React 18 + Vite** (SPA shell, fast dev/prod builds)<br>- **React Router DOM** (client routing)<br>- **Axios** with interceptor (`401 → /auth/refresh`)<br>- **State Management**: Zustand (lightweight) or Redux (global orchestration); optional React Query for caching & background refetch<br>- **TailwindCSS** (design system, theming tokens)<br>- **Recharts** (charts for dashboards)<br>- **Lucide React** (icons)<br>- **Accessibility**: WCAG 2.1 AA, ARIA, keyboard navigation<br>- **Internationalization (future)**: EN/DE tokens |
| **Backend (Runtime & Framework)** | - **Node.js 20 LTS + Express** with modular routers (`auth`, `users`, `exercises`, `sessions`, `progress`, `points`, `feed`)<br>- **Knex.js** for SQL queries, migrations, seeds<br>- **bcryptjs** for password hashing<br>- **jsonwebtoken (RS256)** for short-lived access tokens<br>- **Refresh tokens**: server-stored, rotated by `jti`, revocable on logout<br>- Optional **TOTP 2FA** with backup codes                                                                                                                                      |
| **Authentication & Security**     | - **Helmet** for HTTP headers<br>- **CORS allowlist** (env-configured)<br>- **express-rate-limit** (per-IP & per-account throttling, optional CAPTCHA)<br>- **CSRF protection** middleware<br>- **httpOnly Secure cookies** for refresh/session<br>- **compression** for gzip responses                                                                                                                                                                                                                                                             |
| **Validation & Config**           | - **zod** for request DTO and environment schema validation<br>- **dotenv** for environment variables<br>- Strict schema enforcement (`NODE_ENV`, `DATABASE_URL`, `JWT_PRIVATE_KEY`, etc.)                                                                                                                                                                                                                                                                                                                                                          |
| **Database & Persistence**        | - **PostgreSQL 18** (primary relational datastore)<br>- **Knex.js** migrations (`YYYYMMDDHHMM__*.ts`)<br>- Constraints & indexes (e.g., `lower(username)`, partial indexes, FK cascades)<br>- Soft deletes (`deleted_at`, `archived_at`)<br>- **Backups**: daily encrypted, RPO ≤ 24h, RTO ≤ 4h<br>- **Retention policies** per entity, optional anonymization for analytics                                                                                                                                                                        |
| **File & Media Storage**          | - Local `/uploads` in dev<br>- Cloud storage (**AWS S3 / GCS**) in production<br>- Excluded from Git/Docker<br>- Optional virus scanning hook<br>- Future: avatar uploads, media constraints (JPEG/PNG/WebP ≤ 5 MB)                                                                                                                                                                                                                                                                                                                                 |
| **Email & Notifications**         | - Provider-agnostic mailer abstraction (**SMTP, SES, SendGrid, etc.**)<br>- Used for verification, password reset<br>- Backlog: unified notification system (email + push)                                                                                                                                                                                                                                                                                                                                                                          |
| **Background Jobs & Caching**     | - **Redis** (or LRU fallback in dev) for caching + rate-limit counters (Phase 2+)<br>- **BullMQ / Temporal.io** for async jobs (emails, reports, recalculations, imports)<br>- Retry handling for transient failures with exponential backoff                                                                                                                                                                                                                                                                                                       |
| **Testing Framework**             | **Jest + ts-jest** - unit and integration testing framework for backend and shared packages. Optional Cypress/Playwright for E2E in staging.                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Logging & Monitoring**          | - **pino** or **winston** for structured logs<br>- **morgan** for HTTP request logs<br>- Correlation/request IDs propagated FE→BE<br>- GDPR-compliant (exclude PII)<br>- **Metrics dashboards** (latency p95/p99, auth failures, DB saturation)<br>- **Alerting** on 5xx spikes, auth failures<br>- Tracing enabled                                                                                                                                                                                                                                 |
| **Infrastructure & DevOps**       | - **NGINX** reverse proxy (static assets, HTTPS redirect, HSTS)<br>- **Certbot (Let's Encrypt)** TLS automation & renewal<br>- **Docker / Docker Compose** (multi-stage builds, reproducible dev/prod)<br>- **GitHub Actions CI**: checkout → install (pnpm) → lint → test → build → Docker push (GHCR)<br>- **GitHub Actions CD**: manual approval → SSH deploy → `docker compose up -d`                                                                                                                                                           |
| **Environments**                  | - **Local (dev):** hot reload, verbose logs, seeded demo data<br>- **Staging (optional):** mirrors prod, pre-release validation<br>- **Production:** optimized builds, strict CORS, reduced logs, monitoring enabled                                                                                                                                                                                                                                                                                                                                |
| **Build & Release**               | - **Versioning:** `/api/v1` base path with deprecation policy<br>- **Artifacts:** Docker images tagged with commit SHA + semver<br>- **Rollback:** compose retains last good image<br>- **Static assets:** frontend built assets served by NGINX with cache headers                                                                                                                                                                                                                                                                                 |
| **Data Protection & Privacy**     | - **GDPR compliance**: DSR endpoints (export/delete), privacy notice, minimization<br>- **Cookies:** httpOnly, Secure, SameSite=Lax<br>- Upload scanning optional, user-controlled data management                                                                                                                                                                                                                                                                                                                                                  |
| **Monorepo Tooling**              | - **pnpm workspaces** for dependency mgmt<br>- **turbo** (optional) for task caching & parallelism<br>- **ESLint & Prettier** configs at root<br>- **TypeScript** base config (`tsconfig.base.json`)                                                                                                                                                                                                                                                                                                                                                |

---

## 3.2 Rationale

- **DevSecOps Tools**: **Snyk**, **Trivy/Grype**: Chosen to provide continuous dependency and container vulnerability scanning. Their integration into CI/CD ensures rapid detection of security risks in the supply chain and image builds, reducing the chance of deploying vulnerable components.
- **Secrets Management**: **Vault/AWS Secrets Manager**: Centralized secrets storage and rotation improves operational security and auditability. These systems eliminate plaintext secrets from repositories or CI environments and provide fine-grained access control with traceability.
- **Database Performance**:
  - **pg_stat_statements**: Enables continuous query performance monitoring directly within PostgreSQL. This supports evidence-based tuning and early detection of inefficient queries.
  - **GIN/JSONB**: Selected to accelerate searches in tag arrays and semi-structured data fields without compromising schema normalization.
  - **Table partitioning**: Ensures scalable query performance for time-series data such as user sessions and history logs by minimizing index bloat and query scope.
- **Transport Security**:
  - **TLS 1.3 + OCSP Stapling**: Adopted for best-in-class transport security, forward secrecy, and certificate validity verification at the edge.
  - Strict **Content Security Policy (CSP)** at edge: Mitigates cross-site scripting and data injection risks by controlling allowed origins and resource types in client browsers.
- **Node.js 20 + Express**: Chosen for maturity, wide ecosystem support, and straightforward modularization. Express offers fine-grained control, which is preferable over heavier frameworks for a project emphasizing separation of concerns.
- **Knex.js over full ORM**: Provides SQL flexibility and performance without ORM abstraction overhead. It ensures maintainability via migrations and seeds while keeping developers close to SQL.
- **PostgreSQL 18**: Selected for its robustness, JSONB support (for flexible fields), and strong community support. The latest version ensures long-term support.
- **JWT + refresh rotation**: Access tokens remain short-lived (≤15 min) to minimize compromise risk. Refresh tokens are stored server-side, rotated on each use, and revocable per `jti` to guard against theft.
- **bcryptjs**: A widely adopted password hashing algorithm with proven resilience against brute-force attacks.
- **TOTP 2FA**: Enhances account security with optional strong second-factor authentication.
- **zod**: Ensures runtime validation for API inputs and environment variables, reducing runtime errors and misconfigurations.
- **pino/winston + morgan**: Enable structured logs, traceability, and operational visibility. Logging is GDPR-aware (no PII storage).
- **Mailer abstraction**: Keeps email logic independent of provider (SMTP, AWS SES, SendGrid), allowing flexible deployments.
- **File storage abstraction**: Development uses local storage; production uses cloud object stores (S3/GCS). This separation ensures scalability without complicating dev workflows.
- **Redis + BullMQ/Temporal (backlog)**: Provide caching and asynchronous job execution.
- **Supporting libs**: cors, express-rate-limit, compression, uuid, and date/time utilities are battle-tested solutions for common API needs.

---

## 3.3 Frontend Stack

- **App shell & routing:** React + React Router DOM.
- **State & data:** Zustand/Redux; optional React Query for caching and background refetch.
- **HTTP:** Axios instance with interceptors (attach access token; handle 401 → refresh).
- **Styling:** TailwindCSS; component primitives (Navbar, Card, Button, AvatarUpload, Chart) per styling guide.
- **Charts:** Recharts (line/area, circular progress).
- **Accessibility:** WCAG 2.1 AA; semantic HTML; ARIA labels; keyboard navigation.
- **Internationalization (placeholder):** prepare for EN/DE labels (tokens-based).
- **Performance Enhancements:**
  - Code-splitting and lazy loading (`React.lazy`, `Suspense`) mandatory for all feature routes.
  - Critical CSS inlined in `index.html`; other styles loaded asynchronously.
  - Service worker for static asset caching (PWA baseline).
  - Use `react-query` for caching of idempotent GETs (feed, progress).
  - Lighthouse CI integrated into build; budgets enforced.
  - HTTP cache headers: `immutable, max-age=31536000` for static bundles; API ETags enabled.

---

## 3.4 Backend Stack

- **API:** Express with modular routers per domain (auth, users, exercises, sessions, progress, points, feed).
- **Security:** Helmet, CORS allowlist, rate limiting, CSRF protection, httpOnly `Secure` cookies.
- **Auth:** JWT (short-lived access) + **server-stored refresh** tokens with rotation and revocation by `jti`; optional TOTP 2FA with backup codes.
- **Data access:** Knex query builder; connection pooling; migrations & seeds.
- **Storage:** Local `/uploads` (dev) and pluggable S3/GCS provider (prod) via abstraction; uploads excluded from VCS and Docker build.
- **Email:** Verification/reset via provider-agnostic mailer (SMTP/SES/etc.).
- **Logging:** Structured logs (pino/winston) with correlation IDs; `morgan` for access logs.
- **Validation:** zod schemas for request DTOs and environment config.
- **Background jobs (future):** BullMQ/Temporal for async tasks (emails, reports, imports).
- **System utilities:** The system shall expose a `GET /health` endpoint for container health-checks and uptime monitoring. It shall return HTTP 200 OK with a JSON payload `{ status: 'ok', timestamp: <ISO8601> }`.
- **Performance Enhancements:**
  - Express compression (Brotli/gzip > 1 KB).
  - Global response size cap = 1 MB.
  - Route-level rate limiting with `X-RateLimit-*` headers.
  - Request timeout middleware (10 s).
  - Async translation and analytics jobs queued via BullMQ when runtime > 800 ms.
  - Cached endpoints (`GET /feed`, `GET /progress/*`) backed by Redis (or LRU fallback in dev) with 60 s TTL.
  - Performance middleware exporting per-route latency metrics to Prometheus.
- **Vault / AWS Secrets Manager:** Handles all sensitive configuration and credentials in production. Chosen for its integration with major cloud providers, secret rotation, and audit logging capabilities. This ensures compliance with least-privilege principles and GDPR data minimization.
- **Snyk / Trivy / Grype:** Implemented in the CI/CD pipeline to automatically detect vulnerable dependencies and container images. This supports the project's "security-first" objective by embedding checks early in development.
- **pg_stat_statements & Monitoring Stack:** Used to gather query performance metrics, enabling data-driven database optimization and early anomaly detection.
- **GIN / JSONB Indexing:** Provides the flexibility to store and query semi-structured data (e.g., tags, attributes) efficiently. Chosen to support future AI-driven search features.
- **Partitioned Tables:** Keeps database operations efficient as data grows by isolating recent records for faster access and simplifying archival.
- **Loki + Grafana Integration:** Added for structured log aggregation and visualization, ensuring unified observability across backend, frontend, and infrastructure layers.
- **Redis + BullMQ/Temporal:** Optional components planned for phase 2 to handle caching, job queues, and background task orchestration, ensuring scalable asynchronous operations.

## 3.5 Languages, Frameworks, Versions

- **Frontend:** TypeScript, React 18, Vite, React Router, i18n library.
- **Backend:** Node.js 20 LTS, TypeScript, Express, zod (validation), jose (JWT), nodemailer (email), rate-limiter-flexible.
- **Database:** PostgreSQL (target 16-18; minimum 14), pg, knex (migrations).
- **Infra/Dev:** Docker, Docker Compose, GitHub Actions, pnpm workspaces, Husky, ESLint/Prettier, Playwright, Jest, k6, Lighthouse, ZAP.
- **Observability:** Prometheus, Grafana, OpenTelemetry (traces), Loki (logs) or structured JSON logs to filebeat-compatible sink.

## 3.6 Coding Standards

- **TypeScript strict mode**; no `any` in public surfaces.
- ESLint (recommended + security plugins), Prettier formatting.
- Folder-by-module for BE (`/modules/<domain>`), co-locating routes, services, schemas, tests.
- FE feature-sliced architecture; UI components accessible by default (labels/ARIA).

## 3.7 API Style & Conventions

- **REST over HTTPS**, JSON bodies, camelCase in JSON, snake_case in DB.
- **Pagination:** `?page, ?limit` (default 20, max 100), response `{data, meta: {page, limit, total}}`.
- **Filtering/Sorting:** explicit allow-list; server rejects unknown filters.
- **Error Envelope:**
  ```json
  { "error": { "code": "E.AUTH.INVALID_CREDENTIALS", "message": "string", "details": {...}, "requestId": "uuid" } }
  ```
- **Idempotency:** Clients may send `Idempotency-Key` header for POST/PATCH on session creation, password reset, feed actions; server persists and deduplicates for 24h.
- **Rate Limits:** Per IP and per account; stricter on auth endpoints; `Retry-After` on limit breach.

## 3.8 API Versioning & Deprecation Policy

- Base path **`/api/v1`**.
- **Additive changes only** (new optional fields) within a major version.
- Breaking changes demand **new major** (e.g., `/api/v2`) with **2-release deprecation window** for the old version.
- Deprecations announced via `Deprecation` response header and release notes.

## 3.9 Time, IDs, Locale & Units

- **Time:** All server-side timestamps in **UTC**, RFC 3339; clients display in user's locale.
- **IDs:** ULIDs or UUIDv7 for time-sortable identifiers; no sequential IDs exposed.
- **Locale/i18n:** MVP ships **static tokens (EN/DE)**; `Accept-Language` and user settings negotiate locale; fallback to EN; dates/numbers formatted per locale on the client (server provides ISO values + hints where applicable).
- **Units:** Distances in meters/kilometers; weights in kilograms; durations in seconds; FE renders with locale-specific units/symbols.
- **i18n scope (MVP):** Only **static token catalogs (EN/DE)** are in scope.

## 3.10 Security & Privacy Baselines (Cross-reference)

- **JWT RS256** with refresh rotation and revocation; CSRF mitigated via same-site cookies (if used) + double-submit pattern for web; strict headers: **CSP**, **HSTS**, **Referrer-Policy**, **Permissions-Policy**.
- **Secrets management**: env schema validation at boot; rotation procedure via JWKS; no secrets in logs or client bundles.
- **Uploads:** AV scanning (e.g., clamd) before persistence; size/type allow-list.
- **Logs/Metrics:** PII never logged; metric label cardinality limited; correlation IDs required.

---

# 4. Feature Modules (per Functional Requirement)

> This section specifies module responsibilities, state models, input/output contracts, permissions, error cases, non-goals, and test hooks. Detailed API paths and DTOs are listed in §7 (API Design) and the database design in §6 (Data Design).

## 4.0 Conventions for Module Specs

- **Roles:** `anonymous`, `user`, `admin`.
- **Identifiers:** UUIDv7/ULID, immutable.
- **Timestamps:** UTC, RFC 3339 strings in APIs.
- **Idempotency:** State-changing endpoints accept `Idempotency-Key` (store for 24h).
- **Rate limits:** Per-IP and per-account; auth flows stricter.
- **Privacy default:** All user-created content is **private** unless explicitly published/shared.
- **Error envelope:** `{ "error": { "code", "message", "details", "requestId" } }`.

---

## 4.1 Authentication & Authorization (FR-1)

### 4.1.1 Responsibilities

- Account lifecycle: register → email verify → login → refresh rotation → logout.
- Password reset (request + complete).
- Optional 2FA (TOTP) with backup codes; feature flag controllable.
- Session management (revoke all / device-level).
- Lockout & brute-force protection; no user enumeration.
- RBAC: role assignment (`user`, `admin`).

### 4.1.2 States & Flows

See also [State flows](./diagrams/tdd-4-1-2-states-flows.mmd).

- **Sessions:** Short-lived access token; long-lived refresh token bound to a session id; rotation on refresh; stolen-token detection (rotate-with-reused refresh â‡’ revoke session family).

### 4.1.3 Inputs/Outputs (high-level)

- **Register:** `email`, `password`, `alias` (unique, case-insensitive), optional locale.
- **Verify:** `token` (email link) within TTL.
- **Login:** `email`+`password` (+`otp` if 2FA enabled) → `{accessToken, refreshToken}`.
- **Refresh:** `refreshToken` → new `{accessToken, refreshToken}`.
- **Password reset:** request with `email`; complete with `token` + `newPassword`.

### 4.1.4 Permissions & Policies

- **Anonymous:** register, login, password-reset request, verify.
- **User:** refresh, logout, 2FA setup/disable (with password confirmation), revoke sessions.
- **Admin:** manage roles; access global audit (no content peeking without lawful basis).

### 4.1.5 Security Controls

- RS256 JWT; key rotation via JWKS; leeway ≤ 60s.
- Lockout progressive backoff; event-based alerts for brute force.
- CSRF not applicable to pure token APIs; if cookies used, enforce same-site + CSRF token.
- Strict headers via edge; CORS allow-list.
- **No user enumeration:** identical messages for existent/non-existent emails.

### 4.1.6 Error Codes (sample)

- `E.AUTH.INVALID_CREDENTIALS` (401), `E.AUTH.LOCKED` (423), `E.AUTH.TOTP_REQUIRED` (401), `E.AUTH.TOKEN_EXPIRED` (401), `E.AUTH.IDEMPOTENT_REPLAY` (409).

### 4.1.7 Non-goals (MVP)

- Social login (OAuth), WebAuthn, SSO;

### 4.1.8 Test Hooks

- Seeded test users; mail adapter in test mode; clock freeze for token TTL; brute-force simulation; TOTP deterministic secret in test env.

---

## 4.2 Users & Profile (FR-2)

### 4.2.1 Responsibilities

- Manage user profile (display name, alias, bio, locale, avatar).
- **Alias** uniqueness (case-insensitive via `citext`), URL-safe.
- Avatar upload with AV scan; automatic resizing on FE/CDN.
- Privacy defaults and visibility toggles (e.g., hide age/weight).
- Audit of profile changes (immutable historical log).

### 4.2.2 State Model

- `ACTIVE` | `DEACTIVATED` | `DELETED(PENDING_PURGE)`.
- Profile fields categorized: **public**, **followers**, **private**; default = **private**.

### 4.2.3 Inputs/Outputs

- **Update profile:** partial DTO; server validates lengths/formats; alias change rate-limited (e.g., 1/30d).
- **Get profile:** own profile (full), others' profile (respecting visibility).

### 4.2.4 Permissions

- **User:** read/write own profile; delete account (DSR flow triggers).
- **Admin:** read minimal metadata for moderation; cannot bypass DSR rules.

### 4.2.5 Constraints

- Unique `(LOWER(alias))`; max 32 chars; reserved names blocked.
- Avatar: max size (e.g., 5MB), image-only MIME, AV scan required.

### 4.2.6 Error Codes

- `E.USER.ALIAS_TAKEN` (409), `E.USER.AVATAR_INVALID` (422), `E.USER.VISIBILITY_FORBIDDEN` (403).

### 4.2.7 Non-goals

- Social graph (followers/friends) and messaging.

### 4.2.8 Test Hooks

- Fixtures for alias collision; image EICAR string to test AV rejection; visibility matrix tests.

---

## 4.3 Exercise Library (FR-3)

### 4.3.1 Responsibilities

- CRUD for **exercises** (name, category, primary muscles, equipment, instructions).
- Ownership model: **user-owned** and **admin-owned global** exercises.
- Tagging & search (text + filters: category, equipment, muscles).
- Versioning optional: semantic revs for instructions changes (keeps history).

### 4.3.2 State Model

- `DRAFT` → `PUBLISHED` → `ARCHIVED`. Global exercises cannot be deletedâ€”only archived.

### 4.3.3 Inputs/Outputs

- **Create/Update:** name (i18n token or plain), category (FK), fields; server normalizes and dedupes by normalized key.
- **Search:** `q`, `category`, `equipment`, `primary_muscle`, `tags`, pagination.

### 4.3.4 Permissions

- **User:** full CRUD on own exercises; read global; propose changes to global (admin review, Phase 2).
- **Admin:** CRUD on global exercises; moderation queue.

### 4.3.5 Constraints & Indexing

- Unique `(owner_id, normalized_name)` for user-owned; unique `(normalized_name)` for global.
- GIN index on tags; trigram/text index on `name_normalized`.

### 4.3.6 Error Codes

- `E.EXERCISE.DUPLICATE` (409), `E.EXERCISE.FORBIDDEN` (403), `E.EXERCISE.NOT_FOUND` (404).

### 4.3.7 Non-goals

- Community ratings/reviews (Phase 2+).

### 4.3.8 Test Hooks

- Seed minimal global categories; search relevance snapshots; archive visibility tests.

---

## 4.4 Planning & Sessions (FR-4)

### 4.4.1 Responsibilities

- Plan and log **training sessions** with structured **session_exercises** and **sets**.
- Distinguish **planned** vs **actual**; allow editing with audit trail.
- Recurrence templates (weekly/bi-weekly); cloning; quick-add from library.
- Idempotent creation to avoid duplicates on flaky networks.

### 4.4.2 Data & State

- Session: `PLANNED` | `COMPLETED` | `CANCELLED`.
- Set: repetitions/weight/time/distance/RPE; optional notes; order preserved.
- Time fields: `starts_at`, `ends_at`, `duration_sec` (derived).

### 4.4.3 Inputs/Outputs

- **Create/Update session:** DTO with metadata + nested exercises/sets.
- **Complete session:** set status + fill actual metrics; partial completion allowed.
- **Clone/Template:** source session id → new planned session (date offset).

### 4.4.4 Permissions

- **User:** CRUD on own sessions; share-read if explicitly published.
- **Admin:** no access to private content; only moderation metadata.

### 4.4.5 Constraints & Integrity

- All nested writes **transactional**; reject partial commits.
- Idempotency via key persisted to `session_write_log` table.
- Validation of set metrics (e.g., no negative reps/weights).

### 4.4.6 Error Codes

- `E.SESSION.CONFLICT` (409), `E.SESSION.INVALID_SET` (422), `E.SESSION.IDEMPOTENT_REPLAY` (409).

### 4.4.7 Non-goals

- Real-time collaborative editing (Phase 2+).

### 4.4.8 Test Hooks

- Golden snapshot DTOs; property-based tests for set validators; idempotency replay suite.

---

## 4.5 Progress & Analytics (FR-5)

### 4.5.1 Responsibilities

- Compute and expose rollups: total volume, estimated 1RM per exercise, weekly mileage, time-in-zone, streaks.
- Provide **materialized views** and cached aggregates; consistency guarantees (eventual within minutes).

### 4.5.2 Data & Refresh

- Views: `session_summary`, `exercise_prs`, `weekly_aggregates`.
- Refresh policy: incremental refresh or scheduled job (e.g., every 5 min; immediate refresh on session completion for own views).

### 4.5.3 Inputs/Outputs

- **Get dashboards:** time range filters; aggregation grain (day/week/month).

### 4.5.4 Permissions

- **User:** read own analytics; share specific charts when session/feed is public.
- **Admin:** no visibility into private user data beyond anonymized metrics.

### 4.5.5 Constraints

- Response size ≤ 1MB; pagination/slicing for long ranges.
- Numerical stability for PRs; documented formulas (appendix).

### 4.5.6 Error Codes

- `E.ANALYTICS.RANGE_TOO_LARGE` (413), `E.ANALYTICS.UNSUPPORTED_GRAIN` (422).

### 4.5.7 Non-goals

- Advanced AI insights; forecasting models (Phase 2+).

### 4.5.8 Test Hooks

- Fixtures with canonical PRs; regression tests for materialized view refresh; perf tests on wide ranges.

---

## 4.6 Points & Badges (FR-6)

### 4.6.1 Responsibilities

- Deterministic rules to award **points** per activity; cumulative **badges** for milestones.
- Prevent abuse (rapid duplicates, backdated floods).

### 4.6.2 Model

- Event-sourced ledger (`points_events`), derived `points_balance` view.
- Badge acquisition recorded with criteria snapshot (recomputable).

### 4.6.3 Inputs/Outputs

- **Query points/badges:** filters by period and category.
- **Awarding:** occurs on session completion or specific triggers.

### 4.6.4 Permissions

- **User:** read-only; cannot directly modify points.
- **Admin:** can correct with audit reason (rare; via support tooling).

### 4.6.5 Constraints

- Idempotent awarding keyed by `(user_id, source_event_id)`.
- Anti-cheat: rate limit of backfills; anomaly alerts on unusual spikes.

### 4.6.6 Error Codes

- `E.POINTS.DUPLICATE_EVENT` (409), `E.BADGE.ALREADY_GRANTED` (409).

### 4.6.7 Non-goals

- Marketplace or redemption store (Phase 2+).

### 4.6.8 Test Hooks

- Golden rules table; property checks; idempotent replay suite for ledger.

---

## 4.7 Feed & Sharing (FR-7)

### 4.7.1 Responsibilities

- Optional **public** or **link-only** sharing of sessions/achievements.
- Feed timeline for the user (own items + explicitly followed/public sources in Phase 2).

### 4.7.2 Privacy Model

- Default **private**; user must opt-in per item to publish.
- Share link tokens are unguessable; revokeable; expireable.

### 4.7.3 Inputs/Outputs

- **Publish/unpublish item:** toggle with visibility scope.
- **List feed:** paginated; includes minimal safe fields, no sensitive health data by default.

### 4.7.4 Permissions

- **Anonymous:** view items only if public or link-token provided.
- **User:** view own + subscribed/public (Phase 2).
- **Admin:** moderation metadata only.

### 4.7.5 Constraints & Safety

- Abuse prevention: rate limits; automatic content filters for attachments.
- Takedown workflow (report → review → unpublish).

### 4.7.6 Error Codes

- `E.FEED.NOT_PUBLIC` (403), `E.FEED.TOKEN_INVALID` (401/404), `E.FEED.RATE_LIMITED` (429).

### 4.7.7 Non-goals

- Real-time comments/likes (Phase 2+).

### 4.7.8 Test Hooks

- Visibility matrix tests; token lifecycle tests; pagination correctness.

---

## 4.8 Internationalization (FR-8)

### 4.8.1 Responsibilities (MVP)

- Provide **static token dictionaries** for EN/DE with CI coverage checks.
- Locale negotiation via `Accept-Language` + user profile; fallback to EN.
- **Out of scope (MVP):** Dynamic AI translation of user-generated content (Phase 2).
- Provide **locale hints** in backend responses for dates/number formatting when useful for FE.

### 4.8.2 Data & Caching

- Token catalogs versioned; coverage threshold enforced in CI.
- No storage of user-provided PII in translation caches (when dynamic translation arrives in Phase 2); for MVP, no server-side translation cache is required.

### 4.8.3 Inputs/Outputs

- **Locale negotiation:** `Accept-Language` + user profile setting; fallback to EN.
- **Token delivery:** FE bundles; API returns plain strings + optional i18n keys where relevant to FE rendering.

### 4.8.4 Permissions

- Public data unaffected; user can set preferred locale in profile.

### 4.8.5 Constraints

- All user-facing strings must exist in token catalogs; missing-key detector in CI.

### 4.8.6 Error Codes

- `E.I18N.MISSING_TOKEN` (500 in dev; logged and masked in prod).

### 4.8.7 Non-goals

- Dynamic AI translation of user content (Phase 2).

### 4.8.8 Test Hooks

- Snapshot tests for token coverage; negotiation tests with varied `Accept-Language` headers.

---

## 4.9 Cross-Module Considerations

- **Audit logging:** user-id, session-id, action, target, success/failure, no PII content.
- **Search:** consistent pagination and sorting semantics.
- **Consistency:** eventual for analytics; strong for transactional writes.
- **Feature flags:** 2FA, global exercise moderation queue, feed public discovery.

---

# 5. Cross-Cutting Concerns

This section defines system-wide contracts and guardrails that apply to **every module and endpoint**.

---

## 5.1 Security Architecture

### 5.1.1 Authentication & Tokens

- **Access token**: JWT RS256, short-lived (e.g., 15 min), audience=`fitvibe-api`, issuer=`fitvibe`.
- **Refresh token**: JWT RS256, longer-lived (e.g., 14 d), bound to a **session id** and **client fingerprint** (device hints). Rotated on every refresh.
- **Rotation & Revocation**: reuse-detected refresh invalidates the session family; access tokens are not revoked individuallyâ€”server consults session store for refresh validity.
- **2FA (TOTP)**: optional via feature flag; backup codes stored hashed; rate-limited verification.
- **Key management**: JWKS endpoint (internal); private keys stored via secrets manager; **key rotation** documented in §12 (Runbooks).

### 5.1.2 Authorization & RBAC

- Roles: `anonymous`, `user`, `admin`.
- Resources secured with explicit role checks; `admin` required for global exercise library CRUD and moderation routes.
- Claims: `sub`, `role`, `sid` (session id), `iat`, `exp`.

### 5.1.3 Transport, Sessions & Cookies

- All API traffic via **HTTPS** only; HSTS enforced at edge.
- Default is **Authorization: Bearer <JWT>**; if cookies used for web, mark **HttpOnly, Secure, SameSite=Lax/Strict** and use double-submit CSRF token on state-changing requests.

### 5.1.4 CSRF, CORS & Headers

- **CSRF**: not applicable for pure Bearer; cookie mode uses synchronizer token + SameSite.
- **CORS**: explicit allow-list of origins; block wildcard; allow credentials only when necessary.
- **Security Headers** (example NGINX/SaaS edge):
  ```nginx
  add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:; frame-ancestors 'none'; base-uri 'self'" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  ```

### 5.1.5 Rate Limiting & Abuse Controls

- **Global**: per-IP sliding window, e.g., 300 req/5 min.
- **Auth**: stricter, e.g., 10 login attempts/15 min per account + IP; lockout backoff and alert on spikes.
- **Write endpoints**: separate lower thresholds; include `Retry-After` header on 429.
- **Anomaly detection**: flag unusual points or session creation bursts (Points FR-6).

### 5.1.6 Upload Safety

- Allow-list MIME types; max sizes (e.g., 5 MB images).
- **AV scan** (clamd or service) pre-persistence; quarantine on suspicion; hard fail on malware with `E.MEDIA.MALWARE`.
- Strip EXIF where applicable; generate safe filenames; store outside web root or in S3-compatible bucket with private ACL.

### 5.1.7 Audit & Admin

- **Audit log** event model: `ts`, `user_id`, `sid`, `action`, `target_type/id`, `outcome`, `request_id`; never store raw secrets or payloads.
- **Admin UI** (internal): moderation actions leave signed audit trail.
- **No user enumeration**: identical responses for existing/non-existing emails in auth flows.

---

## 5.2 Privacy & GDPR

### 5.2.1 Principles

- **Data minimization** and **purpose limitation**; private-by-default for user content.
- **Lawful basis** documented per category (contract, consent, legitimate interest).

### 5.2.2 Classification

| Class                 | Examples                             | Handling                                                              |
| --------------------- | ------------------------------------ | --------------------------------------------------------------------- |
| **PII-S** (Sensitive) | email, IPs, auth events, 2FA secrets | encrypt at rest where applicable, access controlled, redact from logs |
| **PII-B** (Basic)     | alias, locale, avatar metadata       | no logs, limited exposure, cached minimally                           |
| **Usage**             | session metrics, aggregates          | anonymize for telemetry; no per-user labels in metrics                |
| **Public**            | intentionally published feed items   | removable; still respect takedown and cache purge                     |

### 5.2.3 Retention & Deletion

- Retention matrix per table/field in §6; defaults minimal.
- **DSR: Export/Delete** flows:
  - Export: JSON bundle (user, profile, sessions, exercises, points, badges).
  - Delete: mark as `DELETED` → async purge; propagate to backups within **≤ 14 days**; tombstone for referential integrity.
- Media: delete object + metadata; purge CDN caches.

### 5.2.4 Consent & Transparency

- Consent required for public publishing and marketing emails.
- Privacy Policy and data map link surfaced in app.

### 5.2.5 Logging & Telemetry Privacy

- No PII in logs or metric labels. Use opaque IDs.
- Traces sample rate configured; spans must not include request bodies.

---

## 5.3 Performance Engineering

### 5.3.1 Budgets & Targets

- **API latency**: p95 < **300 ms**, p99 < 800 ms per route group.
- **FE**: LCP < **2.5 s** (P75), TBT < 200 ms on representative devices.
- **Size limits**: JSON responses ≤ 1 MB; request bodies ≤ 2 MB (except media).

### 5.3.2 Timeouts, Retries, Circuit Breakers

- Upstream calls (SMTP, object store) timeout ≤ 3 s; max 2 retries with jittered backoff; no retries for non-idempotent ops.
- DB statement timeout e.g., 2 s for API paths; longer for maintenance jobs.
- Circuit breaker around flaky adapters; fallback queues for transient errors.

### 5.3.3 Caching & Compression

- HTTP caching: `ETag`/`Last-Modified` for reads, `Cache-Control: no-store` for private resources.
- Server-side memoization/LRU where hot; Redis optional (Phase 2).
- Gzip/Brotli at edge; avoid double-compression on proxied assets.

### 5.3.4 Database Performance

- Index policy: each hot query documented in §6 with supporting index.
- Partition large time-series tables (e.g., sessions) by month; automatic pruning.
- Materialized views for analytics with incremental refresh jobs.

### 5.3.5 Regression Guards

- CI perf tests (k6) must not regress > **10%** vs baseline per route group.
- Lighthouse budgets enforced in CI; failing budgets block merge.

---

## 5.4 Observability

### 5.4.1 Logging

- Structured JSON lines: `ts`, `level`, `request_id`, `user_id?`, `sid?`, `route`, `status`, `lat_ms`, `error_code?`.
- Levels: `debug` (dev only), `info`, `warn`, `error`.
- **No PII** or secrets in messages/fields.

### 5.4.2 Metrics (Prometheus)

| Metric                            | Type      | Labels                      | Notes                |
| --------------------------------- | --------- | --------------------------- | -------------------- |
| `http_request_duration_seconds`   | histogram | `method`, `route`, `status` | route templates only |
| `http_requests_total`             | counter   | `method`, `route`, `status` |                      |
| `db_query_duration_seconds`       | histogram | `op`, `table`               |                      |
| `background_job_duration_seconds` | histogram | `job`                       |                      |
| `rate_limit_events_total`         | counter   | `bucket`                    |                      |
| `points_awarded_total`            | counter   | `rule`                      | abuse detection      |
| `av_scan_failures_total`          | counter   | `reason`                    | upload safety        |

**Cardinality policy**: routes are normalized (e.g., `/sessions/:id`), labels are bounded; drop high-cardinality user identifiers. Bound label sets only; drop labels that exceed 100 unique values in a 10-minute window; never include PII in labels or messages.

### 5.4.3 Tracing

- OpenTelemetry SDK; propagate `traceparent` from edge.
- Sample rate configurable (e.g., 10% prod, 100% staging).
- Spans include timing only; mask request/response bodies.

### 5.4.4 Dashboards & Alerts

- **Dashboards**: API latency & error rate, DB health, job queues, uploads AV, perf budgets.
- **Alerts**: 5xx rate spikes, p95 budget breach, DB saturation, queue backlog, auth lockout anomalies.

---

## 5.5 Accessibility & i18n Responsibilities (Backend Hints)

- Locale negotiation: `Accept-Language` + user setting; FE confirms final rendering locale.
- Server returns **ISO timestamps** and may include **formatting hints** (e.g., `suggestedDateFormat: "YYYY-MM-DD"`).
- Provide **semantic labels** in API only where BE generates strings (emails, system messages) and ensure those strings exist in token catalogs.
- Bidirectional text safety: store strings as UTF-8; FE renders with `dir` heuristics for RTL locales in future phases.

---

## 5.6 Configuration & Secrets Management

### 5.6.1 Environment Schema

- Validate on boot (zod): required keys fail fast with clear messages.
- Example categories:
  - **Core**: `NODE_ENV`, `PORT`, `BASE_URL`
  - **DB**: `DATABASE_URL`
  - **JWT**: `JWT_PRIVATE_KEY`, `JWT_PUBLIC_KEY`, `JWKS_URL?`
  - **Mail**: `SMTP_HOST`, `SMTP_USER`, `SMTP_PASS`
  - **Uploads**: `OBJECT_STORE_URL`, `OBJECT_STORE_BUCKET`
  - **Security**: `RATE_LIMIT_*`, `CSP_EXTRA_*`

### 5.6.2 Storage & Rotation

- Secrets stored in env/secrets manager; never in VCS or images.
- JWT keys rotated via JWKS; rollover period documented in §12; old keys kept to validate extant tokens till expiry.
- Database credentials rotated quarterly or on incident.

### 5.6.3 Feature Flags

- Boolean flags for **2FA**, admin global-exercise moderation, feed public discovery; stored in config table or env; read at startup with hot-reload support where safe.

---

## 5.7 Error Model & Idempotency

### 5.7.1 Error Envelope

```json
{
  "error": {
    "code": "E.SCOPE.SPECIFIC_CODE",
    "message": "Human-readable short message",
    "details": { "field": "reason" },
    "requestId": "uuid"
  }
}
```

- Codes are stable; HTTP status aligns with code family; registry in Appendix B.

### 5.7.2 Idempotency Policy

- **Applies to**: POST/PATCH **session creation/updates**, password reset complete, feed publish/unpublish, points correction.
- Clients send **`Idempotency-Key`** (UUID). Server records hash of request + key; repeats within **24 h** return the original result with `Idempotent-Replay: true`.
- Storage: `idempotency_keys` table with `key`, `fingerprint`, `status`, `response_hash`, `expires_at`.
- Collisions or mismatched payload for same key → 409 `E.IDEMPOTENCY.PAYLOAD_MISMATCH`.

---

## 5.8 Validation (DTO & Environment)

### 5.8.1 DTO Validation

- All inbound requests validated with **zod**: types, min/max, enums, patterns; reject unknown properties.
- Use shared schemas across FE/BE where feasible; export TypeScript types from schemas.

### 5.8.2 Environment Validation

- On boot, validate env; show masked error summary and exit non-zero if required variables are missing.
- Provide `.env.example` covering all keys with safe defaults where possible.

---

**Conformance**: This section's controls are **mandatory**. Any deviation requires an ADR and updates to PRD/QA gates.

---

# 6. Data Design

This section defines the **logical schema**, **entity dictionary**, **indexing strategy**, **partitioning/archival**, **retention & classification**, and the **migrations plan** for the MVP.

> Conventions: snake_case for DB identifiers; UTC timestamps; soft-delete via `deleted_at` where needed; `uuid` (preferably UUIDv7) primary keys unless noted.

---

## 6.1 ERD (Mermaid)

```mermaid
erDiagram
  users ||--o{ user_sessions : "has"
  users ||--o{ profiles : "has (1:1 logical)"
  users ||--o{ user_roles : "has"
  roles ||--o{ user_roles : "assigned"
  users ||--o{ exercises : "owns (user-owned)"
  exercises ||--o{ exercise_tags : "has many"
  tags ||--o{ exercise_tags : "applies"
  exercise_categories ||--o{ exercises : "categorizes"
  users ||--o{ sessions : "owns"
  sessions ||--o{ session_exercises : "has"
  session_exercises ||--o{ exercise_sets : "has"
  users ||--o{ points_events : "earns"
  users ||--o{ badge_awards : "earns"
  badges ||--o{ badge_awards : "granted"
  users ||--o{ feed_items : "publishes"
  media_assets ||--o{ feed_items : "attached to"
  users ||--o{ audit_log : "produces"
  idempotency_keys }o--|| users : "created by"
```

> Global exercises are represented with `owner_id = NULL` (admin-owned global records) and an additional check constraint.

---

## 6.2 Entity Dictionary

### 6.2.1 users

**Indexes:** `users_email_key`, `users_alias_key` (unique), `idx_users_status`.

---

### 6.2.2 profiles (logical 1:1 with users)

| Column       | Type        | Constraints                | Notes       |
| ------------ | ----------- | -------------------------- | ----------- | ----------- | ----------------------- | --------- |
| id           | uuid        | pk                         |             |
| owner_id     | uuid        | fk ��' users.id            |             |
| plan_id      | uuid        | fk ��' plans.id (nullable) |             |
| title        | text        |                            | optional    |
| planned_at   | timestamptz | not null                   |             |
| started_at   | timestamptz |                            |             |
| completed_at | timestamptz |                            |             |
| status       | text        | not null                   | `planned    | in_progress | completed               | canceled` |
| visibility   | text        | not null                   | `private    | link        | public`default`private` |
| notes        | text        |                            | optional    |
| calories     | integer     |                            | optional    |
| points       | integer     |                            | optional    |
| created_at   | timestamptz | not null                   |             |
| updated_at   | timestamptz | not null                   |             |
| deleted_at   | timestamptz |                            | soft-delete |

---

### 6.2.3 roles, user_roles

**roles**
| Column | Type | Constraints |
|---|---|---|
| id | uuid | pk |
| name | text | unique (`user`, `admin`) |

**user_roles**
| Column | Type | Constraints |
|---|---|---|
| user_id | uuid | pk, fk → users.id |
| role_id | uuid | pk, fk → roles.id |
| created_at | timestamptz | not null |

**Indexes:** `idx_user_roles_user`, `idx_user_roles_role`.

---

### 6.2.4 user_sessions (auth device sessions)

| Column       | Type        | Constraints   | Notes                           |
| ------------ | ----------- | ------------- | ------------------------------- | --- | ---------- | ----------- | -------- | --- |
| id           | uuid        | pk            |
| user_id      | uuid        | fk → users.id |
| refresh_jti  | uuid        | unique        | identifies refresh token family |
| user_agent   | text        |               |                                 |
| ip           | inet        |               | PII-S                           |
| last_used_at | timestamptz | not null      |                                 |
| calories     | integer     |               | optional                        |
| points       | integer     |               | optional                        | `n  | created_at | timestamptz | not null |     |
| revoked_at   | timestamptz |               |                                 |

**Indexes:** `idx_user_sessions_user`, `idx_user_sessions_last_used`.

---

### 6.2.5 verification_tokens & reset_tokens

Common columns: `id uuid pk`, `user_id uuid fk`, `token text unique`, `expires_at timestamptz`, `consumed_at timestamptz`, `created_at`.

- Separate tables or a generic `user_tokens` with `type enum('verify','reset')`. TTLs defined in §4/§5.

**Indexes:** `idx_tokens_user`, `idx_tokens_expires`.

---

### 6.2.6 exercises (user-owned or global)

| Column          | Type        | Constraints                 | Notes                     |
| --------------- | ----------- | --------------------------- | ------------------------- | --------- | ---------- | ----------- | -------- | --- |
| id              | uuid        | pk                          |
| owner_id        | uuid        | fk → users.id               | **nullable** for global   |
| plan_id         | uuid        | fk ��' plans.id (nullable)  |
| name            | text        | not null                    | normalized for uniqueness |
| name_normalized | text        | not null                    | lower(trimmed)            |
| category_id     | uuid        | fk → exercise_categories.id |
| primary_muscles | text[]      |                             |                           |
| equipment       | text[]      |                             |                           |
| instructions    | text        |                             |                           |
| tags            | text[]      |                             | GIN                       |
| status          | text        | not null                    | `draft                    | published | archived`  |
| calories        | integer     |                             | optional                  |
| points          | integer     |                             | optional                  | `n        | created_at | timestamptz | not null |     |
| updated_at      | timestamptz | not null                    |                           |

**Constraints:**

- Global: `owner_id IS NULL` and unique on `name_normalized`.
- User-owned: unique on `(owner_id, name_normalized)`.

**Indexes:** `idx_exercises_owner`, `idx_exercises_category`, `idx_exercises_tags_gin`, `idx_exercises_name_trgm`.

---

### 6.2.7 exercise_categories

| Column | Type | Constraints |
| ------ | ---- | ----------- |
| id     | uuid | pk          |
| slug   | text | unique      |
| name   | text | not null    |

**Index:** `exercise_categories_slug_key`.

---

### 6.2.8 tags, exercise_tags (bridge)

**tags**: `id uuid pk`, `slug text unique`, `name text`
**exercise_tags**: `exercise_id uuid fk`, `tag_id uuid fk`, **pk(exercise_id, tag_id)**

Indexes on both FKs.

---

### 6.2.9 sessions

| Column       | Type        | Constraints               | Notes       |
| ------------ | ----------- | ------------------------- | ----------- | ----------- | ----------------------- | --------- |
| id           | uuid        | pk                        |             |
| owner_id     | uuid        | fk -> users.id            |             |
| plan_id      | uuid        | fk -> plans.id (nullable) |             |
| title        | text        |                           | optional    |
| planned_at   | timestamptz | not null                  |             |
| started_at   | timestamptz |                           |             |
| completed_at | timestamptz |                           |             |
| status       | text        | not null                  | `planned    | in_progress | completed               | canceled` |
| visibility   | text        | not null                  | `private    | link        | public`default`private` |
| notes        | text        |                           | optional    |
| calories     | integer     |                           | optional    |
| points       | integer     |                           | optional    |
| created_at   | timestamptz | not null                  |             |
| updated_at   | timestamptz | not null                  |             |
| deleted_at   | timestamptz |                           | soft-delete |

**Indexes:** `idx_sessions_owner`, `idx_sessions_status`, `idx_sessions_planned_at`, partitioned by month (see §6.4).

---

### 6.2.10 session_exercises

| Column      | Type | Constraints       |
| ----------- | ---- | ----------------- |
| id          | uuid | pk                |
| session_id  | uuid | fk → sessions.id  |
| exercise_id | uuid | fk → exercises.id |
| order_index | int  | not null          |
| notes       | text |                   |

**Indexes:** `idx_session_exercises_session`, `idx_session_exercises_exercise`, `idx_session_exercises_order`.

---

### 6.2.11 exercise_sets

| Column              | Type         | Constraints               | Notes    |
| ------------------- | ------------ | ------------------------- | -------- |
| id                  | uuid         | pk                        |
| session_exercise_id | uuid         | fk → session_exercises.id |
| order_index         | int          | not null                  |
| reps                | int          |                           | >=0      |
| weight_kg           | numeric(6,2) |                           | >=0      |
| distance_m          | int          |                           | >=0      |
| duration_sec        | int          |                           | >=0      |
| rpe                 | int          |                           | 1..10    |
| notes               | text         |                           | optional |

**Indexes:** `idx_exercise_sets_session`, `idx_exercise_sets_order`.

---

### 6.2.12 points_events, badges, badge_awards

**points_events**
| Column | Type | Constraints | Notes |
|---|---|---|---|
| id | uuid | pk |
| user_id | uuid | fk → users.id |
| source | text | not null | e.g., 'session_completed' |
| source_id | uuid | | dedupe key |
| points | int | not null |
| calories | integer | | optional |
| points | integer | | optional |`n| created_at | timestamptz | not null | |
| unique_key | text | unique | (user_id, source, source_id) hash |

**badges**
| Column | Type | Constraints |
|---|---|---|
| id | uuid | pk |
| code | text | unique |
| name | text | not null |
| criteria_json | jsonb | not null | rules snapshot |

**badge_awards**
| Column | Type | Constraints |
|---|---|---|
| id | uuid | pk |
| user_id | uuid | fk → users.id |
| badge_id | uuid | fk → badges.id |
| awarded_at | timestamptz | not null |
| criteria_snapshot | jsonb | not null |

Indexes on `user_id`, `badge_id`.

---

### 6.2.13 feed_items

| Column       | Type        | Constraints                | Notes                           |
| ------------ | ----------- | -------------------------- | ------------------------------- | ----------- | ---------- | ----------- | -------- | --- |
| id           | uuid        | pk                         |
| owner_id     | uuid        | fk → users.id              |
| plan_id      | uuid        | fk ��' plans.id (nullable) |
| kind         | text        | not null                   | `session                        | achievement | note`      |
| target_id    | uuid        |                            | points to a session/badge award |
| visibility   | text        | not null                   | `public                         | link        | private`   |
| link_token   | uuid        | unique nullable            | for link sharing                |
| published_at | timestamptz |                            |                                 |
| calories     | integer     |                            | optional                        |
| points       | integer     |                            | optional                        | `n          | created_at | timestamptz | not null |     |
| updated_at   | timestamptz | not null                   |                                 |

Indexes on `owner_id`, `visibility`, `published_at`, `link_token` (unique).

---

### 6.2.14 media_assets

| Column     | Type        | Constraints                | Notes                |
| ---------- | ----------- | -------------------------- | -------------------- | ------- | ----------------- | ----------- | -------- | --- |
| id         | uuid        | pk                         |
| owner_id   | uuid        | fk → users.id              |
| plan_id    | uuid        | fk ��' plans.id (nullable) |
| kind       | text        | not null                   | `image               | video   | doc` (MVP: image) |
| object_key | text        | unique                     | path in object store |
| mime       | text        | not null                   | allow-list enforced  |
| size_bytes | int         | not null                   | limit 5 MB MVP       |
| av_scan    | text        | not null                   | `clean               | suspect | malware`          |
| calories   | integer     |                            | optional             |
| points     | integer     |                            | optional             | `n      | created_at        | timestamptz | not null |     |
| deleted_at | timestamptz |                            |                      |

Indexes on `owner_id`, `av_scan`.

---

### 6.2.15 idempotency_keys

| Column        | Type        | Constraints   | Notes              |
| ------------- | ----------- | ------------- | ------------------ | ------- | ---------- | ----------- | -------- | --- |
| key           | uuid        | pk            |
| user_id       | uuid        | fk → users.id |
| fingerprint   | text        | not null      | hash of route+body |
| status        | text        | not null      | `stored            | applied | error`     |
| response_hash | text        |               | for replay         |
| expires_at    | timestamptz | not null      |                    |
| calories      | integer     |               | optional           |
| points        | integer     |               | optional           | `n      | created_at | timestamptz | not null |     |

Index on `user_id`, `expires_at`.

---

### 6.2.16 audit_log

| Column      | Type        | Constraints            |
| ----------- | ----------- | ---------------------- | ---------- | ----- |
| id          | uuid        | pk                     |
| ts          | timestamptz | not null               |
| user_id     | uuid        | fk → users.id nullable |
| sid         | uuid        |                        | session id |
| action      | text        | not null               |
| target_type | text        |                        |
| target_id   | uuid        |                        |
| outcome     | text        | not null               | `success   | fail` |
| request_id  | uuid        |                        |

Index on `ts`, `user_id`, `action`.

---

## 6.3 Indexing Strategy & Hot Query Map

| Endpoint / Query        | Purpose              | Suggested Index                                               |
| ----------------------- | -------------------- | ------------------------------------------------------------- |
| GET /sessions?from..to  | list by owner + time | `(owner_id, planned_at DESC)` partial on `deleted_at IS NULL` |
| GET /exercises/search   | text+tag search      | trigram on `name_normalized`, `GIN(tags)`                     |
| GET /feed               | public timeline      | `(visibility, published_at DESC)`                             |
| GET /users/:alias       | resolve profile      | unique `citext(alias)`                                        |
| Points ledger by period | summaries            | `(user_id, created_at)`                                       |
| Badge awards by user    | profile badges       | `(user_id, awarded_at DESC)`                                  |

> Each index's effectiveness is validated with `EXPLAIN ANALYZE` during load testing. Keep total index bloat in check; avoid unbounded multi-column indexes unless justified.

---

## 6.4 Partitioning & Archival

- **sessions**: monthly range partitions on `planned_at` (or `started_at` when present). Default partition for safety. Old partitions can be **archived** after 24 months (configurable).
- **audit_log** and **points_events**: optionally monthly partitions if volume warrants; otherwise use time-based retention with simple index + vacuum strategy.

Archival moves cold partitions to cheaper storage or marks for deletion per retention policy.

---

## 6.5 Soft-Delete vs Hard-Delete

- User-driven deletes mark `deleted_at` and hide objects from queries (`WHERE deleted_at IS NULL`).
- **GDPR Delete** performs async **hard-delete** for private content after grace period; relational children are cascaded or anonymized as needed (see §6.6).
- Public `feed_items` are removed immediately and purge caches.

---

## 6.6 Data Retention & Classification Matrix (MVP)

| Table                     | Classification                | Default Retention               | Delete Behavior                                                                |
| ------------------------- | ----------------------------- | ------------------------------- | ------------------------------------------------------------------------------ |
| users                     | PII-S                         | Lifetime of account             | DSR deletes PII fields; tombstone for FKs; hard-delete after 14d backup window |
| profiles                  | PII-B                         | Lifetime                        | Hard-delete on DSR                                                             |
| user_sessions             | PII-S                         | 90 days active, 30 days revoked | Hard-delete                                                                    |
| verification/reset tokens | PII-S                         | TTL (e.g., 15m/1h)              | Auto-purge on expiry/consume                                                   |
| exercises (user)          | Usage/PII-B                   | Lifetime of user                | Hard-delete on DSR (owned)                                                     |
| exercises (global)        | Public/Admin                  | N/A                             | Archive only                                                                   |
| sessions                  | Usage (can contain sensitive) | Lifetime of user                | Hard-delete on DSR                                                             |
| session_exercises/sets    | Usage                         | Lifetime of user                | Hard-delete on DSR                                                             |
| points_events             | Usage                         | Lifetime of user                | Hard-delete on DSR                                                             |
| badges/badge_awards       | Usage                         | Lifetime of user                | Hard-delete on DSR                                                             |
| feed_items                | Public/Usage                  | Until unpublished               | Delete + purge caches                                                          |
| media_assets              | PII-B                         | Lifetime or until removed       | Delete object + metadata                                                       |
| audit_log                 | Usage/PII-S                   | 180 days                        | Anonymize user_id on DSR; keep aggregate events                                |
| idempotency_keys          | Usage                         | 24h                             | Auto-purge                                                                     |

> **Backup propagation:** ensure purge within **≤ 14 days** after a DSR hard-delete is finalized.

---

## 6.7 Migrations Strategy (Knex)

- **Expand/Contract** pattern: forward migrations **add** columns/tables and backfill; avoid destructive changes. Backward migrations may be **no-op** in prod.
- **Naming**: `YYYYMMDDHHMM__description.sql`. One feature per migration.
- **Transactional**: wrap DDL when supported; otherwise emulate.
- **Seeding**: minimal **global** data only (categories, badges). No PII in seeds.

### 6.7.1 Ordered Migration List (MVP)

1. `202510130900__create_extensions_citext_uuid.sql`
2. `202510130905__roles_and_users.sql` (users, roles, user_roles, profiles, user_sessions)
3. `202510130910__tokens_verify_reset.sql`
4. `202510130915__exercise_categories_tags.sql` (exercise_categories, tags)
5. `202510130920__exercises.sql` (incl. constraints for global vs user-owned)
6. `202510130925__sessions_core.sql` (sessions partitioned, owner_id, plan_id)
7. `202510130928__plans.sql` (plans table, progress counters, plan-user FK)
8. `202510130930__sessions_details.sql` (session_exercises, exercise_sets)
9. `202510130935__points_and_badges.sql` (points_events, badges, badge_awards)
10. `202510130940__feed_and_media.sql` (feed_items, media_assets)
11. `202510130945__idempotency_and_audit.sql` (idempotency_keys, audit_log)

---

## 6.8 Seed Data Policy

- **Exercise categories**: e.g., strength, cardio, mobility.
- **Global exercises (admin-owned)**: minimal, high-quality set (e.g., Squat, Bench Press, Deadlift, Run, Ride).
- **Badges**: First Session, 7-Day Streak, 10k Run, 100k Ride (examples).
- **No test users** in prod seeds; test environments use isolated fixtures.

Seed scripts should be **idempotent** and safe to re-run.

---

## 6.9 Data Quality & Integrity Rules

- Strict FK constraints; `ON DELETE CASCADE` where child has no independent value (e.g., exercise_sets).
- Use check constraints for enumerations where helpful (or validated at app layer).
- Denormalize sparingly; keep analytics in matviews; refresh jobs documented in §4.5.
- All writes involving nested session payloads are **transactional**; either fully applied or rejected.

---

## 6.10 Backups, Restore & DR (Pointers)

- Automated daily full backups; PITR if supported.
- Verify restores monthly in staging; document RPO≤24h/RTO≤4h in §12 runbooks.
- Encryption at rest for backups; access controlled and audited.

---

**Compliance**: This schema realizes PRD FR-1â€¦FR-8 with GDPR-aligned classification and retention. Changes require accompanying ADRs and updated QA RTM rows.

---

# 7. API Design & Contracts

This section defines the **canonical REST contracts** for the MVP. It specifies resource paths, methods, auth/roles, common headers, pagination, filtering, error envelopes, **rate limits**, and **idempotency** rules. DTO schemas are summarized here; authoritative TypeScript/Zod and OpenAPI are generated from source.

> Base URL: `https://api.fitvibe.app/api/v1` (staging/prod) Â· `http://localhost:4100/api/v1` (local)

---

The following table summarizes the REST API endpoints implemented.
Each endpoint adheres to REST semantics and returns JSON responses. Authentication is JWT-based as defined in § 9 Authentication Lifecycle.

| Module        | Endpoint                 | Method | Auth           | Description                                           | Status Codes  |
| :------------ | :----------------------- | :----- | :------------- | :---------------------------------------------------- | :------------ |
| **System**    | `/health`                | GET    | No             | System liveness check for CI/CD and uptime monitoring | 200           |
| **Auth**      | `/auth/register`         | POST   | No             | Register a new account                                | 201, 400, 409 |
|               | `/auth/login`            | POST   | No             | Login with credentials                                | 200, 401      |
|               | `/auth/refresh`          | POST   | Yes            | Issue a new access token                              | 200, 401      |
|               | `/auth/logout`           | POST   | Yes            | Invalidate refresh session                            | 204, 401      |
| **Users**     | `/users/me`              | GET    | Yes            | Retrieve own profile                                  | 200, 401      |
|               | `/users/me`              | PUT    | Yes            | Update editable profile fields                        | 200, 400      |
| **Exercises** | `/exercises`             | GET    | Yes            | List user and public exercises                        | 200           |
|               | `/exercises`             | POST   | Yes            | Create a new exercise                                 | 201, 400      |
|               | `/exercises/:id`         | PUT    | Yes            | Update existing exercise                              | 200, 404      |
|               | `/exercises/:id`         | DELETE | Yes            | Archive exercise                                      | 204, 404      |
| **Sessions**  | `/sessions`              | GET    | Yes            | List sessions                                         | 200           |
|               | `/sessions`              | POST   | Yes            | Create planned session                                | 201           |
|               | `/sessions/:id/complete` | PATCH  | Yes            | Mark session as completed                             | 200           |
| **Progress**  | `/progress/summary`      | GET    | Yes            | Summary statistics                                    | 200           |
|               | `/progress/charts`       | GET    | Yes            | Chart data                                            | 200           |
| **Points**    | `/points`                | GET    | Yes            | Get current total                                     | 200           |
|               | `/points/history`        | GET    | Yes            | Retrieve points history                               | 200           |
| **Feed**      | `/feed`                  | GET    | Yes (optional) | Public session feed                                   | 200           |
|               | `/feed/:id/clone`        | POST   | Yes            | Clone public session                                  | 201, 404      |

---

## 7.1 Layer Contracts

The backend shall follow a strict three-layer architecture:

1. **Router Layer** - Handles HTTP routing, parses input, validates DTOs, and maps service errors to HTTP codes.
   Routers shall never access the database directly.
2. **Service Layer** - Encapsulates business logic, transaction handling, and domain events.
3. **Repository Layer** - Performs all SQL operations via Knex; returns typed DTOs; no business logic allowed.

Utilities (e.g., logger, metrics, mailer) are dependency-injected where possible to ensure testability.

---

## 7.2 Error Handling Specification

All API responses shall use a standardized JSON error envelope:

```json
{
  "error": {
    "code": "AUTH_INVALID_CREDENTIALS",
    "message": "Invalid username or password.",
    "requestId": "uuid"
  }
}
```

| HTTP Code | Error Code                               | Description                            |
| --------- | ---------------------------------------- | -------------------------------------- |
| 400       | VALIDATION_ERROR                         | Request body failed schema validation. |
| 401       | AUTH_REQUIRED / AUTH_INVALID_CREDENTIALS | Missing or invalid token.              |
| 403       | FORBIDDEN                                | Insufficient privileges.               |
| 404       | NOT_FOUND                                | Resource not found.                    |
| 409       | CONFLICT                                 | Unique constraint or state conflict.   |
| 422       | UNPROCESSABLE                            | Business rule violation.               |
| 429       | RATE_LIMITED                             | Too many requests.                     |
| 500       | INTERNAL                                 | Unexpected server error.               |

The system shall include correlation IDs in every log and response for traceability.

---

## 7.3 Testing Approach

Each endpoint is covered by automated integration tests (`Jest` + `Supertest`) validating status codes, authentication, and schema compliance. A Postman collection mirrors this route map for manual verification during MVP development.

---

## 7.4 Migration Conventions

- Migration filenames shall follow: `YYYYMMDDHHMM__<description>.ts`.
- Order: lookup → users → domain → attributes → social.
- Each migration shall provide reversible `up`/`down` functions.
- CI executes migrations on ephemeral DB; CD runs `migrate:latest` before app start.
- No destructive `down` migrations in production; use expand/contract pattern.

## 7.5 Logging and Monitoring Middleware

- **Logging:** use `pino` for structured JSON logs; `morgan` for access logs; include `requestId` and `userId` where available.
- **Privacy:** exclude passwords, tokens, and PII from logs.
- **Monitoring:** integrate Prometheus middleware capturing latency histograms by route and status.

---

## 7.6 Conventions

### 7.7.1 Standard Headers

- **Authentication**: `Authorization: Bearer <access-jwt>`
- **Idempotency**: `Idempotency-Key: <uuid>` (for POST/PATCH as specified)
- **Rate Limits (responses)**:
  - `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
  - On 429: `Retry-After: <seconds>`
- **Deprecation**:
  - `Deprecation: true` (when an endpoint is scheduled for removal)
  - `Sunset: <RFC 1123 date>`

### 7.7.2 Pagination & List Responses

- Query: `?page=<1..N>&limit=<1..100>` (default `page=1`, `limit=20`)
- Response envelope:

```json
{
  "data": [
    /* items */
  ],
  "meta": { "page": 1, "limit": 20, "total": 123, "hasNext": true }
}
```

### 7.7.3 Error Envelope

```json
{
  "error": {
    "code": "E.SCOPE.CODE",
    "message": "Human-readable, localized message key or string",
    "details": { "field": "reason" },
    "requestId": "uuid"
  }
}
```

### 7.7.4 Resource Versioning

- All endpoints under `/api/v1`. Additive fields allowed. Breaking changes require `/api/v2` with deprecation window.

---

## 7.8 Auth & Session (FR-1)

| Method | Path                      | Auth          | Roles | Idempotent? | Rate Limit           | Summary                            |
| ------ | ------------------------- | ------------- | ----- | ----------- | -------------------- | ---------------------------------- |
| POST   | `/auth/register`          | none          | anon  | yes (key)   | 5/min/IP             | Create account                     |
| GET    | `/auth/verify`            | none          | anon  | n/a         | 30/min/IP            | Verify email (token param)         |
| POST   | `/auth/login`             | none          | anon  | no          | 10/15min per acct+IP | Issue access+refresh               |
| POST   | `/auth/refresh`           | refresh token | user  | no          | 60/min               | Rotate refresh                     |
| POST   | `/auth/logout`            | access token  | user  | no          | 60/min               | Invalidate current session         |
| POST   | `/auth/password/reset`    | none          | anon  | yes (key)   | 5/min/IP             | Request reset email                |
| POST   | `/auth/password/complete` | none          | anon  | yes (key)   | 5/min/IP             | Complete reset                     |
| POST   | `/auth/2fa/setup`         | access        | user  | no          | 10/min               | Provision TOTP (returns secret+QR) |
| POST   | `/auth/2fa/verify`        | access        | user  | no          | 10/min               | Confirm TOTP enable                |
| POST   | `/auth/2fa/disable`       | access        | user  | no          | 10/min               | Disable TOTP                       |
| GET    | `/auth/sessions`          | access        | user  | n/a         | 60/min               | List device sessions               |
| POST   | `/auth/sessions/revoke`   | access        | user  | no          | 10/min               | Revoke all or specific session     |

**Register (POST /auth/register) â€” Request**

```json
{
  "email": "a@b.com",
  "password": "P@ssw0rd!",
  "alias": "konstantinos",
  "locale": "de"
}
```

**Response 201**

```json
{
  "id": "01J...",
  "email": "a@b.com",
  "alias": "konstantinos",
  "status": "unverified"
}
```

---

## 7.9 Users & Profile (FR-2)

| Method | Path               | Auth     | Roles     | Idempotent? | Notes                      |
| ------ | ------------------ | -------- | --------- | ----------- | -------------------------- |
| GET    | `/users/me`        | access   | user      | n/a         | Own profile (full)         |
| PATCH  | `/users/me`        | access   | user      | yes (key)   | Update profile             |
| DELETE | `/users/me`        | access   | user      | no          | Initiate DSR delete        |
| GET    | `/users/:alias`    | optional | anon/user | n/a         | Public/allowed fields only |
| PUT    | `/users/me/avatar` | access   | user      | yes (key)   | Upload avatar (multipart)  |
| DELETE | `/users/me/avatar` | access   | user      | no          | Remove avatar              |

**PATCH /users/me â€” Request (partial)**

```json
{ "displayName": "Kosta", "bio": "Runner", "locale": "de", "alias": "kpil" }
```

---

## 7.10 Exercise Library (FR-3)

| Method | Path                           | Auth   | Roles       | Idempotent? | Notes                                      |
| ------ | ------------------------------ | ------ | ----------- | ----------- | ------------------------------------------ |
| GET    | `/exercises`                   | access | user        | n/a         | List/search (q, category, tags, equipment) |
| POST   | `/exercises`                   | access | user        | yes (key)   | Create user-owned                          |
| GET    | `/exercises/:id`               | access | user        | n/a         | Read                                       |
| PATCH  | `/exercises/:id`               | access | owner/admin | yes (key)   | Update                                     |
| DELETE | `/exercises/:id`               | access | owner/admin | no          | Archive/delete (user-owned)                |
| GET    | `/exercises/global`            | access | user        | n/a         | List admin-global                          |
| POST   | `/admin/exercises`             | access | admin       | yes (key)   | Create global exercise                     |
| PATCH  | `/admin/exercises/:id`         | access | admin       | yes (key)   | Update global                              |
| POST   | `/admin/exercises/:id/archive` | access | admin       | no          | Archive global                             |

Search params: `?q&category&tag&equipment&page&limit`

---

## 7.11 Planning & Sessions (FR-4)

| Method | Path                     | Auth   | Roles | Idempotent?   | Notes                                 |
| ------ | ------------------------ | ------ | ----- | ------------- | ------------------------------------- |
| GET    | `/sessions`              | access | user  | n/a           | Range filters: `from`, `to`, `status` |
| POST   | `/sessions`              | access | user  | **yes (key)** | Create (with nested exercises/sets)   |
| GET    | `/sessions/:id`          | access | owner | n/a           | Read                                  |
| PATCH  | `/sessions/:id`          | access | owner | **yes (key)** | Update nested payload transactionally |
| POST   | `/sessions/:id/complete` | access | owner | **yes (key)** | Mark completed + actuals              |
| POST   | `/sessions/:id/clone`    | access | owner | **yes (key)** | Clone to new date                     |
| DELETE | `/sessions/:id`          | access | owner | no            | Soft-delete                           |

**POST /sessions â€” Request (excerpt)**

```json
{
  "title": "Leg Day",
  "plannedAt": "2025-10-15T18:00:00Z",
  "exercises": [
    {
      "exerciseId": "01J...",
      "order": 1,
      "sets": [
        { "order": 1, "reps": 5, "weightKg": 100 },
        { "order": 2, "reps": 5, "weightKg": 100 }
      ]
    }
  ]
}
```

---

## 7.12 Progress & Analytics (FR-5)

| Method | Path                 | Auth   | Roles | Notes                      |
| ------ | -------------------- | ------ | ----- | -------------------------- | ---- | ------ |
| GET    | `/analytics/summary` | access | user  | `from`, `to`, `grain=day   | week | month` |
| GET    | `/analytics/prs`     | access | user  | estimated 1RM per exercise |
| GET    | `/analytics/weekly`  | access | user  | weekly aggregates          |

All responses capped to 1 MB; enforce slicing for long ranges.

---

## 7.13 Points & Badges (FR-6)

| Method | Path                    | Auth   | Roles | Notes                               |
| ------ | ----------------------- | ------ | ----- | ----------------------------------- |
| GET    | `/points`               | access | user  | current balance + recent events     |
| GET    | `/badges`               | access | user  | owned badges                        |
| GET    | `/badges/catalog`       | access | user  | badge catalog                       |
| POST   | `/admin/points/correct` | access | admin | correction with audit reason (rare) |

---

## 7.14 Feed & Sharing (FR-7)

| Method | Path                          | Auth     | Roles     | Idempotent? | Notes                                     |
| ------ | ----------------------------- | -------- | --------- | ----------- | ----------------------------------------- |
| GET    | `/feed`                       | optional | anon/user | n/a         | Public timeline; for user view own+public |
| POST   | `/feed/session/:id/publish`   | access   | owner     | yes (key)   | Publish session                           |
| POST   | `/feed/session/:id/unpublish` | access   | owner     | yes (key)   | Unpublish                                 |
| POST   | `/feed/item/:id/link`         | access   | owner     | yes (key)   | Create link-only token                    |
| DELETE | `/feed/item/:id/link`         | access   | owner     | no          | Revoke link token                         |
| GET    | `/feed/link/:token`           | none     | anon      | n/a         | View item by link token                   |

Visibility values: `private | link | public`.

---

## 7.15 Media (Avatars & Attachments)

| Method | Path                | Auth   | Roles       | Notes                              |
| ------ | ------------------- | ------ | ----------- | ---------------------------------- |
| POST   | `/media`            | access | user        | Multipart upload → AV scan → store |
| GET    | `/media/:id`        | access | owner/admin | Signed URLs or proxied reads       |
| DELETE | `/media/:id`        | access | owner/admin | Deletes object + metadata          |
| GET    | `/media/:id/public` | none   | anon        | Only if explicitly public          |

Upload rules: image types only, ≤ 5 MB, AV must be `clean` or request fails with `E.MEDIA.MALWARE`.

---

## 7.16 Admin

| Method | Path                    | Auth   | Roles | Notes                                      |
| ------ | ----------------------- | ------ | ----- | ------------------------------------------ |
| GET    | `/admin/audit`          | access | admin | filter by `userId`, `action`, `from`, `to` |
| POST   | `/admin/users/:id/role` | access | admin | assign role                                |
| GET    | `/admin/health`         | access | admin | liveness/readiness + migrations check      |

---

## 7.17 Health, Metrics & Diagnostics

| Method | Path                | Auth                    | Roles | Notes                          |
| ------ | ------------------- | ----------------------- | ----- | ------------------------------ |
| GET    | `/health/liveness`  | none                    | anon  | 200 OK when process alive      |
| GET    | `/health/readiness` | none                    | anon  | checks DB, queue, dependencies |
| GET    | `/metrics`          | none (cluster/IP allow) | infra | Prometheus exposition          |

---

## 7.18 Filtering & Sorting Rules

- **Allow-list per resource** to avoid unsafe fields. Examples:
  - `/exercises`: `q`, `category`, `equipment`, `tag`, `sort=name|createdAt`
  - `/sessions`: `from`, `to`, `status`, `sort=plannedAt|createdAt`
- Unknown filters are rejected with `422 E.API.UNKNOWN_FILTER`.

---

## 7.19 Rate Limits (Reference)

| Bucket                 | Limit                          |
| ---------------------- | ------------------------------ |
| Auth login             | 10 per 15 min per account + IP |
| Registration           | 5 per min per IP               |
| Password reset request | 5 per 15 min per IP            |
| Session writes         | 30 per 5 min per user          |
| General read           | 300 per 5 min per IP           |

All 429 responses include `Retry-After` and rate headers.

---

## 7.20 Idempotency (Reference)

- **Required** for: POST `/sessions`, PATCH `/sessions/:id`, POST `/sessions/:id/complete`, POST `/sessions/:id/clone`, POST `/auth/password/complete`, feed publish/unpublish, admin points correction.
- On replay within 24h, server returns **same status & body** and sets `Idempotent-Replay: true`.

---

## 7.21 DTO & Validation Summary (selected)

> Definitive schemas live in `apps/backend/src/modules/**/dto.ts` and are used to generate OpenAPI.

### 7.21.1 Auth DTOs

- `RegisterDto { email:string; password:string; alias:string; locale?:string }`
- `LoginDto { email:string; password:string; otp?:string }`
- `PasswordResetRequestDto { email:string }`
- `PasswordResetCompleteDto { token:string; newPassword:string }`

### 7.21.2 Sessions DTOs

- `SessionCreateDto { title?:string; plannedAt?:string; exercises: SessionExerciseDto[] }`
- `SessionExerciseDto { exerciseId:string; order:number; sets: SessionSetDto[] }`
- `SessionSetDto { order:number; reps?:number; weightKg?:number; distanceM?:number; durationSec?:number; rpe?:number; notes?:string }`

### 7.22.3 Exercise DTOs

- `ExerciseCreateDto { name:string; categoryId?:string; primaryMuscles?:string[]; equipment?:string[]; instructions?:string; tags?:string[] }`

---

## 7.23 OpenAPI Generation

- **Source of truth**: Zod schemas in `apps/backend/src/**/dto.ts`; types emitted to shared package.
- **Artifact path**: `apps/backend/openapi/openapi.json` (generated in CI).
- **Publishing**: CI uploads OpenAPI JSON as a build artifact and to the docs site (staging/prod).
- **Viewer**: Dev-only Swagger UI at `/docs` (staging only).
- **Versioning**: OpenAPI file version increments each release; `Deprecation`/`Sunset` headers accompany removals.

---

## 7.17 Error Code Registry (Excerpt)

| Code                             | HTTP | Meaning                     |
| -------------------------------- | ---- | --------------------------- |
| `E.AUTH.INVALID_CREDENTIALS`     | 401  | Wrong email/password        |
| `E.AUTH.TOTP_REQUIRED`           | 401  | 2FA required                |
| `E.AUTH.LOCKED`                  | 423  | Account temporarily locked  |
| `E.USER.ALIAS_TAKEN`             | 409  | Alias not available         |
| `E.EXERCISE.DUPLICATE`           | 409  | Duplicate exercise          |
| `E.SESSION.INVALID_SET`          | 422  | Invalid set payload         |
| `E.MEDIA.MALWARE`                | 422  | Upload failed AV scan       |
| `E.API.UNKNOWN_FILTER`           | 422  | Filter not allowed          |
| `E.IDEMPOTENCY.PAYLOAD_MISMATCH` | 409  | Same key, different payload |

> Full registry lives in **Appendix B** and is validated in unit tests.

---

**Contract Stability**: Changes to endpoint paths, auth, or DTOs require updating §7, regenerating OpenAPI, and adjusting QA tests. Breaking changes MUST be introduced under a new major API version.

---

# 8. Client-Facing Contracts (Frontend Integration)

This section defines how the React app integrates with the API and implements the **user-facing contracts**: route map, auth guards, state, validation, i18n, accessibility, and UI performance conventions. It binds §7 (API) and §5 (cross-cutting) to concrete FE behavior.

---

## 8.1 Route Map & Auth Guards

> SPA with React Router. Guards enforce auth state, roles, and feature flags.

| Route                  | Access       | Guard                                | Notes                                                      |
| ---------------------- | ------------ | ------------------------------------ | ---------------------------------------------------------- |
| `/`                    | public       | none                                 | Marketing/landing or dashboard redirect when authenticated |
| `/auth/login`          | public       | Redirect if authenticated            | Login form (email, password, OTP if 2FA)                   |
| `/auth/register`       | public       | Redirect if authenticated            | Registration form                                          |
| `/auth/verify`         | public       | none                                 | Handles `token` param and shows result                     |
| `/auth/reset`          | public       | none                                 | Request reset form                                         |
| `/auth/reset/complete` | public       | none                                 | Complete reset with `token`                                |
| `/app`                 | user         | **AuthGuard**                        | Shell layout; loads user profile on mount                  |
| `/app/sessions`        | user         | AuthGuard                            | List calendar/timeline; filters `from,to,status`           |
| `/app/sessions/new`    | user         | AuthGuard + **IdempotencyDecorator** | Create session                                             |
| `/app/sessions/:id`    | user (owner) | **OwnerGuard**                       | Read/update; nested sets editor                            |
| `/app/exercises`       | user         | AuthGuard                            | Search list (global + my)                                  |
| `/app/exercises/new`   | user         | AuthGuard                            | Create exercise (user-owned)                               |
| `/app/exercises/:id`   | user/owner   | OwnerOrAdminGuard                    | View/update                                                |
| `/app/analytics`       | user         | AuthGuard                            | Dashboards                                                 |
| `/app/points`          | user         | AuthGuard                            | Points & badges                                            |
| `/app/feed`            | public/user  | Guard depends on visibility          | Public timeline + my items                                 |
| `/app/profile/:alias`  | public/user  | VisibilityGuard                      | Public-safe profile view                                   |
| `/admin`               | admin        | **RoleGuard(admin)**                 | Admin shell (global exercises, audit)                      |

**Guards**:

- `AuthGuard`: requires valid access token; redirects to `/auth/login`.
- `OwnerGuard`: verifies current user is the resource owner (via API or preloaded model).
- `RoleGuard(role)`: checks `role` claim.
- `VisibilityGuard`: calls public endpoint or private owner view accordingly.
- `IdempotencyDecorator`: attaches `Idempotency-Key` to eligible POST/PATCH (see §5.7, §7.14).

---

## 8.2 State, Query & Caching

- **Data layer**: React Query (or equivalent) with stale-while-revalidate.
- **Cache keys**: normalized (e.g., `["sessions", {from,to,status}]`).
- **Revalidation**: on window focus, network regain, or mutation success.
- **Optimistic updates**: only for local UI affordances; server is source of truth; roll back on error.
- **Prefetch**: dashboard critical queries on `/app` mount.
- **Invalidation**: mutate sessions invalidates lists, analytics, points, feed where impacted.
- **Error boundary**: top-level and per-page; shows localized messages based on error `code` from §7.1.3.

---

## 8.3 Forms & Validation Boundaries

- **Client validation** mirrors server schemas (zod) to provide instant feedback; server remains authoritative.
- **Password**: strength meter; enforced min length and complexity consistent with BE.
- **Alias**: debounced uniqueness check; lowercase normalization visible.
- **Session editor**: nested sets with guardrails (non-negative numbers, sensible maxima).
- **Accessibility**: all inputs have labels; errors announced via ARIA live regions.
- **Submit behavior**: disable buttons while pending; show skeletons/spinners; never block UI thread.

---

## 8.4 i18n Token Strategy

- **MVP**: Static token dictionaries **EN/DE** with high coverage threshold in CI.
- **Runtime**: `Accept-Language` parsed on first visit; persisted preference in profile.
- **Fallback**: EN when token missing; capture telemetry for gaps (dev only).
- **Date/number**: use Intl APIs; server returns ISO values + optional hints (see §3.5, §5.5).
- **Email/system strings**: tokens shared between BE & FE to keep consistency (namespace: `system.*`).

---

## 8.5 Accessibility (WCAG 2.1 AA)

- **Keyboard**: fully navigable; focus management after route change and modal open/close.
- **Color contrast**: maintain â‰¥ 4.5:1; tokens defined in theme.
- **ARIA**: landmarks, labels, error announcements (`role="alert"`).
- **Media**: alt text required; decorative images `aria-hidden="true"`.
- **Motion**: respect `prefers-reduced-motion`.
- **Testing**: automated a11y checks in CI (axe) for critical screens.

---

## 8.6 Error Handling & UX Conventions

- Map `error.code` to localized messages and **actionable remediation** (e.g., `E.AUTH.LOCKED` â‡’ show cooldown and security tips).
- Global **toaster/inline** error presentation; avoid modal traps.
- For 401: attempt silent refresh then redirect to login with returnTo.
- For 403: show â€œnot authorizedâ€ with link to help.
- For 404: resource-not-found page and a safe back link.
- For 409 idempotency replays: show non-intrusive info; update UI with returned entity.

---

## 8.7 UI Performance Conventions

- **LCP** budget **< 2.5 s** (P75). Above-the-fold content SSR/CSR hybrid optional (Phase 2).
- **Code splitting**: route-based chunks; prefetch likely next routes.
- **Images**: responsive sizes; lazy-load below fold; AVIF/WebP preferred.
- **Lists**: virtualization for large feeds; skeleton loaders.
- **Memoization**: avoid re-renders in forms and heavy lists; use stable keys.
- **Analytics**: Web Vitals reporting to observability (non-PII).

---

## 8.8 Theming & Design Tokens

- **Tokens**: colors, spacing, typography, radii, shadows; both **light** and **dark** themes.
- **Scaling**: use `rem` and CSS variables; respect user font scaling.
- **Components**: cards, inputs, tables, modals follow tokens; accessible focus styles.
- **Icons**: consistent set (e.g., lucide-react).
- **Brand**: FitVibe logo variants; ensure minimum size and clear space.

---

## 8.9 Frontend DTOs & Mappers

- FE imports **TypeScript types** generated from BE zod schemas (or shared package) to prevent drift.
- Map snake_case DB/BE fields to camelCase UI models in a dedicated mapper layer.
- Date strings parsed to `Date` only at view model boundary; keep raw ISO in caches.

---

## 8.10 Pagination, Filtering & Sorting UX

- **Pagination**: standard page/limit controls; â€œLoad moreâ€ for mobile.
- **Filtering**: debounced inputs; reset/clear pattern; URL query sync for shareable views.
- **Sorting**: explicit dropdown; default stable sort per resource.
- Preserve filters in session storage to improve continuity.

---

## 8.11 Uploads (Avatars & Media)

- Client enforces **type/size** before upload; displays AV scan status from server.
- Show deterministic placeholders while processing; retry with exponential backoff on transient errors.
- Strip EXIF on client when possible before upload (optional).

---

## 8.12 Analytics & Telemetry

- Event taxonomy (examples): `login_success`, `session_created`, `session_completed`, `exercise_created`, `points_awarded`, `feed_published`.
- Send minimal payloads (opaque IDs, no PII).
- Sampling enabled; opt-out respected.

---

## 8.13 Feature Flags (UI)

- Flags read from `/config` or embedded build-time env; cached client-side.
- Gates: **2FA**, **admin global exercises**, **public feed discovery**.
- All flag decisions are **render-blocking** only on first load; afterward cached and rechecked in background.

---

## 8.14 Offline & Resilience (MVP-lite)

- Basic **retry** for transient network errors.
- **Draft caching** for forms (sessions editor) in localStorage with explicit â€œRestore draftâ€.
- Connectivity banner on offline/online events.

---

## 8.15 Security & Privacy on the Client

- Store access tokens in memory (default) or secure cookies (if configured).
- Never persist refresh tokens in localStorage/sessionStorage.
- Redact PII in logs; disable verbose logs in production.
- Sanitize all user-provided HTML (not expected in MVP forms; keep plain text).

---

## 8.16 Component Contracts (Selected)

### 8.16.1 SessionEditor

- **Props**: `initialSession?`, `onSubmit`, `onCancel`.
- **Behavior**: manages nested exercises/sets; validates; emits DTO; attaches `Idempotency-Key`.
- **Empty state**: guided quick-add from Exercise library.
- **Perf**: virtualize large set lists; memoize controls.

### 8.16.2 ExerciseSearch

- **Props**: `query`, `filters`, `onSelect`.
- **Behavior**: debounced server search; shows facets; handles global vs my exercises.
- **Perf**: infinite scroll; cached last queries.

### 8.16.3 AnalyticsDashboard

- **Props**: `from`, `to`, `grain`.
- **Behavior**: fetches aggregates; allows drill-down to sessions; caps response size.
- **Perf**: skeletons; chart virtualization for many points.

---

## 8.17 Contracts for Emails (Rendered by FE Templates or BE)

- Tokens resolved using shared dictionaries.
- Layout responsive; accessible text versions; links include `utm_campaign=system` (non-PII).
- Security: no tracking pixels that violate privacy policy.

---

**Integration Guarantee**: The FE must treat §7 contracts as the single source of truth and adhere to §5 controls. Any deviation requires an ADR and updates to PRD/QA.

---

# 9. Non-Functional Realization

This section operationalizes all **NFRs** (security, performance, reliability, accessibility, observability, privacy) into **measurable budgets**, **controls**, and **CI/CD gates**. It references §5 (cross-cutting), §6 (data), §7 (API), and §8 (FE).

---

## 9.1 NFR → Control → Verification Matrix

| NFR Domain             | Target                                     | Design Control (Where)                                                                  | Verification (How)                                                                   |
| ---------------------- | ------------------------------------------ | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| **Security**           | No high/critical vulns; hardened endpoints | §5.1 security headers, JWT RS256 + refresh rotation, rate limits, AV scan, SBOM/signing | CI SCA (npm audit/OSV), ZAP baseline, headers test, EICAR upload test, cosign verify |
| **Privacy/GDPR**       | DSR export/delete; scrub logs              | §5.2 DSR flows, §6.6 retention/classification                                           | E2E DSR tests, log/metric schema lint (no PII), backup purge policy check            |
| **Performance (API)**  | p95 < **300 ms**, p99 < **800 ms**         | §5.3 budgets/timeouts, §6.3 hot indexes                                                 | k6 CI profile per route group, alert on regression >10%                              |
| **Performance (FE)**   | LCP < **2.5 s** (P75)                      | §8.7 UI perf rules                                                                      | Lighthouse CI budget, Web Vitals RUM dashboard                                       |
| **Reliability**        | Error rate < 0.5%; RPO ≤ 24h; RTO ≤ 4h     | §12 runbooks; §6.10 backups                                                             | Chaos drills (read-only DB, SMTP down), restore test monthly                         |
| **Observability**      | Complete logs/metrics/traces               | §5.4 metrics contract                                                                   | Prometheus scrape integration test; dashboards and alert tests                       |
| **Accessibility**      | WCAG 2.1 AA                                | §8.5 a11y rules                                                                         | axe CI checks, manual keyboard walk-through for key flows                            |
| **Availability (MVP)** | 99.5% monthly                              | NGINX health checks; rolling deploys                                                    | Uptime probe SLO; synthetic checks                                                   |

---

## 9.2 Performance Engineering

### 9.2.1 Load Profiles (MVP realistic)

| Profile        | Actors        | Pattern                                   | Target                                            |
| -------------- | ------------- | ----------------------------------------- | ------------------------------------------------- |
| **Auth Spike** | 50 concurrent | burst login/reset                         | keep p95 < 300 ms; lockouts reliable              |
| **Planner**    | 200 active    | 2 rps GET `/sessions`, 0.5 rps POST/PATCH | p95 < 300 ms; zero duplicate writes (idempotency) |
| **Analytics**  | 100 active    | 1 rps GET `/analytics/*` (window ≤ 90d)   | p95 < 500 ms; payload ≤ 1 MB                      |
| **Feed Read**  | 150 active    | 3 rps GET `/feed`                         | p95 < 300 ms                                      |

### 9.2.2 Budgets & Limits

- **Request size:** ≤ 2 MB (JSON); **Response size:** ≤ 1 MB (JSON).
- **Timeouts:** API → DB 2 s; API → SMTP/object store 3 s; jobs up to 30 s.
- **Concurrency:** Node worker threads tuned to CPU; DB connection pool sized to 2Ã— cores (cap ≤ 20).
- **Compression:** gzip/Brotli enabled at edge.

### 9.2.3 DB Performance Practices

- Per-endpoint **hot query + index** list in §6.3 is mandatory.
- Use **partial indexes** where predicates are common (e.g., `deleted_at IS NULL`).
- Monitor `pg_stat_statements`; alert on heavy scans.
- Prefer **matviews** for aggregates; refresh incrementally post-writes.

### 9.2.4 Regression Guard

- CI k6 run produces baseline JSON; PRs must not regress **>10%** p95 per route group; failures block merge.
- FE Lighthouse budgets: LCP, TBT, CLS enforced in CI; failing budgets block merge.

---

## 9.3 Security Realization (summary)

- **AuthN/Z:** RS256 JWT; refresh rotation; reuse detection → revoke family.
- **Headers:** CSP, HSTS, Referrer-Policy, Permissions-Policy, X-Frame-Options.
- **Abuse:** per-IP/account rate limits; lockout with exponential backoff; **no user enumeration**.
- **Uploads:** AV scan (clamd/service); EXIF strip; private ACL; signed URL or proxy.
- **Supply-chain:** SBOM generation + signature; image signing with cosign; pinned digests in CD.
- **Secret management:** env schema validation; rotation procedures via JWKS.

**Verification:** unit/integration tests for flows; ZAP baseline; negative tests (e.g., missing headers/cors).

---

## 9.4 Privacy & Data Protection

- **Classification** map in §6.6; **PII never** appears in logs/metrics labels.
- **DSR Export/Delete** implemented with audit trail; delete cascades across child tables; **backups purged ≤ 14 days** after finalization.
- **Consent** gating for public feed publishing and marketing emails.
- **Data minimization:** only collect data required to deliver MVP functionality.

**Verification:** E2E tests (export bundle completeness; delete propagation checks); privacy lint for log fields.

---

## 9.5 Reliability & Availability

### 9.5.1 Targets

- **Availability:** 99.5% monthly (MVP).
- **RPO:** ≤ 24 hours. **RTO:** ≤ 4 hours.

### 9.5.2 Patterns

- Health checks: `/health/liveness`, `/health/readiness` (DB, queue, object store).
- **Rolling deployments** (or blue/green) with pre-flight DB migration checks.
- **Backups:** daily full; PITR if supported; encrypted at rest and in transit.
- **Restore procedures** documented in §12; monthly restore drills in staging.
- **Graceful degradation:** analytics endpoints can be temporarily disabled under heavy load; core CRUD stays up.

### 9.5.3 Chaos & Fault Injection

- Simulate: DB read-only, SMTP failure, object store latency; verify timeouts and fallbacks.
- Verify idempotent replays produce consistent outcomes under retries.

---

## 9.6 Accessibility (WCAG 2.1 AA)

- **Keyboard access:** every control reachable; visible focus outlines.
- **Contrast:** â‰¥ 4.5:1; theming tokens enforce.
- **ARIA:** landmarks, labels, live regions for errors; headings in logical order.
- **Motion:** respect `prefers-reduced-motion`.
- **Media:** alt text required; non-decorative images labeled.

**Verification:** automated **axe** checks in CI for `/auth/*`, `/app/sessions`, `/app/exercises`, `/app/analytics` + manual spot-checks.

---

## 9.7 Observability & SLOs

### 9.7.1 SLOs

- **Latency SLO:** 95% of requests < 300 ms (API).
- **Error SLO:** < 0.5% 5xx per 10-minute window.
- **Availability SLO:** 99.5% uptime for `/health/readiness` and primary APIs.

### 9.7.2 Dashboards

- API latency & error rate; DB health (`connections`, `locks`, slow queries); background jobs; upload AV results; RUM Web Vitals.

### 9.7.3 Alerts

- p95 > 300 ms for 15 min.
- 5xx > 0.5% for 10 min.
- DB connection saturation > 80% for 5 min.
- Queue backlog age > 5 min.
- AV scan failures spike beyond baseline.

---

## 9.8 Capacity Planning (MVP)

- **Throughput assumption:** 20 rps peak mixed traffic on a single API node; horizontal scale with 2-3 replicas.
- **DB sizing:** start with 2 vCPU/4-8 GB RAM; scale vertically to 4 vCPU/16 GB as needed; storage with 3000+ IOPS.
- **Object storage:** S3-compatible bucket; lifecycle rules for deleted media.
- **Headroom:** maintain ≤ 60% avg CPU and ≤ 70% DB connections under peak.

---

## 9.9 CI/CD Quality Gates (NFR)

- **Lint + Typecheck:** must pass.
- **Tests:** coverage **â‰¥ 80%** lines/branches.
- **Security:** SCA clean (no high/critical); ZAP baseline no high.
- **Perf:** k6 thresholds for each route group; no >10% regression.
- **A11y:** axe checks pass on key screens.
- **Build:** SBOM generated; images signed; pinned digests.
- **Deployment:** health/readiness checks green; migrations safe; rollback plan present.

---

## 9.10 Exceptions & ADRs

Any exceptions to these NFR controls require:

1. An **ADR** describing the deviation and rationale.
2. Updates to PRD/QA acceptance where applicable.
3. A plan to return to baseline.

---

**Conformance**: This section is enforceable through CI/CD and runtime alerts. Failure to meet gates blocks release until mitigations are applied.

---

# 10. CI/CD & Developer Experience

This section specifies the **pipeline**, **quality gates**, **artifact handling**, **release strategy**, **migration safety**, and **local developer workflow** for FitVibe. It binds §5 (Cross-Cutting), §7 (API), §8 (FE), and §9 (NFR gates) into executable automation.

---

## 10.1 Monorepo Layout & Task Graph

```
FitVibe V2/
 â”œâ”€ apps/
 â”‚   â”œâ”€ backend/         # Express/TS API, tests, migrations, seeds
 â”‚   â””â”€ frontend/        # React/Vite app, tests, e2e (Playwright)
 â”œâ”€ packages/            # shared libs (dto, config, ui)
 â”œâ”€ .github/workflows/   # CI/CD pipelines
 â”œâ”€ docs/                # PRD, TDD, QA, ADRs, diagrams
 â”œâ”€ turbo.json           # task graph (build, lint, test, typecheck)
 â””â”€ docker/              # Dockerfiles & compose files
```

**Turborepo tasks (examples):**

- `build`: builds FE & BE
- `lint`: eslint + prettier check
- `typecheck`: tsc --noEmit
- `test`: unit & integration (Jest)
- `e2e`: Playwright (frontend)
- `perf`: k6 (API)
- `a11y`: axe (frontend)

---

## 10.2 CI Pipeline (GitHub Actions)

### 10.2.1 Stages & Quality Gates

1. **Prepare**: checkout, pnpm cache restore, node setup.
2. **Static checks**: `lint`, `typecheck`.
3. **Unit/Integration tests**: `test` with **coverage â‰¥ 80%** (fail below).
4. **Security**: SCA (OSV), `npm audit` (no high/critical), ZAP baseline (no high).
5. **Build**: FE & BE artifacts; generate **OpenAPI**; build Docker images.
6. **Budgets**: **Lighthouse** (LCP/TBT/CLS) and **k6** (p95 < 300 ms) â€” **no >10% regression** vs baseline.
7. **Artifacts**: upload OpenAPI JSON, coverage, k6/lighthouse reports; **SBOM** (Syft) and **cosign sign**.
8. **Publish images**: to GHCR with pinned digests (staging on `main` merge).
9. **CD trigger**: manual approval for production.

> Any gate failure **blocks** the pipeline (see §9.9).

### 10.2.2 Example Workflow Snippet (excerpt)

```yaml
name: ci
on:
  pull_request:
  push:
    branches: [main]
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: "pnpm" }
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint && pnpm typecheck
      - run: pnpm -w test -- --coverage
      - run: pnpm -w build
      - name: Generate SBOM
        run: syft packages dir:. -o json > sbom.json
      - name: Build & Push Images
        run: |
          docker build -f docker/backend.Dockerfile -t ghcr.io/you/fitvibe-backend:${{ github.sha }} .
          docker build -f docker/frontend.Dockerfile -t ghcr.io/you/fitvibe-frontend:${{ github.sha }} .
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/you/fitvibe-backend:${{ github.sha }}
          docker push ghcr.io/you/fitvibe-frontend:${{ github.sha }}
```

> Full YAML lives in `.github/workflows/ci.yml` and `.github/workflows/cd.yml`.

---

## 10.3 CD & Release Strategy

### 10.3.1 Environments

- **Staging**: auto-deploy on `main` merge; feature flags enabled for preview.
- **Production**: manual approval; blue/green or rolling updates via Docker Compose/Swarm/Kubernetes (as available).

### 10.3.2 Health & Rollout

- Pre-deploy: run DB connectivity + pending migrations check.
- Deploy sequence:
  1. Pull images by **digest** from GHCR.
  2. Run DB migrations (see §10.4) with safety checks.
  3. Start new app containers behind NGINX.
  4. Wait for readiness; switch traffic (blue/green) or roll one-by-one (rolling).

### 10.3.3 Rollback

- Keep last two releases' image digests.
- `compose -f docker/compose.prod.yml up -d` with previous digest labels.
- Reverse migrations only if safe; otherwise **forward-fix**.

---

## 10.4 Database Migrations in CD

- **Expand/Contract**: apply additive changes first; code reads both old/new; remove legacy in follow-up release.
- **Ordering**: use §6.7 list; CI verifies monotonic timestamps.
- **Execution**: run migrations as a **one-shot job** container with the new image and `DB_MIGRATE=true`.
- **Safety**:
  - Dry-run in staging before prod.
  - Guard-rails: blocks on long locks; statement timeout (e.g., 2 s) for risky ops.
  - Backfill tasks run asynchronously where possible.

**Failure policy**: stop rollout; keep old app version serving; investigate; apply forward-fix migration.

---

## 10.5 Artifacts, SBOM & Signing

- **OpenAPI** (`apps/backend/openapi/openapi.json`) uploaded on every CI run.
- **Coverage reports** saved as artifacts; minimum gate enforced.
- **SBOM** generated with **Syft**; container images **signed with cosign**.
- **Pinned digests** used in CD to prevent tag drift.
- Release notes include **deprecation headers** (see §7.1.1) if applicable.

---

## 10.6 Secrets & Configuration

- **.env.example** in repo with placeholders; **.env** not committed.
- CI uses **Actions secrets** and **environment protection rules** for staging/prod.
- Production JWT keys loaded from secrets manager or Actions-encrypted vars.
- Rotations documented in §12 runbooks.

---

## 10.7 Local Development (DX)

### 10.7.1 Quickstart

```bash
pnpm install
pnpm -w build    # first-time type generation
cp .env.example .env
docker compose -f docker/compose.dev.yml up -d db mailhog nginx
pnpm --filter backend migrate
pnpm --filter backend seed-dev
pnpm dev         # runs both FE & BE via turbo
```

### 10.7.2 VS Code Tasks (examples)

```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "FitVibe: Dev (FE+BE)",
      "type": "shell",
      "command": "pnpm dev",
      "group": "build"
    },
    {
      "label": "FitVibe: Build All",
      "type": "shell",
      "command": "pnpm build",
      "group": "build"
    },
    {
      "label": "FitVibe: Lint + Typecheck",
      "type": "shell",
      "command": "pnpm lint && pnpm typecheck",
      "group": "build"
    },
    {
      "label": "FitVibe: Migrate DB",
      "type": "shell",
      "command": "pnpm --filter backend migrate",
      "group": "test"
    },
    {
      "label": "FitVibe: Seed Demo Data",
      "type": "shell",
      "command": "pnpm --filter backend seed-dev",
      "group": "test"
    },
    {
      "label": "FitVibe: Rollback Last Migration",
      "type": "shell",
      "command": "pnpm --filter backend migrate:rollback",
      "group": "test"
    }
  ]
}
```

### 10.7.3 Pre-commit Hooks

- **Husky**: run `lint-staged` on staged files; prevent committing failing code.
- Conventional commits optional (e.g., `feat:`, `fix:`) for better changelogs.

### 10.7.4 Test Data & Fixtures

- Ephemeral DB for tests (Docker).
- Deterministic seeds for unit/integration; Playwright uses isolated account fixtures.

---

## 10.8 E2E, Perf & A11y in CI

- **Playwright**: headless runs on staging build (auth flow, sessions CRUD, analytics read).
- **k6**: per-route group scripts (auth, sessions, feed). Thresholds enforced.
- **Lighthouse**: CI run on built frontend; budgets: LCP < 2.5 s, TBT < 200 ms, CLS < 0.1.
- **axe**: a11y checks on core routes (see §9.6).

Reports uploaded as artifacts and linked in PR comments.

---

## 10.9 Incident Readiness in CD

- Health endpoints + synthetic probes; alerting wired to on-call channel.
- **One-click rollback** command documented; previous digests stored.
- DR drill checklist: restore latest backup to staging monthly; verify app boot + migrations on restored DB.

---

## 10.10 Governance

- Pipeline changes require PR review from **owner**.
- Exceptions to gates require **ADR** and time-bound mitigation plan.
- Security updates prioritized; dependency bot PRs obey same gates.

---

**Outcome**: CI/CD codifies the NFRs from §9 as enforceable gates, produces signed artifacts with SBOM, deploys safely with migration discipline, and supports a fast, friendly local DX.

---

# 11. Testability Hooks & Fixtures

This section makes the system **easy to test** and ensures verifiable conformance to the PRD and QA Plan. It defines **test strategy, fixtures, fakes/mocks, deterministic controls, datasets, coverage policy, CI wiring**, and **RTM mapping**. It is binding for both FE and BE.

---

## 11.1 Strategy Overview

- **Goal:** Achieve QA gates (coverage â‰¥ **80%**, perf **p95 < 300 ms**, a11y **WCAG 2.1 AA**) with fast, reliable tests.
- **Split:** Unit → Integration → E2E → Non-functional (security, perf, a11y).
- **Determinism:** Clock/ID/mail are controllable; tests are order-independent; data isolated per test.
- **Artifacts:** Coverage, OpenAPI, k6/Lighthouse/axe reports uploaded in CI.

---

## 11.2 Test Pyramid & Ownership

| Layer         | Scope                             | Tools                                  | Runs In          | Owner         |
| ------------- | --------------------------------- | -------------------------------------- | ---------------- | ------------- |
| Unit          | pure functions, schemas, services | Jest (ts-jest), Vitest (FE)            | Node/JSdom       | Module author |
| Integration   | API routes + DB, migrations       | Jest + Supertest + Dockerized Postgres | Container        | BE            |
| E2E (FE)      | user flows across UI/API          | Playwright                             | Headless browser | FE            |
| Security      | headers, auth flows, ZAP baseline | ZAP, custom checks                     | CI               | Sec/BE        |
| Performance   | per-route groups & FE budgets     | k6, Lighthouse                         | CI               | BE/FE         |
| Accessibility | critical screens                  | axe                                    | CI               | FE            |

---

## 11.3 Test Environments

- **Unit:** in-memory, no DB; mocks for adapters.
- **Integration:** ephemeral Postgres container; run **migrations** from §6.7; seed minimal data; cleanup between tests.
- **E2E:** start backend on ephemeral port + built frontend (or dev server); use isolated test accounts; external adapters set to fakes (mail).
- **Data separation:** unique **schema** or random database per run to avoid cross-test interference.

---

## 11.4 Fixtures & Factories (Backend)

- **Factories** (TypeScript): `makeUser`, `makeSession`, `makeExercise`, `makePointsEvent` with sensible defaults and override options.
- **Seeds (integration):** minimal **global** data only: exercise categories, 3 global exercises, 3 badges.
- **Per-test data:** created via factories inside transactions; rollback after test (or truncate selective tables).
- **Clock control:** test helper exposes `setNow()`; DB timestamps rely on app clock to remain deterministic.

**Example (pseudo):**

```ts
const u = await makeUser({ alias: "alice" });
const s = await makeSession({ ownerId: u.id, plannedAt: nowPlus(1, "day") });
```

---

## 11.5 Fakes, Mocks & Stubs

- **Mail adapter:** Fake transport capturing **outbox** in memory/JSON; assertions on recipients & subjects; renders both text & HTML.
- **AV scanner:** Fake returns `clean` by default; EICAR string triggers `malware`.
- **Feature flags:** Test harness toggles 2FA, public feed discovery, admin global exercises.
- **External time/uuid:** `FakeClock`, `DeterministicUuid` for reproducible snapshots.

---

## 11.6 Determinism Controls

- **Clock:** single source of time (DI) for API and jobs; tests call `clock.freeze('2025-10-13T12:00:00Z')`.
- **IDs:** use ULID/UUIDv7 factory with seeded randomness.
- **Randomness:** all PRNG seeded; property-based tests use fixed seeds for snapshots.

---

## 11.7 Datasets & Golden Files

- **Golden responses** for selected endpoints: `/sessions`, `/analytics/summary`. Stored under `apps/backend/tests/golden/**`.
- **k6 datasets**: CSV/JSON users & session payloads sized for load profiles in §9.2.1.
- **Lighthouse config** with budgets used in CI; thresholds committed under `apps/frontend/.lighthouse/`.
- **axe rulesets**: baseline for critical screens.

---

## 11.8 Module-Specific Test Hooks (FR Mapping)

| FR             | Critical Hooks                                                                                  | Notes                                       |
| -------------- | ----------------------------------------------------------------------------------------------- | ------------------------------------------- |
| FR-1 Auth      | Fake mail; token TTLs; lockout counters; 2FA TOTP with deterministic secret; session revoke API | Assert no user enumeration; headers present |
| FR-2 Profile   | Avatar upload with AV fake; alias collision; visibility matrix                                  | `citext` uniqueness; reserved names         |
| FR-3 Exercises | Global vs user-owned permissions; search indices; archive flow                                  | Text/trigram & GIN search                   |
| FR-4 Sessions  | Transactional nested writes; idempotency replay; clone/complete                                 | 409 on payload mismatch for same key        |
| FR-5 Analytics | Matview refresh after completion; large-range slicing                                           | 1MB cap; perf budget                        |
| FR-6 Points    | Idempotent ledger; anomaly spikes alert                                                         | Backfill rate limit                         |
| FR-7 Feed      | Publish/unpublish; link-token lifecycle; visibility                                             | Token revoke → 404                          |
| FR-8 i18n      | Token coverage; locale negotiation                                                              | Fallback to EN tracked in dev               |

---

## 11.9 Coverage Policy

- **Thresholds (repo-wide):** **Lines â‰¥ 80%**, **Branches â‰¥ 80%**.
- **Critical files** (auth, sessions writes, analytics aggregation): individual file floor **â‰¥ 90%** lines.
- CI fails below thresholds; coverage reports published per package.

---

## 11.10 CI Wiring

- **Commands** (workspace root):
  - `pnpm -w test -- --coverage` (unit+integration, BE/FE)
  - `pnpm --filter backend perf` (k6)
  - `pnpm --filter frontend a11y` (axe)
  - `pnpm --filter frontend e2e` (Playwright)
- **Artifacts:** `coverage/**`, `k6/**.json`, `lighthouse/**.json`, `axe/**.json`, screenshots/videos from Playwright.
- **Parallelization:** matrix jobs per package; DB service shared via network for integration.

---

## 11.11 RTM Mapping (QA)

A minimal RTM slice is embedded for quick checks; full matrix lives in QA Plan.

| PRD Ref  | TDD Section | Test Layer   | Evidence                                       |
| -------- | ----------- | ------------ | ---------------------------------------------- |
| FR-1     | §4.1, §7.2  | Unit/Int/E2E | auth.spec.ts, tokens.spec.ts, e2e-auth.spec.ts |
| FR-4     | §4.4, §7.5  | Int/E2E      | sessions.spec.ts, e2e-sessions.spec.ts         |
| NFR-Perf | §5.3, §9    | k6           | k6-report.json, perf-thresholds.yaml           |
| NFR-A11y | §8.5, §9    | axe          | axe-summary.json                               |
| NFR-Sec  | §5.1        | ZAP/headers  | zap-report.html, headers.spec.ts               |

---

## 11.12 Frontend Testability

- **data-testid** attributes on interactive elements (stable, documented).
- **Mock Service Worker (MSW)** for FE unit/integration tests; E2E uses real API.
- **Visual regression** optional (Phase 2) via Playwright snapshots for critical pages.

---

## 11.13 Error Injection & Chaos (Test Mode)

- Toggle SMTP failure, DB read-only, object-store latency via env flags:
  - `TEST_FAIL_SMTP=1`, `TEST_DB_READONLY=1`, `TEST_OBJSTORE_SLOW_MS=500`.
- Verify user-facing remediation and correct HTTP statuses/timeouts.

---

## 11.14 Example Test Specs (Illustrative)

- **auth.spec.ts**: register → verify → login → refresh → reuse-detected refresh → family revoke; lockout after N attempts; 2FA enable/disable.
- **sessions.spec.ts**: create (idempotent), update nested, complete, clone; 409 on mismatched replay; transactional rollback on set validation fail.
- **analytics.spec.ts**: after session completion, matview refresh exposes updated PRs; wide range returns 413.
- **feed.spec.ts**: publish/unpublish; link token access; revoke returns 404.
- **uploads.spec.ts**: EICAR blocked; metadata persisted on clean; EXIF stripped; private ACL.

---

## 11.15 Tooling & Helpers

- **Test logger** with lower verbosity; prints `requestId` on failure.
- **DB helpers**: `truncateAll()`, `withTransaction(testFn)`.
- **OpenAPI validator** optional: ensure routes conform to schema in tests.

---

## 11.16 Exit Criteria (Per PR/Release)

- All tests green; coverage thresholds met.
- Perf/a11y/security gates pass (see §9.9).
- No flaky tests (quarantined tests block merge).
- Artifacts uploaded and linked in PR.
- If any exception, an ADR documents scope and timeline to return to baseline.

---

**Assurance**: With these hooks and fixtures, FitVibe's features are **verifiable** and **repeatable** across environments. Deviations require ADRs and updates to the QA Plan.

---

# 12. Operations & Runbooks

This section defines **repeatable, checklist-driven procedures** for operating FitVibe safely: monitoring, incident response, **JWT key rotation**, **session revocation**, **GDPR DSR delete**, **backup/restore drills**, **partition rotation**, **media AV failures**, **rollbacks**, and **DR**. It binds to §5 (security/privacy), §6 (data), §7 (API), §9 (NFRs), and §10 (CI/CD).

> Golden rule: **Prefer forward-fix.** Keep production changes **audited** in `audit_log` and/or infra logs. Any deviation requires an ADR entry.

---

## 12.1 On-Call Overview

**Primary objective**: restore service within SLOs (latency p95 < 300 ms, error rate < 0.5%).

- **Hours**: business-hours for MVP (extend later).
- **Dashboards**: API latency/error, DB health, job queues, AV scan failures, Web Vitals.
- **Alerts** (from §9.7.3): p95 breach, 5xx spike, DB saturation, queue backlog, AV failure spike.
- **Escalation**: Primary → Owner (Konstantinos) → Infra support (if applicable).
- **Communication**: status note in commit log/ops channel; user-facing status page (Phase 2).

---

## 12.2 Health Checks & Fast Triage

### 12.2.1 Checklist (Triage in ≤ 10 minutes)

1. **Readiness**: `GET /health/readiness` must be 200 and show DB OK, object store OK.
2. **Logs**: Scan last 15 minutes for `level=error`, top `error.code`.
3. **DB**: Check `connections`, `locks`, long-run queries (`pg_stat_activity`).
4. **Queue/Jobs**: backlog age; retry spikes.
5. **Recent deploy?** If yes, consider **rollback** (see §12.7).

### 12.2.2 Common Remedies

- Restart single API pod/container if memory leak; keep one instance serving.
- Pause background workers if they contend with API.
- Scale up replicas temporarily if CPU-bound (ensure DB headroom).

---

## 12.3 Incident Response Playbook

### 12.3.1 Severity Levels

- **SEV-1**: user-visible outage/degradation > 10 min.
- **SEV-2**: partial impairment; workarounds exist.
- **SEV-3**: non-urgent bug; no user impact.

### 12.3.2 Actions

- Assign **Incident Commander** (IC).
- Start timeline log: who/what/when.
- Contain: rate-limit, feature-flag risky paths, rollback if recent deploy.
- Communicate: internal note; (public status Phase 2).
- Recover: apply forward-fix or rollback.
- Postmortem within 48h; attach to ADR or `/docs/postmortems/`.

---

## 12.4 JWT Key Rotation (RS256 via JWKS)

**Goal**: rotate signing keys without invalidating legitimate sessions. Rotation window typically **7 days**.

### 12.4.1 Prereqs

- Keys stored in secrets manager or encrypted vars.
- JWKS endpoint served internally (`/internal/.well-known/jwks.json`).
- API reads active `kid` from env/config; verifies against JWKS (accepts old+new).

### 12.4.2 Procedure

1. **Generate** new keypair: `kid=new-YYYYMMDD`. Keep old as `kid=old-YYYYMMDD`.
2. **Publish** new public key to JWKS (append).
3. **Deploy** API config with `ACTIVE_KID=new-YYYYMMDD`. New tokens are issued with new `kid`.
4. **Observe**: error rate on auth; ensure both keys validate.
5. **Wait** until all old **access tokens** expire (e.g., 15 min) + buffer.
6. **Revoke old refresh families** only if compromised; otherwise maintain until natural expiry.
7. **Remove** old key from JWKS after **rotation window**; keep private part archived securely.

### 12.4.3 Rollback

- Set `ACTIVE_KID` to previous `kid`; ensure JWKS still contains the old key.

**Audit**: record `key_rotation` event in `audit_log` with `new_kid`, `old_kid`.

---

## 12.5 Session Revocation (Compromise Response)

**Use when** a device is lost or suspicious reuse detected.

1. **Identify** `user_id` / `sid` from alert/log.
2. **Revoke** session (or family) via admin API: `POST /auth/sessions/revoke` with scope.
3. **Force logout**: deny refresh for revoked `sid`; access tokens expire naturally (short TTL).
4. **Notify user** via security email with geo/time hints (no IP in clear-text).
5. **Optional**: rotate user's 2FA backup codes.

**Verification**: attempt refresh with old token must fail; audit log records revocation.

---

## 12.6 GDPR DSR â€” Export & Delete

### 12.6.1 Export (Subject Access Request)

1. Verify requester identity (logged-in, email challenge).
2. Queue export job for `user_id`.
3. **Assemble bundle**: users, profile, sessions, exercises, points, badges, feed items, media **metadata** (not binaries by default).
4. Sign bundle hash; store in temporary object store location.
5. Email secure download link (expires in 7 days).

### 12.6.2 Delete (Right to Erasure)

1. Verify identity; warn about **irreversibility**.
2. Mark account `DELETED(PENDING_PURGE)`; disable login.
3. **Async purge**:
   - Hard-delete private content: sessions, exercises (user-owned), points, feed items, media objects.
   - Anonymize `audit_log` (`user_id` null).
4. **Backups**: schedule purge to propagate in **≤ 14 days**; document completion timestamp.
5. Send confirmation email when finished.

**Edge cases**: Public/shared items are removed and caches purged. Legal hold is **not** expected in MVP; if needed, add exemption ADR.

---

## 12.7 Release Rollback

**Triggers**: p95 latency or 5xx breach post-deploy, migrations failure, critical bug.

### 12.7.1 Checklist

1. **Freeze** new traffic: disable auto-scaler changes.
2. **Switch** to previous image digests (kept per §10.3.3).
3. **Re-run readiness** until green.
4. **Database**: avoid down migrations; prefer forward-fix. If down is safe, run with caution in off-hours.
5. **Unfreeze**; monitor alerts for 30 minutes.

**Post-rollback**: create **forward-fix** ticket and ADR note.

---

## 12.8 Backup & Restore Drill

- **Backup**: daily full; PITR if supported; encrypted, access-controlled.
- **Monthly drill (staging)**:
  1. Provision fresh DB instance.
  2. Restore latest backup; record **RTO** time.
  3. Start app against restored DB; run migrations if needed.
  4. Sanity test: login, list sessions, create dummy session.
  5. Document **RPO** (data freshness) and discrepancies.

Failures are blockers; fix before next release.

---

## 12.9 Partition Rotation & Vacuum Policy

- **sessions** (monthly partitions):
  - **Create** next month's partition 7 days before month-end.
  - **Detach/Archive** partitions older than 24 months (move to cheaper storage or drop after retention).
  - Run `VACUUM (ANALYZE)` weekly and after large deletes.

- **audit_log / points_events** (if partitioned): same cadence when volume high.

**Script**: part-rotate job runs weekly; logs actions to `audit_log` with `action=partition_rotate`.

---

## 12.10 Media AV Failure Handling

1. Upload receives `suspect` or `malware` from AV.
2. Return `422 E.MEDIA.MALWARE` to client; store quarantine metadata (no public access).
3. Alert on spike in `av_scan_failures_total`.
4. Auto-purge quarantined objects after 30 days.
5. Investigate if spike: update allow-list/MIME checks; verify scanner health.

---

## 12.11 Disaster Recovery (DR) â€” Regional Failure

- **Objective**: RTO ≤ 4 h, RPO ≤ 24 h.
- **Cold standby** environment definition: infra templates, secrets, and images digests available.
- **Procedure**:
  1. Provision DB from last backup in DR region.
  2. Deploy images by **digest**; set env to point to DR DB and object store.
  3. Point DNS to DR edge.
  4. Validate health & critical flows.
  5. Back-migrate data upon primary recovery if bi-directional required (MVP: single failover, manual reconcile).

**Test**: annual DR exercise; document gaps.

---

## 12.12 Communication Templates (Internal)

- **Incident Start**: â€œSEV-x at HH:MM UTC. Symptom: <latency/5xx>. Last deploy: <sha>. Actions underway: <owner>.â€
- **Mitigation**: â€œApplied rollback to <digest>. Monitoring. Current error rate: x%.â€
- **Resolution**: â€œResolved at HH:MM UTC. Root cause: <short>. Follow-up: <ticket/ADR>.â€

---

## 12.13 Runbook Index (Quick Links)

- JWT Key Rotation → §12.4
- Session Revocation → §12.5
- DSR Export/Delete → §12.6
- Release Rollback → §12.7
- Backup & Restore Drill → §12.8
- Partition Rotation → §12.9
- Media AV Failure → §12.10
- Disaster Recovery → §12.11

---

## 12.14 RACI (MVP, single-owner simplified)

| Activity                | Responsible | Accountable | Consulted | Informed |
| ----------------------- | ----------- | ----------- | --------- | -------- |
| Deploy to prod          | Owner       | Owner       | â€”       | â€”      |
| Incident commander      | Owner       | Owner       | â€”       | â€”      |
| Key rotation            | Owner       | Owner       | â€”       | â€”      |
| DSR handling            | Owner       | Owner       | â€”       | User     |
| Backups & restore drill | Owner       | Owner       | â€”       | â€”      |

---

**Outcome**: These runbooks make operations repeatable, auditable, and aligned with FitVibe's security, privacy, and reliability targets. Keep them **current** with every release and reflect exceptions in ADRs.

---

# 13. Environments & Configuration Matrix

This section specifies **environment topology**, **configuration schema**, **required/optional variables**, **defaults**, **rotation policies**, **feature flags**, and **change control** for **Local**, **Staging**, and **Production**. It binds to §5.6 (Configuration & Secrets), §9 (NFRs), and §10 (CI/CD).

---

## 13.1 Environments Overview

| Env            | Purpose                         | Infra                                                  | Data           | Access            | API                               | Web                           |
| -------------- | ------------------------------- | ------------------------------------------------------ | -------------- | ----------------- | --------------------------------- | ----------------------------- |
| **Local**      | Dev & debugging                 | Docker Compose (API, DB, NGINX, MailHog)               | throwaway      | developer machine |
| **Staging**    | Pre-production tests, CI deploy | Same topology as prod (smaller size)                   | synthetic/test | owner only        | `https://staging.api.fitvibe.app` | `https://staging.fitvibe.app` |
| **Production** | User traffic                    | NGINX + API + Worker + Managed Postgres + Object store | real           | owner             | `https://api.fitvibe.app`         | `https://fitvibe.app`         |

---

## 13.2 Configuration Schema (Validated at Boot)

All services validate configuration on startup. Missing **required** keys cause a **non-zero exit** with a masked error summary.

| Key                               | Type                                              |           Required | Default                 | Notes                                      |
| --------------------------------- | ------------------------------------------------- | -----------------: | ----------------------- | ------------------------------------------ |
| `NODE_ENV`                        | enum(`development`,`test`,`staging`,`production`) |                âœ… | `development`           |                                            |
| `PORT`                            | int                                               |                âœ… | `4100`                  | API port                                   |
| `BASE_URL`                        | url                                               |                âœ… | `http://localhost:4100` | external base URL                          |
| `LOG_LEVEL`                       | enum(`debug`,`info`,`warn`,`error`)               |                âœ… | `info`                  | prod must be `info` or higher              |
| `DATABASE_URL`                    | string                                            |                âœ… | â€”                     | Postgres URL                               |
| `DB_STATEMENT_TIMEOUT_MS`         | int                                               |                âœ… | `2000`                  | API-side timeout                           |
| `JWT_PRIVATE_KEY`                 | pem                                               | âœ… (prod/staging) | dev test key            | **secret**                                 |
| `JWT_PUBLIC_KEY`                  | pem                                               |                âœ… | dev test key            |                                            |
| `ACTIVE_KID`                      | string                                            |                âœ… | `dev-001`               | key id in headers                          |
| `JWKS_URL`                        | url                                               |                 âŒ | â€”                     | internal JWKS, optional for dev            |
| `ACCESS_TOKEN_TTL_MIN`            | int                                               |                âœ… | `15`                    | minutes                                    |
| `REFRESH_TOKEN_TTL_DAYS`          | int                                               |                âœ… | `14`                    | days                                       |
| `TOTP_ENABLED`                    | bool                                              |                âœ… | `false`                 | feature flag                               |
| `SMTP_HOST`                       | string                                            |                âœ… | `localhost`             |                                            |
| `SMTP_PORT`                       | int                                               |                âœ… | `1025`                  | MailHog in dev                             |
| `SMTP_USER`                       | string                                            |                 âŒ | â€”                     | required in staging/prod                   |
| `SMTP_PASS`                       | string                                            |                 âŒ | â€”                     | **secret**                                 |
| `MAIL_FROM`                       | email                                             |                âœ… | `no-reply@fitvibe.app`  | sender                                     |
| `OBJECT_STORE_URL`                | url                                               |                âœ… | `http://minio:9000`     | S3-compatible ok                           |
| `OBJECT_STORE_BUCKET`             | string                                            |                âœ… | `fitvibe`               |                                            |
| `OBJECT_STORE_ACCESS_KEY`         | string                                            |                 âŒ | â€”                     | **secret**                                 |
| `OBJECT_STORE_SECRET_KEY`         | string                                            |                 âŒ | â€”                     | **secret**                                 |
| `MAX_UPLOAD_MB`                   | int                                               |                âœ… | `5`                     | media limit                                |
| `CORS_ALLOW_ORIGINS`              | csv                                               |                âœ… | `http://localhost:5173` | staging/prod must list exact domains       |
| `RATE_LIMIT_GLOBAL_PER5M`         | int                                               |                âœ… | `300`                   | per IP                                     |
| `RATE_LIMIT_AUTH_ATTEMPTS`        | int                                               |                âœ… | `10`                    | per 15 min, per account+IP                 |
| `RATE_LIMIT_REG_PERM`             | int                                               |                âœ… | `5`                     | registrations per minute, per IP           |
| `RATE_LIMIT_PWDRESET_PER15M`      | int                                               |                âœ… | `5`                     | password reset requests per 15 min, per IP |
| `RATE_LIMIT_SESSION_WRITES_PER5M` | int                                               |                âœ… | `30`                    | session writes per 5 min, per user         |
| `AV_SCANNER_URL`                  | url                                               |                 âŒ | â€”                     | if external service                        |
| `ENABLE_PUBLIC_FEED`              | bool                                              |                âœ… | `false`                 | feature flag                               |
| `ENABLE_ADMIN_GLOBAL_EXERCISES`   | bool                                              |                âœ… | `true`                  | feature flag                               |
| `ANALYTICS_DISABLED`              | bool                                              |                âœ… | `false`                 | for privacy/testing                        |
| `METRICS_BIND_ADDR`               | string                                            |                âœ… | `0.0.0.0:9400`          | Prometheus endpoint                        |
| `TRACING_ENABLED`                 | bool                                              |                âœ… | `false`                 | enable OTel exporter                       |
| `OTEL_EXPORTER_OTLP_ENDPOINT`     | url                                               |                 âŒ | â€”                     | if `TRACING_ENABLED=true`                  |

> **Note:** Secrets must **never** be logged or returned by diagnostics endpoints.

---

## 13.3 Environment Matrices

### 13.3.1 Local (development)

| Key                   | Value                                                                                  |
| --------------------- | -------------------------------------------------------------------------------------- |
| `NODE_ENV`            | `development`                                                                          |
| `BASE_URL`            | `http://localhost:4100`                                                                |
| `DATABASE_URL`        | `postgres://fitvibe:fitvibe@db:5432/fitvibe_dev`                                       |
| `SMTP_HOST`           | `mailhog`                                                                              |
| `SMTP_PORT`           | `1025`                                                                                 |
| `MAIL_FROM`           | `dev@fitvibe.local`                                                                    |
| `OBJECT_STORE_URL`    | `http://minio:9000`                                                                    |
| `OBJECT_STORE_BUCKET` | `fitvibe-dev`                                                                          |
| `CORS_ALLOW_ORIGINS`  | `http://localhost:5173`                                                                |
| Feature Flags         | `TOTP_ENABLED=false`, `ENABLE_PUBLIC_FEED=false`, `ENABLE_ADMIN_GLOBAL_EXERCISES=true` |

### 13.3.2 Staging

| Key                   | Value                                                                                |
| --------------------- | ------------------------------------------------------------------------------------ |
| `NODE_ENV`            | `staging`                                                                            |
| `BASE_URL`            | `https://staging.api.fitvibe.app`                                                    |
| `DATABASE_URL`        | managed Postgres staging                                                             |
| `SMTP_HOST`           | provider host                                                                        |
| `SMTP_USER/PASS`      | set via secrets                                                                      |
| `MAIL_FROM`           | `no-reply@staging.fitvibe.app`                                                       |
| `OBJECT_STORE_URL`    | S3 or compatible                                                                     |
| `OBJECT_STORE_BUCKET` | `fitvibe-staging`                                                                    |
| `CORS_ALLOW_ORIGINS`  | `https://staging.fitvibe.app`                                                        |
| Feature Flags         | `TOTP_ENABLED=true`, `ENABLE_PUBLIC_FEED=true`, `ENABLE_ADMIN_GLOBAL_EXERCISES=true` |

### 13.3.3 Production

| Key                   | Value                                                                                |
| --------------------- | ------------------------------------------------------------------------------------ |
| `NODE_ENV`            | `production`                                                                         |
| `BASE_URL`            | `https://api.fitvibe.app`                                                            |
| `DATABASE_URL`        | managed Postgres prod                                                                |
| `SMTP_HOST`           | provider host                                                                        |
| `SMTP_USER/PASS`      | set via secrets                                                                      |
| `MAIL_FROM`           | `no-reply@fitvibe.app`                                                               |
| `OBJECT_STORE_URL`    | S3 or compatible                                                                     |
| `OBJECT_STORE_BUCKET` | `fitvibe-prod`                                                                       |
| `CORS_ALLOW_ORIGINS`  | `https://fitvibe.app`                                                                |
| Feature Flags         | `TOTP_ENABLED=true`, `ENABLE_PUBLIC_FEED=true`, `ENABLE_ADMIN_GLOBAL_EXERCISES=true` |

---

## 13.4 .env.example (Excerpt)

```dotenv
# Core
NODE_ENV=development
PORT=4100
BASE_URL=http://localhost:4100
LOG_LEVEL=info

# Database
DATABASE_URL=postgres://fitvibe:fitvibe@localhost:5432/fitvibe_dev
DB_STATEMENT_TIMEOUT_MS=2000

# Auth
JWT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
...dev...
-----END PRIVATE KEY-----"
JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----
...dev...
-----END PUBLIC KEY-----"
ACTIVE_KID=dev-001
ACCESS_TOKEN_TTL_MIN=15
REFRESH_TOKEN_TTL_DAYS=14
TOTP_ENABLED=false

# Mail
SMTP_HOST=localhost
SMTP_PORT=1025
SMTP_USER=
SMTP_PASS=
MAIL_FROM=no-reply@fitvibe.local

# Object Store
OBJECT_STORE_URL=http://localhost:9000
OBJECT_STORE_BUCKET=fitvibe-dev
OBJECT_STORE_ACCESS_KEY=
OBJECT_STORE_SECRET_KEY=

# CORS
CORS_ALLOW_ORIGINS=http://localhost:5173

# Limits
MAX_UPLOAD_MB=5
RATE_LIMIT_GLOBAL_PER5M=300
RATE_LIMIT_AUTH_ATTEMPTS=10
RATE_LIMIT_REG_PERM=5
RATE_LIMIT_PWDRESET_PER15M=5
RATE_LIMIT_SESSION_WRITES_PER5M=30

# Observability
METRICS_BIND_ADDR=0.0.0.0:9400
TRACING_ENABLED=false
OTEL_EXPORTER_OTLP_ENDPOINT=
```

> The repository includes **`.env.example`**; **`.env` is not committed**. CI/CD injects secrets via environment-protected variables.

---

## 13.5 Configuration Endpoints & Diagnostics

- **`GET /health/readiness`**: includes config checks (DB reachable, object store ping). **Never** dumps secrets.
- **`GET /config` (optional, guarded)**: returns **non-secret** runtime flags needed by the client (e.g., feature flags, max upload MB, locales).
- **Metrics** (`/metrics`): exposes standard metrics (see §5.4).

---

## 13.6 Change Control & Rollout

- **Config changes** tracked via Git for non-secrets, and via secret manager history for secrets.
- **Two-person rule** optional (Phase 2); MVP requires owner approval for staging/prod.
- **Rollout**: staging first; verify dashboards and smoke tests; then promote to production.
- **Audit**: record `config_change` in `audit_log` including changed keys (masked) and actor.

---

## 13.7 Secrets Handling & Rotation

- Secrets stored in secret manager or GH Actions environment secrets.
- **JWT keys** rotated per §12.4; other secrets rotated **quarterly** or on incident.
- Avoid long-lived credentials; prefer tokens with scopes.
- Never print secrets in logs; redact suspicious values in error messages.

---

## 13.8 Feature Flags & Kill-Switches

| Flag                            | Default                              | Scope | Notes                                  |
| ------------------------------- | ------------------------------------ | ----- | -------------------------------------- |
| `TOTP_ENABLED`                  | `false` (dev), `true` (staging/prod) | BE+FE | Enables 2FA setup/verify UIs and flows |
| `ENABLE_PUBLIC_FEED`            | `false` (dev), `true` (staging/prod) | BE+FE | Allows public/link visibility          |
| `ENABLE_ADMIN_GLOBAL_EXERCISES` | `true`                               | BE+FE | Admin CRUD for global library          |
| `KILL_SWITCH_ANALYTICS`         | `false`                              | FE    | Hide analytics pages under stress      |
| `READ_ONLY_MODE`                | `false`                              | BE    | Blocks writes except admin             |

**Kill-switches** are loaded at startup; certain critical ones (e.g., `READ_ONLY_MODE`) can be polled on an interval (e.g., 30s) to toggle without redeploy.

---

## 13.9 Safe Defaults

- **Production hardening** set automatically when `NODE_ENV=production`:
  - `LOG_LEVEL=info` (no debug), `CORS_ALLOW_ORIGINS` must be explicit domains,
  - cookies `Secure` and `SameSite`, HSTS enabled, error messages generic,
  - rate limits enabled with non-zero thresholds, analytics enabled but non-PII.

- **Staging** mimics production; emails are **sandboxed** to a safe domain or disabled for real recipients.

---

## 13.10 Drift Detection

- CI step validates `.env.example` vs runtime config schema and flags **missing/extra keys**.
- A nightly job hits `/health/readiness` and checks a **config hash** exposed there to detect unexpected drift across replicas.

---

## 13.11 Ownership & Approvals

- **Owner** approves changes in staging/prod.
- Emergency changes allowed only to mitigate incidents; an ADR documents rationale and remediation plan within 48 hours.

---

**Outcome**: Configuration is **explicit, validated, and auditable**. Environments remain consistent, secrets safe, and feature flags give controlled flexibility without risking security or reliability.

---

# 14. Risks, Assumptions, and Constraints

This section tracks **known risks**, **explicit assumptions**, and **hard constraints** for the MVP. Each risk has an owner, mitigation, and verification hook so it can be managed in day-to-day work and reflected in ADRs when design changes are needed.

---

## 14.1 Risk Register (MVP)

Legend: **L**=Likelihood (Low/Med/High), **I**=Impact (Low/Med/High), **R**=Risk Level (LÃ—I)

| ID   | Risk                                                                   | L   | I   | R     | Mitigation / Controls                                                                                                      | Contingency / Triggers                                                                               | Owner | Status |
| ---- | ---------------------------------------------------------------------- | --- | --- | ----- | -------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | ----- | ------ |
| R-01 | **Bus factor = 1** (solo owner); delayed incident response or releases | H   | H   | **H** | Documented runbooks (§12); CI/CD automation (§10); infra as code; keep rollback one command away; small, frequent releases | If on-call unavailable → extend maintenance window; pause feature work; prioritize automation & docs | Owner | Open   |
| R-02 | API performance misses p95 < 300 ms under spikes                       | M   | H   | **H** | Hot-index map (§6.3); k6 gates (§9.2.4); caching/ETag; DB timeouts                                                         | Auto-scale API; enable read-only mode for heavy analytics                                            | Owner | Open   |
| R-03 | Security headers or CORS misconfig in prod                             | M   | H   | **H** | NGINX template checked-in; CI header tests; ZAP baseline (§9.3)                                                            | Immediate config rollback; block deploys until fixed                                                 | Owner | Open   |
| R-04 | Token reuse/refresh rotation bugs → session hijack window              | L   | H   | **M** | Reuse detection, family revoke; short access TTL; deterministic tests (§11)                                                | Force global logout; rotate keys (§12.4)                                                             | Owner | Open   |
| R-05 | GDPR DSR delete not fully propagated to backups in ≤14d                | M   | M   | **M** | Delete queue with audit trail; backup purge checklist (§12.6)                                                              | Temporarily disable new signups; manual purge + postmortem                                           | Owner | Open   |
| R-06 | Media uploads accept malware or PII leaks via EXIF                     | M   | M   | **M** | AV scan + EXIF strip; MIME allow-list; quarantine and alerts (§5.1.6, §12.10)                                              | Block uploads; rotate allow-list; incident notice if required                                        | Owner | Open   |
| R-07 | Analytics queries exceed 1 MB / time budgets                           | M   | M   | **M** | Enforce server-side slicing; matviews; CI perf gates                                                                       | Temporarily disable analytics endpoints (§9.5)                                                       | Owner | Open   |
| R-08 | Vendor lock-in: object store / SMTP provider                           | M   | M   | **M** | Adapter pattern; config via env; smoke tests                                                                               | Switch provider via config; replay failed jobs                                                       | Owner | Open   |
| R-09 | Data corruption from nested session writes                             | L   | H   | **M** | Single-transaction writes; schema constraints; property tests                                                              | Run repair job from audit; restore from backup if needed                                             | Owner | Open   |
| R-10 | Rate-limit tuning blocks legitimate users or allows abuse              | M   | M   | **M** | Metrics for 429; separate per-IP & per-account buckets; `Retry-After`                                                      | Adjust buckets; add captcha (Phase 2)                                                                | Owner | Open   |
| R-11 | i18n token coverage gaps or fallback errors                            | M   | L   | **L** | CI coverage check; fallback EN; telemetry in dev                                                                           | Hotfix missing tokens; add lint                                                                      | Owner | Open   |
| R-12 | Schema migrations cause locks/outage                                   | L   | H   | **M** | Expand/contract, statement timeouts, staging dry-run (§10.4)                                                               | Rollback app; forward-fix migration                                                                  | Owner | Open   |
| R-13 | Observability cardinality explosion                                    | M   | M   | **M** | Label allow-list; route templates; alerts on series count (§5.4)                                                           | Drop high-card labels; reduce sample rate                                                            | Owner | Open   |
| R-14 | Legal/ToS exposure from public feed content                            | L   | H   | **M** | Private by default; takedown workflow; audit for admin actions (§4.7, §5.2)                                                | Disable public feed flag; remove offending content                                                   | Owner | Open   |
| R-15 | Cost overrun (DB size, object storage, egress)                         | M   | M   | **M** | Lifecycle rules; partition/archival; logging sampling                                                                      | Tighten retention; scale down non-critical services                                                  | Owner | Open   |

**Review cadence:** weekly scan; update status and add ADRs for structural mitigations.

---

## 14.2 Assumptions (Make them explicit)

1. **MVP user base** is modest (≤ a few thousand monthly active), allowing single-node API + managed Postgres to meet SLOs.
2. **Email delivery** via a reliable SMTP provider with acceptable deliverability from day 1 (DKIM/SPF configured).
3. **Static i18n** (EN/DE) is sufficient for MVP; Dynamic AI translation is **explicitly deferred to Phase 2**; PRD reflects this deferral.
4. **No legal hold** scenarios for data deletion in MVP; full removal is permissible after identity verification.
5. **Browser target**: modern evergreen browsers; no IE/legacy edge cases.
6. **Single region** hosting is acceptable for MVP with DR plan in §12.11.
7. **Users accept** typical password and 2FA flows; social login is not required in MVP.

> If any assumption breaks, raise an ADR to capture the pivot and its design impact.

---

## 14.3 Constraints (Non-negotiables for MVP)

- **Security/Privacy**: RS256 JWT with refresh rotation; CSP/HSTS/Referrer/Permissions headers; **no PII** in logs/metrics.
- **GDPR**: DSR export & delete supported; backup purge ≤ **14 days** after deletion completion.
- **Performance**: API **p95 < 300 ms**; FE **LCP < 2.5 s** (P75); payload caps (req ≤ 2 MB, resp ≤ 1 MB).
- **Quality**: **Coverage â‰¥ 80%** repo-wide; ZAP baseline no high findings; k6/Lighthouse budgets enforced in CI.
- **Reliability**: RPO ≤ 24 h; RTO ≤ 4 h; health/readiness endpoints mandatory.
- **Architecture**: Postgres primary; REST/JSON; `/api/v1` versioning; additive changes only in v1.
- **Operations**: Blue/green or rolling deploy; migrations follow expand/contract; signed images + SBOM.
- **Compliance artifacts**: PRD/TDD/QA kept in sync; RTM updated when features change.

---

## 14.4 Open Questions / TBDs

- **Exact token TTLs**: email verification (15 min vs 60 min); align TDD/QA with single value.
- **Admin scope** for global exercise library moderation (future: proposals from users?).
- **Public feed discovery**: will there be search/hashtags in MVP or only direct links/user profiles?
- **Object storage** choice for prod (S3 vs self-hosted MinIO); cost/performance trade-offs.
- **Tracing exporter**: enable in prod from day 1 or after initial stabilization?
- **Access model** for analytics sharing (exportable images/links?).

Each TBD should be resolved via an ADR before release.

---

## 14.5 Risk Heatmap (Textual)

```
Impact
High   : [R-01][R-02][R-03][R-04][R-12][R-14]
Medium : [R-05][R-06][R-07][R-08][R-09][R-10][R-13][R-15]
Low    : [R-11]

         Low     Med     High
Likelihood
Low      R-04    R-09    R-12
Medium   R-11    R-05    R-02 R-03 R-06 R-07 R-08 R-10 R-13 R-15
High     R-01    -       -
```

---

## 14.6 Links to Related ADRs (Planned)

- **ADR-001**: API Versioning Policy (v1 additive; v2 for breaking changes).
- **ADR-002**: Auth Tokens & Rotation Strategy.
- **ADR-003**: Data Retention & GDPR Backup Purge Window.
- **ADR-004**: Media Upload Safety & AV Scanning.
- **ADR-005**: Partitioning Strategy for `sessions` and `audit_log`.
- **ADR-006**: Observability Cardinality Policy.
- **ADR-007**: Idempotency Policy for Writes
- **ADR-008**: Materialized Views for Analytics
- **ADR-009**: Global Exercise Library Ownership Model
- **ADR-010**: Public/Link/Private Visibility Model
- **ADR-011**: Internationalization – Hybrid Model with MVP Static-Only Rollout
- **ADR-012**: Monorepo Structure, Tooling, and Governance
- **ADR-013**: Modular Backend Architecture (Router → Service → Repository)
- **ADR-014**: Technology Stack & Runtime Standards
- **ADR-015**: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged
- **ADR-016**: Security Middleware & Audit Logging
- **ADR-017**: Avatar Handling & Media Storage (Object Storage + AV Scan)
- **ADR-018**: CI/CD with GitHub Actions and GHCR
- **ADR-019**: Caching & Performance Strategy
- **ADR-020**: Accessibility Compliance (WCAG 2.1 AA) & Inclusive UX
- **ADR-021**: Standardize Backend Test Runner on Jest 30 + @swc/jest

---

**Maintenance**: Update this register at the end of each sprint/release. Risks that require structural changes must reference an ADR and update PRD/QA acceptance where applicable.

---

# 15. ADR Index & References

This section catalogs the **Architecture Decision Records (ADRs)** that govern FitVibe's design and implementation, and provides a consolidated **reference list** to source documents. Every material change to architecture, data, security, or contracts must be captured by an ADR and cross-linked from the PRD, TDD, and QA Plan (traceability).

---

## 15.1 ADR Process

- **Format**: MADR style (lightweight Markdown). One decision per file.
- **Location**: `docs/adr/ADR-XXX-title.md` (three-digit, zero-padded index).
- **Status lifecycle**: `Proposed → Accepted → Superseded → Deprecated`.
- **Change control**: Any PR touching §5 (security), §6 (data), §7 (API), or §9 (NFRs) must reference an **ADR** (new or existing).
- **Linking**: Each ADR must link the affected sections: PRD §_, TDD §_, QA §\*, and list impacted tests/gates.
- **Decision date**: UTC date in header.
- **Rationale & consequences**: mandatory; list alternatives considered.
- **Supersession**: if an ADR replaces another, set `Supersedes:`/`Superseded by:` headers.

All ADR IDs must **match the filename** under `docs/adr/` and every accepted ADR must link back to the exact sections it changes (PRD/TDD/QA).

### 15.1.1 ADR Template (copy/paste)

```markdown
---
id: ADR-XXX
title: "<Short, imperative decision>"
status: "Proposed | Accepted | Superseded | Deprecated"
date: "YYYY-MM-DD"
supersedes: "ADR-YYY (optional)"
superseded_by: "ADR-ZZZ (optional)"
owners: ["Konstantinos Pilpilidis (Dr.)"]
links:
  - PRD: "docs/1. Product Requirements Document.md#<section>"
  - TDD: "docs/2. Technical Design Document.md#<section>"
  - QA: "docs/3. Testing and Quality Assurance Plan.md#<section>"
---

## Context

<Problem statement, constraints, drivers, stakeholders>

## Decision

<What is decided; include exact contracts/values if applicable>

## Status & Consequences

<Operational, security, cost, and team impact; migration plan if any>

## Alternatives Considered

- Alternative A : pros/cons
- Alternative B : pros/cons

## Implementation Notes

<Follow-up tasks, feature flags, rollout, telemetry/alerting>

## Backout Plan

<Rollback steps or superseding ADR plan>
```

---

## 15.2 ADR Index (Planned & Suggested)

> Populate as decisions are made. The IDs and titles below reflect items already implied by the TDD/PRD/QA and should be created early.

| ID      | Title                                                                                    | Status      | Summary                                                                                                                                              | Decision Date | Links                                                         |
| ------- | ---------------------------------------------------------------------------------------- | ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- | ------------------------------------------------------------- |
| ADR-001 | API Versioning Policy (v1 additive; v2 for breaking changes)                             | ✅ Accepted | `/api/v1` is stable; additive fields only; deprecations use `Deprecation/Sunset` headers; breaking changes land in `/api/v2` with 2-release overlap. | 2025-10-13    | TDD §7.1.4, §7.1.1                                            |
| ADR-002 | Auth Tokens & Rotation Strategy                                                          | ✅ Accepted | RS256 JWT with 15m access, 14d refresh; refresh rotation + reuse detection; JWKS-based key rotation.                                                 | 2025-10-13    | TDD §5.1.1, §12.4                                             |
| ADR-003 | Data Retention & GDPR Backup Purge Window                                                | ✅ Accepted | Classification table; DSR delete hard-deletes private content and purges backups ≤14 days; audit trail.                                              | 2025-10-13    | TDD §6.6, §12.6                                               |
| ADR-004 | Media Upload Safety & AV Scanning                                                        | ✅ Accepted | AV scan before persistence; allow-list MIME; EXIF strip; quarantine on suspect/malware; alerting.                                                    | 2025-10-13    | TDD §5.1.6, §12.10                                            |
| ADR-005 | Partitioning Strategy for `sessions` (monthly)                                           | ✅ Accepted | Range partition on `planned_at` with default partition; rotate & archive after 24 months.                                                            | 2025-10-13    | TDD §6.4, §12.9                                               |
| ADR-006 | Observability Cardinality Policy                                                         | ✅ Accepted | Route templates in labels, bounded label sets, no PII; alerts on series count growth.                                                                | 2025-10-13    | TDD §5.4                                                      |
| ADR-007 | Idempotency Policy for Writes                                                            | ✅ Accepted | `Idempotency-Key` header; 24h storage; 409 on payload mismatch; deterministic replay.                                                                | 2025-10-13    | TDD §5.7, §7.14                                               |
| ADR-008 | Materialized Views for Analytics                                                         | ✅ Accepted | Use matviews for `session_summary`, `weekly_aggregates`; incremental refresh on writes + scheduled.                                                  | 2025-10-13    | TDD §4.5, §6.3                                                |
| ADR-009 | Global Exercise Library Ownership Model                                                  | ✅ Accepted | Admin-owned global records (`owner_id = NULL`); user-owned duplicates allowed via normalized uniqueness.                                             | 2025-10-13    | TDD §4.3, §6.2.6                                              |
| ADR-010 | Public/Link/Private Visibility Model                                                     | ✅ Accepted | Resource visibility enum with default **private**; link tokens revocable; public feed feature-flagged.                                               | 2025-10-13    | TDD §4.7, §7.8                                                |
| ADR-011 | Internationalization – Hybrid Model with MVP Static-Only Rollout                         | ✅ Accepted | Static UI catalogs (EN/DE) for MVP; feature-flagged AI translation for UGC with caching, PII redaction, and DSR purge.                               | 2025-10-14    | [ADR-011](./ADR-011-internationalization-hybrid-approach.md)  |
| ADR-012 | Monorepo Structure, Tooling, and Governance                                              | ✅ Accepted | pnpm workspaces + optional Turbo; Dockerized CI; governance via CODEOWNERS, changesets, and feature flags.                                           | 2025-10-14    | [ADR-012](./ADR-012-monorepo-structure.md)                    |
| ADR-013 | Modular Backend Architecture (Router → Service → Repository)                             | ✅ Accepted | Three-layer modules (router/service/repo); strict authz, audit, caching seams; Knex migrations.                                                      | 2025-10-14    | [ADR-013](./ADR-013-modular-backend-architecture.md)          |
| ADR-014 | Technology Stack & Runtime Standards                                                     | ✅ Accepted | Node/Express, React/Vite, Postgres + Knex, object storage for media, strong headers/CSRF/RBAC; OpenAPI in CI.                                        | 2025-10-14    | [ADR-014](./ADR-014-technology-stack.md)                      |
| ADR-015 | API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged | ✅ Accepted | REST/JSON `/v1`, RFC7807 errors, idempotency, cursor pagination; i18n hybrid at API with feature flag.                                               | 2025-10-14    | [ADR-015](./ADR-015-api-design-and-i18n-hybrid.md)            |
| ADR-016 | Security Middleware & Audit Logging                                                      | ✅ Accepted | CSP/HSTS/Referrer/Permissions, CSRF, RBAC; PII-free audit logs with correlation IDs and tamper-evidence.                                             | 2025-10-14    | [ADR-016](./ADR-016-audit-logging-and-security-middleware.md) |
| ADR-017 | Avatar Handling & Media Storage (Object Storage + AV Scan)                               | ✅ Accepted | Server-mediated uploads; AV scan; EXIF strip; derivatives; signed URLs; private-by-default.                                                          | 2025-10-14    | [ADR-017](./ADR-017-avatar-handling-base64.md)                |
| ADR-018 | CI/CD with GitHub Actions and GHCR                                                       | ✅ Accepted | GitHub Actions with quality gates; GHCR images with SBOM/provenance; OIDC, signed releases, manual prod gate.                                        | 2025-10-14    | [ADR-018](./ADR-018-ci-cd-github-ghcr.md)                     |
| ADR-019 | Caching & Performance Strategy                                                           | ✅ Accepted | Layered caching with explicit invalidation; API p95 < 300 ms; LCP < 2.5 s; fail on >10% regression.                                                  | 2025-10-14    | [ADR-019](./ADR-019-caching-and-performance-strategy.md)      |
| ADR-020 | Accessibility Compliance (WCAG 2.1 AA) & Inclusive UX                                    | ✅ Accepted | Semantics-first components, keyboard flows, contrast, alt text; Lighthouse/axe in CI with ≥90 score.                                                 | 2025-10-14    | [ADR-020](./ADR-020-accessibility-compliance.md)              |
| ADR-021 | Standardize Backend Test Runner on Jest 30 + @swc/jest                                   | ✅ Accepted | Adopt _Jest 30_ with _@swc/jest_ for the backend test runner (unit + integration with Supertest), replacing ts-jest.                                 | 2025-10-14    | [ADR-021](./ADR-021-test-runner-backend-jest30-sw.md)         |

> When an ADR is **Accepted**, update the `Status` column and add its file path in the Links cell (e.g., `docs/adr/ADR-001-api-versioning.md`).

---

## 15.3 Reference Documents (Repository Canon)

| Doc                                         | Purpose                                  | Path                                            |
| ------------------------------------------- | ---------------------------------------- | ----------------------------------------------- |
| **PRD** â€” Product Requirements Document   | WHAT & WHY                               | `docs/1. Product Requirements Document.md`      |
| **TDD** â€” Technical Design Document       | HOW (architecture, data, APIs)           | `docs/2. Technical Design Document.md`          |
| **QA Plan** â€” Testing & Quality Assurance | HOW WELL (tests, gates, RTM)             | `docs/3. Testing and Quality Assurance Plan.md` |
| **SECURITY** â€” Security & Privacy Policy  | Normative security posture, GDPR anchors | `docs/SECURITY.md` (planned)                    |
| **Tasks.md / Roadmap**                      | Delivery planning, milestones            | `docs/Tasks.md`                                 |
| **Changelog**                               | User-visible changes per release         | `CHANGELOG.md`                                  |
| **Contributing**                            | Repo standards, coding guide             | `CONTRIBUTING.md`                               |

---

## 15.4 How to Add a New ADR (Checklist)

1. **Create file** `docs/adr/ADR-XYZ-title.md` from the template in §15.1.1.
2. Fill **Context → Decision → Consequences → Alternatives**.
3. Cross-link affected sections in PRD/TDD/QA.
4. Add to table in §15.2 with `Proposed` status.
5. Submit PR; on approval, set status to `Accepted` and add decision date.
6. If superseding a prior ADR, update both records' headers accordingly.
7. Ensure related **tests/gates** are updated (coverage, perf, a11y, security).

---

## 15.5 Governance & Review Cadence

- **Owner** approves ADRs; complex ones can include an optional design review meeting.
- ADRs that impact external contracts (APIs, data retention, privacy) require **explicit mention** in the release notes.
- Conduct a **quarterly sweep** to retire deprecated ADRs and confirm no drift between ADRs and implementation.

---

**Outcome**: With ADRs rigorously maintained and referenced here, architectural intent stays **explicit, auditable, and synchronized** with the PRD, TDD, and QA Plan.

---

# Appendix A Metrics Catalog

This catalog defines **Prometheus-compatible** metrics, their **types**, **labels**, and **alert hooks**. Labels are **bounded** and PII-free.

## A.1 HTTP/API Metrics

| Name                            | Type      | Labels                    | Description                       | Alert/Threshold        |
| ------------------------------- | --------- | ------------------------- | --------------------------------- | ---------------------- |
| `http_requests_total`           | counter   | `method`,`route`,`status` | Request count by normalized route | Anomaly detection only |
| `http_request_duration_seconds` | histogram | `method`,`route`,`status` | Request latency buckets           | p95 > 0.3s for 15m     |
| `http_response_size_bytes`      | histogram | `route`,`status`          | Response size distribution        | >1MB responses flagged |

## A.2 DB & Jobs

| Name                              | Type      | Labels         | Description        | Alert/Threshold    |
| --------------------------------- | --------- | -------------- | ------------------ | ------------------ |
| `db_query_duration_seconds`       | histogram | `op`,`table`   | DB query latency   | p95 > 0.2s         |
| `db_pool_in_use`                  | gauge     | `pool`         | Active connections | >80% for 10m       |
| `background_job_duration_seconds` | histogram | `job`          | Job runtime        | p95 > (job budget) |
| `background_job_failures_total`   | counter   | `job`,`reason` | Job failures       | Sudden spikes      |

## A.3 Security & Abuse

| Name                      | Type    | Labels   | Description            | Alert/Threshold         |
| ------------------------- | ------- | -------- | ---------------------- | ----------------------- |
| `auth_lockouts_total`     | counter | `reason` | Account lockouts       | Spike vs baseline       |
| `rate_limit_events_total` | counter | `bucket` | Rate limit hits        | Spike vs baseline       |
| `jwt_refresh_reuse_total` | counter | â€”      | Detected refresh reuse | Any > 0 warrants triage |

## A.4 Media & AV

| Name                      | Type    | Labels   | Description        | Alert/Threshold       |
| ------------------------- | ------- | -------- | ------------------ | --------------------- |
| `uploads_total`           | counter | `kind`   | Successful uploads | â€”                   |
| `av_scan_failures_total`  | counter | `reason` | AV failures        | Spike vs baseline     |
| `upload_quarantine_total` | counter | `reason` | Files quarantined  | Any persistent growth |

## A.5 Analytics & Business

| Name                   | Type    | Labels | Description    | Alert/Threshold |
| ---------------------- | ------- | ------ | -------------- | --------------- |
| `points_awarded_total` | counter | `rule` | Points issued  | Anomaly spike   |
| `badges_awarded_total` | counter | `code` | Badges granted | Anomaly spike   |

## A.6 Web Vitals (RUM, non-PII)

| Name                     | Type      | Labels   | Description              | Alert/Threshold |
| ------------------------ | --------- | -------- | ------------------------ | --------------- |
| `web_vitals_lcp_seconds` | histogram | `device` | Largest Contentful Paint | P75 > 2.5s      |
| `web_vitals_cls`         | histogram | `device` | Cumulative Layout Shift  | P75 > 0.1       |
| `web_vitals_tbt_ms`      | histogram | `device` | Total Blocking Time      | P75 > 200ms     |

## A.7 Cardinality Guardrails

- Label allow-list only; **no user IDs**.
- Use **route templates** (`/sessions/:id`).
- Drop labels with >100 unique values/min across a 10m window.

# Appendix B Error Code Registry

Stable `error.code` → HTTP mapping with user-facing guidance. Messages are localized on the client.

| Code                             | HTTP    | Scope     | Example Message             | Remediation / Notes                     |
| -------------------------------- | ------- | --------- | --------------------------- | --------------------------------------- |
| `E.AUTH.INVALID_CREDENTIALS`     | 401     | Auth      | Wrong email or password     | Retry; lockout after N attempts         |
| `E.AUTH.TOTP_REQUIRED`           | 401     | Auth      | Two-factor code required    | Provide OTP or disable 2FA with backup  |
| `E.AUTH.TOKEN_EXPIRED`           | 401     | Auth      | Token expired               | Login again or refresh                  |
| `E.AUTH.LOCKED`                  | 423     | Auth      | Account temporarily locked  | Wait cooldown; reset password if needed |
| `E.AUTH.RATE_LIMITED`            | 429     | Auth      | Too many attempts           | Respect `Retry-After`                   |
| `E.USER.ALIAS_TAKEN`             | 409     | Users     | Alias already in use        | Choose a different alias                |
| `E.USER.VISIBILITY_FORBIDDEN`    | 403     | Users     | Private field               | Adjust visibility or permissions        |
| `E.USER.AVATAR_INVALID`          | 422     | Users     | Invalid avatar upload       | Check type/size; reupload               |
| `E.EXERCISE.DUPLICATE`           | 409     | Exercises | Duplicate name              | Rename or use existing                  |
| `E.EXERCISE.FORBIDDEN`           | 403     | Exercises | Not owner/admin             | Check permissions                       |
| `E.EXERCISE.NOT_FOUND`           | 404     | Exercises | Not found                   | Verify ID                               |
| `E.SESSION.INVALID_SET`          | 422     | Sessions  | Invalid set values          | Fix non-negative constraints            |
| `E.SESSION.CONFLICT`             | 409     | Sessions  | Edit conflict               | Refresh and retry                       |
| `E.SESSION.IDEMPOTENT_REPLAY`    | 409     | Sessions  | Duplicate request           | Treat response as success               |
| `E.ANALYTICS.RANGE_TOO_LARGE`    | 413     | Analytics | Date window too large       | Narrow range                            |
| `E.ANALYTICS.UNSUPPORTED_GRAIN`  | 422     | Analytics | Bad `grain`                 | Use day/week/month                      |
| `E.MEDIA.MALWARE`                | 422     | Media     | Failed AV scan              | Use clean file                          |
| `E.FEED.NOT_PUBLIC`              | 403     | Feed      | Not public                  | Change visibility                       |
| `E.FEED.TOKEN_INVALID`           | 401/404 | Feed      | Invalid/expired link        | Request new link                        |
| `E.API.UNKNOWN_FILTER`           | 422     | API       | Unknown filter              | Use allow-list filters                  |
| `E.IDEMPOTENCY.PAYLOAD_MISMATCH` | 409     | API       | Same key, different payload | Use a new key                           |

> The canonical list is unit-tested; additions require review to avoid drift.

---

# Appendix C API Summary Tables

Quick reference to major endpoints (full contracts in **TDD §7**).

## C.1 Auth

| M    | Path                      | Auth    | Notes                |
| ---- | ------------------------- | ------- | -------------------- |
| POST | `/auth/register`          | anon    | Create account       |
| GET  | `/auth/verify`            | anon    | Verify email         |
| POST | `/auth/login`             | anon    | Issue tokens         |
| POST | `/auth/refresh`           | refresh | Rotate refresh       |
| POST | `/auth/logout`            | access  | Invalidate session   |
| POST | `/auth/password/reset`    | anon    | Request reset        |
| POST | `/auth/password/complete` | anon    | Complete reset       |
| POST | `/auth/2fa/*`             | access  | Setup/verify/disable |

## C.2 Users & Profile

| M      | Path               | Auth     | Notes          |
| ------ | ------------------ | -------- | -------------- |
| GET    | `/users/me`        | access   | Own profile    |
| PATCH  | `/users/me`        | access   | Update profile |
| DELETE | `/users/me`        | access   | DSR delete     |
| PUT    | `/users/me/avatar` | access   | Upload avatar  |
| GET    | `/users/:alias`    | optional | Public profile |

## C.3 Exercises

| M      | Path                   | Auth          | Notes                     |
| ------ | ---------------------- | ------------- | ------------------------- |
| GET    | `/exercises`           | access        | Search/list               |
| POST   | `/exercises`           | access        | Create                    |
| GET    | `/exercises/:id`       | access        | Read                      |
| PATCH  | `/exercises/:id`       | access        | Update                    |
| DELETE | `/exercises/:id`       | access        | Archive/delete            |
| GET    | `/exercises/global`    | access        | Global list (admin-owned) |
| POST   | `/admin/exercises`     | access(admin) | Create global             |
| PATCH  | `/admin/exercises/:id` | access(admin) | Update global             |

## C.4 Sessions

| M      | Path                     | Auth   | Notes         |
| ------ | ------------------------ | ------ | ------------- |
| GET    | `/sessions`              | access | Range filters |
| POST   | `/sessions`              | access | Create nested |
| GET    | `/sessions/:id`          | access | Read          |
| PATCH  | `/sessions/:id`          | access | Update        |
| POST   | `/sessions/:id/complete` | access | Complete      |
| POST   | `/sessions/:id/clone`    | access | Clone         |
| DELETE | `/sessions/:id`          | access | Soft-delete   |

## C.5 Analytics

| M   | Path                 | Auth   | Notes             |
| --- | -------------------- | ------ | ----------------- |
| GET | `/analytics/summary` | access | Range+grain       |
| GET | `/analytics/prs`     | access | PRs               |
| GET | `/analytics/weekly`  | access | Weekly aggregates |

## C.6 Points & Badges

| M    | Path                    | Auth          | Notes          |
| ---- | ----------------------- | ------------- | -------------- |
| GET  | `/points`               | access        | Balance+events |
| GET  | `/badges`               | access        | Owned badges   |
| GET  | `/badges/catalog`       | access        | Catalog        |
| POST | `/admin/points/correct` | access(admin) | Correction     |

## C.7 Feed & Media

| M      | Path                          | Auth     | Notes            |
| ------ | ----------------------------- | -------- | ---------------- |
| GET    | `/feed`                       | optional | Public timeline  |
| POST   | `/feed/session/:id/publish`   | access   | Publish          |
| POST   | `/feed/session/:id/unpublish` | access   | Unpublish        |
| POST   | `/feed/item/:id/link`         | access   | Create link      |
| DELETE | `/feed/item/:id/link`         | access   | Revoke link      |
| GET    | `/feed/link/:token`           | anon     | View by token    |
| POST   | `/media`                      | access   | Upload (AV scan) |
| GET    | `/media/:id`                  | access   | Read (signed)    |
| DELETE | `/media/:id`                  | access   | Delete           |

## C.8 Admin & Ops

| M    | Path                    | Auth          | Notes              |
| ---- | ----------------------- | ------------- | ------------------ |
| GET  | `/admin/audit`          | access(admin) | Filterable         |
| POST | `/admin/users/:id/role` | access(admin) | Assign role        |
| GET  | `/admin/health`         | access(admin) | Health/migrations  |
| GET  | `/health/*`             | anon          | Liveness/readiness |
| GET  | `/metrics`              | restricted    | Prometheus         |

---

# Appendix D Data Classification Matrix

Field/table-level classification, lawful basis, retention, and handling. Classes: **PII-S** (Sensitive), **PII-B** (Basic), **Usage**, **Public**.

| Table.Field                       | Class        | Lawful Basis                   | Retention (Default)      | Access Scope               | Handling Notes              |
| --------------------------------- | ------------ | ------------------------------ | ------------------------ | -------------------------- | --------------------------- |
| users.email                       | PII-S        | Contract                       | Lifetime (acct)          | User/Admin                 | citext unique; never logged |
| users.alias                       | PII-B        | Contract                       | Lifetime                 | Public (if profile public) | case-insensitive unique     |
| users.password_hash               | PII-S        | Contract                       | Lifetime                 | None                       | bcryptjs; never exported    |
| users.locale                      | PII-B        | Legitimate interest            | Lifetime                 | User/Admin                 | defaults to 'en'            |
| profiles.avatar_asset_id          | PII-B        | Consent                        | Lifetime                 | User/Admin                 | image; AV scan              |
| user_sessions.ip                  | PII-S        | Legitimate interest (security) | 90d active + 30d revoked | Admin                      | inet; masked in UI          |
| verification_tokens.token         | PII-S        | Contract                       | TTL (15-60m)             | System                     | one-time; auto-purge        |
| exercises.\* (user-owned)         | Usage/PII-B  | Contract                       | Lifetime of user         | User                       | hard-delete on DSR          |
| exercises.\* (global)             | Public/Admin | Legitimate interest            | N/A                      | Admin                      | archive only                |
| sessions.\*                       | Usage        | Contract                       | Lifetime of user         | User                       | may include sensitive notes |
| exercise_sets.weight_kg/reps/etc. | Usage        | Contract                       | Lifetime of user         | User                       | validate non-negative       |
| points_events.\*                  | Usage        | Contract                       | Lifetime of user         | User/Admin                 | idempotent ledger           |
| badges/badge_awards.\*            | Usage        | Contract                       | Lifetime of user         | User/Admin                 | criteria snapshot           |
| feed_items.visibility=public      | Public       | Consent                        | Until unpublish          | Anyone                     | purge caches on delete      |
| media_assets.mime/size/av_scan    | PII-B        | Legitimate interest            | Lifetime                 | User/Admin                 | allow-list; quarantine      |
| audit_log.user_id                 | PII-S        | Legitimate interest            | 180 days                 | Admin                      | anonymize on DSR            |
| idempotency_keys.\*               | Usage        | Legitimate interest            | 24h                      | System                     | auto-purge                  |

**Encryption & Transport**: TLS everywhere; at-rest encryption as provided by infrastructure. No PII in logs/metrics labels.

---

# Appendix E Full Migration Order List

Authoritative, **ordered** migrations for MVP (expand/contract pattern). Replace timestamps with actual generation time on creation.

| #   | Filename                                          | Purpose / Objects                                                       |
| --- | ------------------------------------------------- | ----------------------------------------------------------------------- |
| 1   | `202510130900__create_extensions_citext_uuid.sql` | Enable `citext`, `uuid-ossp`/`pgcrypto` if needed                       |
| 2   | `202510130905__roles_and_users.sql`               | `roles`, `users`, `user_roles`, `profiles`, `user_sessions`             |
| 3   | `202510130910__tokens_verify_reset.sql`           | `verification_tokens`, `reset_tokens` or `user_tokens` with type        |
| 4   | `202510130915__exercise_categories_tags.sql`      | `exercise_categories`, `tags`                                           |
| 5   | `202510130920__exercises.sql`                     | `exercises` + constraints (global vs user-owned), trigram & GIN indexes |
| 6   | `202510130925__sessions_core.sql`                 | `sessions` (monthly partitioned), base indexes                          |
| 7   | `202510130930__sessions_details.sql`              | `session_exercises`, `exercise_sets`                                    |
| 8   | `202510130935__points_and_badges.sql`             | `points_events`, `badges`, `badge_awards`                               |
| 9   | `202510130940__feed_and_media.sql`                | `feed_items`, `media_assets`                                            |
| 10  | `202510130945__idempotency_and_audit.sql`         | `idempotency_keys`, `audit_log`                                         |
| 11  | `202510130950__indexes_views.sql`                 | Additional hot indexes; `session_summary` (matview); refresh function   |
| 12  | `202510130955__constraints_fkeys_check.sql`       | Late check constraints/fkeys not covered earlier                        |
| 13  | `202510131000__seed_categories_badges.sql`        | Seed global categories & starter badges (idempotent)                    |

**Notes**

- Wrap DDL in transactions when supported.
- Late constraints (step 12) allow backfilling before tightening.
- Seeds are safe to re-run and contain **no PII**.
