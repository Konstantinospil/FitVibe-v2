---
title: "FitVibe Technical Design Document (TDD): Modules"
version: "v2.0"
status: "Accepted"
owner: "Konstantinos Pilpilidis (Dr.)"
date: "2025-10-21"
links:
  - PRD: docs/1.Product_Requirements_Document.md
  - QA: docs/3.Testing_and_Quality_Assurance_Plan.md
  - ADR Index: docs/adr/README.md
license: "MIT"
---

# 0. Introduction

## 0.1 Purpose & Scope

This TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).

## 0.2 Audience & Reading Guide

- **Engineers** implement according to specs, contracts, and runbooks.
- **QA** uses RTM links to derive tests and quality gates.
- **Security/Compliance** verifies controls, data classification, GDPR flows.
- **Product/Design** confirms that behavior matches PRD intent.

## 0.3 Assumptions & Constraints

- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL ≥ 14 (target 16-18 locally).
- All external calls (email) are **adapterized** and mockable for tests.
- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.
- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.

## 0.4 Versioning & Changelog

- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.

---

# 4. Feature Modules (per Functional Requirement)

> This section specifies module responsibilities, state models, input/output contracts, permissions, error cases, non-goals, and test hooks. Detailed API paths and DTOs are listed in §7 (API Design) and the database design in §6 (Data Design).

## 4.0 Conventions for Module Specs

- **Roles:** `anonymous`, `user`, `admin`.
- **Identifiers:** UUIDv7/ULID, immutable.
- **Timestamps:** UTC, RFC 3339 strings in APIs.
- **Idempotency:** State-changing endpoints accept `Idempotency-Key` (store for 24h).
- **Rate limits:** Per-IP and per-account; auth flows stricter.
- **Privacy default:** All user-created content is **private** unless explicitly published/shared.
- **Error envelope:** `{ "error": { "code", "message", "details", "requestId" } }`.

---

## 4.1 Authentication & Authorization (FR-1)

### 4.1.1 Responsibilities

- Account lifecycle: register → email verify → login → refresh rotation → logout.
- Password reset (request + complete).
- Optional 2FA (TOTP) with backup codes; feature flag controllable.
- Session management (revoke all / device-level).
- Lockout & brute-force protection; no user enumeration.
- RBAC: role assignment (`user`, `admin`).

### 4.1.2 States & Flows

See also [State flows](./diagrams/tdd-4-1-2-states-flows.mmd).

- **Sessions:** Short-lived access token; long-lived refresh token bound to a session id; rotation on refresh; stolen-token detection (rotate-with-reused refresh → revoke session family).

### 4.1.3 Inputs/Outputs (high-level)

- **Register:** `email`, `password`, `alias` (unique, case-insensitive), optional locale.
- **Verify:** `token` (email link) within TTL.
- **Login:** `email`+`password` (+`otp` if 2FA enabled) → `{accessToken, refreshToken}`.
- **Refresh:** `refreshToken` → new `{accessToken, refreshToken}`.
- **Password reset:** request with `email`; complete with `token` + `newPassword`.

### 4.1.4 Permissions & Policies

- **Anonymous:** register, login, password-reset request, verify.
- **User:** refresh, logout, 2FA setup/disable (with password confirmation), revoke sessions.
- **Admin:** manage roles; access global audit (no content peeking without lawful basis).

### 4.1.5 Security Controls

- RS256 JWT; key rotation via JWKS; leeway ≤ 60s;
- Lockout progressive backoff; event-based alerts for brute force;
- CSRF not applicable to pure token APIs; if cookies used, enforce same-site + CSRF token;
- Strict headers via edge; CORS allow-list;
- No user enumeration: identical messages for existent/non-existent emails;
- Password policy: minimum 12 characters and must include uppercase, lowercase, number, and symbol. Enforced at `/auth/register` and `/auth/password/reset`; violations return explicit validation errors (400) and QA tests cover both endpoints;
- Verification tokens TTL = 15 minutes;
- Reset tokens TTL = 15 minutes;
- Verification email resend ≤ 3/hour;
- unverified accounts auto-purged after 7 days;
- **Logout invalidation:** logging out **revokes the active refresh session family** (all tokens bound to its `jti`).

### 4.1.6 Error Codes (sample)

- `E.AUTH.INVALID_CREDENTIALS` (401), `E.AUTH.LOCKED` (423), `E.AUTH.TOTP_REQUIRED` (401), `E.AUTH.TOKEN_EXPIRED` (401), `E.AUTH.IDEMPOTENT_REPLAY` (409).

### 4.1.7 Non-goals (MVP)

- Social login (OAuth), WebAuthn, SSO;

### 4.1.8 Test Hooks

- Seeded test users; mail adapter in test mode; clock freeze for token TTL; brute-force simulation; TOTP deterministic secret in test env.

---

## 4.2 Users & Profile (FR-2)

### 4.2.1 Responsibilities

- Manage user profile:
  - display name,
  - alias,
  - bio,
  - locale,
  - avatar,
  - weight
  - fitness level
  - training frequency
  - privacy toggles
- **Alias** uniqueness (case-insensitive via `citext`), URL-safe.
- Avatar upload with AV scan; automatic resizing on FE/CDN. generate a 128×128 avatar derivative (preview).
- Privacy defaults and visibility toggles (e.g., hide age/weight).
- Audit of profile changes (immutable historical log).

### 4.2.2 State Model

- `ACTIVE` | `DEACTIVATED` | `DELETED(PENDING_PURGE)`.
- Profile fields categorized: **public**, **followers**, **private**; default = **private**.

### 4.2.3 Inputs/Outputs

- **Update profile:** partial DTO; server validates lengths/formats; alias change rate-limited (e.g., 1/30d).
- **Get profile:** own profile (full), others' profile (respecting visibility).

### 4.2.4 Permissions

- **User:** read/write own profile; delete account (DSR flow triggers).
- **Admin:** read minimal metadata for moderation; cannot bypass DSR rules.

### 4.2.5 Constraints

- Unique `(LOWER(alias))`; max 32 chars; reserved names blocked.
- Avatar: max size (e.g., 5MB), image-only MIME, AV scan required; **128×128 derivative** stored for previews.
- Immutability: `date_of_birth` and `gender` are immutable after first set (enforced by trigger).
- **Enumerations:**
  - `gender ∈ {man, woman, diverse, prefer_not_to_say}`
  - `fitnessLevel ∈ {beginner, intermediate, advanced, elite}`
  - `trainingFrequency ∈ {rarely, 1_2_per_week, 3_4_per_week, 5_plus_per_week}`
  - `weightUnit ∈ {kg, lb}`
- **Validation & Storage:**
  - `weight` accepted as user input with `weightUnit`; internally stored as **kg** (`weight_kg`), UI converts for display.
  - Acceptable `weight` range (kg-equivalent): **20–400**.

### 4.2.6 Error Codes

- `E.USER.ALIAS_TAKEN` (409), `E.USER.AVATAR_INVALID` (422), `E.USER.VISIBILITY_FORBIDDEN` (403).

### 4.2.7 Non-goals

- Messaging (DMs).

### 4.2.8 Test Hooks

- Fixtures for alias collision; image EICAR string to test AV rejection; visibility matrix tests.

---

## 4.3 Exercise Library (FR-3)

### 4.3.1 Responsibilities

- CRUD for **exercises** (name, category, primary muscles, equipment, instructions).
- Ownership model: **user-owned** and **admin-owned global** exercises.
- Tagging & search (text + filters: category, equipment, muscles).
- Versioning optional: semantic revs for instructions changes (keeps history).

### 4.3.2 State Model

- `DRAFT` → `PUBLISHED` → `ARCHIVED`. Admins may delete global exercises when required (policy/ToS breach);
- Default action is archive. Deletion requires safety checks (no dangling FKs) and audit log.

### 4.3.3 Inputs/Outputs

- **Create/Update:** name (i18n token or plain), category (FK), fields; server normalizes and dedupes by normalized key.
- **Search:** `q`, `category`, `equipment`, `primary_muscle`, `tags`, pagination.

### 4.3.4 Permissions

- **User:** full CRUD on own exercises; read global; propose changes to global (admin review, Phase 2).
- **Admin:** CRUD on global exercises; moderation queue.

### 4.3.5 Constraints & Indexing

- Unique `(owner_id, normalized_name)` for user-owned; unique `(normalized_name)` for global.
- GIN index on tags; trigram/text index on `name_normalized`.

### 4.3.6 Error Codes

- `E.EXERCISE.DUPLICATE` (409), `E.EXERCISE.FORBIDDEN` (403), `E.EXERCISE.NOT_FOUND` (404).

### 4.3.7 Non-goals

- Community ratings/reviews (Phase 2+).

### 4.3.8 Test Hooks

- Seed minimal global categories; search relevance snapshots; archive visibility tests.

---

## 4.4 Planning & Sessions (FR-4)

### 4.4.1 Responsibilities

- Plan and log **training sessions** with structured **session_exercises** and **sets**.
- Distinguish **planned** vs **actual**; allow editing with audit trail.
- Recurrence templates (weekly/bi-weekly);
- Track plan completion progress (sessions completed vs planned).
- Allow cloning plans between users (with attribution).
- Associate sessions with their source plan (optional relationship).
- Quick-add from library.
- Idempotent creation to avoid duplicates on flaky networks.
- Deletion policy: user-initiated deletes are **soft-deletes (archive)** for historical traceability.

### 4.4.2 Data & State

- Session: `DRAFT` | `ACTIVE` | `COMPLETED` | `ARCHIVED`.
- Set: repetitions/weight/time/distance/RPE; optional notes; order preserved.
- Time fields: `starts_at`, `ends_at`, `duration_sec` (derived).
- Plans contain metadata: title, description, duration (weeks), target frequency
- Plans reference exercise templates but not specific dates (sessions materialize from plans)
- **Privacy default:** sessions are **private** by default. Toggling to public is **non-retroactive** and never exposes previously private data.

### 4.4.3 Inputs/Outputs

- **Create/Update session:** DTO with metadata + nested exercises/sets.
- **Complete session:** set status + fill actual metrics; partial completion allowed.
- **Clone/Template:** source session id → new planned session (date offset).
- **Create plan**: `{ title, description, duration_weeks, target_frequency, template_sessions: [...] }`
- **Activate plan**: user subscribes; system generates scheduled sessions based on recurrence
- **Track progress**: aggregate `sessions.status` where `session.plan_id = plan.id`

### 4.4.4 Permissions

- **User:** CRUD on own sessions; share-read if explicitly published.
- **Admin:** no access to private content; only moderation metadata.

### 4.4.5 Constraints & Integrity

- `duration_weeks` ∈ [1..52]
- `target_frequency` ∈ [1..7] sessions per week
- Template sessions must have valid exercise references
- Deleting a plan does NOT delete associated completed sessions (historical integrity)
- All nested writes **transactional**; reject partial commits.
- Idempotency via key persisted to `session_write_log` table.
- Validation of set metrics (e.g., no negative reps/weights).

### 4.4.6 Error Codes

- `E.SESSION.CONFLICT` (409),
- `E.SESSION.INVALID_SET` (422),
- `E.SESSION.IDEMPOTENT_REPLAY` (409).
- `E.PLAN.INVALID_DURATION` (422)
- `E.PLAN.FREQUENCY_OUT_OF_RANGE` (422)
- `E.PLAN.NOT_FOUND` (404)
- `E.PLAN.FORBIDDEN` (403)

### 4.4.7 Non-goals

- Real-time collaborative editing (Phase 2+).
- AI-generated plans (Phase 2)
- Adaptive plan adjustments based on performance

### 4.4.8 Test Hooks

- Golden snapshot DTOs; property-based tests for set validators; idempotency replay suite.
- Factory: `makePlan({ ownerId, title, duration_weeks })`
- Activation flow: verify sessions generated correctly
- Progress calculation: deterministic session count

---

## 4.5 Progress & Analytics (FR-5)

### 4.5.1 Responsibilities

- Compute and expose rollups: total volume, estimated 1RM per exercise, weekly mileage, time-in-zone, streaks.
- Provide **materialized views** and cached aggregates; consistency guarantees (eventual within minutes).

### 4.5.2 Data & State

- Views: `session_summary`, `exercise_prs`, `weekly_aggregates`.
- Refresh policy: incremental refresh or scheduled job (e.g., every 5 min; immediate refresh on session completion for own views).

### 4.5.3 Inputs/Outputs

- **Get dashboards:** time range filters; aggregation grain (day/week/month).

### 4.5.4 Permissions

- **User:** read own analytics; share specific charts when session/feed is public.
- **Admin:** no visibility into private user data beyond anonymized metrics.

### 4.5.5 Constraints

- Response size ≤ 1MB; pagination/slicing for long ranges.
- Numerical stability for PRs; documented formulas (appendix).

### 4.5.6 Error Codes

- `E.ANALYTICS.RANGE_TOO_LARGE` (413), `E.ANALYTICS.UNSUPPORTED_GRAIN` (422).

### 4.5.7 Non-goals

- Advanced AI insights; forecasting models (Phase 2+).

### 4.5.8 Test Hooks

- Fixtures with canonical PRs; regression tests for materialized view refresh; perf tests on wide ranges.

---

## 4.6 Points & Badges (FR-6)

### 4.6.1 Responsibilities

- Deterministic rules to award **points** per activity; cumulative **badges** for milestones.
- Prevent abuse (rapid duplicates, backdated floods).
- **Formula inputs (server-side only):** **calories** (if available), **age**, **gender**, **fitness level**, **training frequency**, **RPE**. Clients only see **awarded totals** (not coefficients or weights).

### 4.6.2 State Model

- Event-sourced ledger (`points_events`), derived `points_balance` view.
- Badge acquisition recorded with criteria snapshot (recomputable).

### 4.6.3 Inputs/Outputs

- **Query points/badges:** filters by period and category.
- **Awarding:** occurs on session completion or specific triggers.

### 4.6.4 Permissions

- **User:** read-only; cannot directly modify points.
- **Admin:** can correct with audit reason (rare; via support tooling).

### 4.6.5 Constraints

- Idempotent awarding keyed by `(user_id, source_event_id)`.
- Anti-cheat: rate limit of backfills; anomaly alerts on unusual spikes.

### 4.6.6 Error Codes

- `E.POINTS.DUPLICATE_EVENT` (409), `E.BADGE.ALREADY_GRANTED` (409).

### 4.6.7 Non-goals

- Marketplace or redemption store (Phase 2+).

### 4.6.8 Test Hooks

- Golden rules table; property checks; idempotent replay suite for ledger.

---

## 4.7 Feed, Sharing and social interactions (FR-7)

### 4.7.1 Responsibilities

- Optional **public** or **link-only** sharing of sessions/achievements.
- **Social interactions**: like/unlike; bookmark/unbookmark; **comments CRUD** (non-real-time).
- **Follow/unfollow** users; follower/following counts.
- **Leaderboards**: server-side aggregates (e.g., weekly/monthly points).
- Feed timeline for the user (own items + explicitly followed/public sources in Phase 2).

### 4.7.2 Privacy Model

- Default **private**; user must opt-in per item to publish.
- Share link tokens are unguessable; revokeable; expireable.
- visibility `ENUM('private','link','public')` on `sessions`.
- public items may appear in feed subject to policy.
- No IDOR: every read checks `subject→viewer` relation + visibility. (Extends ADR-010.)
- `DELETED(TOMBSTONE)` for moderation traceability
- **Contract guardrails**:
  - Link access: `GET /sessions/:id?token=...` requires a live token; revoke → `404`.
  - Privacy switch is not retroactive; past unauthorized viewers never gain access. Events:
    - `session.visibility_changed` → invalidates feed/materialized views.
  - Negative tests live in QA (AC-7.1, AC-7.4).

### 4.7.3 Inputs/Outputs

- Feed & Publishing\*\*
  - Publish/unpublish: toggle with visibility scope
  - List feed: paginated; minimal safe fields; no PII by default
- Likes
  - Like: `POST /feed/item/:id/like` (idempotent)
  - Unlike: `DELETE /feed/item/:id/like`
  - Get likes count: included in feed item metadata
- Bookmarks
  - Bookmark session: `POST /sessions/:id/bookmark` (idempotent)
  - Unbookmark: `DELETE /sessions/:id/bookmark`
  - List bookmarks: `GET /users/me/bookmarks`
- Comments
  - List comments: `GET /feed/item/:id/comments` (paginated, public if item is public)
  - Add comment: `POST /feed/item/:id/comments` with `{ body: string }` (idempotent via key)
  - Delete comment: `DELETE /comments/:commentId` (owner or item owner only)
- Comments support: plain text only (MVP), 500 char max, no nested replies
- Follow/Unfollow
  - Follow user: `POST /users/:alias/follow`
  - Unfollow user: `DELETE /users/:alias/follow`
  - Get followers: `GET /users/:alias/followers` (counts + list if permitted)
  - Get following: `GET /users/:alias/following`
- Leaderboards
  - Global/Friends leaderboard: `GET /leaderboards?type={global|friends}&period={week|month}`
  - Returns: `{ rank, user_alias, avatar_url, points, badges_count }`
  - Cached via materialized view; refresh hourly

### 4.7.4 Permissions

- **Anonymous:** view items only if public or link-token provided.
- **User:**
  - view own + subscribed/public
  - can like/bookmark/comment on public items
  - delete own comments
  - Follow/unfollow any public profile
  - Block users (hides their content from feed)
- **Admin**: moderation metadata only; content access via explicit audit

### 4.7.5 Constraints & Safety

- Like/bookmark actions are **idempotent** (repeated calls = 200 OK)
- Comment body: max 500 chars, plain text, no HTML
- Rate limits:
  - Likes/bookmarks: 100 per 5 min per user
  - Comments: 20 per hour per user
  - Follow: 50 per day per user
- Abuse prevention: auto-hide comments with flagged keywords (configurable)
- Takedown workflow: report → review → unpublish/delete

### 4.7.6 Error Codes

- `E.FEED.NOT_PUBLIC` (403),
- `E.FEED.TOKEN_INVALID` (401/404),
- `E.FEED.RATE_LIMITED` (429),
- `E.SOCIAL.ALREADY_LIKED` (409)
- `E.SOCIAL.NOT_LIKED` (404)
- `E.SOCIAL.ALREADY_FOLLOWING` (409)
- `E.SOCIAL.CANNOT_FOLLOW_SELF` (422)
- `E.SOCIAL.COMMENT_TOO_LONG` (422)
- `E.SOCIAL.COMMENT_FORBIDDEN` (403)

### 4.7.7 Non-goals

- Real-time notifications (polling acceptable)
- Hashtags/discovery search
- Nested comment threads
- Emoji reactions (only like)

### 4.7.8 Test Hooks

- Visibility matrix: test all (viewer_role, item_visibility) combinations
- Token lifecycle: create → access → revoke → verify 404
- Idempotency: duplicate like/bookmark calls
- Follow reflexivity: cannot follow self

---

## 4.8 Internationalization (FR-8)

### 4.8.1 Responsibilities

- Provide **static token dictionaries** for EN/DE with CI coverage checks.
- Locale negotiation via `Accept-Language` + user profile; fallback to EN.
- **Out of scope:** Dynamic AI translation of user-generated content.
- Provide **locale hints** in backend responses for dates/number formatting when useful for FE.

### 4.8.2 Data & Caching

- Token catalogs versioned; coverage threshold enforced in CI.

### 4.8.3 Inputs/Outputs

- **Locale negotiation:** `Accept-Language` + user profile setting; fallback to EN.
- **Token delivery:** FE bundles; API returns plain strings + optional i18n keys where relevant to FE rendering.

### 4.8.4 Permissions

- Public data unaffected; user can set preferred locale in profile.

### 4.8.5 Constraints

- All user-facing strings must exist in token catalogs; missing-key detector in CI.

### 4.8.6 Error Codes

- `E.I18N.MISSING_TOKEN` (500 in dev; logged and masked in prod).

### 4.8.7 Non-goals

- Dynamic AI translation of user content.

### 4.8.8 Test Hooks

- Snapshot tests for token coverage; negotiation tests with varied `Accept-Language` headers.

---

## 4.9 Cross-Module Considerations

- **Audit logging:** user-id, session-id, action, target, success/failure, no PII content.
- **Search:** consistent pagination and sorting semantics.
- **Consistency:** eventual for analytics; strong for transactional writes.
- **Feature flags:** 2FA, global exercise moderation queue, feed public discovery.

---

# 5. Cross-Cutting Concerns

This section defines system-wide contracts and guardrails that apply to **every module and endpoint**.

---

## 5.1 Security Architecture

### 5.1.1 Authentication & Tokens

- **Access token**: JWT RS256, short-lived (e.g., 15 min), audience=`fitvibe-api`, issuer=`fitvibe`.
- **Refresh token**: JWT RS256, longer-lived (e.g., 14 d), bound to a **session id** and **client fingerprint** (device hints). Rotated on every refresh.
- **Rotation & Revocation**: reuse-detected refresh invalidates the session family; access tokens are not revoked individuallyâ€”server consults session store for refresh validity.
- **2FA (TOTP)**: optional via feature flag; backup codes stored hashed; rate-limited verification.
- **Key management**: JWKS endpoint (internal); private keys stored via secrets manager; **key rotation** documented in §12 (Runbooks).

### 5.1.2 Authorization & RBAC

- Roles: `anonymous`, `user`, `admin`.
- Resources secured with explicit role checks; `admin` required for global exercise library CRUD and moderation routes.
- Claims: `sub`, `role`, `sid` (session id), `iat`, `exp`.

### 5.1.3 Transport, Sessions & Cookies

- All API traffic via **HTTPS** only;
- HSTS enforced at edge.
- TLS 1.3 with OCSP stapling
- Default is **Authorization: Bearer <JWT>**; if cookies used for web, mark **HttpOnly, Secure, SameSite=Lax/Strict** and use double-submit CSRF token on state-changing requests.

### 5.1.4 CSRF, CORS & Headers

- **CSRF**: not applicable for pure Bearer; cookie mode uses synchronizer token + SameSite.
- **CORS**: explicit allow-list of origins; block wildcard; allow credentials only when necessary.
- **Security Headers** (example NGINX/SaaS edge):
  ```nginx
  add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:; frame-ancestors 'none'; base-uri 'self'" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  ```

### 5.1.5 Rate Limiting & Abuse Controls

- **Global**: per-IP sliding window, e.g., 300 req/5 min.
- **Auth**: stricter, e.g., 10 login attempts/15 min per account + IP; lockout backoff and alert on spikes.
- **Write endpoints**: separate lower thresholds; include `Retry-After` header on 429.
- **Anomaly detection**: flag unusual points or session creation bursts (Points FR-6).

### 5.1.6 Upload Safety

- Allow-list MIME types; max sizes (e.g., 5 MB images).
- **AV scan** (clamd or service) pre-persistence; quarantine on suspicion; hard fail on malware with `E.MEDIA.MALWARE`.
- Strip EXIF where applicable; generate safe filenames; store outside web root or in S3-compatible bucket with private ACL.

### 5.1.7 Audit & Admin

- **Audit log** event model: `ts`, `user_id`, `sid`, `action`, `target_type/id`, `outcome`, `request_id`; never store raw secrets or payloads.
- **Admin UI** (internal): moderation actions leave signed audit trail.
- **No user enumeration**: identical responses for existing/non-existing emails in auth flows.

---

## 5.2 Privacy & GDPR

### 5.2.1 Principles

- **Data minimization** and **purpose limitation**; private-by-default for user content.
- **Lawful basis** documented per category (contract, consent, legitimate interest).

### 5.2.2 Classification

| Class                 | Examples                             | Handling                                                              |
| --------------------- | ------------------------------------ | --------------------------------------------------------------------- |
| **PII-S** (Sensitive) | email, IPs, auth events, 2FA secrets | encrypt at rest where applicable, access controlled, redact from logs |
| **PII-B** (Basic)     | alias, locale, avatar metadata       | no logs, limited exposure, cached minimally                           |
| **Usage**             | session metrics, aggregates          | anonymize for telemetry; no per-user labels in metrics                |
| **Public**            | intentionally published feed items   | removable; still respect takedown and cache purge                     |

### 5.2.3 Retention & Deletion

- Retention matrix per table/field in §6; defaults minimal.
- **DSR: Export/Delete** flows:
  - Export: JSON bundle (user, profile, sessions, exercises, points, badges).
  - Delete: mark as `DELETED` → async purge; propagate to backups within **≤ 14 days**; tombstone for referential integrity.
- Media: delete object + metadata; purge CDN caches.

### 5.2.4 Consent & Transparency

- Consent required for public publishing and marketing emails.
- Privacy Policy and data map link surfaced in app.

### 5.2.5 Logging & Telemetry Privacy

- No PII in logs or metric labels. Use opaque IDs.
- Traces sample rate configured; spans must not include request bodies.

---

## 5.3 Performance Engineering

### 5.3.1 Budgets & Targets

- **API latency**: p95 < **300 ms**, p99 < 800 ms per route group.
- **FE**: LCP < **2.5 s** (P75), TBT < 200 ms on representative devices.
- **Size limits**: JSON responses ≤ 1 MB; request bodies ≤ 2 MB (except media).

### 5.3.2 Timeouts, Retries, Circuit Breakers

- Upstream calls (SMTP, object store) timeout ≤ 3 s; max 2 retries with jittered backoff; no retries for non-idempotent ops.
- DB statement timeout e.g., 2 s for API paths; longer for maintenance jobs.
- Circuit breaker around flaky adapters; fallback queues for transient errors.

### 5.3.3 Caching & Compression

- HTTP caching: `ETag`/`Last-Modified` for reads, `Cache-Control: no-store` for private resources.
- Server-side memoization/LRU where hot; Redis optional (Phase 2).
- Gzip/Brotli at edge; avoid double-compression on proxied assets.

### 5.3.4 Database Performance

- Index policy: each hot query documented in §6 with supporting index.
- Partition large time-series tables (e.g., sessions) by month; automatic pruning.
- Materialized views for analytics with incremental refresh jobs.

### 5.3.5 Regression Guards

- CI perf tests (k6) must not regress > **10%** vs baseline per route group.
- Lighthouse budgets enforced in CI; failing budgets block merge.

---

## 5.4 Observability

### 5.4.1 Logging

- Structured JSON lines: `ts`, `level`, `request_id`, `user_id?`, `sid?`, `route`, `status`, `lat_ms`, `error_code?`.
- Levels: `debug` (dev only), `info`, `warn`, `error`.
- **No PII** or secrets in messages/fields.

### 5.4.2 Metrics (Prometheus)

| Metric                            | Type      | Labels                      | Notes                |
| --------------------------------- | --------- | --------------------------- | -------------------- |
| `http_request_duration_seconds`   | histogram | `method`, `route`, `status` | route templates only |
| `http_requests_total`             | counter   | `method`, `route`, `status` |                      |
| `db_query_duration_seconds`       | histogram | `op`, `table`               |                      |
| `background_job_duration_seconds` | histogram | `job`                       |                      |
| `rate_limit_events_total`         | counter   | `bucket`                    |                      |
| `points_awarded_total`            | counter   | `rule`                      | abuse detection      |
| `av_scan_failures_total`          | counter   | `reason`                    | upload safety        |

**Cardinality policy**: routes are normalized (e.g., `/sessions/:id`), labels are bounded; drop high-cardinality user identifiers. Bound label sets only; drop labels that exceed 100 unique values in a 10-minute window; never include PII in labels or messages.

### 5.4.3 Tracing

- OpenTelemetry SDK; propagate `traceparent` from edge.
- Sample rate configurable (e.g., 10% prod, 100% staging).
- Spans include timing only; mask request/response bodies.

### 5.4.4 Dashboards & Alerts

- **Dashboards**: API latency & error rate, DB health, job queues, uploads AV, perf budgets.
- **Alerts**: 5xx rate spikes, p95 budget breach, DB saturation, queue backlog, auth lockout anomalies.

---

## 5.5 Accessibility & i18n Responsibilities (Backend Hints)

- Locale negotiation: `Accept-Language` + user setting; FE confirms final rendering locale.
- Server returns **ISO timestamps** and may include **formatting hints** (e.g., `suggestedDateFormat: "YYYY-MM-DD"`).
- Provide **semantic labels** in API only where BE generates strings (emails, system messages) and ensure those strings exist in token catalogs.
- Bidirectional text safety: store strings as UTF-8; FE renders with `dir` heuristics for RTL locales in future phases.

---

## 5.6 Configuration & Secrets Management

### 5.6.1 Environment Schema

- Validate on boot (zod): required keys fail fast with clear messages.
- Example categories:
  - **Core**: `NODE_ENV`, `PORT`, `BASE_URL`
  - **DB**: `DATABASE_URL`
  - **JWT**: `JWT_PRIVATE_KEY`, `JWT_PUBLIC_KEY`, `JWKS_URL?`
  - **Mail**: `SMTP_HOST`, `SMTP_USER`, `SMTP_PASS`
  - **Uploads**: `OBJECT_STORE_URL`, `OBJECT_STORE_BUCKET`
  - **Security**: `RATE_LIMIT_*`, `CSP_EXTRA_*`

### 5.6.2 Storage & Rotation

- Secrets stored in env/secrets manager; never in VCS or images.
- JWT keys rotated via JWKS; rollover period documented in §12; old keys kept to validate extant tokens till expiry.
- Database credentials rotated quarterly or on incident.

### 5.6.3 Feature Flags

- Boolean flags for **2FA**, admin global-exercise moderation, feed public discovery; stored in config table or env; read at startup with hot-reload support where safe.

---

## 5.7 Error Model & Idempotency

### 5.7.1 Error Envelope

```json
{
  "error": {
    "code": "E.SCOPE.SPECIFIC_CODE",
    "message": "Human-readable short message",
    "details": { "field": "reason" },
    "requestId": "uuid"
  }
}
```

- Codes are stable; HTTP status aligns with code family; registry in Appendix B.

### 5.7.2 Idempotency Policy

- **Applies to**: POST/PATCH **session creation/updates**, password reset complete, feed publish/unpublish, points correction.
- Clients send **`Idempotency-Key`** (UUID). Server records hash of request + key; repeats within **24 h** return the original result with `Idempotent-Replay: true`.
- Storage: `idempotency_keys` table with `key`, `fingerprint`, `status`, `response_hash`, `expires_at`.
- Collisions or mismatched payload for same key → 409 `E.IDEMPOTENCY.PAYLOAD_MISMATCH`.

---

## 5.8 Validation (DTO & Environment)

### 5.8.1 DTO Validation

- All inbound requests validated with **zod**: types, min/max, enums, patterns; reject unknown properties.
- Use shared schemas across FE/BE where feasible; export TypeScript types from schemas.

### 5.8.2 Environment Validation

- On boot, validate env; show masked error summary and exit non-zero if required variables are missing.
- Provide `.env.example` covering all keys with safe defaults where possible.

---

**Conformance**: This section's controls are **mandatory**. Any deviation requires an ADR and updates to PRD/QA gates.

---

- See also [Tech Stack](./2a.Technical_Design_Document_TechStack.md)
- See also [Data](./2c.Technical_Design_Document_Data.md)
- See also [Design & Architecture](./2d.Technical_Design_Document_APIDesign.md)
- See also [Other](./2e.Technical_Design_Document_misc.md)
