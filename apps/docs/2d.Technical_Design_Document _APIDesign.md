---
title: "FitVibe Technical Design Document (TDD)"
version: "v2.0"
status: "Accepted"
owner: "Konstantinos Pilpilidis (Dr.)"
date: "2025-10-21"
links:
  - PRD: docs/1.Product_Requirements_Document.md
  - QA: docs/3.Testing_and_Quality_Assurance_Plan.md
  - ADR Index: docs/adr/README.md
license: "MIT"
---

# 0. Introduction

## 0.1 Purpose & Scope

This TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).

## 0.2 Audience & Reading Guide

- **Engineers** implement according to specs, contracts, and runbooks.
- **QA** uses RTM links to derive tests and quality gates.
- **Security/Compliance** verifies controls, data classification, GDPR flows.
- **Product/Design** confirms that behavior matches PRD intent.

## 0.3 Assumptions & Constraints

- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL ≥ 14 (target 16-18 locally).
- All external calls (email) are **adapterized** and mockable for tests.
- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.
- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.

## 0.4 Versioning & Changelog

- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.

---

# 7. API Design & Contracts

This section defines the **canonical REST contracts** for the MVP. It specifies resource paths, methods, auth/roles, common headers, pagination, filtering, error envelopes, **rate limits**, and **idempotency** rules. DTO schemas are summarized here; authoritative TypeScript/Zod and OpenAPI are generated from source.

> Base URL: `https://api.fitvibe.app/api/v1` (staging/prod) - `http://localhost:4100/api/v1` (local)

---

The following table summarizes the REST API endpoints implemented.
Each endpoint adheres to REST semantics and returns JSON responses. Authentication is JWT-based as defined in § 9 Authentication Lifecycle.

| Module         | Endpoint                      | Method | Auth           | Description                                            | Status Codes  |
| :------------- | :---------------------------- | :----- | :------------- | :----------------------------------------------------- | :------------ |
| **System**     | `/health`                     | GET    | No             | System liveness check for CI/CD and uptime monitoring  | 200           |
| **Auth**       | `/auth/register`              | POST   | No             | Register a new account                                 | 201, 400, 409 |
|                | `/auth/login`                 | POST   | No             | Login with credentials                                 | 200, 401      |
|                | `/auth/refresh`               | POST   | Yes            | Issue a new access token                               | 200, 401      |
|                | `/auth/logout`                | POST   | Yes            | Invalidate refresh session                             | 204, 401      |
| **Users**      | `/users/me`                   | GET    | Yes            | Retrieve own profile                                   | 200, 401      |
|                | `/users/me/preferences`       | PATCH  | Yes            | Update unit & measurement preferences                  | 200, 400      |
|                | `/users/:alias`               | GET    | Optional       | Public profile (visibility rules)                      | 200, 404      |
|                | `/users/me`                   | PUT    | Yes            | Update editable profile fields                         | 200, 400      |
| **Exercises**  | `/exercises`                  | GET    | Yes            | List user and public exercises                         | 200           |
|                | `/exercises`                  | POST   | Yes            | Create a new exercise                                  | 201, 400      |
|                | `/exercises/:id`              | PUT    | Yes            | Update existing exercise                               | 200, 404      |
|                | `/exercises/:id`              | DELETE | Yes            | Archive exercise                                       | 204, 404      |
|                | `/exercises/:id/translations` | PUT    | Owner/Admin    | Upsert localized name/description (i18n)               | 200, 400, 404 |
| **Sessions**   | `/sessions`                   | GET    | Yes            | List sessions                                          | 200           |
|                | `/sessions`                   | POST   | Yes            | Create planned session                                 | 201           |
|                | `/sessions/:id/complete`      | PATCH  | Yes            | Mark session as completed                              | 200           |
|                | `/sessions/:id/clone`         | POST   | Yes            | Clone session (idempotent)                             | 201, 404      |
|                | `/sessions/:id`               | PATCH  | Owner          | Update nested exercises/sets transactionally           | 200, 404      |
| **Progress**   | `/analytics/summary`          | GET    | Yes            | Summary (from,to,grain)                                | 200           |
|                | `/analytics/prs`              | GET    | Yes            | Personal records (current & history)                   | 200           |
|                | `/analytics/weekly`           | GET    | Yes            | Weekly aggregates                                      | 200           |
| **Points**     | `/points`                     | GET    | Yes            | Get current total                                      | 200           |
|                | `/points/history`             | GET    | Yes            | Retrieve points history                                | 200           |
| **Feed**       | `/feed`                       | GET    | Yes (optional) | Public session feed                                    | 200           |
|                | `/feed/:id/clone`             | POST   | Yes            | Clone public session                                   | 201, 404      |
|                | `/feed/item/:id/like`         | POST   | Yes            | Like item                                              | 204, 404      |
|                | `/feed/item/:id/like`         | DELETE | Yes            | Unlike item                                            | 204, 404      |
|                | `/feed/item/:id/bookmark`     | POST   | Yes            | Bookmark session                                       | 204, 404      |
|                | `/feed/item/:id/bookmark`     | DELETE | Yes            | Remove bookmark                                        | 204, 404      |
|                | `/feed/item/:id/comments`     | GET    | Optional       | List comments (public rules)                           | 200, 404      |
|                | `/feed/item/:id/comments`     | POST   | Yes            | Add comment                                            | 201, 400, 404 |
|                | `/feed/comments/:commentId`   | DELETE | Owner          | Soft-delete comment                                    | 204, 404      |
| **Social**     | `/users/:alias/follow`        | POST   | Yes            | Follow                                                 | 204, 404      |
|                | `/users/:alias/follow`        | DELETE | Yes            | Unfollow                                               | 204, 404      |
|                | `/notifications`              | GET    | Yes            | List notifications (unread first)                      | 200           |
|                | `/notifications/:id/read`     | POST   | Yes            | Mark read (batch supported)                            | 204, 404      |
| **i18n**       | `/translations`               | PUT    | Admin/Owner    | Upsert translation (entityType, entityId, field, lang) | 200, 400      |
|                | `/translation-fields`         | GET    | Admin          | List allowed fields (seeded)                           | 200           |
| **Lookup**     | `/code-sets`                  | GET    | Optional       | List code sets (replaces enums)                        | 200           |
|                | `/code-sets/:key/values`      | GET    | Optional       | Values for a set                                       | 200           |
| **Attributes** | `/attributes`                 | GET    | Admin          | List dynamic attributes                                | 200           |
|                | `/attribute-values`           | POST   | Yes            | Record attribute value (entity scoped)                 | 201, 400      |

---

## 7.1 Layer Contracts

The backend shall follow a strict three-layer architecture:

1. **Router Layer** - Handles HTTP routing, parses input, validates DTOs, and maps service errors to HTTP codes.
   Routers shall never access the database directly.
   Idempotency keys are validated at the router and enforced within the service transaction boundary for POST/PATCH routes listed in §7.20.
2. **Service Layer** - Encapsulates business logic, transaction handling, and domain events.
3. **Repository Layer** - Performs all SQL operations via Knex; returns typed DTOs; no business logic allowed.

Utilities (e.g., logger, metrics, mailer) are dependency-injected where possible to ensure testability.

---

## 7.2 Error Handling Specification

All API responses shall use a standardized JSON error envelope:

```json
{
  "error": {
    "code": "AUTH_INVALID_CREDENTIALS",
    "message": "Invalid username or password.",
    "requestId": "uuid"
  }
}
```

| HTTP Code | Error Code                               | Description                            |
| --------- | ---------------------------------------- | -------------------------------------- |
| 400       | VALIDATION_ERROR                         | Request body failed schema validation. |
| 401       | AUTH_REQUIRED / AUTH_INVALID_CREDENTIALS | Missing or invalid token.              |
| 403       | FORBIDDEN                                | Insufficient privileges.               |
| 404       | NOT_FOUND                                | Resource not found.                    |
| 409       | CONFLICT                                 | Unique constraint or state conflict.   |
| 422       | UNPROCESSABLE                            | Business rule violation.               |
| 423       | LOCKED                                   | Account temporarily locked.            |
| 429       | RATE_LIMITED                             | Too many requests.                     |
| 500       | INTERNAL                                 | Unexpected server error.               |

The system shall include correlation IDs in every log and response for traceability.

---

## 7.3 Testing Approach

Each endpoint is covered by automated integration tests (`Jest` + `Supertest`) validating status codes, authentication, and schema compliance. A Postman collection mirrors this route map for manual verification during MVP development.

---

## 7.4 Migration Conventions

- Migration filenames shall follow: `YYYYMMDDHHMM__<description>.ts`.
- Order: lookup → users → domain → attributes → social.
- Each migration shall provide reversible `up`/`down` functions.
- CI executes migrations on ephemeral DB; CD runs `migrate:latest` before app start.
- No destructive `down` migrations in production; use expand/contract pattern.

## 7.5 Logging and Monitoring Middleware

- **Logging:** use `pino` for structured JSON logs; `morgan` for access logs; include `requestId` and `userId` where available.
- **Privacy:** exclude passwords, tokens, and PII from logs.
- **Monitoring:** integrate Prometheus middleware capturing latency histograms by route and status.

---

## 7.6 Conventions

### 7.6.1 Standard Headers

- **Authentication**: `Authorization: Bearer <access-jwt>`
- **Idempotency**: `Idempotency-Key: <uuid>` (for POST/PATCH as specified)
- **Rate Limits (responses)**:
  - `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
  - On 429: `Retry-After: <seconds>`
- **Deprecation**:
  - `Deprecation: true` (when an endpoint is scheduled for removal)
  - `Sunset: <RFC 1123 date>`

### 7.6.2 Pagination & List Responses

- Query: `?page=<1..N>&limit=<1..100>` (default `page=1`, `limit=20`)
- Response envelope:

```json
{
  "data": [
    /* items */
  ],
  "meta": { "page": 1, "limit": 20, "total": 123, "hasNext": true }
}
```

### 7.6.3 Error Envelope

```json
{
  "error": {
    "code": "E.SCOPE.CODE",
    "message": "Human-readable, localized message key or string",
    "details": { "field": "reason" },
    "requestId": "uuid"
  }
}
```

### 7.6.4 Resource Versioning

- All endpoints under `/api/v1`. Additive fields allowed. Breaking changes require `/api/v2` with deprecation window.

---

## 7.7 Auth & Session (FR-1)

| Method | Path                      | Auth          | Roles | Idempotent? | Rate Limit           | Summary                             |
| ------ | ------------------------- | ------------- | ----- | ----------- | -------------------- | ----------------------------------- |
| POST   | `/auth/register`          | none          | anon  | yes (key)   | 5/min/IP             | Create account                      |
| GET    | `/auth/verify`            | none          | anon  | n/a         | 30/min/IP            | Verify email (token param: `token`) |
| POST   | `/auth/2fa/setup`         | access        | user  | no          | 10/min               | Provision TOTP (secret+QR)          |
| POST   | `/auth/2fa/verify`        | access        | user  | no          | 10/min               | Confirm TOTP enable                 |
| POST   | `/auth/2fa/disable`       | access        | user  | no          | 10/min               | Disable TOTP                        |
| POST   | `/auth/login`             | none          | anon  | no          | 10/15min per acct+IP | Issue access+refresh                |
| POST   | `/auth/refresh`           | refresh token | user  | no          | 60/min               | Rotate refresh                      |
| POST   | `/auth/logout`            | access token  | user  | no          | 60/min               | Invalidate current session          |
| POST   | `/auth/password/reset`    | none          | anon  | yes (key)   | 5/min/IP             | Request reset email                 |
| POST   | `/auth/password/complete` | none          | anon  | yes (key)   | 5/min/IP             | Complete reset                      |
| GET    | `/auth/sessions`          | access        | user  | n/a         | 60/min               | List device sessions                |
| POST   | `/auth/sessions/revoke`   | access        | user  | no          | 10/min               | Revoke all or specific session      |

**Register (POST /auth/register) & Request**

```json
{
  "email": "a@b.com",
  "password": "P@ssw0rd!",
  "alias": "konstantinos",
  "locale": "de"
}
```

**Response 201**

```json
{
  "id": "01J...",
  "email": "a@b.com",
  "alias": "konstantinos",
  "status": "unverified"
}
```

---

## 7.8 Users & Profile (FR-2)

| Method | Path               | Auth     | Roles     | Idempotent? | Notes                                                                   |
| ------ | ------------------ | -------- | --------- | ----------- | ----------------------------------------------------------------------- |
| GET    | `/users/me`        | access   | user      | n/a         | Own profile (full)                                                      |
| PATCH  | `/users/me`        | access   | user      | yes (key)   | Update profile                                                          |
| DELETE | `/users/me`        | access   | user      | no          | Initiate DSR delete                                                     |
| GET    | `/users/:alias`    | optional | anon/user | n/a         | Public/allowed fields only (visibility: `private;follower;link;public`) |
| PATCH  | `/users/me`        | access   | user      | yes (key)   | Update profile & measurement preferences (see §6 profiles)              |
| PUT    | `/users/me/avatar` | access   | user      | yes (key)   | Upload avatar (multipart)                                               |
| DELETE | `/users/me/avatar` | access   | user      | no          | Remove avatar                                                           |

**PATCH /users/me - Request (partial)**

```json
{ "displayName": "Kosta", "bio": "Runner", "locale": "de", "alias": "kpil" }
```

---

## 7.9 Exercise Library (FR-3)

| Method | Path                           | Auth        | Roles       | Idempotent?                                                       | Notes                                      |
| ------ | ------------------------------ | ----------- | ----------- | ----------------------------------------------------------------- | ------------------------------------------ |
| GET    | `/exercises`                   | access      | user        | n/a                                                               | List/search (q, category, tags, equipment) |
| POST   | `/exercises`                   | access      | user        | yes (key)                                                         | Create user-owned                          |
| GET    | `/exercises/:id`               | access      | user        | n/a                                                               | Read                                       |
| PATCH  | `/exercises/:id`               | access      | owner/admin | yes (key)                                                         | Update                                     |
| DELETE | `/exercises/:id`               | access      | owner/admin | no                                                                | Archive/delete (user-owned)                |
| GET    | `/exercises/global`            | access      | user        | n/a                                                               | List admin-global                          |
| POST   | `/admin/exercises`             | access      | admin       | yes (key)                                                         | Create global exercise                     |
| PATCH  | `/admin/exercises/:id`         | access      | admin       | yes (key)                                                         | Update global                              |
| POST   | `/admin/exercises/:id/archive` | access      | admin       | no                                                                | Archive global                             |
| PUT    | `/exercises/:id/translations`  | owner/admin | yes (key)   | Upsert {lang, fieldKey, value}; validated by `translation_fields` |

Search params now include `lang` to include localized fields where available.
Search params: `?q&category&tag&equipment&page&limit`

---

## 7.10 Planning & Sessions (FR-4)

| Method | Path                     | Auth   | Roles | Idempotent?   | Notes                                                                                     |
| ------ | ------------------------ | ------ | ----- | ------------- | ----------------------------------------------------------------------------------------- |
| GET    | `/sessions`              | access | user  | n/a           | Range filters: `from`, `to`, `status`                                                     |
| POST   | `/sessions`              | access | user  | **yes (key)** | Create (with nested exercises/sets)                                                       |
| GET    | `/sessions/:id`          | access | owner | n/a           | Read                                                                                      |
| PATCH  | `/sessions/:id`          | access | owner | **yes (key)** | Update nested payload transactionally                                                     |
| POST   | `/sessions/:id/complete` | access | owner | **yes (key)** | Mark completed + actuals; validates <br>lifecycle checks from §6 (timestamps consistency) |
| POST   | `/sessions/:id/clone`    | access | owner | **yes (key)** | Clone to new date                                                                         |
| DELETE | `/sessions/:id`          | access | owner | no            | Soft-delete                                                                               |

**POST /sessions - Request (excerpt)**

```json
{
  "title": "Leg Day",
  "plannedAt": "2025-10-15T18:00:00Z",
  "exercises": [
    {
      "exerciseId": "01J...",
      "order": 1,
      "sets": [
        { "order": 1, "reps": 5, "weightKg": 100 },
        { "order": 2, "reps": 5, "weightKg": 100 }
      ]
    }
  ]
}
```

---

## 7.11 Progress & Analytics (FR-5)

| Method | Path                 | Auth   | Roles | Notes                                |
| ------ | -------------------- | ------ | ----- | ------------------------------------ |
| GET    | `/analytics/summary` | access | user  | `from`, `to`, `grain=day;week;month` |
| GET    | `/analytics/prs`     | access | user  | current & history (is_current flag)  |
| GET    | `/analytics/weekly`  | access | user  | aggregates; payload ≤ 1MB            |

All responses capped to 1 MB; enforce slicing for long ranges.

---

## 7.12 Points & Badges (FR-6)

| Method | Path                    | Auth   | Roles | Notes                               |
| ------ | ----------------------- | ------ | ----- | ----------------------------------- |
| GET    | `/points`               | access | user  | current balance + recent events     |
| GET    | `/badges`               | access | user  | owned badges                        |
| GET    | `/badges/catalog`       | access | user  | badge catalog                       |
| POST   | `/admin/points/correct` | access | admin | correction with audit reason (rare) |

---

## 7.13 Feed & Sharing (FR-7)

| Method | Path                          | Auth     | Roles      | Idempotent? | Notes                                     |
| ------ | ----------------------------- | -------- | ---------- | ----------- | ----------------------------------------- |
| GET    | `/feed`                       | optional | anon/user  | n/a         | Public timeline; for user view own+public |
| POST   | `/feed/session/:id/publish`   | access   | owner      | yes (key)   | Publish session                           |
| POST   | `/feed/session/:id/unpublish` | access   | owner      | yes (key)   | Unpublish                                 |
| POST   | `/feed/item/:id/link`         | access   | owner      | yes (key)   | Create link-only token                    |
| DELETE | `/feed/item/:id/link`         | access   | owner      | no          | Revoke link token                         |
| GET    | `/feed/link/:token`           | none     | anon       | n/a         | View item by link token                   |
| POST   | `/feed/item/:id/like`         | access   | user       | yes (key)   | Like item                                 |
| DELETE | `/feed/item/:id/like`         | access   | user       | no          | Unlike item                               |
| POST   | `/feed/item/:id/bookmark`     | access   | user       | yes (key)   | Bookmark item/session                     |
| DELETE | `/feed/item/:id/bookmark`     | access   | user       | no          | Unbookmark                                |
| GET    | `/feed/item/:id/comments`     | optional | anon/user  | n/a         | List comments (public)                    |
| POST   | `/feed/item/:id/comments`     | access   | user       | yes (key)   | Add comment                               |
| DELETE | `/feed/comments/:commentId`   | access   | user/owner | no          | Delete own comment                        |
| POST   | `/users/:alias/follow`        | access   | user       | no          | Follow user                               |
| DELETE | `/users/:alias/follow`        | access   | user       | no          | Unfollow user                             |
| GET    | `/leaderboards`               | optional | anon/user  | no          | `type`, `period` filters                  |

Visibility values: `private | follower | link | public`.

---

## 7.14 Media (Avatars & Attachments)

| Method | Path                | Auth   | Roles       | Notes                              |
| ------ | ------------------- | ------ | ----------- | ---------------------------------- |
| POST   | `/media`            | access | user        | Multipart upload → AV scan → store |
| GET    | `/media/:id`        | access | owner/admin | Signed URLs or proxied reads       |
| DELETE | `/media/:id`        | access | owner/admin | Deletes object + metadata          |
| GET    | `/media/:id/public` | none   | anon        | Only if explicitly public          |

Upload rules: image types only, ≤ 5 MB, AV must be `clean` or request fails with `E.MEDIA.MALWARE`. Public reads allowed only for items explicitly marked public or via share token (§6 media_assets).

---

## 7.15 Admin

| Method | Path                    | Auth   | Roles | Notes                                      |
| ------ | ----------------------- | ------ | ----- | ------------------------------------------ |
| GET    | `/admin/audit`          | access | admin | filter by `userId`, `action`, `from`, `to` |
| POST   | `/admin/users/:id/role` | access | admin | assign role                                |
| GET    | `/admin/health`         | access | admin | liveness/readiness + migrations check      |

---

## 7.16 Health, Metrics & Diagnostics

| Method | Path                | Auth                    | Roles | Notes                          |
| ------ | ------------------- | ----------------------- | ----- | ------------------------------ |
| GET    | `/health/liveness`  | none                    | anon  | 200 OK when process alive      |
| GET    | `/health/readiness` | none                    | anon  | checks DB, queue, dependencies |
| GET    | `/metrics`          | none (cluster/IP allow) | infra | Prometheus exposition          |

---

## 7.17 Filtering & Sorting Rules

- **Allow-list per resource** to avoid unsafe fields. Examples:
  - `/exercises`: `q`, `category`, `equipment`, `tag`, `sort=name|createdAt`
  - `/sessions`: `from`, `to`, `status`, `sort=plannedAt|createdAt`
- Unknown filters are rejected with `422 E.API.UNKNOWN_FILTER`.

---

## 7.18 Rate Limits (Reference)

| Bucket                 | Limit                          |
| ---------------------- | ------------------------------ |
| Auth login             | 10 per 15 min per account + IP |
| Registration           | 5 per min per IP               |
| Password reset request | 5 per 15 min per IP            |
| Session writes         | 30 per 5 min per user          |
| General read           | 300 per 5 min per IP           |
| Feed interactions      | 60 per 5 min per user          |
| Attribute writes       | 60 per 5 min per user          |

All 429 responses include `Retry-After` and rate headers.

---

## 7.19 Idempotency (Reference)

- **Required** for: POST `/sessions`, PATCH `/sessions/:id`, POST `/sessions/:id/complete`, POST `/sessions/:id/clone`, POST `/auth/password/complete`, feed publish/unpublish, admin points correction, exercise create/update, translations upsert, notifications mark-as-read (batch).
- On replay within 24h, server returns **same status & body** and sets `Idempotent-Replay: true`.

---

## 7.20 DTO & Validation Summary (selected)

> Definitive schemas live in `apps/backend/src/modules/**/dto.ts` and are used to generate OpenAPI.

### 7.20.1 Auth DTOs

- `RegisterDto { email:string; password:string; alias:string; locale?:string }`
- `LoginDto { email:string; password:string; otp?:string }`
- `PasswordResetRequestDto { email:string }`
- `PasswordResetCompleteDto { token:string; newPassword:string }`

### 7.20.2 Sessions DTOs

- `SessionCreateDto { title?:string; plannedAt?:string; exercises: SessionExerciseDto[] }`
- `SessionExerciseDto { exerciseId:string; order:number; sets: SessionSetDto[] }`
- `SessionSetDto { order:number; reps?:number; weightKg?:number; distanceM?:number; durationSec?:number; rpe?:number; notes?:string }`

### 7.20.3 Exercise DTOs

- `ExerciseCreateDto { name:string; categoryId?:string; primaryMuscles?:string[]; equipment?:string[]; instructions?:string; tags?:string[] }`

### 7.20.4 i18n DTOs

- `TranslationUpsertDto { entityType:"exercise"|"badge"|"workout_template"|"exercise_category"; entityId:string; lang:"en"|"de"|...; fieldKey:string; value:string }`

### 7.20.5 Social DTOs

- `CommentCreateDto { body:string }`
- `NotificationsReadDto { ids:string[] }`

### 7.20.6 Attributes & Lookups DTOs

- `AttributeValueCreateDto { attributeId:string; entityType:string; entityId:string; measuredAt?:string; unitCode?:string; intValue?|numericValue?|textValue?|boolValue?|dateValue?|tsValue?|jsonValue? (one required) }`

---

## 7.21 OpenAPI Generation

- **Source of truth**: Zod schemas in `apps/backend/src/**/dto.ts`; types emitted to shared package.
- **Artifact path**: `apps/backend/openapi/openapi.json` and `openapi.yaml` (generated in CI).
- **Publishing**: CI uploads OpenAPI JSON as a build artifact and to the docs site (staging/prod).
- **Viewer**: Dev-only Swagger UI at `/docs` (staging only).
- **Versioning**: OpenAPI file version increments each release; `Deprecation`/`Sunset` headers accompany removals.

---

## 7.22 Error Code Registry (Excerpt)

| Code                             | HTTP | Meaning                     |
| -------------------------------- | ---- | --------------------------- |
| `E.AUTH.INVALID_CREDENTIALS`     | 401  | Wrong email/password        |
| `E.AUTH.TOTP_REQUIRED`           | 401  | 2FA required                |
| `E.AUTH.LOCKED`                  | 423  | Account temporarily locked  |
| `E.USER.ALIAS_TAKEN`             | 409  | Alias not available         |
| `E.EXERCISE.DUPLICATE`           | 409  | Duplicate exercise          |
| `E.SESSION.LIFECYCLE_CONFLICT`   | 409  | Illegal timestamp state     |
| `E.SESSION.INVALID_SET`          | 422  | Invalid set payload         |
| `E.MEDIA.MALWARE`                | 422  | Upload failed AV scan       |
| `E.API.UNKNOWN_FILTER`           | 422  | Filter not allowed          |
| `E.IDEMPOTENCY.PAYLOAD_MISMATCH` | 409  | Same key, different payload |
| `E.I18N.FIELD_NOT_ALLOWED`       | 400  | fieldKey not permitted      |
| `E.ATTR.VALUE_TYPE_MISMATCH`     | 400  | Wrong value type for attr   |

> Full registry lives in **Appendix B** and is validated in unit tests.

---

**Contract Stability**: Changes to endpoint paths, auth, or DTOs require updating §7, regenerating OpenAPI, and adjusting QA tests. Breaking changes MUST be introduced under a new major API version.

---

# 8. Client-Facing Contracts (Frontend Integration)

This section defines how the React app integrates with the API and implements the **user-facing contracts**: route map, auth guards, state, validation, i18n, accessibility, and UI performance conventions. It binds §7 (API) and §5 (cross-cutting) to concrete FE behavior.

---

## 8.1 Route Map & Auth Guards

> SPA with React Router. Guards enforce auth state, roles, and feature flags.

| Route                  | Access       | Guard                                | Notes                                                      |
| ---------------------- | ------------ | ------------------------------------ | ---------------------------------------------------------- |
| `/`                    | public       | none                                 | Marketing/landing or dashboard redirect when authenticated |
| `/auth/login`          | public       | Redirect if authenticated            | Login form (email, password, OTP if 2FA)                   |
| `/auth/register`       | public       | Redirect if authenticated            | Registration form                                          |
| `/auth/verify`         | public       | none                                 | Handles `token` param and shows result                     |
| `/auth/reset`          | public       | none                                 | Request reset form                                         |
| `/auth/reset/complete` | public       | none                                 | Complete reset with `token`                                |
| `/app`                 | user         | **AuthGuard**                        | Shell layout; loads user profile on mount                  |
| `/app/sessions`        | user         | AuthGuard                            | List calendar/timeline; filters `from,to,status`           |
| `/app/sessions/new`    | user         | AuthGuard + **IdempotencyDecorator** | Create session                                             |
| `/app/sessions/:id`    | user (owner) | **OwnerGuard**                       | Read/update; nested sets editor                            |
| `/app/exercises`       | user         | AuthGuard                            | Search list (global + my)                                  |
| `/app/exercises/new`   | user         | AuthGuard                            | Create exercise (user-owned)                               |
| `/app/exercises/:id`   | user/owner   | OwnerOrAdminGuard                    | View/update                                                |
| `/app/analytics`       | user         | AuthGuard                            | Dashboards                                                 |
| `/app/points`          | user         | AuthGuard                            | Points & badges                                            |
| `/app/feed`            | public/user  | Guard depends on visibility          | Public timeline + my items                                 |
| `/app/profile/:alias`  | public/user  | VisibilityGuard                      | Public-safe profile view                                   |
| `/admin`               | admin        | **RoleGuard(admin)**                 | Admin shell (global exercises, audit)                      |

**Guards**:

- `AuthGuard`: requires valid access token; redirects to `/auth/login`.
- `OwnerGuard`: verifies current user is the resource owner (via API or preloaded model).
- `RoleGuard(role)`: checks `role` claim.
- `VisibilityGuard`: calls public endpoint or private owner view accordingly.
- `IdempotencyDecorator`: attaches `Idempotency-Key` to eligible POST/PATCH (see §5, §7.19).

---

## 8.2 State, Query & Caching

- **Data layer**: React Query (or equivalent) with stale-while-revalidate.
- **Cache keys**: normalized (e.g., `["sessions", {from,to,status}]`).
- **Revalidation**: on window focus, network regain, or mutation success.
- **Optimistic updates**: only for local UI affordances; server is source of truth; roll back on error.
- **Prefetch**: dashboard critical queries on `/app` mount.
- **Invalidation**: mutate sessions invalidates lists, analytics, points, feed where impacted.
- **Error boundary**: top-level and per-page; shows localized messages based on error `code` from §7.1.3.

---

## 8.3 Forms & Validation Boundaries

- **Client validation** mirrors server schemas (zod) to provide instant feedback; server remains authoritative.
- **Password**: strength meter; enforced min length and complexity consistent with BE.
- **Alias**: debounced uniqueness check; lowercase normalization visible.
- **Session editor**: nested sets with guardrails (non-negative numbers, sensible maxima).
- **Accessibility**: all inputs have labels; errors announced via ARIA live regions.
- **Submit behavior**: disable buttons while pending; show skeletons/spinners; never block UI thread.

---

## 8.4 i18n Token Strategy

- **MVP**: Static token dictionaries **EN/DE** with high coverage threshold in CI.
- **Runtime**: `Accept-Language` parsed on first visit; persisted preference in profile.
- **Fallback**: EN when token missing; capture telemetry for gaps (dev only).
- **Date/number**: use Intl APIs; server returns ISO values + optional hints (see §3.5, §5.5).
- **Email/system strings**: tokens shared between BE & FE to keep consistency (namespace: `system.*`).

---

## 8.5 Accessibility (WCAG 2.1 AA)

- **Keyboard**: fully navigable; focus management after route change and modal open/close.
- **Color contrast**: maintain ≥ 4.5:1; tokens defined in theme.
- **ARIA**: landmarks, labels, error announcements (`role="alert"`).
- **Media**: alt text required; decorative images `aria-hidden="true"`.
- **Motion**: respect `prefers-reduced-motion`.
- **Testing**: automated a11y checks in CI (axe) for critical screens.

---

## 8.6 Error Handling & UX Conventions

- Map `error.code` to localized messages and **actionable remediation** (e.g., `E.AUTH.LOCKED` â‡’ show cooldown and security tips).
- Global **toaster/inline** error presentation; avoid modal traps.
- For 401: attempt silent refresh then redirect to login with returnTo.
- For 403: show â€œnot authorizedâ€ with link to help.
- For 404: resource-not-found page and a safe back link.
- For 409 idempotency replays: show non-intrusive info; update UI with returned entity.

---

## 8.7 UI Performance Conventions

- **LCP** budget **< 2.5 s** (P75). Above-the-fold content SSR/CSR hybrid optional (Phase 2).
- **Code splitting**: route-based chunks; prefetch likely next routes.
- **Images**: responsive sizes; lazy-load below fold; AVIF/WebP preferred.
- **Lists**: virtualization for large feeds; skeleton loaders.
- **Memoization**: avoid re-renders in forms and heavy lists; use stable keys.
- **Analytics**: Web Vitals reporting to observability (non-PII).

---

## 8.8 Theming & Design Tokens

- **Tokens**: colors, spacing, typography, radii, shadows; both **light** and **dark** themes.
- **Scaling**: use `rem` and CSS variables; respect user font scaling.
- **Components**: cards, inputs, tables, modals follow tokens; accessible focus styles.
- **Icons**: consistent set (e.g., lucide-react).
- **Brand**: FitVibe logo variants; ensure minimum size and clear space.

---

## 8.9 Frontend DTOs & Mappers

- FE imports **TypeScript types** generated from BE zod schemas (or shared package) to prevent drift.
- Map snake_case DB/BE fields to camelCase UI models in a dedicated mapper layer.
- Date strings parsed to `Date` only at view model boundary; keep raw ISO in caches.

---

## 8.10 Pagination, Filtering & Sorting UX

- **Pagination**: standard page/limit controls; “Load more” for mobile.
- **Filtering**: debounced inputs; reset/clear pattern; URL query sync for shareable views.
- **Sorting**: explicit dropdown; default stable sort per resource.
- Preserve filters in session storage to improve continuity.

---

## 8.11 Uploads (Avatars & Media)

- Client enforces **type/size** before upload; displays AV scan status from server.
- Show deterministic placeholders while processing; retry with exponential backoff on transient errors.
- Strip EXIF on client when possible before upload (optional).

---

## 8.12 Analytics & Telemetry

- Event taxonomy (examples): `login_success`, `session_created`, `session_completed`, `exercise_created`, `points_awarded`, `feed_published`.
- Send minimal payloads (opaque IDs, no PII).
- Sampling enabled; opt-out respected.

---

## 8.13 Feature Flags (UI)

- Flags read from `/config` or embedded build-time env; cached client-side.
- Gates: **2FA**, **admin global exercises**, **public feed discovery**.
- All flag decisions are **render-blocking** only on first load; afterward cached and rechecked in background.

---

## 8.14 Offline & Resilience (MVP-lite)

- Basic **retry** for transient network errors.
- **Draft caching** for forms (sessions editor) in localStorage with explicit â€œRestore draftâ€.
- Connectivity banner on offline/online events.

---

## 8.15 Security & Privacy on the Client

- Store access tokens in memory (default) or secure cookies (if configured).
- Never persist refresh tokens in localStorage/sessionStorage.
- Redact PII in logs; disable verbose logs in production.
- Sanitize all user-provided HTML (not expected in MVP forms; keep plain text).

---

## 8.16 Component Contracts (Selected)

### 8.16.1 SessionEditor

- **Props**: `initialSession?`, `onSubmit`, `onCancel`.
- **Behavior**: manages nested exercises/sets; validates; emits DTO; attaches `Idempotency-Key`.
- **Empty state**: guided quick-add from Exercise library.
- **Perf**: virtualize large set lists; memoize controls.

### 8.16.2 ExerciseSearch

- **Props**: `query`, `filters`, `onSelect`.
- **Behavior**: debounced server search; shows facets; handles global vs my exercises.
- **Perf**: infinite scroll; cached last queries.

### 8.16.3 AnalyticsDashboard

- **Props**: `from`, `to`, `grain`.
- **Behavior**: fetches aggregates; allows drill-down to sessions; caps response size.
- **Perf**: skeletons; chart virtualization for many points.

---

## 8.17 Contracts for Emails (Rendered by FE Templates or BE)

- Tokens resolved using shared dictionaries.
- Layout responsive; accessible text versions; links include `utm_campaign=system` (non-PII).
- Security: no tracking pixels that violate privacy policy.

---

**Integration Guarantee**: The FE must treat §7 contracts as the single source of truth and adhere to §5 controls. Any deviation requires an ADR and updates to PRD/QA.

---

# 9. Non-Functional Realization

This section operationalizes all **NFRs** (security, performance, reliability, accessibility, observability, privacy) into **measurable budgets**, **controls**, and **CI/CD gates**. It references §5 (cross-cutting), §6 (data), §7 (API), and §8 (FE).

---

## 9.1 NFR → Control → Verification Matrix

| NFR Domain             | Target                                                                                | Design Control (Where)                                                                  | Verification (How)                                                                   |
| ---------------------- | ------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | --- |
| **Security**           | No high/critical vulns; hardened endpoints                                            | §5.1 security headers, JWT RS256 + refresh rotation, rate limits, AV scan, SBOM/signing | CI SCA (npm audit/OSV), ZAP baseline, headers test, EICAR upload test, cosign verify |
| **Privacy/GDPR**       | DSR export/delete; scrub logs                                                         | §5.2 DSR flows, §6.6 retention/classification                                           | E2E DSR tests, log/metric schema lint (no PII), backup purge policy check            |     |
| **Performance (FE)**   | LCP < **2.5 s** (P75); **TTI < 3.0 s**; **Total JS ≤ 300 KB gz**                      | §8.7 UI perf rules                                                                      | Lighthouse CI budget (bundle cap), Web Vitals RUM dashboard                          |
| **Performance (API)**  | p95 < **300 ms**, p99 < **800 ms**; **Throughput ≥ 500 req/s sustained (1000 burst)** | §5.3, §9.2                                                                              | k6 profiles with thresholds                                                          |
| **Reliability**        | Error rate < 0.5%; RPO ≤ 24h; RTO ≤ 4h                                                | §12 runbooks; §6.10 backups                                                             | Chaos drills (read-only DB, SMTP down), restore test monthly                         |
| **Observability**      | Complete logs/metrics/traces                                                          | §5.4 metrics contract                                                                   | Prometheus scrape integration test; dashboards and alert tests                       |
| **Accessibility**      | WCAG 2.1 AA                                                                           | §8.5 a11y rules                                                                         | axe CI checks, manual keyboard walk-through for key flows                            |
| **Availability (MVP)** | 99.5% monthly                                                                         | NGINX health checks; rolling deploys                                                    | Uptime probe SLO; synthetic checks                                                   |

---

## 9.2 Performance Engineering

### 9.2.1 Load Profiles (MVP realistic)

| Profile        | Actors        | Pattern                                   | Target                                            |
| -------------- | ------------- | ----------------------------------------- | ------------------------------------------------- |
| **Auth Spike** | 50 concurrent | burst login/reset                         | keep p95 < 300 ms; lockouts reliable              |
| **Planner**    | 200 active    | 2 rps GET `/sessions`, 0.5 rps POST/PATCH | p95 < 300 ms; zero duplicate writes (idempotency) |
| **Analytics**  | 100 active    | 1 rps GET `/analytics/*` (window ≤ 90d)   | p95 < 500 ms; payload ≤ 1 MB                      |
| **Feed Read**  | 150 active    | 3 rps GET `/feed`                         | p95 < 300 ms                                      |

### 9.2.2 Budgets & Limits

| Endpoint Group              | Target p95 | Expected Payload | Notes                    |
| --------------------------- | ---------- | ---------------- | ------------------------ |
| Auth / Users                | ≤ 200 ms   | < 10 KB          | Short transactions only  |
| Exercises / Sessions (CRUD) | ≤ 300 ms   | < 100 KB         | Cached lookups preferred |
| Progress / Analytics        | ≤ 600 ms   | up to 250 KB     | Materialized views       |
| Feed / Public endpoints     | ≤ 400 ms   | 20 items/page    | Edge-cached ~30 s        |

- **Request size:** ≤ 2 MB (JSON); **Response size:** ≤ 1 MB (JSON).
- **Timeouts:** API → DB 2 s; API → SMTP/object store 3 s; jobs up to 30 s.
- **Concurrency:** Node worker threads tuned to CPU; DB connection pool sized to 2Ã— cores (cap ≤ 20).
- **Compression:** gzip/Brotli enabled at edge.

### 9.2.3 DB Performance Practices

- Per-endpoint **hot query + index** list in §6.3 is mandatory.
- Use **partial indexes** where predicates are common (e.g., `deleted_at IS NULL`).
- Monitor `pg_stat_statements`; alert on heavy scans.
- Prefer **matviews** for aggregates; refresh incrementally post-writes.

### 9.2.4 Regression Guard

- CI k6 run produces baseline JSON; PRs must not regress **>10%** p95 per route group; failures block merge.
- FE Lighthouse budgets: LCP, TBT, CLS enforced in CI; failing budgets block merge.

---

## 9.3 Security Realization (summary)

- **AuthN/Z:** RS256 JWT; refresh rotation; reuse detection → revoke family.
- **Headers:** CSP, HSTS, Referrer-Policy: no-referrer, Permissions-Policy: (deny camera/mic/geolocation by default) set at the edge, X-Frame-Options.
- **Abuse:** per-IP/account rate limits; lockout with exponential backoff; **no user enumeration**.
- **Uploads:** AV scan (clamd/service); EXIF strip; private ACL; signed URL or proxy.
- **Supply-chain:** SBOM generation + signature; image signing with cosign; pinned digests in CD.
- **Secret management:** env schema validation; rotation procedures via JWKS.

**Verification:** unit/integration tests for flows; ZAP baseline; negative tests (e.g., missing headers/cors).

---

## 9.4 Privacy & Data Protection

- **Classification** map in §6.6; **PII never** appears in logs/metrics labels.
- **DSR Export/Delete** implemented with audit trail; delete cascades across child tables; **backups purged ≤ 14 days** after finalization.
- **Consent** gating for public feed publishing and marketing emails.
- **Data minimization:** only collect data required to deliver MVP functionality.

**Verification:** E2E tests (export bundle completeness; delete propagation checks); privacy lint for log fields.

---

## 9.5 Reliability & Availability

### 9.5.1 Targets

- **Availability:** 99.5% monthly (MVP).
- **RPO:** ≤ 24 hours. **RTO:** ≤ 4 hours.

### 9.5.2 Patterns

- Health checks: `/health/liveness`, `/health/readiness` (DB, queue, object store).
- **Rolling deployments** (or blue/green) with pre-flight DB migration checks.
- **Backups:** daily full; PITR if supported; encrypted at rest and in transit.
- **Restore procedures** documented in §12; monthly restore drills in staging.
- **Graceful degradation:** analytics endpoints can be temporarily disabled under heavy load; core CRUD stays up.

### 9.5.3 Chaos & Fault Injection

- Simulate: DB read-only, SMTP failure, object store latency; verify timeouts and fallbacks.
- Verify idempotent replays produce consistent outcomes under retries.

---

## 9.6 Accessibility (WCAG 2.1 AA)

- **Keyboard access:** every control reachable; visible focus outlines.
- **Contrast:** ≥ 4.5:1; theming tokens enforce.
- **ARIA:** landmarks, labels, live regions for errors; headings in logical order.
- **Motion:** respect `prefers-reduced-motion`.
- **Media:** alt text required; non-decorative images labeled.

**Verification:** automated **axe** checks in CI for `/auth/*`, `/app/sessions`, `/app/exercises`, `/app/analytics` + manual spot-checks.

---

## 9.7 Observability & SLOs

### 9.7.1 SLOs

- **Latency SLO:** 95% of requests < 300 ms (API).
- **Error SLO:** < 0.5% 5xx per 10-minute window.
- **Availability SLO:** 99.5% uptime for `/health/readiness` and primary APIs.

### 9.7.2 Dashboards

- API latency & error rate; DB health (`connections`, `locks`, slow queries); background jobs; upload AV results; RUM Web Vitals.

### 9.7.3 Alerts

- p95 > 300 ms for 15 min.
- 5xx > 0.5% for 10 min.
- DB connection saturation > 80% for 5 min.
- Queue backlog age > 5 min.
- AV scan failures spike beyond baseline.

---

## 9.8 Capacity Planning (MVP)

- **Throughput assumption:** 20 rps peak mixed traffic on a single API node; horizontal scale with 2-3 replicas.
- **DB sizing:** start with 2 vCPU/4-8 GB RAM; scale vertically to 4 vCPU/16 GB as needed; storage with 3000+ IOPS.
- **Object storage:** S3-compatible bucket; lifecycle rules for deleted media.
- **Headroom:** maintain ≤ 60% avg CPU and ≤ 70% DB connections under peak.

---

## 9.9 CI/CD Quality Gates (NFR)

- **Lint + Typecheck:** must pass.
- **Tests:** coverage **≥ 80%** lines/branches.
- **Security:** SCA clean (no high/critical); ZAP baseline no high.
- **Perf:** k6 thresholds for each route group; no >10% regression.
- **A11y:** axe checks pass on key screens.
- **Build:** SBOM generated; images signed; pinned digests.
- **Deployment:** health/readiness checks green; migrations safe; rollback plan present.

---

## 9.10 Exceptions & ADRs

Any exceptions to these NFR controls require:

1. An **ADR** describing the deviation and rationale.
2. Updates to PRD/QA acceptance where applicable.
3. A plan to return to baseline.

---

**Conformance**: This section is enforceable through CI/CD and runtime alerts. Failure to meet gates blocks release until mitigations are applied.

---

- See also [Tech Stack](./2a.Technical_Design_Document_TechStack.md)
- See also [Modules](./2b.Technical_Design_Document_Modules.md)
- See also [Data](./2c.Technical_Design_Document_Data.md)
- See also [Other](./2e.Technical_Design_Document_misc.md)
