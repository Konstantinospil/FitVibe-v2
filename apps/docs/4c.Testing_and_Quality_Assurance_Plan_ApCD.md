---
title: "FitVibe — Testing & Quality Assurance Plan"
version: "v3.0"
status: "Approved (MVP → GA baseline)"
review_cadence: "Per release and quarterly"
date: "2025-10-26"
license: "MIT"
---

# Appendix C — CI Gate Snippets (indicative)

# C.1 Objectives & Policy

This appendix defines **enforceable CI/CD gates** that map directly to the **Acceptance Criteria** and **RTM**. Any gate breach **fails the pipeline**. Waivers require **ID, rationale, expiry, approver (PO+Tech+QA)**, and are tracked as artifacts and issues.

**Top-level gates (blockers):**

- Coverage thresholds: repo ≥ **80%** lines & branches; critical areas (auth/sessions/points) ≥ **90%**.
- Perf budgets (p95): **auth ≤200ms · crud ≤300ms · feed ≤400ms · analytics ≤600ms**; regression guard **≤10%**.
- A11y: Lighthouse/axe score ≥ **90** on tracked screens.
- Visual: diff ≤ **0.2%** on critical pages; tokens & contrast checks pass.
- Security: **0 High/Critical** (SCA/ZAP/Images); headers policy enforced.
- Observability: metrics contract passes (`/metrics` required series).
- Supply chain: **SBOM + cosign verify + pinned digests**.
- Release safety: feature flags default **off** in prod; rollback smoke passes.

---

# C.2 Pipeline Overview

Stages (some parallelized):

1. **static** (lint, typecheck)
2. **unit+int** (coverage enforced)
3. **contract** (OpenAPI + DB)
4. **e2e** (Playwright + traces)
5. **a11y** (axe + Lighthouse)
6. **perf** (k6 budgets + regression guard)
7. **security** (SCA + ZAP baseline + image scan)
8. **visual** (snapshots + tokens + contrast)
9. **observability** (metrics contract)
10. **package** (SBOM, sign, verify, digest pinning)
11. **deploy:staging** (manual) → **release-safety smoke** → **UAT sign‑off** → **deploy:prod**

---

# C.3 GitHub Actions (reference YAML)

> Save as `.github/workflows/ci.yml`

```yaml
name: CI
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch: { {} }

env:
  NODE_OPTIONS: --max-old-space-size=4096
  PNPM_CACHE_DIR: .pnpm-store
  PLAYWRIGHT_BROWSERS_PATH: 0

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{{{ steps.cache-pnpm.outputs.cache-hit }}}}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - id: cache-pnpm
        uses: actions/cache@v4
        with:
          path: |
            .pnpm-store
            node_modules
          key: pnpm-${{{{ runner.os }}}}-${{{{ hashFiles('**/pnpm-lock.yaml') }}}}
      - run: pnpm install --frozen-lockfile

  static:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - run: pnpm -w lint && pnpm -w typecheck

  unit_int:
    needs: static
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - run: pnpm -w test -- --coverage --maxWorkers=2
      - name: Enforce coverage thresholds
        run: node ./scripts/ci/assert-coverage.mjs 80 80 90:auth,sessions,points
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage

  contract:
    needs: unit_int
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - run: pnpm --filter backend contract:test # zod ↔ OpenAPI
      - run: pnpm --filter backend db:contracts # index/FK/migration guards
      - uses: actions/upload-artifact@v4
        with:
          name: contract-reports
          path: reports/contract

  e2e:
    needs: unit_int
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - run: pnpm --filter frontend e2e -- --project ${{{{ matrix.browser }}}}
      - uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-${{{{ matrix.browser }}}}
          path: playwright-report

  a11y:
    needs: e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - run: pnpm --filter frontend a11y # axe + Lighthouse
      - run: node ./scripts/ci/assert-lighthouse.mjs 90
      - uses: actions/upload-artifact@v4
        with:
          name: accessibility-reports
          path: reports/accessibility

  perf:
    needs: contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6@v1
      - run: k6 run tests/perf/k6/budgets.js --out json=reports/perf.json
      - run: node tests/perf/k6/assert-budgets.mjs reports/perf.json               --groups auth:200 crud:300 feed:400 analytics:600               --regression 10
      - uses: actions/upload-artifact@v4
        with:
          name: perf-k6
          path: reports/perf.json

  security:
    needs: [unit_int, contract]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dependency audit (npm/OSV)
        run: pnpm -w audit:ci
      - name: Container scan (Trivy)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ghcr.io/org/fitvibe:ci
          severity: HIGH,CRITICAL
          exit-code: "1"
      - name: ZAP baseline
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: ${{{{ secrets.STAGING_URL }}}}
          rules_file_name: .zap/rules.tsv
          cmd_options: -a -I
      - uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap

  visual:
    needs: e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { { version: 9 } }
      - run: pnpm --filter frontend test:visual
      - run: node scripts/ci/assert-visual.mjs --maxDiff 0.002
      - uses: actions/upload-artifact@v4
        with:
          name: visual-diffs
          path: reports/visual

  observability:
    needs: contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: node tests/metrics/assert-prom.js
      - uses: actions/upload-artifact@v4
        with:
          name: metrics-contract
          path: reports/metrics

  package:
    needs: [security, perf, a11y, visual, observability]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: docker build -t ghcr.io/org/fitvibe:${{{{ github.sha }}}} .
      - name: SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/org/fitvibe:${{{{ github.sha }}}}
          output-file: reports/sbom.json
      - name: Cosign sign
        run: cosign sign --key env://COSIGN_KEY ghcr.io/org/fitvibe:${{{{ github.sha }}}}
        env:
          COSIGN_KEY: ${{{{ secrets.COSIGN_KEY }}}}
      - name: Cosign verify
        run: cosign verify --key env://COSIGN_PUB ghcr.io/org/fitvibe:${{{{ github.sha }}}}
        env:
          COSIGN_PUB: ${{{{ secrets.COSIGN_PUB }}}}
      - name: Enforce pinned digests
        run: node scripts/ci/assert-pinned-digests.mjs k8s/deploy/*.yaml
      - uses: actions/upload-artifact@v4
        with:
          name: supply-chain
          path: reports

  deploy_staging:
    if: github.ref == 'refs/heads/main'
    needs: package
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{{{ secrets.STAGING_URL }}}}
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        run: ./scripts/deploy.sh staging ${{{{ github.sha }}}}

  release_safety:
    needs: deploy_staging
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: pnpm -w flag:assert-defaults # must be off in prod config
      - run: pnpm --filter frontend smoke:rollback
      - run: node scripts/ci/assert-release-safety.mjs

  uat_gate:
    needs: release_safety
    runs-on: ubuntu-latest
    steps:
      - name: Require UAT sign-off
        run: node scripts/ci/assert-uat.mjs

  deploy_prod:
    if: github.event_name == 'workflow_dispatch'
    needs: uat_gate
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{{{ secrets.PROD_URL }}}}
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        run: ./scripts/deploy.sh prod ${{{{ github.sha }}}}
```

---

# C.4 Assertion Scripts (key snippets)

**Coverage gate (`scripts/ci/assert-coverage.mjs`):**

```js
import fs from "node:fs";
const summary = JSON.parse(fs.readFileSync("coverage/coverage-summary.json", "utf8"));
const repoLines = summary.total.lines.pct;
const repoBranches = summary.total.branches.pct;
const [minLines, minBranches, criticalSpec] = process.argv.slice(2);
if (repoLines < minLines || repoBranches < minBranches) process.exit(1);
// Critical packages threshold (e.g., 90%)
const [pct, list] = criticalSpec.split(":");
const critical = list.split(",");
for (const pkg of critical) {
  {
    /* read per-package coverage & assert ≥ pct */
  }
}
```

**Perf budgets (`tests/perf/k6/assert-budgets.mjs`):**

```js
// Parse k6 JSON, compute p95 by group, compare to budgets; also enforce ≤10% regression vs baseline stored in artifact.
```

**Visual diff gate (`scripts/ci/assert-visual.mjs`):**

```js
// Read Playwright diff artifacts; assert maxDiffPixelRatio ≤ 0.002 (0.2%)
```

**Metrics contract (`tests/metrics/assert-prom.js`):**

- Implements checks from **Appendix E** (names, labels, buckets, sample presence).

**Pinned digests (`scripts/ci/assert-pinned-digests.mjs`):**

```js
// Fail if any image reference is not a sha256 digest.
```

---

# C.5 Artifacts & Retention

- **coverage-html**, **playwright-traces-\***, **accessibility-reports**, **perf-k6**, **zap-report**, **visual-diffs**, **metrics-contract**, **supply-chain**.
- Retain **30 days** (or until next release) for auditability.

---

# C.6 Waivers (temporary policy)

Waiver file schema (`reports/waivers.json`):

```json
{{ "id":"WVR-2025-001", "gate":"PERF-P95", "reason":"Cold cache incident", "expires":"2025-11-15", "approver":"QA Lead + PO + Tech", "issue":"#1234" }}
```

CI step **must** validate expiry and approvers; expired waivers **fail**.

---

# C.7 Secrets, Caching & Parallelism

- Secrets in **GitHub Environments**; short‑lived tokens preferred.
- PNPM & Playwright caches enabled; browsers vendored via action.
- Parallel E2E across browsers; **fail-fast: false** to collect full signal.

---

# C.8 Required Status Checks (branch protection)

Enable **required checks**: `static`, `unit_int`, `contract`, `e2e`, `a11y`, `perf`, `security`, `visual`, `observability`, `package`.

---

# C.9 Local Parity

Provide `pnpm ci:all` to reproduce CI locally: runs all gates with sane defaults.

---

# C.10 Maintenance

- Update thresholds in lockstep with **PRD/TDD/AC** changes.
- Review flaky tests weekly; quarantine maximum **1 sprint** with issue link.
- Revisit perf budgets quarterly with traffic & infra data.

---

# Appendix D — Visual Snapshot Config (Playwright)

# D.1 Purpose

Define a **deterministic, reviewable system** for visual regression testing that protects FitVibe’s UI and **design tokens** across themes, breakpoints, and locales. Visual diffs are **release-blocking** per AC **VIZ-SNAP-02**, **VIZ-TOK-03**, **VIZ-RESP-05**, **VIZ-MOTION-09**.

**Gate:** Any unapproved diff > **0.2%** (maxDiffPixelRatio **0.002**) or token/contrast violation **fails** the pipeline.

---

# D.2 Scope

- Pages: **Auth**, **Planner**, **Logger**, **Dashboard**, **Feed**, **Profile**, **Settings**.
- Components (critical): **Navbar**, **SessionCard**, **ExerciseRow**, **PointBadge**, **ChartPanel**, **Toast**.
- Themes: **light** and **dark**.
- Breakpoints: **xs(360)**, **sm(640)**, **md(1024)**, **lg(1280)**.
- Locales: **EN** and **DE** (long-string stress on DE).
- Modes: **reduced-motion on/off**.

---

# D.3 Test Matrix

| Page/Component   | Themes     | Breakpoints    | Locales | Motion | Notes                        |
| ---------------- | ---------- | -------------- | ------- | ------ | ---------------------------- |
| Auth             | light/dark | xs, sm         | EN/DE   | both   | captcha placeholder masked   |
| Planner          | light/dark | sm, md, lg     | EN/DE   | both   | date/time masked             |
| Logger           | light/dark | sm, md         | EN/DE   | both   | live counters masked         |
| Dashboard        | light/dark | xs, sm, md, lg | EN/DE   | both   | chart animations/data masked |
| Feed             | light/dark | md, lg         | EN/DE   | both   | avatars/timestamps masked    |
| Profile/Settings | light/dark | sm, md         | EN/DE   | both   | avatar masked                |

---

# D.4 Determinism Controls

- **FakeClock**: freeze time to static UTC (e.g., `2025-10-01T12:00:00Z`).
- **Seeded data**: deterministic fixtures for sessions/exercises/points.
- **Network stability**: mock analytics; record/replay API with MSW.
- **Font loading**: self-hosted test fonts (no FOIT/FOUT); CSS `font-display: swap` disabled in tests.
- **Animations**: set `prefers-reduced-motion` for baseline; validate parity when **on**.
- **Dynamic regions masked**: timestamps, avatars, sparklines, animated loaders.

---

# D.5 Repository Layout

```
apps/frontend/
├─ tests/visual/
│  ├─ config/
│  │  ├─ playwright.config.ts
│  │  ├─ mask.ts
│  │  ├─ themes.ts
│  │  ├─ viewport.ts
│  ├─ helpers/
│  │  ├─ fakeClock.ts
│  │  ├─ msw.ts
│  │  └─ seed.ts
│  ├─ pages/
│  │  ├─ auth.spec.ts
│  │  ├─ planner.spec.ts
│  │  ├─ logger.spec.ts
│  │  ├─ dashboard.spec.ts
│  │  ├─ feed.spec.ts
│  │  └─ profile_settings.spec.ts
│  └─ components/
│     ├─ navbar.spec.tsx
│     ├─ sessionCard.spec.tsx
│     └─ pointBadge.spec.tsx
└─ reports/visual/   # diff artifacts (CI uploads)
```

---

# D.6 Playwright Config (reference)

> Save as `apps/frontend/tests/visual/config/playwright.config.ts`

```ts
import { defineConfig, devices } from "@playwright/test";

const light = { name: "light", colorScheme: "light" as const };
const dark = { name: "dark", colorScheme: "dark" as const };

const viewports = [
  { name: "xs", width: 360, height: 900 },
  { name: "sm", width: 640, height: 900 },
  { name: "md", width: 1024, height: 900 },
  { name: "lg", width: 1280, height: 900 },
];

export default defineConfig({
  testDir: "../",
  reporter: [["html", { outputFolder: "../../playwright-report" }], ["list"]],
  use: {
    baseURL: process.env.APP_URL || "http://localhost:5173",
    timezoneId: "UTC",
    locale: "en-US",
    geolocation: { latitude: 52.52, longitude: 13.405 }, // Berlin for consistency
    colorScheme: "light",
    viewport: { width: 1024, height: 900 },
    video: "off",
    trace: "on-first-retry",
  },
  projects: [
    ...[light, dark].flatMap((theme) =>
      viewports.map((vp) => ({
        name: `ui:${theme.name}:${vp.name}`,
        use: { colorScheme: theme.colorScheme, viewport: { width: vp.width, height: vp.height } },
      })),
    ),
  ],
  expect: {
    toHaveScreenshot: { maxDiffPixelRatio: 0.002 }, // 0.2%
  },
});
```

---

# D.7 Helper: Fake Clock & MSW

```ts
// helpers/fakeClock.ts
import { Page } from "@playwright/test";
export async function freezeTime(page: Page, iso = "2025-10-01T12:00:00.000Z") {
  await page.addInitScript(`{
    // Override Date.now and new Date()
    const fixed = ${Date.parse("2025-10-01T12:00:00.000Z")};
    Date.now = () => fixed;
    const _Date = Date;
    // @ts-ignore
    globalThis.Date = class extends _Date { constructor(...args){ super(args.length ? args[0] : fixed); } };
  }`);
}
```

```ts
// helpers/msw.ts - mock analytics + network stability
export async function installNetworkGuards(page) {
  await page.route("**/analytics/**", (r) => r.fulfill({ status: 204 }));
  await page.route("**/*", async (route, req) => {
    if ([".png", ".jpg", ".webp", ".gif", ".svg"].some((ext) => req.url().endsWith(ext))) {
      return route.fulfill({ status: 200, body: "" });
    }
    return route.continue();
  });
}
```

---

# D.8 Helper: Masking Dynamic Regions

```ts
// config/mask.ts
import { Page, Locator } from "@playwright/test";
export function dynamicMasks(page: Page): Locator[] {
  return [
    page.locator("[data-dynamic]"),
    page.locator('[data-testid="timestamp"]'),
    page.locator('[data-testid="avatar"] img'),
    page.locator('[data-testid="chart"] canvas'),
    page.locator(".animated,.skeleton,.loader"),
  ];
}
```

---

# D.9 Example Page Test (Dashboard)

```ts
// pages/dashboard.spec.ts
import { test, expect } from "@playwright/test";
import { freezeTime } from "../helpers/fakeClock";
import { installNetworkGuards } from "../helpers/msw";
import { dynamicMasks } from "../config/mask";

test.describe("Dashboard visual", () => {
  test.beforeEach(async ({ page }) => {
    await freezeTime(page);
    await installNetworkGuards(page);
  });

  for (const locale of ["en", "de"]) {
    for (const motion of ["reduced", "full"]) {
      test(`dashboard snapshot ${locale} ${motion}`, async ({ page }) => {
        await page.addInitScript(() => {
          const mq = window.matchMedia("(prefers-reduced-motion: reduce)");
          Object.defineProperty(mq, "matches", { value: true });
        });
        if (motion === "full") {
          await page.addStyleTag({ content: ":root { --reduce-motion: 0 }" });
        }
        await page.goto(`/dashboard?locale=${locale}`);
        await page.waitForSelector('[data-ready="true"]');
        await expect(page).toHaveScreenshot(`dashboard-${locale}-${motion}.png`, {
          mask: dynamicMasks(page),
        });
      });
    }
  }
});
```

---

# D.10 Component Snapshot Example (SessionCard)

```tsx
// components/sessionCard.spec.tsx
import { test, expect } from "@playwright/experimental-ct-react";
import SessionCard from "@/components/SessionCard";
import { dynamicMasks } from "../config/mask";

test.use({ viewport: { width: 640, height: 420 } });

test("SessionCard states", async ({ mount, page }) => {
  const props = { title: "5×5 Squats", points: 120, plannedAt: "2025-10-01" };
  await mount(<SessionCard {...props} state="planned" />);
  await expect(page).toHaveScreenshot("sessionCard-planned.png", { mask: dynamicMasks(page) });

  await mount(<SessionCard {...props} state="completed" />);
  await expect(page).toHaveScreenshot("sessionCard-completed.png", { mask: dynamicMasks(page) });
});
```

---

# D.11 Baseline Management & Review

- Baselines live under `apps/frontend/tests/visual/__screenshots__/` mirrored to CI artifact storage.
- **Change control:** baseline updates must be accompanied by **design approval** and PR description with before/after thumbnails.
- **Auto-reject** baseline updates in PRs that lack `design-ack` label.
- **Rebase conflicts:** regenerate by re-running visual suite locally with the same commit SHA.

---

# D.12 Naming Convention

`screenshots/<page|component>/<theme>/<breakpoint>/<locale>/<motion>/<name>.png`
Example: `screenshots/dashboard/dark/lg/de/reduced/dashboard-de-reduced.png`

---

# D.13 Responsive Guards (VIZ-RESP-05)

Automated checks to **fail** on horizontal overflow or layout breakage:

```ts
await expect(
  page.evaluate(() => document.body.scrollWidth <= window.innerWidth),
).resolves.toBeTruthy();
```

Long-DE strings suite:

```ts
await page.addInitScript(() => localStorage.setItem("i18n_long_strings", "1"));
```

Grids & alignment:

```ts
const box = await page.locator("[data-grid]").boundingBox();
expect(box?.width).toBeGreaterThan(0);
```

---

# D.14 Token & Contrast Checks (VIZ-TOK-03)

- Validate presence of required CSS variables: `--color-*`, `--radius-*`, `--font-size-*`, spacing scale.
- Deny ad-hoc inline overrides (lint rule).
- Contrast assertions via DevTools protocol or axe:

```ts
import axe from "axe-core";
// rules: color-contrast, aria-required-attr, focus-visible
```

---

# D.15 Flake Handling & Retries

- `expect.toHaveScreenshot` retries: **2** on CI.
- Mark tests **@flaky** only with issue link; quarantine ≤ 1 sprint.
- Non-deterministic regions must be **masked** or **stubbed**, not ignored.

---

# D.16 CI Integration

- Run after E2E; upload **`reports/visual/`** artifacts (diffs, actual, expected).
- Gate script `scripts/ci/assert-visual.mjs --maxDiff 0.002` parses Playwright JSON and fails on breach.
- PR comment bot posts thumbnails for changed baselines.

---

# D.17 Accessibility Parity (VIZ-MOTION-09)

- Ensure **visual parity** with `prefers-reduced-motion`.
- No essential information by animation alone (tooltips, progress).
- Keyboard focus ring visible and not masked.

---

# D.18 Troubleshooting

- **Large diffs**: verify fonts, dark mode tokens, seed data, clock.
- **Only on CI**: ensure headless rendering fonts installed; match device scale.
- **Transient network**: confirm asset routes mocked.
- **Canvas/charts**: always mask canvases or render with deterministic seed.

---

# D.19 Checklist (Quick)

- [ ] FakeClock + seeded data in place
- [ ] Assets mocked; analytics silenced
- [ ] Masks applied for dynamic regions
- [ ] Themes × breakpoints × locales matrix covered
- [ ] Reduced-motion parity captured
- [ ] Token & contrast checks pass
- [ ] Diff ≤ 0.2% or approved with `design-ack`
- [ ] Artifacts uploaded to `reports/visual/`

---
