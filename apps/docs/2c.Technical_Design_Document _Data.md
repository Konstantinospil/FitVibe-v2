---
title: "FitVibe Technical Design Document (TDD): Data"
version: "v2.0"
status: "Accepted"
owner: "Konstantinos Pilpilidis (Dr.)"
date: "2025-10-21"
links:
  - PRD: docs/1.Product_Requirements_Document.md
  - QA: docs/3.Testing_and_Quality_Assurance_Plan.md
  - ADR Index: docs/adr/README.md
license: "MIT"
---

# 0. Introduction

## 0.1 Purpose & Scope

This TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).

## 0.2 Audience & Reading Guide

- **Engineers** implement according to specs, contracts, and runbooks.
- **QA** uses RTM links to derive tests and quality gates.
- **Security/Compliance** verifies controls, data classification, GDPR flows.
- **Product/Design** confirms that behavior matches PRD intent.

## 0.3 Assumptions & Constraints

- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL ≥ 14 (target 16-18 locally).
- All external calls (email) are **adapterized** and mockable for tests.
- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.
- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.

## 0.4 Versioning & Changelog

- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.

---

# 6. Data Design

This section defines the **logical schema**, **entity dictionary**, **indexing strategy**, **partitioning/archival**, **retention & classification**, and the **migrations plan**.

This chapter describes the **current** FitVibe data model after the refactor to support:

- strict keys and referential integrity,
- **extensible enumerations** via `code_sets` / `code_values`,
- **typed attributes** (EAV) for fast schema evolution,
- consistent soft-delete/archival semantics,
- i18n via `translations`/`translation_fields`.

It is optimized for day-1 developer experience, long-term evolvability, and operational safety (clear ON DELETE policies, indices for hot paths, and partitioning guidance).

> Conventions: snake_case for DB identifiers; UTC timestamps; soft-delete via `deleted_at` where needed; `uuid` (preferably UUIDv7) primary keys unless noted.

---

## 6.1 Architectural Overview

The model is organized into seven layers:

1. **Identity & Security** — users, roles, sessions, tokens, profiles.
2. **Catalog & i18n** — exercises, categories, tags, translations.
3. **Planning & Logging** — plans, templates, sessions, per-set logs.
4. **Progress & Recovery** — personal records, body measurements, recovery logs.
5. **Social & Gamification** — feed, comments, followers/likes, badges/points.
6. **Media & Operations** — media assets, idempotency, audit logs.
7. **Extensibility** — `code_sets` / `code_values` for enums; `attributes` / `attribute_values` for new metrics without schema churn.

**Keys & types:** all entity IDs are `uuid`; timestamps are `timestamptz (UTC)`.
**Visibility & statuses:** formerly in-table enums are now **foreign keys** to `code_values` (e.g., `sessions.status_id → code_values.id`).

---

## 6.2 ERD

See [ERD](./diagrams/prd-7-2-1-erd-mermaid.mmd)

> Global exercises are represented with `owner_id = NULL` (admin-owned global records) and an additional check constraint.

---

## 6.3 Core Entities (day‑to‑day)

Below are the **interfaces teams build against**. Each entity lists its key constraints and noteworthy fields. Detailed column lists are in the ERD above.

### 6.3.1 Identity & Security

- **users** — account record. `status_id → code_values(user_status)`. Soft delete via `deleted_at`.
- **profiles** — 1:1 user profile; preferences as FKs to code values (gender/units/visibility).
- **roles, user_roles** — RBAC mapping with `(user_id, role_id)` as PK.
- **user_sessions** — auth device sessions with `refresh_jti` and IP/user-agent trail.
- **verification_tokens, reset_tokens** — short-lived tokens. `ON DELETE SET NULL` preserves auditability.

### 6.3.2 Catalog & i18n

- **exercise_categories, exercises** — user-owned or global exercises; archived via `archived_at`.
  Type/muscle/equipment are FKs to `code_values` (no in-table enums).
- **tags, exercise_tags** — tagging bridge.
- **translations, translation_fields** — field-level i18n with allow-list enforcement.
- **translation_cache** — optional cache (may be user-scoped).

### 6.3.3 Planning & Logging

- **plans** — user plans; `status_id` is a code value.
- **workout_templates** — reusable workouts; difficulty & visibility via code values.
  - **template_muscle_groups** — multi-select targeting (FK to `code_values(muscle_group)`).
  - **template_exercises** — ordered content of a template.
  - **template_ratings** — per-user 1–5 with `UNIQUE(template_id, user_id)`.
- **sessions** — planned/started/completed with lifecycle checks; visibility via code values.
- **session_exercises** — ordered list of exercises performed in a session.
- **exercise_sets** — set-level data incl. `rpe`, `set_type_id` (warmup, working, dropset, etc.), `tempo`, `rest_sec`, `completed`.

### 6.3.4 Progress & Recovery

- **personal_records** — time-series PRs; `is_current` partial unique ensures a single current record per `(user, exercise, metric)`.
- **body_measurements** — daily snapshot table (hot fields like weight BF%).
- **recovery_logs** — daily wellness inputs (sleep, soreness, stress, etc.).

### 6.3.5 Social & Gamification

- **feed_items** — public timeline with visibility via code values; soft delete via `deleted_at`.
- **comments** (threaded), **likes**, **followers**, **bookmarks**, **share_links** (exactly one target enforced).
- **badges, badge_awards** — static catalog + ledger of awards.
- **points_events**, **user_points_balance** — event ledger + cached totals.
- **notifications** — typed notifications with priority, grouping, and optional expiry.

### 6.3.6 Media & Operations

- **media_assets** — owned objects with target typing via code values.
- **idempotency_keys** — request dedupe with TTL.
- **audit_log** — PII-free metadata; actor optional.

---

## 6.2 Entity Dictionary

### 6.2.1 Identity & Security

#### 6.2.1.1 users

| Column         | Type        | Constraints / Notes                         |
| -------------- | ----------- | ------------------------------------------- |
| id             | uuid        | **pk**                                      |
| username       | text        | **unique**                                  |
| display_name   | text        | 0–120 chars                                 |
| password_hash  | text        | required                                    |
| status_id      | uuid        | **fk → code_values.id** (set=`user_status`) |
| locale         | text        | e.g., `en`, `de-DE`                         |
| preferred_lang | text        | ISO 639-1                                   |
| created_at     | timestamptz | default `now()`                             |
| deleted_at     | timestamptz | soft-delete                                 |

---

#### 6.2.1.2 roles

| Column      | Type | Constraints / Notes |
| ----------- | ---- | ------------------- |
| id          | uuid | **pk**              |
| code        | text | **unique**          |
| name        | text | not null            |
| description | text | nullable            |

---

#### 6.2.1.3 user_roles

| Column      | Type        | Constraints / Notes                           |
| ----------- | ----------- | --------------------------------------------- |
| user_id     | uuid        | **pk**, **fk → users.id (ON DELETE CASCADE)** |
| role_id     | uuid        | **pk**, **fk → roles.id (ON DELETE CASCADE)** |
| assigned_at | timestamptz | default `now()`                               |

---

#### 6.2.1.4 profiles

| Column                | Type         | Constraints / Notes                                                    |
| --------------------- | ------------ | ---------------------------------------------------------------------- |
| user_id               | uuid         | **pk**, **fk → users.id (ON DELETE CASCADE)**, **unique** (1:1)        |
| alias                 | text         | **unique**                                                             |
| avatar_asset_id       | uuid         | **fk → media_assets.id** (nullable)                                    |
| bio                   | text         | 0–500 chars                                                            |
| date_of_birth         | date         | **immutable after first non-null set**                                 |
| gender_id             | uuid         | **fk → code_values.id** (set=`gender`) (**immutable after first set**) |
| weight_kg             | numeric(6,2) | internally normalized to kg                                            |
| weight_unit_id        | uuid         | **fk → code_values.id** (set=`weight_unit`)                            |
| measurement_system_id | uuid         | **fk → code_values.id** (set=`measurement_system`)                     |
| unit_preferences      | jsonb        | e.g., `{"weight":"kg","distance":"km"}`                                |
| fitness_level_id      | uuid         | **fk → code_values.id** (set=`fitness_level`)                          |
| training_frequency_id | uuid         | **fk → code_values.id** (set=`training_frequency`)                     |
| visibility_id         | uuid         | **fk → code_values.id** (set=`visibility`)                             |
| timezone              | text         | e.g., `Europe/Berlin`                                                  |
| created_at            | timestamptz  | default `now()`                                                        |
| updated_at            | timestamptz  | default `now()`                                                        |
| deleted_at            | timestamptz  | soft-delete                                                            |

**Trigger:** reject updates to `date_of_birth`/`gender_id` once set (immutability). **Index:** unique on `user_id`.

---

#### 6.2.1.5 user_sessions

| Column       | Type        | Constraints / Notes                   |
| ------------ | ----------- | ------------------------------------- |
| id           | uuid        | **pk**                                |
| user_id      | uuid        | **fk → users.id (ON DELETE CASCADE)** |
| refresh_jti  | uuid        | **unique** (refresh token family id)  |
| device_id    | text        | nullable                              |
| user_agent   | text        | nullable                              |
| ip           | inet        | PII-S                                 |
| created_at   | timestamptz | default `now()`                       |
| last_used_at | timestamptz | not null                              |
| expires_at   | timestamptz | not null                              |
| revoked_at   | timestamptz | nullable                              |

---

#### 6.2.1.6 verification_tokens

| Column      | Type        | Constraints / Notes                                                             |
| ----------- | ----------- | ------------------------------------------------------------------------------- |
| id          | uuid        | **pk**                                                                          |
| user_id     | uuid        | **fk → users.id (ON DELETE SET NULL)**                                          |
| token       | text        | **unique**                                                                      |
| purpose     | text        | values in `code_values` or constrained app-side (`email_verify`,`phone_verify`) |
| expires_at  | timestamptz | not null                                                                        |
| consumed_at | timestamptz | nullable                                                                        |
| created_at  | timestamptz | default `now()`                                                                 |

---

#### 6.1.2.7 reset_tokens

| Column      | Type        | Constraints / Notes                    |
| ----------- | ----------- | -------------------------------------- |
| id          | uuid        | **pk**                                 |
| user_id     | uuid        | **fk → users.id (ON DELETE SET NULL)** |
| token       | text        | **unique**                             |
| expires_at  | timestamptz | not null                               |
| consumed_at | timestamptz | nullable                               |
| created_at  | timestamptz | default `now()`                        |

---

### 6.3 Catalog & i18n

#### 6.3.1 exercise_categories

| Column     | Type        | Constraints / Notes |
| ---------- | ----------- | ------------------- |
| id         | uuid        | **pk**              |
| slug       | text        | **unique**          |
| title      | text        | not null            |
| created_at | timestamptz | default `now()`     |

---

#### 6.3.2 exercises

| Column          | Type        | Constraints / Notes                            |
| --------------- | ----------- | ---------------------------------------------- |
| id              | uuid        | **pk**                                         |
| owner_id        | uuid        | **fk → users.id** (nullable = global exercise) |
| name            | text        | not null                                       |
| category_id     | uuid        | **fk → exercise_categories.id**                |
| type_id         | uuid        | **fk → code_values.id** (set=`exercise_type`)  |
| muscle_group_id | uuid        | **fk → code_values.id** (set=`muscle_group`)   |
| equipment_id    | uuid        | **fk → code_values.id** (set=`equipment`)      |
| is_public       | boolean     | default `false`                                |
| created_at      | timestamptz | default `now()`                                |
| updated_at      | timestamptz | default `now()`                                |
| archived_at     | timestamptz | soft archive                                   |

**Indexes:** `(owner_id, is_public)`, `(category_id)` where `archived_at IS NULL`.

---

#### 6.3.2.3 tags

| Column | Type | Constraints / Notes |
| ------ | ---- | ------------------- |
| id     | uuid | **pk**              |
| slug   | text | **unique**          |
| label  | text | not null            |

---

#### 6.3.2.4 exercise_tags

| Column      | Type | Constraints / Notes           |
| ----------- | ---- | ----------------------------- |
| exercise_id | uuid | **pk**, **fk → exercises.id** |
| tag_id      | uuid | **pk**, **fk → tags.id**      |

---

#### 6.3.2.5 translation_fields

| Column      | Type | Constraints / Notes                     |
| ----------- | ---- | --------------------------------------- |
| entity_type | text | **pk** (composite)                      |
| field_key   | text | **pk** (composite); allow-listed fields |

---

#### 6.3.2.6 translations

| Column      | Type        | Constraints / Notes                 |
| ----------- | ----------- | ----------------------------------- |
| id          | uuid        | **pk**                              |
| entity_type | text        | constrained by `translation_fields` |
| entity_id   | uuid        | target entity id                    |
| lang        | text        | ISO 639-1                           |
| field_key   | text        | allowed per `translation_fields`    |
| value       | text        | localized text                      |
| created_at  | timestamptz | default `now()`                     |
| updated_at  | timestamptz | default `now()`                     |

**Uniques:** `(entity_type, entity_id, lang, field_key)`.

---

#### 6.3.2.7 translation_cache

| Column     | Type        | Constraints / Notes                      |
| ---------- | ----------- | ---------------------------------------- |
| id         | uuid        | **pk**                                   |
| owner_id   | uuid        | **fk → users.id** (nullable)             |
| hash       | uuid        | **unique** (computed md5 of source+lang) |
| source     | text        | raw source                               |
| lang       | text        | ISO 639-1                                |
| translated | text        | translated output                        |
| created_at | timestamptz | default `now()`                          |
| expires_at | timestamptz | optional TTL                             |

---

### 6.3.4 Planning & Logging

#### 6.3.4.1 plans

| Column          | Type        | Constraints / Notes                         |
| --------------- | ----------- | ------------------------------------------- |
| id              | uuid        | **pk**                                      |
| user_id         | uuid        | **fk → users.id**                           |
| title           | text        | not null                                    |
| status_id       | uuid        | **fk → code_values.id** (set=`plan_status`) |
| recurrence_rule | text        | RFC 5545 RRULE                              |
| notes           | text        | nullable                                    |
| created_at      | timestamptz | default `now()`                             |
| updated_at      | timestamptz | default `now()`                             |
| archived_at     | timestamptz | soft archive                                |

---

#### 6.3.4.2 workout_templates

| Column                 | Type         | Constraints / Notes                        |
| ---------------------- | ------------ | ------------------------------------------ |
| id                     | uuid         | **pk**                                     |
| user_id                | uuid         | **fk → users.id**                          |
| name                   | text         | not null                                   |
| description            | text         | nullable                                   |
| estimated_duration_min | smallint     | duration minutes                           |
| difficulty_id          | uuid         | **fk → code_values.id** (set=`difficulty`) |
| times_used             | smallint     | default 0                                  |
| avg_rating             | numeric(3,2) | nullable (denormalized)                    |
| is_public              | boolean      | default `false`                            |
| visibility_id          | uuid         | **fk → code_values.id** (set=`visibility`) |
| created_at             | timestamptz  | default `now()`                            |
| updated_at             | timestamptz  | default `now()`                            |
| archived_at            | timestamptz  | soft archive                               |

---

#### 6.3.4.3 template_muscle_groups

| Column          | Type | Constraints / Notes                                       |
| --------------- | ---- | --------------------------------------------------------- |
| template_id     | uuid | **pk**, **fk → workout_templates.id (ON DELETE CASCADE)** |
| muscle_group_id | uuid | **pk**, **fk → code_values.id** (set=`muscle_group`)      |

---

#### 6.3.4.4 template_exercises

| Column      | Type        | Constraints / Notes                                    |
| ----------- | ----------- | ------------------------------------------------------ |
| id          | uuid        | **pk**                                                 |
| template_id | uuid        | **fk → workout_templates.id (ON DELETE CASCADE)**      |
| exercise_id | uuid        | **fk → exercises.id**                                  |
| order_index | int         | not null; **unique** with `(template_id, order_index)` |
| target_sets | int         | nullable                                               |
| target_reps | text        | e.g., `"8-12"`                                         |
| target_rest | text        | e.g., `"90s"`                                          |
| notes       | text        | nullable                                               |
| updated_at  | timestamptz | default `now()`                                        |

---

#### 6.3.4.5 template_ratings

| Column      | Type        | Constraints / Notes                               |
| ----------- | ----------- | ------------------------------------------------- |
| id          | uuid        | **pk**                                            |
| template_id | uuid        | **fk → workout_templates.id (ON DELETE CASCADE)** |
| user_id     | uuid        | **fk → users.id (ON DELETE CASCADE)**             |
| rating      | smallint    | **check** 1..5                                    |
| review      | text        | nullable                                          |
| created_at  | timestamptz | default `now()`                                   |
| updated_at  | timestamptz | default `now()`                                   |

**Unique:** `(template_id, user_id)`.

---

#### 6.3.4.6 sessions

| Column            | Type        | Constraints / Notes                            |
| ----------------- | ----------- | ---------------------------------------------- |
| id                | uuid        | **pk**                                         |
| owner_id          | uuid        | **fk → users.id**                              |
| plan_id           | uuid        | **fk → plans.id** (nullable)                   |
| template_id       | uuid        | **fk → workout_templates.id** (nullable)       |
| source_session_id | uuid        | **fk → sessions.id** (nullable; copied from)   |
| title             | text        | nullable                                       |
| planned_at        | timestamptz | not null                                       |
| recurrence_rule   | text        | RFC 5545 RRULE                                 |
| started_at        | timestamptz | nullable                                       |
| completed_at      | timestamptz | nullable                                       |
| status_id         | uuid        | **fk → code_values.id** (set=`session_status`) |
| visibility_id     | uuid        | **fk → code_values.id** (set=`visibility`)     |
| calories          | int         | nullable                                       |
| notes             | text        | nullable                                       |
| created_at        | timestamptz | default `now()`                                |
| updated_at        | timestamptz | default `now()`                                |
| deleted_at        | timestamptz | soft-delete                                    |

**Checks:** lifecycle coherence (planned/in_progress/completed); timestamp ordering (`completed_at >= started_at >= planned_at`).

---

#### 6.3.4.7 session_exercises

| Column      | Type        | Constraints / Notes                                   |
| ----------- | ----------- | ----------------------------------------------------- |
| id          | uuid        | **pk**                                                |
| session_id  | uuid        | **fk → sessions.id (ON DELETE CASCADE)**              |
| exercise_id | uuid        | **fk → exercises.id**                                 |
| order_index | int         | not null; **unique** with `(session_id, order_index)` |
| notes       | text        | nullable                                              |
| created_at  | timestamptz | default `now()`                                       |
| updated_at  | timestamptz | default `now()`                                       |

---

#### 6.3.4.8 exercise_sets

| Column              | Type          | Constraints / Notes                                            |
| ------------------- | ------------- | -------------------------------------------------------------- |
| id                  | uuid          | **pk**                                                         |
| session_exercise_id | uuid          | **fk → session_exercises.id (ON DELETE CASCADE)**              |
| order_index         | int           | not null; **unique** with `(session_exercise_id, order_index)` |
| reps                | smallint      | nullable                                                       |
| weight_kg           | numeric(10,2) | nullable                                                       |
| distance_m          | int           | nullable                                                       |
| duration_sec        | int           | nullable                                                       |
| rpe                 | smallint      | **check** 1..10                                                |
| set_type_id         | uuid          | **fk → code_values.id** (set=`set_type`)                       |
| tempo               | text          | e.g., `3-0-1-0`                                                |
| rest_sec            | smallint      | actual rest                                                    |
| completed           | boolean       | default `true`; `false` if skipped                             |
| notes               | text          | nullable                                                       |
| created_at          | timestamptz   | default `now()`                                                |
| updated_at          | timestamptz   | default `now()`                                                |

---

### 6.3.5 Progress & Recovery

#### 6.3.5.1 personal_records

| Column              | Type          | Constraints / Notes                                                         |
| ------------------- | ------------- | --------------------------------------------------------------------------- |
| id                  | uuid          | **pk**                                                                      |
| user_id             | uuid          | **fk → users.id**                                                           |
| exercise_id         | uuid          | **fk → exercises.id**                                                       |
| metric              | text          | e.g., `1rm; max_distance; best_time` (or via code set if preferred)         |
| value               | numeric(10,2) | not null                                                                    |
| unit                | text          | `kg; lb; m; km; sec; min; reps`                                             |
| achieved_at         | timestamptz   | not null                                                                    |
| session_exercise_id | uuid          | **fk → session_exercises.id** (nullable)                                    |
| is_current          | boolean       | partial **unique** `(user_id, exercise_id, metric) WHERE is_current = true` |
| created_at          | timestamptz   | default `now()`                                                             |

---

#### 6.3.5.2 body_measurements

| Column           | Type         | Constraints / Notes                   |
| ---------------- | ------------ | ------------------------------------- |
| id               | uuid         | **pk**                                |
| user_id          | uuid         | **fk → users.id (ON DELETE CASCADE)** |
| measurement_date | date         | **unique** with `user_id`             |
| weight_kg        | numeric(6,2) | nullable                              |
| body_fat_pct     | numeric(4,2) | nullable                              |
| chest_cm         | numeric(6,2) | nullable                              |
| waist_cm         | numeric(6,2) | nullable                              |
| hips_cm          | numeric(6,2) | nullable                              |
| thigh_cm         | numeric(6,2) | nullable                              |
| bicep_cm         | numeric(6,2) | nullable                              |
| notes            | text         | nullable                              |
| created_at       | timestamptz  | default `now()`                       |

---

#### 6.3.5.3 recovery_logs

| Column         | Type        | Constraints / Notes                   |
| -------------- | ----------- | ------------------------------------- |
| id             | uuid        | **pk**                                |
| user_id        | uuid        | **fk → users.id (ON DELETE CASCADE)** |
| log_date       | date        | **unique** with `user_id`             |
| sleep_hours    | smallint    | 0–24                                  |
| sleep_quality  | smallint    | 1–10                                  |
| soreness_level | smallint    | 1–10                                  |
| stress_level   | smallint    | 1–10                                  |
| energy_level   | smallint    | 1–10                                  |
| notes          | text        | nullable                              |
| created_at     | timestamptz | default `now()`                       |

---

### 6.3.6. Social & Gamification

#### 6.3.6.1 badges

| Column        | Type | Constraints / Notes                        |
| ------------- | ---- | ------------------------------------------ |
| id            | uuid | **pk**                                     |
| badge_type_id | uuid | **fk → code_values.id** (set=`badge_type`) |
| code          | text | **unique**                                 |
| title         | text | not null                                   |
| description   | text | nullable                                   |
| icon_url      | text | nullable                                   |
| display_order | int  | nullable                                   |

---

#### 6.3.6.2 badge_awards

| Column     | Type        | Constraints / Notes                    |
| ---------- | ----------- | -------------------------------------- |
| id         | uuid        | **pk**                                 |
| user_id    | uuid        | **fk → users.id (ON DELETE CASCADE)**  |
| badge_id   | uuid        | **fk → badges.id (ON DELETE CASCADE)** |
| awarded_at | timestamptz | not null                               |

**Unique:** `(user_id, badge_id)`.

---

#### 6.3.6.3 points_events

| Column            | Type        | Constraints / Notes                                    |
| ----------------- | ----------- | ------------------------------------------------------ |
| id                | uuid        | **pk**                                                 |
| user_id           | uuid        | **fk → users.id (ON DELETE CASCADE)**                  |
| source            | text        | e.g., `session_completed; pr_achieved; streak; social` |
| source_id         | uuid        | dedupe key component                                   |
| points            | int         | not null                                               |
| calories          | int         | optional                                               |
| algorithm_version | text        | nullable                                               |
| created_at        | timestamptz | default `now()`                                        |

**Unique:** `(user_id, source, source_id)`.

---

#### 6.3.6.4 user_points_balance

| Column          | Type        | Constraints / Notes                           |
| --------------- | ----------- | --------------------------------------------- |
| user_id         | uuid        | **pk**, **fk → users.id (ON DELETE CASCADE)** |
| total_points    | bigint      | not null                                      |
| last_updated_at | timestamptz | not null                                      |

_Maintained by trigger or job from `points_events`._

---

#### 6.3.6.5 feed_items

| Column         | Type          | Constraints / Notes                         |
| -------------- | ------------- | ------------------------------------------- |
| id             | uuid          | **pk**                                      |
| owner_id       | uuid          | **fk → users.id**                           |
| kind_id        | uuid          | **fk → code_values.id** (set=`feed_kind`)   |
| target_type_id | uuid          | **fk → code_values.id** (set=`target_type`) |
| target_id      | uuid          | polymorphic target                          |
| visibility_id  | uuid          | **fk → code_values.id** (set=`visibility`)  |
| score          | numeric(10,2) | ranking aid                                 |
| published_at   | timestamptz   | nullable                                    |
| created_at     | timestamptz   | default `now()`                             |
| updated_at     | timestamptz   | default `now()`                             |
| deleted_at     | timestamptz   | soft-delete                                 |

**Indexes:** `(visibility_id, published_at DESC)` partial for public; `(owner_id, published_at DESC)`.

---

#### 6.3.6.6 share_links

| Column       | Type        | Constraints / Notes                         |
| ------------ | ----------- | ------------------------------------------- |
| id           | uuid        | **pk**                                      |
| feed_item_id | uuid        | **fk → feed_items.id (ON DELETE SET NULL)** |
| session_id   | uuid        | **fk → sessions.id (ON DELETE SET NULL)**   |
| token        | text        | **unique**                                  |
| view_count   | int         | default 0                                   |
| max_views    | int         | optional                                    |
| expires_at   | timestamptz | optional                                    |
| created_at   | timestamptz | default `now()`                             |
| revoked_at   | timestamptz | nullable                                    |

**Check:** exactly one of (`feed_item_id`, `session_id`) is set.

---

### 6.3.6.7 followers

| Column      | Type        | Constraints / Notes                           |
| ----------- | ----------- | --------------------------------------------- |
| follower_id | uuid        | **pk**, **fk → users.id (ON DELETE CASCADE)** |
| followee_id | uuid        | **pk**, **fk → users.id (ON DELETE CASCADE)** |
| created_at  | timestamptz | default `now()`                               |

**Check:** `follower_id != followee_id`. **Index:** `(followee_id)`.

---

#### 6.3.6.8 likes

| Column       | Type        | Constraints / Notes                                |
| ------------ | ----------- | -------------------------------------------------- |
| user_id      | uuid        | **pk**, **fk → users.id (ON DELETE CASCADE)**      |
| feed_item_id | uuid        | **pk**, **fk → feed_items.id (ON DELETE CASCADE)** |
| created_at   | timestamptz | default `now()`                                    |

**Index:** `(feed_item_id, created_at DESC)`.

---

#### 6.3.6.9 bookmarks

| Column     | Type        | Constraints / Notes                              |
| ---------- | ----------- | ------------------------------------------------ |
| user_id    | uuid        | **pk**, **fk → users.id (ON DELETE CASCADE)**    |
| session_id | uuid        | **pk**, **fk → sessions.id (ON DELETE CASCADE)** |
| created_at | timestamptz | default `now()`                                  |

---

#### 6.3.6.10 comments

| Column       | Type        | Constraints / Notes                        |
| ------------ | ----------- | ------------------------------------------ |
| id           | uuid        | **pk**                                     |
| feed_item_id | uuid        | **fk → feed_items.id (ON DELETE CASCADE)** |
| user_id      | uuid        | **fk → users.id (ON DELETE CASCADE)**      |
| parent_id    | uuid        | **fk → comments.id** (nullable; threading) |
| body         | text        | **not null**                               |
| created_at   | timestamptz | default `now()`                            |
| edited_at    | timestamptz | nullable                                   |
| deleted_at   | timestamptz | tombstone                                  |

**Indexes:** `(feed_item_id, created_at)`, `(parent_id)` where not null.

---

#### 6.3.6.11 notifications

| Column         | Type        | Constraints / Notes                               |
| -------------- | ----------- | ------------------------------------------------- |
| id             | uuid        | **pk**                                            |
| user_id        | uuid        | **fk → users.id (ON DELETE CASCADE)**             |
| type_id        | uuid        | **fk → code_values.id** (set=`notification_type`) |
| actor_id       | uuid        | **fk → users.id (ON DELETE CASCADE)**             |
| target_type_id | uuid        | **fk → code_values.id** (set=`target_type`)       |
| target_id      | uuid        | id of target entity                               |
| is_read        | boolean     | default `false`                                   |
| priority_id    | uuid        | **fk → code_values.id** (set=`priority`)          |
| group_key      | text        | batching key                                      |
| group_count    | smallint    | number in batch                                   |
| expires_at     | timestamptz | optional                                          |
| created_at     | timestamptz | default `now()`                                   |
| read_at        | timestamptz | nullable                                          |

**Unique (partial):** `(user_id, type_id, target_type_id, target_id)` where `is_read=false` and `(expires_at IS NULL OR expires_at>now())`.
**Indexes:** `(user_id, created_at DESC)` with partial unread filter; `(expires_at)` partial where not null.

---

#### 6.3.6.12 leaderboard_cache_global

| Column       | Type        | Constraints / Notes                     |
| ------------ | ----------- | --------------------------------------- |
| type         | text        | leaderboard metric (e.g., `points`)     |
| period_start | date        | inclusive                               |
| period_end   | date        | exclusive/inclusive (consistent policy) |
| rank         | int         | 1-based                                 |
| user_id      | uuid        | **fk → users.id**                       |
| value        | numeric     | metric value                            |
| computed_at  | timestamptz | not null                                |

**PK:** `(type, period_start, period_end, user_id)`.

---

#### 6.3.6.13 leaderboard_cache_scoped

| Column        | Type        | Constraints / Notes                                    |
| ------------- | ----------- | ------------------------------------------------------ |
| type          | text        | leaderboard metric                                     |
| scope_type_id | uuid        | **fk → code_values.id** (`club`, `challenge`, `group`) |
| scope_id      | uuid        | referenced entity id                                   |
| period_start  | date        | inclusive                                              |
| period_end    | date        | exclusive/inclusive (consistent policy)                |
| rank          | int         | 1-based                                                |
| user_id       | uuid        | **fk → users.id**                                      |
| value         | numeric     | metric value                                           |
| computed_at   | timestamptz | not null                                               |

**PK:** `(type, scope_type_id, scope_id, period_start, period_end, user_id)`.

---

### 6.3.7 Media & Operations

#### 6.3.7.1 media_assets

| Column         | Type        | Constraints / Notes                         |
| -------------- | ----------- | ------------------------------------------- |
| id             | uuid        | **pk**                                      |
| owner_id       | uuid        | **fk → users.id (ON DELETE CASCADE)**       |
| target_type_id | uuid        | **fk → code_values.id** (set=`target_type`) |
| target_id      | uuid        | entity id                                   |
| object_key     | text        | **unique** path/key                         |
| mime_type      | text        | allow-list enforced                         |
| kind_id        | uuid        | **fk → code_values.id** (set=`media_kind`)  |
| size_bytes     | int         | not null                                    |
| width_px       | int         | nullable                                    |
| height_px      | int         | nullable                                    |
| duration_sec   | int         | nullable                                    |
| av_scan_passed | boolean     | default `false` → set `true` on clean       |
| created_at     | timestamptz | default `now()`                             |
| updated_at     | timestamptz | default `now()`                             |

**Index:** `(target_type_id, target_id)`.

---

#### 6.3.7.2 audit_log

| Column      | Type        | Constraints / Notes                       |
| ----------- | ----------- | ----------------------------------------- |
| id          | uuid        | **pk**                                    |
| actor_id    | uuid        | **fk → users.id** (nullable)              |
| action      | text        | e.g., `user.created`, `session.completed` |
| entity_type | text        | domain string                             |
| entity_id   | uuid        | entity id                                 |
| request_id  | uuid        | correlation id                            |
| meta        | jsonb       | PII-free metadata                         |
| created_at  | timestamptz | default `now()`                           |

**Indexes:** `(entity_type, entity_id, created_at DESC)`, `(actor_id, created_at DESC)` partial where actor exists.

---

#### 6.3.7.3 idempotency_keys

| Column        | Type        | Constraints / Notes                   |
| ------------- | ----------- | ------------------------------------- |
| key           | uuid        | **pk**                                |
| user_id       | uuid        | **fk → users.id** (nullable)          |
| fingerprint   | text        | not null (hash of normalized request) |
| status        | text        | `stored; completed; expired; failed`  |
| response_hash | text        | nullable                              |
| expires_at    | timestamptz | not null                              |
| created_at    | timestamptz | default `now()`                       |

**Index:** `(expires_at)` partial where `status != 'expired'`.

---

### 6.3.8 Extensibility (Enums & Attributes)

#### 6.3.8.1 code_sets

| Column      | Type        | Constraints / Notes |
| ----------- | ----------- | ------------------- |
| id          | uuid        | **pk**              |
| key         | text        | **unique**          |
| description | text        | nullable            |
| created_at  | timestamptz | default `now()`     |

---

#### 6.3.8.2 code_values

| Column     | Type | Constraints / Notes              |
| ---------- | ---- | -------------------------------- |
| id         | uuid | **pk**                           |
| set_id     | uuid | **fk → code_sets.id**            |
| code       | text | **unique** with `(set_id, code)` |
| label      | text | display label                    |
| sort_order | int  | for ordering                     |
| is_active  | bool | default `true`                   |

**Index:** `(set_id, sort_order)`.

---

#### 6.3.8.3 code_value_i18n

| Column   | Type | Constraints / Notes                         |
| -------- | ---- | ------------------------------------------- |
| value_id | uuid | **pk** (composite), **fk → code_values.id** |
| lang     | text | **pk** (composite)                          |
| label    | text | localized label                             |

---

#### 6.3.8.4 attributes

| Column         | Type        | Constraints / Notes                                    |
| -------------- | ----------- | ------------------------------------------------------ | ------- | ---- | ------- | ---- | ----------- | ----- | ----------- |
| id             | uuid        | **pk**                                                 |
| key            | text        | **unique**                                             |
| label          | text        | not null                                               |
| data_type      | text        | `int                                                   | numeric | text | boolean | date | timestamptz | jsonb | code_value` |
| unit_set_key   | text        | nullable (links to `code_sets.key` if using unit sets) |
| min_value      | numeric     | nullable                                               |
| max_value      | numeric     | nullable                                               |
| is_time_series | boolean     | default `true`                                         |
| created_at     | timestamptz | default `now()`                                        |

---

#### 6.3.8.5 attribute_scopes

| Column       | Type | Constraints / Notes                                     |
| ------------ | ---- | ------------------------------------------------------- |
| attribute_id | uuid | **pk** (composite), **fk → attributes.id**              |
| entity_type  | text | **pk** (composite); e.g., `body_measurement`, `session` |

---

#### 6.3.8.6 attribute_values

| Column        | Type        | Constraints / Notes                   |
| ------------- | ----------- | ------------------------------------- |
| id            | uuid        | **pk**                                |
| attribute_id  | uuid        | **fk → attributes.id**                |
| entity_type   | text        | scoped per `attribute_scopes`         |
| entity_id     | uuid        | target entity id                      |
| measured_at   | timestamptz | not null                              |
| unit_value_id | uuid        | **fk → code_values.id** (unit)        |
| int_value     | bigint      | one-of value columns                  |
| numeric_value | numeric     | one-of                                |
| text_value    | text        | one-of                                |
| bool_value    | boolean     | one-of                                |
| date_value    | date        | one-of                                |
| ts_value      | timestamptz | one-of                                |
| json_value    | jsonb       | one-of                                |
| code_value_id | uuid        | **fk → code_values.id** (coded value) |

**Checks:** exactly one value column is non-null; value domain matches `attributes.data_type`.
**Index:** `(entity_type, entity_id, attribute_id, measured_at DESC)`.

---

## 6.4 Extensibility Layer

### 6.4.1 Enumerations → `code_sets` / `code_values`

All former enums (status, visibility, difficulty, set types, etc.) are **data-driven**:

- `code_sets(key)` → set (e.g., `session_status`, `visibility`, `muscle_group`).
- `code_values(set_id, code, label)` → values within a set.
- Domain tables reference **`code_values.id`** (e.g., `sessions.status_id`).

**Benefits:** runtime additions, localization via `code_value_i18n`, central governance, consistent analytics.

### 6.4.2 Attributes (typed EAV) → `attributes` / `attribute_values`

Fast expansion for metrics without migrations:

- `attributes` defines a key, label, type (`int|numeric|text|boolean|date|timestamptz|jsonb|code_value`), optional unit set.
- `attribute_scopes` restricts valid entity types (e.g., `body_measurement`, `recovery_log`, `exercise_set`).
- `attribute_values` stores **exactly one** of the typed value columns per row (enforced by a CHECK).
- Units and coded values link to **`code_values`**.

**Recommended use:**

- Keep **hot fields** in base tables (e.g., `weight_kg`, `rpe`).
- Put **expanding/long-tail** metrics in attributes (e.g., HRV, circumference variants, readiness scores).

---

## 6.5 Internationalization

- `translation_fields(entity_type, field_key)` is the **allow-list** to prevent junk keys.
- `translations` stores localized text per field (unique on `entity_type, entity_id, lang, field_key`).
- `translation_cache` may store pre-rendered or AI-generated translations; not SoT.

---

## 6.6 Data Integrity & Constraints

**Keys & constraints**

- All IDs `uuid`, timestamps `timestamptz`.
- Composite PKs: `user_roles(user_id, role_id)`, `exercise_tags(exercise_id, tag_id)`, `followers(follower_id, followee_id)`, etc.
- Partial unique: `personal_records(user_id, exercise_id, metric) WHERE is_current=true`.
- Ordering uniques: `session_exercises(session_id, order_index)` and `exercise_sets(session_exercise_id, order_index)`.

**ON DELETE policies (high-level)**

- **CASCADE** for dependent private data: `profiles`, `user_sessions`, `followers`, `likes`, `bookmarks`, `badge_awards`, etc.
- **SET NULL** where history should persist detached: `verification_tokens.user_id`, `reset_tokens.user_id`, `share_links` targets.
- **No cascade** for historical facts that must remain unless specifically noted.

**Critical CHECKs**

- `followers`: `follower_id != followee_id`.
- `share_links`: exactly one of (`feed_item_id`, `session_id`) is set.
- `exercise_sets.rpe`: 1..10.
- **Session lifecycle** (application/DB):
  - `planned`: `started_at IS NULL AND completed_at IS NULL`
  - `in_progress`: `started_at IS NOT NULL AND completed_at IS NULL`
  - `completed`: `started_at IS NOT NULL AND completed_at IS NOT NULL`

---

## 6.7 Indexing & Partitioning

**Hot-path indices**

- Sessions: `(owner_id, status, planned_at DESC)` and partial `WHERE deleted_at IS NULL`.
- Feed: `(visibility_id, published_at DESC)` and public partial index.
- PRs: partial `WHERE is_current=true` on `(user_id, exercise_id, metric)`.
- Notifications: `(user_id, created_at DESC) WHERE is_read=false AND (expires_at IS NULL OR expires_at>now())`.
- Translations: `(lang, entity_type, entity_id)`.
- Attributes: `(entity_type, entity_id, attribute_id, measured_at DESC)`.

**Partitioning**

- **sessions**: monthly range partitions on `planned_at` (or `started_at` if present). Keep a **default** partition. Archive or detach partitions ≥ 24 months old.
- **audit_log**, **points_events**: consider monthly partitions at scale; else retain single table + time-based retention and vacuum tuning.
- Optional: cold partitions on cheaper storage; keep query router aware of active windows.

---

## 6.8 Soft-Delete, Archival & Retention

- **Soft delete**: `users.deleted_at`, `feed_items.deleted_at`, `sessions.deleted_at`.
- **Archive**: content catalogs like `exercises.archived_at`, `workout_templates.archived_at`.
- **GDPR / DSR**: private user content cascaded or anonymized per controller policy; backup purge ≤ 14 days.

| Table                          | Classification                 | Default Retention        | Delete / DSR Behavior                                                              |
| ------------------------------ | ------------------------------ | ------------------------ | ---------------------------------------------------------------------------------- |
| users                          | PII-S                          | Lifetime of account      | Tombstone then hard-delete after grace; cascade/anonymize children per table rules |
| profiles                       | PII-B                          | Lifetime                 | Hard-delete with user                                                              |
| user_sessions                  | PII-S                          | 90d active, 30d revoked  | Hard-delete                                                                        |
| verification_tokens            | PII-S                          | TTL (e.g., 15m/1h)       | Auto-purge on expire/consume                                                       |
| reset_tokens                   | PII-S                          | TTL (e.g., 15m/24h)      | Auto-purge                                                                         |
| exercise_categories            | Public/Admin                   | N/A                      | Keep                                                                               |
| tags                           | Public/Admin                   | N/A                      | Keep                                                                               |
| exercises (global)             | Public/Admin                   | N/A                      | Archive via `archived_at`                                                          |
| exercises (user-owned)         | Usage/PII-B                    | Lifetime of user         | Hard-delete on DSR                                                                 |
| exercise_tags                  | Usage                          | Lifetime of parent       | Cascade with `exercises`                                                           |
| plans                          | Usage                          | Lifetime of user         | Hard-delete on DSR                                                                 |
| workout_templates              | Usage                          | Lifetime of user         | Soft archive or hard-delete on DSR                                                 |
| template_muscle_groups         | Usage                          | Lifetime of parent       | Cascade with `workout_templates`                                                   |
| template_exercises             | Usage                          | Lifetime of parent       | Cascade with `workout_templates`                                                   |
| template_ratings               | Usage/PII-B                    | Lifetime of user         | Hard-delete on DSR                                                                 |
| sessions                       | Usage (may include sensitive)  | Lifetime of user         | Hard-delete on DSR                                                                 |
| session_exercises / sets       | Usage                          | Lifetime of session      | Cascade with session                                                               |
| personal_records               | Usage/PII-B                    | Lifetime of user         | Hard-delete on DSR                                                                 |
| body_measurements              | PII-B                          | Lifetime of user         | Hard-delete on DSR                                                                 |
| recovery_logs                  | PII-B                          | Lifetime of user         | Hard-delete on DSR                                                                 |
| points_events                  | Usage                          | Lifetime of user         | Hard-delete on DSR                                                                 |
| user_points_balance            | Derived cache                  | Rebuildable              | Recompute or drop on user delete                                                   |
| badges                         | Public/Admin                   | N/A                      | Keep                                                                               |
| badge_awards                   | Usage                          | Lifetime of user         | Hard-delete on DSR                                                                 |
| feed_items                     | Public/Usage                   | Until unpublished        | Delete + cache purge                                                               |
| followers / likes / bookmarks  | Usage (social graph)           | Lifetime of user         | Cascade with user; remove edges                                                    |
| comments                       | Usage                          | Lifetime of user         | Tombstone text or hard-delete (policy decision)                                    |
| notifications                  | Usage (ephemeral)              | 90d default              | Auto-expire; purge unread on DSR                                                   |
| media_assets                   | PII-B                          | Lifetime / until removed | Delete object + metadata                                                           |
| audit_log                      | Usage/PII-S (minimized PII)    | 180d                     | Anonymize `actor_id` on DSR; keep aggregate events                                 |
| idempotency_keys               | Usage                          | 24h                      | Auto-purge                                                                         |
| translation_fields             | System config                  | N/A                      | Keep                                                                               |
| translations                   | SoT (i18n)                     | Lifetime                 | Keep unless entity is deleted                                                      |
| translation_cache              | Cache                          | TTL (e.g., 30d)          | Auto-purge                                                                         |
| leaderboard_cache_global       | Cache                          | 30–90d                   | Purgeable                                                                          |
| leaderboard_cache_scoped       | Cache                          | 30–90d                   | Purgeable                                                                          |
| code_sets / code_values / i18n | System config                  | Lifetime                 | Keep                                                                               |
| attributes / scopes / values   | Usage/PII-B (depends on scope) | Lifetime of user         | Hard-delete on DSR                                                                 |

> **Backups:** ensure purge **≤ 14 days** after DSR hard-delete finalization.

---

## 6.9 Migration

1. **Enums → code values**
   Add `*_id` FK columns, backfill from old text codes, then make `NOT NULL` and (optionally) drop legacy text columns.

2. **Attributes enablement**
   Seed `attributes` and `attribute_scopes`; start writing new metrics to `attribute_values`.
   Keep existing hot columns for performance.

3. **Integrity**
   Ensure all composite PKs/uniques are created; enforce session lifecycle checks and `share_links` XOR check.

4. **Indexes**
   Create the hot-path indices; run `EXPLAIN ANALYZE` on feed and sessions queries to validate plans.

## 6.9.1 Migrations Strategy (Knex)

- **Pattern**: _expand/contract_. Forward migrations add schema + backfill; destructive changes guarded and scheduled. Prod down-migrations may be no-op.
- **Naming**: `YYYYMMDDHHMM__description.sql`
- **Transactional**: use transactional DDL where supported.
- **Seeds**: only global/config (no PII).

### 6.9.2 Ordered Migration List (MVP+)

1. `...__create_extensions_uuid_citext_trgm.sql`
2. `...__code_sets_values_i18n.sql` _(seed core sets)_
3. `...__users_roles_profiles_sessions.sql`
4. `...__tokens_verify_reset.sql`
5. `...__catalog_categories_tags.sql`
6. `...__exercises_core.sql`
7. `...__i18n_translation_fields_and_translations.sql` _(seed allow-list)_
8. `...__planning_plans_templates.sql` _(workout_templates, template_muscle_groups, template_exercises, template_ratings)_
9. `...__sessions_details.sql` _(session_exercises, exercise_sets)_
10. `...__progress_personal_records_body_recovery.sql`
11. `...__social_graph_and_feed.sql` _(followers, feed_items, likes, bookmarks, comments, share_links, notifications)_
12. `...__points_and_badges.sql` _(points_events, user_points_balance, badges, badge_awards)_
13. `...__media_assets.sql`
14. `...__leaderboards_global_scoped.sql`
15. `...__attributes_scopes_values.sql`
16. `...__idempotency_and_audit.sql`
17. `...__indexes_and_constraints_pass.sql` _(all partial/unique/check indexes)_
18. `...__policies_and_retention.sql` _(optional, RLS/TTL/cron)_

---

## 6.10 Entity Cheat-Sheet (selected)

- **User profile visibility** → `profiles.visibility_id → code_values(visibility)`.
- **Session status/visibility** → `sessions.status_id`, `sessions.visibility_id`.
- **Exercise typing** → `exercises.type_id`, `muscle_group_id`, `equipment_id`.
- **Set metadata** → `exercise_sets.set_type_id` (+ `tempo`, `rest_sec`, `completed`).
- **Template difficulty** → `workout_templates.difficulty_id`.
- **Notifications** → `type_id`, `priority_id`, `target_type_id`.
- **Leaderboards** → global and scoped variants; `scope_type_id` classifies scope.

---

## 6.11 Indexing Strategy & Hot Query Map

| Endpoint / Query          | Purpose                           | Suggested Index / Note                                                                                                                                                                                              |
| ------------------------- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| GET `/sessions?from..to`  | List by owner + time + status     | `CREATE INDEX idx_sessions_owner_status_time ON sessions(owner_id, status_id, planned_at DESC) WHERE deleted_at IS NULL;`                                                                                           |
| GET `/sessions?completed` | Completed by owner (recent first) | `CREATE INDEX idx_sessions_completed ON sessions(owner_id, completed_at DESC) WHERE status_id = <completed_id>;`                                                                                                    |
| GET `/exercises/search`   | Text + tag filter                 | Enable `pg_trgm`: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`<br>`CREATE INDEX idx_exercises_name_trgm ON exercises USING gin (name gin_trgm_ops);`<br>`CREATE INDEX idx_exercise_tags_tag ON exercise_tags(tag_id);` |
| GET `/feed` (public)      | Public timeline                   | `CREATE INDEX idx_feed_public_recent ON feed_items(published_at DESC) WHERE visibility_id = <public_id> AND deleted_at IS NULL;`                                                                                    |
| GET `/users/:alias`       | Resolve profile by alias          | Prefer `citext`: `ALTER TABLE profiles ALTER COLUMN alias TYPE citext;` + `CREATE UNIQUE INDEX profiles_alias_key ON profiles(alias);`                                                                              |
| Points ledger by period   | User points paging                | `CREATE INDEX idx_points_user_created ON points_events(user_id, created_at DESC);`                                                                                                                                  |
| Badge awards by user      | Profile badges                    | `CREATE INDEX idx_badge_awards_user ON badge_awards(user_id, awarded_at DESC);`                                                                                                                                     |
| Media by target           | Attachments listing               | `CREATE INDEX idx_media_target ON media_assets(target_type_id, target_id);`                                                                                                                                         |
| Notifications (unread)    | Polling latest                    | `CREATE INDEX idx_notifications_user_unread ON notifications(user_id, created_at DESC) WHERE is_read = FALSE AND (expires_at IS NULL OR expires_at > NOW());`                                                       |
| Attributes readback       | Latest time-series values         | `CREATE INDEX idx_attr_values_read ON attribute_values(entity_type, entity_id, attribute_id, measured_at DESC);`                                                                                                    |

> Validate with `EXPLAIN ANALYZE` during load tests. Balance read speed vs. write cost; avoid redundant multicolumn indexes when single-column + sort is enough.

---

## 6.12 Seed Data Policy

- **code_sets/code_values (minimum):**
  - `visibility`: `private`, `link`, `follower`, `public`
  - `session_status`: `planned`, `in_progress`, `completed`, `canceled`
  - `user_status`: `active`, `suspended`, `deleted`
  - `gender`: `man`, `woman`, `diverse`, `prefer_not_to_say`
  - `measurement_system`: `metric`, `imperial`, `mixed`
  - `weight_unit`: `kg`, `lb`
  - `fitness_level`: `beginner`, `intermediate`, `advanced`, `elite`
  - `training_frequency`: `rarely`, `1_2_per_week`, `3_4_per_week`, `5_plus_per_week`
  - `exercise_type`, `muscle_group`, `equipment`
  - `set_type`: `working`, `warmup`, `dropset`, `amrap`, `failure`
  - `feed_kind`, `target_type`, `media_kind`
  - `notification_type`: `like`, `comment`, `follow`, `pr`, `badge`, `mention`
  - `priority`: `low`, `normal`, `high`
  - `leaderboard_scope_type`: `club`, `challenge`, `group`
- **translation_fields** (allow-list):
  `(exercise, name)`, `(exercise, description)`, `(exercise, instructions)`, `(badge, title)`, `(badge, description)`, `(workout_template, name)`, `(workout_template, description)`, `(exercise_category, title)`.
- **exercise_categories**: seed minimal curated set.
- **global exercises** (admin-owned): Squat, Bench Press, Deadlift, Run, Ride, Plank (minimal, high-quality).

> All seeds are **idempotent** and environment-scoped.

---

## 6.13 Data Quality & Integrity Rules

- **Referential integrity**: FKs with explicit `ON DELETE` (cascade for session children; set-null where audit needs to persist).
- **Enumerations via FKs**: prefer `code_values` over CHECKs for domain lists. Use CHECKs for invariants (e.g., `rpe BETWEEN 1 AND 10`, session lifecycle timestamps, `share_links` XOR FK rule).
- **Soft-delete discipline**: all queries include `deleted_at IS NULL` where applicable; define partial indexes for hot paths.
- **Text search**: `pg_trgm` for fuzzy name search; consider tsvector if we expand full-text.
- **Caching/derived**: keep `user_points_balance`, leaderboard caches, and translation cache rebuildable; document refresh cadence.
- **Transactions**: nested session writes are atomic; idempotency enforced via `(user_id, source, source_id)` in `points_events`.

---

## 6.14 Backups, Restore & DR (Pointers)

- Automated daily full backups; PITR if supported.
- Verify restores monthly in staging; document RPO≤24h/RTO≤4h in §12 runbooks.
- Encryption at rest for backups; access controlled and audited.

---

**Compliance**: This schema realizes PRD FR-1...FR-8 with GDPR-aligned classification and retention. Changes require accompanying ADRs and updated QA RTM rows.

---

- See also [Tech Stack](./2a.Technical_Design_Document_TechStack.md)
- See also [Modules](./2b.Technical_Design_Document_Modules.md)
- See also [Design & Architecture](./2d.Technical_Design_Document_APIDesign.md)
- See also [Other](./2e.Technical_Design_Document_misc.md)
