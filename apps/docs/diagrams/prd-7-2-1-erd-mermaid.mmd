erDiagram
  %% ========= Core Identity =========
  users {
    uuid id PK
    string username
    string display_name
    string password_hash
    uuid status_id
    string locale
    string preferred_lang
    timestamptz created_at
    timestamptz deleted_at
  }

  roles {
    uuid id PK
    string code
    string name
    string description
  }

  user_roles {
    uuid user_id
    uuid role_id
    timestamptz assigned_at
  }

  profiles {
    uuid user_id PK
    string alias
    uuid avatar_asset_id
    string bio
    date date_of_birth
    uuid gender_id
    numeric weight_kg
    uuid weight_unit_id
    uuid measurement_system_id
    jsonb unit_preferences
    uuid fitness_level_id
    uuid training_frequency_id
    uuid visibility_id
    string timezone
    timestamptz created_at
    timestamptz updated_at
    timestamptz deleted_at
  }

  user_sessions {
    uuid id PK
    uuid user_id
    uuid refresh_jti
    string device_id
    string user_agent
    inet ip
    timestamptz created_at
    timestamptz last_used_at
    timestamptz expires_at
    timestamptz revoked_at
  }

  verification_tokens {
    uuid id PK
    uuid user_id
    string token
    string purpose
    timestamptz expires_at
    timestamptz consumed_at
    timestamptz created_at
  }

  reset_tokens {
    uuid id PK
    uuid user_id
    string token
    timestamptz expires_at
    timestamptz consumed_at
    timestamptz created_at
  }

  %% ========= Catalog & i18n =========
  exercise_categories {
    uuid id PK
    string slug
    string title
    timestamptz created_at
  }

  exercises {
    uuid id PK
    uuid owner_id
    string name
    uuid category_id
    uuid type_id
    uuid muscle_group_id
    uuid equipment_id
    boolean is_public
    timestamptz created_at
    timestamptz updated_at
    timestamptz archived_at
  }

  tags {
    uuid id PK
    string slug
    string label
  }

  exercise_tags {
    uuid exercise_id
    uuid tag_id
  }

  translation_fields {
    string entity_type
    string field_key
  }

  translations {
    uuid id PK
    string entity_type
    uuid entity_id
    string lang
    string field_key
    string value
    timestamptz created_at
    timestamptz updated_at
  }

  translation_cache {
    uuid id PK
    uuid owner_id
    uuid hash
    string source
    string lang
    string translated
    timestamptz created_at
    timestamptz expires_at
  }

  %% ========= Planning & Templates =========
  plans {
    uuid id PK
    uuid user_id
    string title
    uuid status_id
    string recurrence_rule
    string notes
    timestamptz created_at
    timestamptz updated_at
    timestamptz archived_at
  }

  workout_templates {
    uuid id PK
    uuid user_id
    string name
    string description
    smallint estimated_duration_min
    uuid difficulty_id
    smallint times_used
    numeric avg_rating
    boolean is_public
    uuid visibility_id
    timestamptz created_at
    timestamptz updated_at
    timestamptz archived_at
  }

  template_muscle_groups {
    uuid template_id
    uuid muscle_group_id
  }

  template_exercises {
    uuid id PK
    uuid template_id
    uuid exercise_id
    int order_index
    int target_sets
    string target_reps
    string target_rest
    string notes
    timestamptz updated_at
  }

  template_ratings {
    uuid id PK
    uuid template_id
    uuid user_id
    smallint rating
    string review
    timestamptz created_at
    timestamptz updated_at
  }

  %% ========= Sessions & Logging =========
  sessions {
    uuid id PK
    uuid owner_id
    uuid plan_id
    uuid template_id
    uuid source_session_id
    string title
    timestamptz planned_at
    string recurrence_rule
    timestamptz started_at
    timestamptz completed_at
    uuid status_id
    uuid visibility_id
    int calories
    string notes
    timestamptz created_at
    timestamptz updated_at
    timestamptz deleted_at
  }

  session_exercises {
    uuid id PK
    uuid session_id
    uuid exercise_id
    int order_index
    string notes
    timestamptz created_at
    timestamptz updated_at
  }

  exercise_sets {
    uuid id PK
    uuid session_exercise_id
    int order_index
    smallint reps
    numeric weight_kg
    int distance_m
    int duration_sec
    smallint rpe
    uuid set_type_id
    string tempo
    smallint rest_sec
    boolean completed
    string notes
    timestamptz created_at
    timestamptz updated_at
  }

  %% ========= Progress & Recovery =========
  personal_records {
    uuid id PK
    uuid user_id
    uuid exercise_id
    string metric
    numeric value
    string unit
    timestamptz achieved_at
    uuid session_exercise_id
    boolean is_current
    timestamptz created_at
  }

  body_measurements {
    uuid id PK
    uuid user_id
    date measurement_date
    numeric weight_kg
    numeric body_fat_pct
    numeric chest_cm
    numeric waist_cm
    numeric hips_cm
    numeric thigh_cm
    numeric bicep_cm
    string notes
    timestamptz created_at
  }

  recovery_logs {
    uuid id PK
    uuid user_id
    date log_date
    smallint sleep_hours
    smallint sleep_quality
    smallint soreness_level
    smallint stress_level
    smallint energy_level
    string notes
    timestamptz created_at
  }

  %% ========= Gamification =========
  badges {
    uuid id PK
    uuid badge_type_id
    string code
    string title
    string description
    string icon_url
    int display_order
  }

  badge_awards {
    uuid id PK
    uuid user_id
    uuid badge_id
    timestamptz awarded_at
  }

  points_events {
    uuid id PK
    uuid user_id
    string source
    uuid source_id
    int points
    int calories
    string algorithm_version
    timestamptz created_at
  }

  user_points_balance {
    uuid user_id PK
    bigint total_points
    timestamptz last_updated_at
  }

  %% ========= Feed, Social, Media =========
  feed_items {
    uuid id PK
    uuid owner_id
    uuid kind_id
    uuid target_type_id
    uuid target_id
    uuid visibility_id
    numeric score
    timestamptz published_at
    timestamptz created_at
    timestamptz updated_at
    timestamptz deleted_at
  }

  share_links {
    uuid id PK
    uuid feed_item_id
    uuid session_id
    string token
    int view_count
    int max_views
    timestamptz expires_at
    timestamptz created_at
    timestamptz revoked_at
  }

  followers {
    uuid follower_id
    uuid followee_id
    timestamptz created_at
  }

  likes {
    uuid user_id
    uuid feed_item_id
    timestamptz created_at
  }

  bookmarks {
    uuid user_id
    uuid session_id
    timestamptz created_at
  }

  comments {
    uuid id PK
    uuid feed_item_id
    uuid user_id
    uuid parent_id
    string body
    timestamptz created_at
    timestamptz edited_at
    timestamptz deleted_at
  }

  notifications {
    uuid id PK
    uuid user_id
    uuid type_id
    uuid actor_id
    uuid target_type_id
    uuid target_id
    boolean is_read
    uuid priority_id
    string group_key
    smallint group_count
    timestamptz expires_at
    timestamptz created_at
    timestamptz read_at
  }

  leaderboard_cache_global {
    string type
    date period_start
    date period_end
    int rank
    uuid user_id
    numeric value
    timestamptz computed_at
  }

  leaderboard_cache_scoped {
    string type
    uuid scope_type_id
    uuid scope_id
    date period_start
    date period_end
    int rank
    uuid user_id
    numeric value
    timestamptz computed_at
  }

  media_assets {
    uuid id PK
    uuid owner_id
    uuid target_type_id
    uuid target_id
    string object_key
    string mime_type
    uuid kind_id
    int size_bytes
    int width_px
    int height_px
    int duration_sec
    boolean av_scan_passed
    timestamptz created_at
    timestamptz updated_at
  }

  %% ========= Ops =========
  audit_log {
    uuid id PK
    uuid actor_id
    string action
    string entity_type
    uuid entity_id
    uuid request_id
    jsonb meta
    timestamptz created_at
  }

  idempotency_keys {
    uuid key PK
    uuid user_id
    string fingerprint
    string status
    string response_hash
    timestamptz expires_at
    timestamptz created_at
  }

  %% ========= Code Sets & Attributes =========
  code_sets {
    uuid id PK
    string key
    string description
    timestamptz created_at
  }

  code_values {
    uuid id PK
    uuid set_id
    string code
    string label
    int sort_order
    boolean is_active
  }

  code_value_i18n {
    uuid value_id
    string lang
    string label
  }

  attributes {
    uuid id PK
    string key
    string label
    string data_type
    string unit_set_key
    numeric min_value
    numeric max_value
    boolean is_time_series
    timestamptz created_at
  }

  attribute_scopes {
    uuid attribute_id
    string entity_type
  }

  attribute_values {
    uuid id PK
    uuid attribute_id
    string entity_type
    uuid entity_id
    timestamptz measured_at
    uuid unit_value_id
    bigint int_value
    numeric numeric_value
    string text_value
    boolean bool_value
    date date_value
    timestamptz ts_value
    jsonb json_value
    uuid code_value_id
  }

  %% ========= Relationships =========
  users ||--o{ user_roles : has
  roles ||--o{ user_roles : maps

  users ||--|| profiles : owns
  users ||--o{ user_sessions : has
  users ||--o{ verification_tokens : has
  users ||--o{ reset_tokens : has

  users ||--o{ exercises : owns
  exercise_categories ||--o{ exercises : categorizes
  exercises ||--o{ exercise_tags : tagged_by
  tags ||--o{ exercise_tags : applies

  users ||--o{ plans : owns
  users ||--o{ workout_templates : creates
  workout_templates ||--o{ template_exercises : includes
  workout_templates ||--o{ template_muscle_groups : targets
  workout_templates ||--o{ template_ratings : rated_by
  exercises ||--o{ template_exercises : used_in

  plans ||--o{ sessions : schedules
  workout_templates ||--o{ sessions : instantiates
  users ||--o{ sessions : owns
  sessions ||--o{ session_exercises : includes
  session_exercises ||--o{ exercise_sets : has
  exercises ||--o{ session_exercises : performed_in

  users ||--o{ personal_records : achieves
  exercises ||--o{ personal_records : recorded_for
  session_exercises ||--o{ personal_records : achieved_in

  users ||--o{ body_measurements : tracks
  users ||--o{ recovery_logs : logs

  users ||--o{ points_events : earns
  users ||--|| user_points_balance : balance
  badges ||--o{ badge_awards : defines
  users ||--o{ badge_awards : receives

  users ||--o{ feed_items : publishes
  feed_items ||--o{ share_links : shared_via
  sessions ||--o{ share_links : shared_via
  users ||--o{ followers : follows
  feed_items ||--o{ likes : liked_by
  sessions ||--o{ bookmarks : bookmarked_by
  feed_items ||--o{ comments : has
  comments ||--o{ comments : replies
  users ||--o{ notifications : receives

  users ||--o{ media_assets : uploads

  users ||--o{ audit_log : produces
  idempotency_keys }o--|| users : created_by

  users ||--o{ translation_cache : owns
  translation_fields ||--o{ translations : validates

  code_sets ||--o{ code_values : contains
  code_values ||--o{ code_value_i18n : localizes

  attributes ||--o{ attribute_scopes : scoped_to
  attributes ||--o{ attribute_values : recorded_as
  code_values ||--o{ attribute_values : used_as_unit
  code_values ||--o{ attribute_values : used_as_code
  users ||--o{ attribute_values : owns
  sessions ||--o{ attribute_values : owns
  exercises ||--o{ attribute_values : owns
  workout_templates ||--o{ attribute_values : owns
  plans ||--o{ attribute_values : owns
  session_exercises ||--o{ attribute_values : owns
  exercise_sets ||--o{ attribute_values : owns
  body_measurements ||--o{ attribute_values : owns
  recovery_logs ||--o{ attribute_values : owns
  personal_records ||--o{ attribute_values : owns
  feed_items ||--o{ attribute_values : owns
  comments ||--o{ attribute_values : owns
  badges ||--o{ attribute_values : owns
  badge_awards ||--o{ attribute_values : owns
  points_events ||--o{ attribute_values : owns
  user_points_balance ||--o{ attribute_values : owns
  media_assets ||--o{ attribute_values : owns
  audit_log ||--o{ attribute_values : owns
  idempotency_keys ||--o{ attribute_values : owns
  verification_tokens ||--o{ attribute_values : owns
  reset_tokens ||--o{ attribute_values : owns
  user_sessions ||--o{ attribute_values : owns
