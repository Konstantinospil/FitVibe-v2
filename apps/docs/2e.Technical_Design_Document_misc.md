---
title: "FitVibe Technical Design Document (TDD)"
version: "v2.0"
status: "Accepted"
owner: "Konstantinos Pilpilidis (Dr.)"
date: "2025-10-21"
links:
  - PRD: docs/1.Product Requirements Document.md
  - QA: docs/3.Testing and Quality Assurance Plan.md
  - ADR Index: docs/adr/README.md
license: "MIT"
---

# 0. Introduction

## 0.1 Purpose & Scope

This TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).

## 0.2 Audience & Reading Guide

- **Engineers** implement according to specs, contracts, and runbooks.
- **QA** uses RTM links to derive tests and quality gates.
- **Security/Compliance** verifies controls, data classification, GDPR flows.
- **Product/Design** confirms that behavior matches PRD intent.

## 0.3 Assumptions & Constraints

- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL â‰¥ 14 (target 16-18 locally).
- All external calls (email) are **adapterized** and mockable for tests.
- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.
- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.

## 0.4 Versioning & Changelog

- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.

---

# 10. CI/CD & Developer Experience

This section specifies the **pipeline**, **quality gates**, **artifact handling**, **release strategy**, **migration safety**, and **local developer workflow** for FitVibe. It binds §5 (Cross-Cutting), §7 (API), §8 (FE), and §9 (NFR gates) into executable automation.

---

## 10.1 Monorepo Layout & Task Graph

```
FitVibe V2/
├─ apps/
│  ├─ backend/         # Express/TS API, tests, migrations, seeds
│  └─ frontend/        # React/Vite app, tests, e2e (Playwright)
├─ packages/           # shared libs (dto, config, ui)
├─ .github/workflows/  # CI/CD pipelines
├─ docs/               # PRD, TDD, QA, ADRs, diagrams
├─ turbo.json          # task graph (build, lint, test, typecheck)
└─ docker/             # Dockerfiles & compose files
```

**Turborepo tasks (examples):**

- `build`: builds FE & BE
- `lint`: eslint + prettier check
- `typecheck`: tsc --noEmit
- `test`: unit & integration (Jest)
- `e2e`: Playwright (frontend)
- `perf`: k6 (API)
- `a11y`: axe (frontend)

---

## 10.2 CI Pipeline (GitHub Actions)

### 10.2.1 Stages & Quality Gates

1. **Prepare**: checkout, pnpm cache restore, node setup.
2. **Static checks**: `lint`, `typecheck`.
3. **Unit/Integration tests**: `test` with **coverage â‰¥ 80%** (fail below).
4. **Security**: SCA (OSV), `npm audit` (no high/critical), ZAP baseline (no high).
5. **Build**: FE & BE artifacts; generate **OpenAPI**; build Docker images.
6. **Budgets**: **Lighthouse** (LCP/TBT/CLS) and **k6** (p95 < 300 ms) - **no >10% regression** vs baseline.
7. **Artifacts**: upload OpenAPI JSON, coverage, k6/lighthouse reports; **SBOM** (Syft) and **cosign sign**.
8. **Publish images**: to GHCR with pinned digests (staging on `main` merge).
9. **CD trigger**: manual approval for production.

> Any gate failure **blocks** the pipeline (see §9.9).

### 10.2.2 Example Workflow Snippet (excerpt)

```yaml
name: ci
on:
  pull_request:
  push:
    branches: [main]
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: "pnpm" }
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint && pnpm typecheck
      - run: pnpm -w test -- --coverage
      - run: pnpm -w build
      - name: Generate SBOM
        run: syft packages dir:. -o json > sbom.json
      - name: Build & Push Images
        run: |
          docker build -f docker/backend.Dockerfile -t ghcr.io/you/fitvibe-backend:${{ github.sha }} .
          docker build -f docker/frontend.Dockerfile -t ghcr.io/you/fitvibe-frontend:${{ github.sha }} .
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/you/fitvibe-backend:${{ github.sha }}
          docker push ghcr.io/you/fitvibe-frontend:${{ github.sha }}
```

> Full YAML lives in `.github/workflows/ci.yml` and `.github/workflows/cd.yml`.

---

## 10.3 CD & Release Strategy

### 10.3.1 Environments

- **Staging**: auto-deploy on `main` merge; feature flags enabled for preview.
- **Production**: manual approval; blue/green or rolling updates via Docker Compose/Swarm/Kubernetes (as available).

### 10.3.2 Health & Rollout

- Pre-deploy: run DB connectivity + pending migrations check.
- Deploy sequence:
  1. Pull images by **digest** from GHCR.
  2. Run DB migrations (see §10.4) with safety checks.
  3. Start new app containers behind NGINX.
  4. Wait for readiness; switch traffic (blue/green) or roll one-by-one (rolling).

### 10.3.3 Rollback

- Keep last two releases' image digests.
- `compose -f docker/compose.prod.yml up -d` with previous digest labels.
- Reverse migrations only if safe; otherwise **forward-fix**.

---

## 10.4 Database Migrations in CD

- **Expand/Contract**: apply additive changes first; code reads both old/new; remove legacy in follow-up release.
- **Ordering**: use §6.7 list; CI verifies monotonic timestamps.
- **Execution**: run migrations as a **one-shot job** container with the new image and `DB_MIGRATE=true`.
- **Safety**:
  - Dry-run in staging before prod.
  - Guard-rails: blocks on long locks; statement timeout (e.g., 2 s) for risky ops.
  - Backfill tasks run asynchronously where possible.

**Failure policy**: stop rollout; keep old app version serving; investigate; apply forward-fix migration.

---

## 10.5 Artifacts, SBOM & Signing

- **OpenAPI** (`apps/backend/openapi/openapi.json`) uploaded on every CI run.
- **Coverage reports** saved as artifacts; minimum gate enforced.
- **SBOM** generated with **Syft**; container images **signed with cosign**.
- **Pinned digests** used in CD to prevent tag drift.
- Release notes include **deprecation headers** (see §7.1.1) if applicable.

---

## 10.6 Secrets & Configuration

- **.env.example** in repo with placeholders; **.env** not committed.
- CI uses **Actions secrets** and **environment protection rules** for staging/prod.
- Production JWT keys loaded from secrets manager or Actions-encrypted vars.
- Rotations documented in §12 runbooks.

---

## 10.7 Local Development (DX)

### 10.7.1 Quickstart

```bash
pnpm install
pnpm -w build    # first-time type generation
cp .env.example .env
docker compose -f docker/compose.dev.yml up -d db mailhog nginx
pnpm --filter backend migrate
pnpm --filter backend seed-dev
pnpm dev         # runs both FE & BE via turbo
```

### 10.7.2 VS Code Tasks (examples)

```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "FitVibe: Dev (FE+BE)",
      "type": "shell",
      "command": "pnpm dev",
      "group": "build"
    },
    {
      "label": "FitVibe: Build All",
      "type": "shell",
      "command": "pnpm build",
      "group": "build"
    },
    {
      "label": "FitVibe: Lint + Typecheck",
      "type": "shell",
      "command": "pnpm lint && pnpm typecheck",
      "group": "build"
    },
    {
      "label": "FitVibe: Migrate DB",
      "type": "shell",
      "command": "pnpm --filter backend migrate",
      "group": "test"
    },
    {
      "label": "FitVibe: Seed Demo Data",
      "type": "shell",
      "command": "pnpm --filter backend seed-dev",
      "group": "test"
    },
    {
      "label": "FitVibe: Rollback Last Migration",
      "type": "shell",
      "command": "pnpm --filter backend migrate:rollback",
      "group": "test"
    }
  ]
}
```

### 10.7.3 Pre-commit Hooks

- **Husky**: run `lint-staged` on staged files; prevent committing failing code.
- Conventional commits optional (e.g., `feat:`, `fix:`) for better changelogs.

### 10.7.4 Test Data & Fixtures

- Ephemeral DB for tests (Docker).
- Deterministic seeds for unit/integration; Playwright uses isolated account fixtures.

---

## 10.8 E2E, Perf & A11y in CI

- **Playwright**: headless runs on staging build (auth flow, sessions CRUD, analytics read).
- **k6**: per-route group scripts (auth, sessions, feed). Thresholds enforced.
- **Lighthouse**: CI run on built frontend; budgets: LCP < 2.5 s, TBT < 200 ms, CLS < 0.1.
- **axe**: a11y checks on core routes (see §9.6).

Reports uploaded as artifacts and linked in PR comments.

---

## 10.9 Incident Readiness in CD

- Health endpoints + synthetic probes; alerting wired to on-call channel.
- **One-click rollback** command documented; previous digests stored.
- DR drill checklist: restore latest backup to staging monthly; verify app boot + migrations on restored DB.

---

## 10.10 Governance

- Pipeline changes require PR review from **owner**.
- Exceptions to gates require **ADR** and time-bound mitigation plan.
- Security updates prioritized; dependency bot PRs obey same gates.

---

**Outcome**: CI/CD codifies the NFRs from §9 as enforceable gates, produces signed artifacts with SBOM, deploys safely with migration discipline, and supports a fast, friendly local DX.

---

# 11. Testability Hooks & Fixtures

This section makes the system **easy to test** and ensures verifiable conformance to the PRD and QA Plan. It defines **test strategy, fixtures, fakes/mocks, deterministic controls, datasets, coverage policy, CI wiring**, and **RTM mapping**. It is binding for both FE and BE.

---

## 11.1 Strategy Overview

- **Goal:** Achieve QA gates (coverage â‰¥ **80%**, perf **p95 < 300 ms**, a11y **WCAG 2.1 AA**) with fast, reliable tests.
- **Split:** Unit → Integration → E2E → Non-functional (security, perf, a11y).
- **Determinism:** Clock/ID/mail are controllable; tests are order-independent; data isolated per test.
- **Artifacts:** Coverage, OpenAPI, k6/Lighthouse/axe reports uploaded in CI.

---

## 11.2 Test Pyramid & Ownership

| Layer         | Scope                             | Tools                                  | Runs In          | Owner         |
| ------------- | --------------------------------- | -------------------------------------- | ---------------- | ------------- |
| Unit          | pure functions, schemas, services | Jest (ts-jest), Vitest (FE)            | Node/JSdom       | Module author |
| Integration   | API routes + DB, migrations       | Jest + Supertest + Dockerized Postgres | Container        | BE            |
| E2E (FE)      | user flows across UI/API          | Playwright                             | Headless browser | FE            |
| Security      | headers, auth flows, ZAP baseline | ZAP, custom checks                     | CI               | Sec/BE        |
| Performance   | per-route groups & FE budgets     | k6, Lighthouse                         | CI               | BE/FE         |
| Accessibility | critical screens                  | axe                                    | CI               | FE            |

---

## 11.3 Test Environments

- **Unit:** in-memory, no DB; mocks for adapters.
- **Integration:** ephemeral Postgres container; run **migrations** from §6.7; seed minimal data; cleanup between tests.
- **E2E:** start backend on ephemeral port + built frontend (or dev server); use isolated test accounts; external adapters set to fakes (mail).
- **Data separation:** unique **schema** or random database per run to avoid cross-test interference.

---

## 11.4 Fixtures & Factories (Backend)

- **Factories** (TypeScript): `makeUser`, `makeSession`, `makeExercise`, `makePointsEvent` with sensible defaults and override options.
- **Seeds (integration):** minimal **global** data only: exercise categories, 3 global exercises, 3 badges.
- **Per-test data:** created via factories inside transactions; rollback after test (or truncate selective tables).
- **Clock control:** test helper exposes `setNow()`; DB timestamps rely on app clock to remain deterministic.

**Example (pseudo):**

```ts
const u = await makeUser({ alias: "alice" });
const s = await makeSession({ ownerId: u.id, plannedAt: nowPlus(1, "day") });
```

---

## 11.5 Fakes, Mocks & Stubs

- **Mail adapter:** Fake transport capturing **outbox** in memory/JSON; assertions on recipients & subjects; renders both text & HTML.
- **AV scanner:** Fake returns `clean` by default; EICAR string triggers `malware`.
- **Feature flags:** Test harness toggles 2FA, public feed discovery, admin global exercises.
- **External time/uuid:** `FakeClock`, `DeterministicUuid` for reproducible snapshots.

---

## 11.6 Determinism Controls

- **Clock:** single source of time (DI) for API and jobs; tests call `clock.freeze('2025-10-13T12:00:00Z')`.
- **IDs:** use ULID/UUIDv7 factory with seeded randomness.
- **Randomness:** all PRNG seeded; property-based tests use fixed seeds for snapshots.

---

## 11.7 Datasets & Golden Files

- **Golden responses** for selected endpoints: `/sessions`, `/analytics/summary`. Stored under `apps/backend/tests/golden/**`.
- **k6 datasets**: CSV/JSON users & session payloads sized for load profiles in §9.2.1.
- **Lighthouse config** with budgets used in CI; thresholds committed under `apps/frontend/.lighthouse/`.
- **axe rulesets**: baseline for critical screens.

---

## 11.8 Module-Specific Test Hooks (FR Mapping)

| FR             | Critical Hooks                                                                                  | Notes                                       |
| -------------- | ----------------------------------------------------------------------------------------------- | ------------------------------------------- |
| FR-1 Auth      | Fake mail; token TTLs; lockout counters; 2FA TOTP with deterministic secret; session revoke API | Assert no user enumeration; headers present |
| FR-2 Profile   | Avatar upload with AV fake; alias collision; visibility matrix                                  | `citext` uniqueness; reserved names         |
| FR-3 Exercises | Global vs user-owned permissions; search indices; archive flow                                  | Text/trigram & GIN search                   |
| FR-4 Sessions  | Transactional nested writes; idempotency replay; clone/complete                                 | 409 on payload mismatch for same key        |
| FR-5 Analytics | Matview refresh after completion; large-range slicing                                           | 1MB cap; perf budget                        |
| FR-6 Points    | Idempotent ledger; anomaly spikes alert                                                         | Backfill rate limit                         |
| FR-7 Feed      | Publish/unpublish; link-token lifecycle; visibility                                             | Token revoke → 404                          |
| FR-8 i18n      | Token coverage; locale negotiation                                                              | Fallback to EN tracked in dev               |

---

## 11.9 Coverage Policy

- **Thresholds (repo-wide):** **Lines â‰¥ 80%**, **Branches â‰¥ 80%**.
- **Critical files** (auth, sessions writes, analytics aggregation): individual file floor **â‰¥ 90%** lines.
- CI fails below thresholds; coverage reports published per package.

---

## 11.10 CI Wiring

- **Commands** (workspace root):
  - `pnpm -w test -- --coverage` (unit+integration, BE/FE)
  - `pnpm --filter backend perf` (k6)
  - `pnpm --filter frontend a11y` (axe)
  - `pnpm --filter frontend e2e` (Playwright)
- **Artifacts:** `coverage/**`, `k6/**.json`, `lighthouse/**.json`, `axe/**.json`, screenshots/videos from Playwright.
- **Parallelization:** matrix jobs per package; DB service shared via network for integration.

---

## 11.11 RTM Mapping (QA)

A minimal RTM slice is embedded for quick checks; full matrix lives in QA Plan.

| PRD Ref  | TDD Section | Test Layer   | Evidence                                       |
| -------- | ----------- | ------------ | ---------------------------------------------- |
| FR-1     | §4.1, §7.2  | Unit/Int/E2E | auth.spec.ts, tokens.spec.ts, e2e-auth.spec.ts |
| FR-4     | §4.4, §7.5  | Int/E2E      | sessions.spec.ts, e2e-sessions.spec.ts         |
| NFR-Perf | §5.3, §9    | k6           | k6-report.json, perf-thresholds.yaml           |
| NFR-A11y | §8.5, §9    | axe          | axe-summary.json                               |
| NFR-Sec  | §5.1        | ZAP/headers  | zap-report.html, headers.spec.ts               |

---

## 11.12 Frontend Testability

- **data-testid** attributes on interactive elements (stable, documented).
- **Mock Service Worker (MSW)** for FE unit/integration tests; E2E uses real API.
- **Visual regression** optional (Phase 2) via Playwright snapshots for critical pages.

---

## 11.13 Error Injection & Chaos (Test Mode)

- Toggle SMTP failure, DB read-only, object-store latency via env flags:
  - `TEST_FAIL_SMTP=1`, `TEST_DB_READONLY=1`, `TEST_OBJSTORE_SLOW_MS=500`.
- Verify user-facing remediation and correct HTTP statuses/timeouts.

---

## 11.14 Example Test Specs (Illustrative)

- **auth.spec.ts**: register → verify → login → refresh → reuse-detected refresh → family revoke; lockout after N attempts; 2FA enable/disable.
- **sessions.spec.ts**: create (idempotent), update nested, complete, clone; 409 on mismatched replay; transactional rollback on set validation fail.
- **analytics.spec.ts**: after session completion, matview refresh exposes updated PRs; wide range returns 413.
- **feed.spec.ts**: publish/unpublish; link token access; revoke returns 404.
- **uploads.spec.ts**: EICAR blocked; metadata persisted on clean; EXIF stripped; private ACL.

---

## 11.15 Tooling & Helpers

- **Test logger** with lower verbosity; prints `requestId` on failure.
- **DB helpers**: `truncateAll()`, `withTransaction(testFn)`.
- **OpenAPI validator** optional: ensure routes conform to schema in tests.

---

## 11.16 Exit Criteria (Per PR/Release)

- All tests green; coverage thresholds met.
- Perf/a11y/security gates pass (see §9.9).
- No flaky tests (quarantined tests block merge).
- Artifacts uploaded and linked in PR.
- If any exception, an ADR documents scope and timeline to return to baseline.

---

**Assurance**: With these hooks and fixtures, FitVibe's features are **verifiable** and **repeatable** across environments. Deviations require ADRs and updates to the QA Plan.

---

# 12. Operations & Runbooks

This section defines **repeatable, checklist-driven procedures** for operating FitVibe safely: monitoring, incident response, **JWT key rotation**, **session revocation**, **GDPR DSR delete**, **backup/restore drills**, **partition rotation**, **media AV failures**, **rollbacks**, and **DR**. It binds to §5 (security/privacy), §6 (data), §7 (API), §9 (NFRs), and §10 (CI/CD).

> Golden rule: **Prefer forward-fix.** Keep production changes **audited** in `audit_log` and/or infra logs. Any deviation requires an ADR entry.

---

## 12.1 On-Call Overview

**Primary objective**: restore service within SLOs (latency p95 < 300 ms, error rate < 0.5%).

- **Hours**: business-hours for MVP (extend later).
- **Dashboards**: API latency/error, DB health, job queues, AV scan failures, Web Vitals.
- **Alerts** (from §9.7.3): p95 breach, 5xx spike, DB saturation, queue backlog, AV failure spike.
- **Escalation**: Primary → Owner (Konstantinos) → Infra support (if applicable).
- **Communication**: status note in commit log/ops channel; user-facing status page (Phase 2).

---

## 12.2 Health Checks & Fast Triage

### 12.2.1 Checklist (Triage in ≤ 10 minutes)

1. **Readiness**: `GET /health/readiness` must be 200 and show DB OK, object store OK.
2. **Logs**: Scan last 15 minutes for `level=error`, top `error.code`.
3. **DB**: Check `connections`, `locks`, long-run queries (`pg_stat_activity`).
4. **Queue/Jobs**: backlog age; retry spikes.
5. **Recent deploy?** If yes, consider **rollback** (see §12.7).

### 12.2.2 Common Remedies

- Restart single API pod/container if memory leak; keep one instance serving.
- Pause background workers if they contend with API.
- Scale up replicas temporarily if CPU-bound (ensure DB headroom).

---

## 12.3 Incident Response Playbook

### 12.3.1 Severity Levels

- **SEV-1**: user-visible outage/degradation > 10 min.
- **SEV-2**: partial impairment; workarounds exist.
- **SEV-3**: non-urgent bug; no user impact.

### 12.3.2 Actions

- Assign **Incident Commander** (IC).
- Start timeline log: who/what/when.
- Contain: rate-limit, feature-flag risky paths, rollback if recent deploy.
- Communicate: internal note; (public status Phase 2).
- Recover: apply forward-fix or rollback.
- Postmortem within 48h; attach to ADR or `/docs/postmortems/`.

---

## 12.4 JWT Key Rotation (RS256 via JWKS)

**Goal**: rotate signing keys without invalidating legitimate sessions. Rotation window typically **7 days**.

### 12.4.1 Prereqs

- Keys stored in secrets manager or encrypted vars.
- JWKS endpoint served internally (`/internal/.well-known/jwks.json`).
- API reads active `kid` from env/config; verifies against JWKS (accepts old+new).

### 12.4.2 Procedure

1. **Generate** new keypair: `kid=new-YYYYMMDD`. Keep old as `kid=old-YYYYMMDD`.
2. **Publish** new public key to JWKS (append).
3. **Deploy** API config with `ACTIVE_KID=new-YYYYMMDD`. New tokens are issued with new `kid`.
4. **Observe**: error rate on auth; ensure both keys validate.
5. **Wait** until all old **access tokens** expire (e.g., 15 min) + buffer.
6. **Revoke old refresh families** only if compromised; otherwise maintain until natural expiry.
7. **Remove** old key from JWKS after **rotation window**; keep private part archived securely.

### 12.4.3 Rollback

- Set `ACTIVE_KID` to previous `kid`; ensure JWKS still contains the old key.

**Audit**: record `key_rotation` event in `audit_log` with `new_kid`, `old_kid`.

---

## 12.5 Session Revocation (Compromise Response)

**Use when** a device is lost or suspicious reuse detected.

1. **Identify** `user_id` / `sid` from alert/log.
2. **Revoke** session (or family) via admin API: `POST /auth/sessions/revoke` with scope.
3. **Force logout**: deny refresh for revoked `sid`; access tokens expire naturally (short TTL).
4. **Notify user** via security email with geo/time hints (no IP in clear-text).
5. **Optional**: rotate user's 2FA backup codes.

**Verification**: attempt refresh with old token must fail; audit log records revocation.

---

## 12.6 GDPR DSR - Export & Delete

### 12.6.1 Export (Subject Access Request)

1. Verify requester identity (logged-in, email challenge).
2. Queue export job for `user_id`.
3. **Assemble bundle**: users, profile, sessions, exercises, points, badges, feed items, media **metadata** (not binaries by default).
4. Sign bundle hash; store in temporary object store location.
5. Email secure download link (expires in 24 hours).

### 12.6.2 Delete (Right to Erasure)

1. Verify identity; warn about **irreversibility**.
2. Mark account `DELETED(PENDING_PURGE)`; disable login.
3. **Async purge**:
   - Hard-delete private content: sessions, exercises (user-owned), points, feed items, media objects.
   - Anonymize `audit_log` (`user_id` null).
4. **Backups**: schedule purge to propagate in **≤ 14 days**; document completion timestamp.
5. Send confirmation email when finished.

**Edge cases**: Public/shared items are removed and caches purged. Legal hold is **not** expected in MVP; if needed, add exemption ADR.

---

## 12.7 Release Rollback

**Triggers**: p95 latency or 5xx breach post-deploy, migrations failure, critical bug.

### 12.7.1 Checklist

1. **Freeze** new traffic: disable auto-scaler changes.
2. **Switch** to previous image digests (kept per §10.3.3).
3. **Re-run readiness** until green.
4. **Database**: avoid down migrations; prefer forward-fix. If down is safe, run with caution in off-hours.
5. **Unfreeze**; monitor alerts for 30 minutes.

**Post-rollback**: create **forward-fix** ticket and ADR note.

---

## 12.8 Backup & Restore Drill

- **Backup**: daily full; PITR if supported; encrypted, access-controlled.
- **Monthly drill (staging)**:
  1. Provision fresh DB instance.
  2. Restore latest backup; record **RTO** time.
  3. Start app against restored DB; run migrations if needed.
  4. Sanity test: login, list sessions, create dummy session.
  5. Document **RPO** (data freshness) and discrepancies.

Failures are blockers; fix before next release.

---

## 12.9 Partition Rotation & Vacuum Policy

- **sessions** (monthly partitions):
  - **Create** next month's partition 7 days before month-end.
  - **Detach/Archive** partitions older than 24 months (move to cheaper storage or drop after retention).
  - Run `VACUUM (ANALYZE)` weekly and after large deletes.

- **audit_log / points_events** (if partitioned): same cadence when volume high.

**Script**: part-rotate job runs weekly; logs actions to `audit_log` with `action=partition_rotate`.

---

## 12.10 Media AV Failure Handling

1. Upload receives `suspect` or `malware` from AV.
2. Return `422 E.MEDIA.MALWARE` to client; store quarantine metadata (no public access).
3. Alert on spike in `av_scan_failures_total`.
4. Auto-purge quarantined objects after 30 days.
5. Investigate if spike: update allow-list/MIME checks; verify scanner health.

---

## 12.11 Disaster Recovery (DR) - Regional Failure

- **Objective**: RTO ≤ 4 h, RPO ≤ 24 h.
- **Cold standby** environment definition: infra templates, secrets, and images digests available.
- **Procedure**:
  1. Provision DB from last backup in DR region.
  2. Deploy images by **digest**; set env to point to DR DB and object store.
  3. Point DNS to DR edge.
  4. Validate health & critical flows.
  5. Back-migrate data upon primary recovery if bi-directional required (MVP: single failover, manual reconcile).

**Test**: annual DR exercise; document gaps.

---

## 12.12 Communication Templates (Internal)

- **Incident Start**: â€œSEV-x at HH:MM UTC. Symptom: <latency/5xx>. Last deploy: <sha>. Actions underway: <owner>.â€
- **Mitigation**: â€œApplied rollback to <digest>. Monitoring. Current error rate: x%.â€
- **Resolution**: â€œResolved at HH:MM UTC. Root cause: <short>. Follow-up: <ticket/ADR>.â€

---

## 12.13 Runbook Index (Quick Links)

- JWT Key Rotation → §12.4
- Session Revocation → §12.5
- DSR Export/Delete → §12.6
- Release Rollback → §12.7
- Backup & Restore Drill → §12.8
- Partition Rotation → §12.9
- Media AV Failure → §12.10
- Disaster Recovery → §12.11

---

## 12.14 RACI (MVP, single-owner simplified)

| Activity                | Responsible | Accountable | Consulted | Informed |
| ----------------------- | ----------- | ----------- | --------- | -------- |
| Deploy to prod          | Owner       | Owner       | -         | -        |
| Incident commander      | Owner       | Owner       | -         | -        |
| Key rotation            | Owner       | Owner       | -         | -        |
| DSR handling            | Owner       | Owner       | -         | User     |
| Backups & restore drill | Owner       | Owner       | -         | -        |

---

**Outcome**: These runbooks make operations repeatable, auditable, and aligned with FitVibe's security, privacy, and reliability targets. Keep them **current** with every release and reflect exceptions in ADRs.

---

# 13. Environments & Configuration Matrix

This section specifies **environment topology**, **configuration schema**, **required/optional variables**, **defaults**, **rotation policies**, **feature flags**, and **change control** for **Local**, **Staging**, and **Production**. It binds to §5.6 (Configuration & Secrets), §9 (NFRs), and §10 (CI/CD).

---

## 13.1 Environments Overview

| Env            | Purpose                         | Infra                                                  | Data           | Access            | API                               | Web                           |
| -------------- | ------------------------------- | ------------------------------------------------------ | -------------- | ----------------- | --------------------------------- | ----------------------------- |
| **Local**      | Dev & debugging                 | Docker Compose (API, DB, NGINX, MailHog)               | throwaway      | developer machine |
| **Staging**    | Pre-production tests, CI deploy | Same topology as prod (smaller size)                   | synthetic/test | owner only        | `https://staging.api.fitvibe.app` | `https://staging.fitvibe.app` |
| **Production** | User traffic                    | NGINX + API + Worker + Managed Postgres + Object store | real           | owner             | `https://api.fitvibe.app`         | `https://fitvibe.app`         |

---

## 13.2 Configuration Schema (Validated at Boot)

All services validate configuration on startup. Missing **required** keys cause a **non-zero exit** with a masked error summary.

| Key                               | Type                                              |           Required | Default                 | Notes                                      |
| --------------------------------- | ------------------------------------------------- | -----------------: | ----------------------- | ------------------------------------------ |
| `NODE_ENV`                        | enum(`development`,`test`,`staging`,`production`) |                Yes | `development`           |                                            |
| `PORT`                            | int                                               |                Yes | `4100`                  | API port                                   |
| `BASE_URL`                        | url                                               |                Yes | `http://localhost:4100` | external base URL                          |
| `LOG_LEVEL`                       | enum(`debug`,`info`,`warn`,`error`)               |                Yes | `info`                  | prod must be `info` or higher              |
| `DATABASE_URL`                    | string                                            |                Yes | -                       | Postgres URL                               |
| `DB_STATEMENT_TIMEOUT_MS`         | int                                               |                Yes | `2000`                  | API-side timeout                           |
| `JWT_PRIVATE_KEY`                 | pem                                               | Yes (prod/staging) | dev test key            | **secret**                                 |
| `JWT_PUBLIC_KEY`                  | pem                                               |                Yes | dev test key            |                                            |
| `ACTIVE_KID`                      | string                                            |                Yes | `dev-001`               | key id in headers                          |
| `JWKS_URL`                        | url                                               |                 No | -                       | internal JWKS, optional for dev            |
| `ACCESS_TOKEN_TTL_MIN`            | int                                               |                Yes | `15`                    | minutes                                    |
| `REFRESH_TOKEN_TTL_DAYS`          | int                                               |                Yes | `14`                    | days                                       |
| `TOTP_ENABLED`                    | bool                                              |                Yes | `false`                 | feature flag                               |
| `SMTP_HOST`                       | string                                            |                Yes | `localhost`             |                                            |
| `SMTP_PORT`                       | int                                               |                Yes | `1025`                  | MailHog in dev                             |
| `SMTP_USER`                       | string                                            |                 No | -                       | required in staging/prod                   |
| `SMTP_PASS`                       | string                                            |                 No | -                       | **secret**                                 |
| `MAIL_FROM`                       | email                                             |                Yes | `no-reply@fitvibe.app`  | sender                                     |
| `OBJECT_STORE_URL`                | url                                               |                Yes | `http://minio:9000`     | S3-compatible ok                           |
| `OBJECT_STORE_BUCKET`             | string                                            |                Yes | `fitvibe`               |                                            |
| `OBJECT_STORE_ACCESS_KEY`         | string                                            |                 No | -                       | **secret**                                 |
| `OBJECT_STORE_SECRET_KEY`         | string                                            |                 No | -                       | **secret**                                 |
| `MAX_UPLOAD_MB`                   | int                                               |                Yes | `5`                     | media limit                                |
| `CORS_ALLOW_ORIGINS`              | csv                                               |                Yes | `http://localhost:5173` | staging/prod must list exact domains       |
| `RATE_LIMIT_GLOBAL_PER5M`         | int                                               |                Yes | `300`                   | per IP                                     |
| `RATE_LIMIT_AUTH_ATTEMPTS`        | int                                               |                Yes | `10`                    | per 15 min, per account+IP                 |
| `RATE_LIMIT_REG_PERM`             | int                                               |                Yes | `5`                     | registrations per minute, per IP           |
| `RATE_LIMIT_PWDRESET_PER15M`      | int                                               |                Yes | `5`                     | password reset requests per 15 min, per IP |
| `RATE_LIMIT_SESSION_WRITES_PER5M` | int                                               |                Yes | `30`                    | session writes per 5 min, per user         |
| `AV_SCANNER_URL`                  | url                                               |                 No | -                       | if external service                        |
| `ENABLE_PUBLIC_FEED`              | bool                                              |                Yes | `false`                 | feature flag                               |
| `ENABLE_ADMIN_GLOBAL_EXERCISES`   | bool                                              |                Yes | `true`                  | feature flag                               |
| `ANALYTICS_DISABLED`              | bool                                              |                Yes | `false`                 | for privacy/testing                        |
| `METRICS_BIND_ADDR`               | string                                            |                Yes | `0.0.0.0:9400`          | Prometheus endpoint                        |
| `TRACING_ENABLED`                 | bool                                              |                Yes | `false`                 | enable OTel exporter                       |
| `OTEL_EXPORTER_OTLP_ENDPOINT`     | url                                               |                 No | -                       | if `TRACING_ENABLED=true`                  |

> **Note:** Secrets must **never** be logged or returned by diagnostics endpoints.

---

## 13.3 Environment Matrices

### 13.3.1 Local (development)

| Key                   | Value                                                                                  |
| --------------------- | -------------------------------------------------------------------------------------- |
| `NODE_ENV`            | `development`                                                                          |
| `BASE_URL`            | `http://localhost:4100`                                                                |
| `DATABASE_URL`        | `postgres://fitvibe:fitvibe@db:5432/fitvibe_dev`                                       |
| `SMTP_HOST`           | `mailhog`                                                                              |
| `SMTP_PORT`           | `1025`                                                                                 |
| `MAIL_FROM`           | `dev@fitvibe.local`                                                                    |
| `OBJECT_STORE_URL`    | `http://minio:9000`                                                                    |
| `OBJECT_STORE_BUCKET` | `fitvibe-dev`                                                                          |
| `CORS_ALLOW_ORIGINS`  | `http://localhost:5173`                                                                |
| Feature Flags         | `TOTP_ENABLED=false`, `ENABLE_PUBLIC_FEED=false`, `ENABLE_ADMIN_GLOBAL_EXERCISES=true` |

### 13.3.2 Staging

| Key                   | Value                                                                                |
| --------------------- | ------------------------------------------------------------------------------------ |
| `NODE_ENV`            | `staging`                                                                            |
| `BASE_URL`            | `https://staging.api.fitvibe.app`                                                    |
| `DATABASE_URL`        | managed Postgres staging                                                             |
| `SMTP_HOST`           | provider host                                                                        |
| `SMTP_USER/PASS`      | set via secrets                                                                      |
| `MAIL_FROM`           | `no-reply@staging.fitvibe.app`                                                       |
| `OBJECT_STORE_URL`    | S3 or compatible                                                                     |
| `OBJECT_STORE_BUCKET` | `fitvibe-staging`                                                                    |
| `CORS_ALLOW_ORIGINS`  | `https://staging.fitvibe.app`                                                        |
| Feature Flags         | `TOTP_ENABLED=true`, `ENABLE_PUBLIC_FEED=true`, `ENABLE_ADMIN_GLOBAL_EXERCISES=true` |

### 13.3.3 Production

| Key                   | Value                                                                                |
| --------------------- | ------------------------------------------------------------------------------------ |
| `NODE_ENV`            | `production`                                                                         |
| `BASE_URL`            | `https://api.fitvibe.app`                                                            |
| `DATABASE_URL`        | managed Postgres prod                                                                |
| `SMTP_HOST`           | provider host                                                                        |
| `SMTP_USER/PASS`      | set via secrets                                                                      |
| `MAIL_FROM`           | `no-reply@fitvibe.app`                                                               |
| `OBJECT_STORE_URL`    | S3 or compatible                                                                     |
| `OBJECT_STORE_BUCKET` | `fitvibe-prod`                                                                       |
| `CORS_ALLOW_ORIGINS`  | `https://fitvibe.app`                                                                |
| Feature Flags         | `TOTP_ENABLED=true`, `ENABLE_PUBLIC_FEED=true`, `ENABLE_ADMIN_GLOBAL_EXERCISES=true` |

---

## 13.4 .env.example (Excerpt)

```dotenv
# Core
NODE_ENV=development
PORT=4100
BASE_URL=http://localhost:4100
LOG_LEVEL=info

# Database
DATABASE_URL=postgres://fitvibe:fitvibe@localhost:5432/fitvibe_dev
DB_STATEMENT_TIMEOUT_MS=2000

# Auth
JWT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
...dev...
-----END PRIVATE KEY-----"
JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----
...dev...
-----END PUBLIC KEY-----"
ACTIVE_KID=dev-001
ACCESS_TOKEN_TTL_MIN=15
REFRESH_TOKEN_TTL_DAYS=14
TOTP_ENABLED=false

# Mail
SMTP_HOST=localhost
SMTP_PORT=1025
SMTP_USER=
SMTP_PASS=
MAIL_FROM=no-reply@fitvibe.local

# Object Store
OBJECT_STORE_URL=http://localhost:9000
OBJECT_STORE_BUCKET=fitvibe-dev
OBJECT_STORE_ACCESS_KEY=
OBJECT_STORE_SECRET_KEY=

# CORS
CORS_ALLOW_ORIGINS=http://localhost:5173

# Limits
MAX_UPLOAD_MB=5
RATE_LIMIT_GLOBAL_PER5M=300
RATE_LIMIT_AUTH_ATTEMPTS=10
RATE_LIMIT_REG_PERM=5
RATE_LIMIT_PWDRESET_PER15M=5
RATE_LIMIT_SESSION_WRITES_PER5M=30

# Observability
METRICS_BIND_ADDR=0.0.0.0:9400
TRACING_ENABLED=false
OTEL_EXPORTER_OTLP_ENDPOINT=
```

> The repository includes **`.env.example`**; **`.env` is not committed**. CI/CD injects secrets via environment-protected variables.

---

## 13.5 Configuration Endpoints & Diagnostics

- **`GET /health/readiness`**: includes config checks (DB reachable, object store ping). **Never** dumps secrets.
- **`GET /config` (optional, guarded)**: returns **non-secret** runtime flags needed by the client (e.g., feature flags, max upload MB, locales).
- **Metrics** (`/metrics`): exposes standard metrics (see §5.4).

---

## 13.6 Change Control & Rollout

- **Config changes** tracked via Git for non-secrets, and via secret manager history for secrets.
- **Two-person rule** optional (Phase 2); MVP requires owner approval for staging/prod.
- **Rollout**: staging first; verify dashboards and smoke tests; then promote to production.
- **Audit**: record `config_change` in `audit_log` including changed keys (masked) and actor.

---

## 13.7 Secrets Handling & Rotation

- Secrets stored in secret manager or GH Actions environment secrets.
- **JWT keys** rotated per §12.4; other secrets rotated **quarterly** or on incident.
- Avoid long-lived credentials; prefer tokens with scopes.
- Never print secrets in logs; redact suspicious values in error messages.

---

## 13.8 Feature Flags & Kill-Switches

| Flag                            | Default                              | Scope | Notes                                  |
| ------------------------------- | ------------------------------------ | ----- | -------------------------------------- |
| `TOTP_ENABLED`                  | `false` (dev), `true` (staging/prod) | BE+FE | Enables 2FA setup/verify UIs and flows |
| `ENABLE_PUBLIC_FEED`            | `false` (dev), `true` (staging/prod) | BE+FE | Allows public/link visibility          |
| `ENABLE_ADMIN_GLOBAL_EXERCISES` | `true`                               | BE+FE | Admin CRUD for global library          |
| `KILL_SWITCH_ANALYTICS`         | `false`                              | FE    | Hide analytics pages under stress      |
| `READ_ONLY_MODE`                | `false`                              | BE    | Blocks writes except admin             |

**Kill-switches** are loaded at startup; certain critical ones (e.g., `READ_ONLY_MODE`) can be polled on an interval (e.g., 30s) to toggle without redeploy.

---

## 13.9 Safe Defaults

- **Production hardening** set automatically when `NODE_ENV=production`:
  - `LOG_LEVEL=info` (no debug), `CORS_ALLOW_ORIGINS` must be explicit domains,
  - cookies `Secure` and `SameSite`, HSTS enabled, error messages generic,
  - rate limits enabled with non-zero thresholds, analytics enabled but non-PII.

- **Staging** mimics production; emails are **sandboxed** to a safe domain or disabled for real recipients.

---

## 13.10 Drift Detection

- CI step validates `.env.example` vs runtime config schema and flags **missing/extra keys**.
- A nightly job hits `/health/readiness` and checks a **config hash** exposed there to detect unexpected drift across replicas.

---

## 13.11 Ownership & Approvals

- **Owner** approves changes in staging/prod.
- Emergency changes allowed only to mitigate incidents; an ADR documents rationale and remediation plan within 48 hours.

---

**Outcome**: Configuration is **explicit, validated, and auditable**. Environments remain consistent, secrets safe, and feature flags give controlled flexibility without risking security or reliability.

---

# 14. Risks, Assumptions, and Constraints

This section tracks **known risks**, **explicit assumptions**, and **hard constraints** for the MVP. Each risk has an owner, mitigation, and verification hook so it can be managed in day-to-day work and reflected in ADRs when design changes are needed.

---

## 14.1 Risk Register (MVP)

Legend: **L**=Likelihood (Low/Med/High), **I**=Impact (Low/Med/High), **R**=Risk Level (LÃ—I)

| ID   | Risk                                                                   | L   | I   | R     | Mitigation / Controls                                                                                                      | Contingency / Triggers                                                                               | Owner | Status |
| ---- | ---------------------------------------------------------------------- | --- | --- | ----- | -------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | ----- | ------ |
| R-01 | **Bus factor = 1** (solo owner); delayed incident response or releases | H   | H   | **H** | Documented runbooks (§12); CI/CD automation (§10); infra as code; keep rollback one command away; small, frequent releases | If on-call unavailable → extend maintenance window; pause feature work; prioritize automation & docs | Owner | Open   |
| R-02 | API performance misses p95 < 300 ms under spikes                       | M   | H   | **H** | Hot-index map (§6.3); k6 gates (§9.2.4); caching/ETag; DB timeouts                                                         | Auto-scale API; enable read-only mode for heavy analytics                                            | Owner | Open   |
| R-03 | Security headers or CORS misconfig in prod                             | M   | H   | **H** | NGINX template checked-in; CI header tests; ZAP baseline (§9.3)                                                            | Immediate config rollback; block deploys until fixed                                                 | Owner | Open   |
| R-04 | Token reuse/refresh rotation bugs → session hijack window              | L   | H   | **M** | Reuse detection, family revoke; short access TTL; deterministic tests (§11)                                                | Force global logout; rotate keys (§12.4)                                                             | Owner | Open   |
| R-05 | GDPR DSR delete not fully propagated to backups in ≤14d                | M   | M   | **M** | Delete queue with audit trail; backup purge checklist (§12.6)                                                              | Temporarily disable new signups; manual purge + postmortem                                           | Owner | Open   |
| R-06 | Media uploads accept malware or PII leaks via EXIF                     | M   | M   | **M** | AV scan + EXIF strip; MIME allow-list; quarantine and alerts (§5.1.6, §12.10)                                              | Block uploads; rotate allow-list; incident notice if required                                        | Owner | Open   |
| R-07 | Analytics queries exceed 1 MB / time budgets                           | M   | M   | **M** | Enforce server-side slicing; matviews; CI perf gates                                                                       | Temporarily disable analytics endpoints (§9.5)                                                       | Owner | Open   |
| R-08 | Vendor lock-in: object store / SMTP provider                           | M   | M   | **M** | Adapter pattern; config via env; smoke tests                                                                               | Switch provider via config; replay failed jobs                                                       | Owner | Open   |
| R-09 | Data corruption from nested session writes                             | L   | H   | **M** | Single-transaction writes; schema constraints; property tests                                                              | Run repair job from audit; restore from backup if needed                                             | Owner | Open   |
| R-10 | Rate-limit tuning blocks legitimate users or allows abuse              | M   | M   | **M** | Metrics for 429; separate per-IP & per-account buckets; `Retry-After`                                                      | Adjust buckets; add captcha (Phase 2)                                                                | Owner | Open   |
| R-11 | i18n token coverage gaps or fallback errors                            | M   | L   | **L** | CI coverage check; fallback EN; telemetry in dev                                                                           | Hotfix missing tokens; add lint                                                                      | Owner | Open   |
| R-12 | Schema migrations cause locks/outage                                   | L   | H   | **M** | Expand/contract, statement timeouts, staging dry-run (§10.4)                                                               | Rollback app; forward-fix migration                                                                  | Owner | Open   |
| R-13 | Observability cardinality explosion                                    | M   | M   | **M** | Label allow-list; route templates; alerts on series count (§5.4)                                                           | Drop high-card labels; reduce sample rate                                                            | Owner | Open   |
| R-14 | Legal/ToS exposure from public feed content                            | L   | H   | **M** | Private by default; takedown workflow; audit for admin actions (§4.7, §5.2)                                                | Disable public feed flag; remove offending content                                                   | Owner | Open   |
| R-15 | Cost overrun (DB size, object storage, egress)                         | M   | M   | **M** | Lifecycle rules; partition/archival; logging sampling                                                                      | Tighten retention; scale down non-critical services                                                  | Owner | Open   |

**Review cadence:** weekly scan; update status and add ADRs for structural mitigations.

---

## 14.2 Assumptions (Make them explicit)

1. **MVP user base** is modest (≤ a few thousand monthly active), allowing single-node API + managed Postgres to meet SLOs.
2. **Email delivery** via a reliable SMTP provider with acceptable deliverability from day 1 (DKIM/SPF configured).
3. **Static i18n** (EN/DE) is sufficient for MVP;
4. **No legal hold** scenarios for data deletion in MVP; full removal is permissible after identity verification.
5. **Browser target**: modern evergreen browsers; no IE/legacy edge cases.
6. **Single region** hosting is acceptable for MVP with DR plan in §12.11.
7. **Users accept** typical password and 2FA flows; social login is not required in MVP.

> If any assumption breaks, raise an ADR to capture the pivot and its design impact.

---

## 14.3 Constraints (Non-negotiables for MVP)

- **Security/Privacy**: RS256 JWT with refresh rotation; CSP/HSTS/Referrer/Permissions headers; **no PII** in logs/metrics.
- **GDPR**: DSR export & delete supported; backup purge ≤ **14 days** after deletion completion.
- **Performance**: API **p95 < 300 ms**; FE **LCP < 2.5 s** (P75); payload caps (req ≤ 2 MB, resp ≤ 1 MB).
- **Quality**: **Coverage â‰¥ 80%** repo-wide; ZAP baseline no high findings; k6/Lighthouse budgets enforced in CI.
- **Reliability**: RPO ≤ 24 h; RTO ≤ 4 h; health/readiness endpoints mandatory.
- **Architecture**: Postgres primary; REST/JSON; `/api/v1` versioning; additive changes only in v1.
- **Operations**: Blue/green or rolling deploy; migrations follow expand/contract; signed images + SBOM.
- **Compliance artifacts**: PRD/TDD/QA kept in sync; RTM updated when features change.

---

## 14.4 Open Questions / TBDs

- _(Resolved)_ Exact token TTLs: **email verification = 15 minutes** (see §4.1.5).
- **Admin scope** for global exercise library moderation (future: proposals from users?).
- **Public feed discovery**: will there be search/hashtags in MVP or only direct links/user profiles?
- **Object storage** choice for prod (S3 vs self-hosted MinIO); cost/performance trade-offs.
- **Tracing exporter**: enable in prod from day 1 or after initial stabilization?
- **Access model** for analytics sharing (exportable images/links?).

Each TBD should be resolved via an ADR before release.

---

## 14.5 Risk Heatmap (Textual)

```
Impact
High   : [R-01][R-02][R-03][R-04][R-12][R-14]
Medium : [R-05][R-06][R-07][R-08][R-09][R-10][R-13][R-15]
Low    : [R-11]

         Low     Med     High
Likelihood
Low      R-04    R-09    R-12
Medium   R-11    R-05    R-02 R-03 R-06 R-07 R-08 R-10 R-13 R-15
High     R-01    -       -
```

---

## 14.6 Links to Related ADRs (Planned)

- **ADR-001**: API Versioning Policy (v1 additive; v2 for breaking changes).
- **ADR-002**: Auth Tokens & Rotation Strategy.
- **ADR-003**: Data Retention & GDPR Backup Purge Window.
- **ADR-004**: Media Upload Safety & AV Scanning.
- **ADR-005**: Partitioning Strategy for `sessions` and `audit_log`.
- **ADR-006**: Observability Cardinality Policy.
- **ADR-007**: Idempotency Policy for Writes
- **ADR-008**: Materialized Views for Analytics
- **ADR-009**: Global Exercise Library Ownership Model
- **ADR-010**: Public/Link/Private Visibility Model
- **ADR-011**: Internationalization – Hybrid Model with MVP Static-Only Rollout
- **ADR-012**: Monorepo Structure, Tooling, and Governance
- **ADR-013**: Modular Backend Architecture (Router → Service → Repository)
- **ADR-014**: Technology Stack & Runtime Standards
- **ADR-015**: API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged
- **ADR-016**: Security Middleware & Audit Logging
- **ADR-017**: Avatar Handling & Media Storage (Object Storage + AV Scan)
- **ADR-018**: CI/CD with GitHub Actions and GHCR
- **ADR-019**: Caching & Performance Strategy
- **ADR-020**: Accessibility Compliance (WCAG 2.1 AA) & Inclusive UX
- **ADR-021**: Standardize Backend Test Runner on Jest 30 + @swc/jest

---

**Maintenance**: Update this register at the end of each sprint/release. Risks that require structural changes must reference an ADR and update PRD/QA acceptance where applicable.

---

# 15. ADR Index & References

This section catalogs the **Architecture Decision Records (ADRs)** that govern FitVibe's design and implementation, and provides a consolidated **reference list** to source documents. Every material change to architecture, data, security, or contracts must be captured by an ADR and cross-linked from the PRD, TDD, and QA Plan (traceability).

---

## 15.1 ADR Process

- **Format**: MADR style (lightweight Markdown). One decision per file.
- **Location**: `docs/adr/ADR-XXX-title.md` (three-digit, zero-padded index).
- **Status lifecycle**: `Proposed → Accepted → Superseded → Deprecated`.
- **Change control**: Any PR touching §5 (security), §6 (data), §7 (API), or §9 (NFRs) must reference an **ADR** (new or existing).
- **Linking**: Each ADR must link the affected sections: PRD §_, TDD §_, QA §\*, and list impacted tests/gates.
- **Decision date**: UTC date in header.
- **Rationale & consequences**: mandatory; list alternatives considered.
- **Supersession**: if an ADR replaces another, set `Supersedes:`/`Superseded by:` headers.

All ADR IDs must **match the filename** under `docs/adr/` and every accepted ADR must link back to the exact sections it changes (PRD/TDD/QA).

### 15.1.1 ADR Template (copy/paste)

```markdown
---
id: ADR-XXX
title: "<Short, imperative decision>"
status: "Proposed | Accepted | Superseded | Deprecated"
date: "YYYY-MM-DD"
supersedes: "ADR-YYY (optional)"
superseded_by: "ADR-ZZZ (optional)"
owners: ["Konstantinos Pilpilidis (Dr.)"]
links:
  - PRD: "docs/1. Product Requirements Document.md#<section>"
  - TDD: "docs/2. Technical Design Document.md#<section>"
  - QA: "docs/3. Testing and Quality Assurance Plan.md#<section>"
---

## Context

<Problem statement, constraints, drivers, stakeholders>

## Decision

<What is decided; include exact contracts/values if applicable>

## Status & Consequences

<Operational, security, cost, and team impact; migration plan if any>

## Alternatives Considered

- Alternative A : pros/cons
- Alternative B : pros/cons

## Implementation Notes

<Follow-up tasks, feature flags, rollout, telemetry/alerting>

## Backout Plan

<Rollback steps or superseding ADR plan>
```

---

## 15.2 ADR Index (Planned & Suggested)

> Populate as decisions are made. The IDs and titles below reflect items already implied by the TDD/PRD/QA and should be created early.

| ID      | Title                                                                                    | Status      | Summary                                                                                                                                              | Decision Date | Links                                                         |
| ------- | ---------------------------------------------------------------------------------------- | ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- | ------------------------------------------------------------- |
| ADR-001 | API Versioning Policy (v1 additive; v2 for breaking changes)                             | ✅ Accepted | `/api/v1` is stable; additive fields only; deprecations use `Deprecation/Sunset` headers; breaking changes land in `/api/v2` with 2-release overlap. | 2025-10-13    | TDD §7.1.4, §7.1.1                                            |
| ADR-002 | Auth Tokens & Rotation Strategy                                                          | ✅ Accepted | RS256 JWT with 15m access, 14d refresh; refresh rotation + reuse detection; JWKS-based key rotation.                                                 | 2025-10-13    | TDD §5.1.1, §12.4                                             |
| ADR-003 | Data Retention & GDPR Backup Purge Window                                                | ✅ Accepted | Classification table; DSR delete hard-deletes private content and purges backups ≤14 days; audit trail.                                              | 2025-10-13    | TDD §6.6, §12.6                                               |
| ADR-004 | Media Upload Safety & AV Scanning                                                        | ✅ Accepted | AV scan before persistence; allow-list MIME; EXIF strip; quarantine on suspect/malware; alerting.                                                    | 2025-10-13    | TDD §5.1.6, §12.10                                            |
| ADR-005 | Partitioning Strategy for `sessions` (monthly)                                           | ✅ Accepted | Range partition on `planned_at` with default partition; rotate & archive after 24 months.                                                            | 2025-10-13    | TDD §6.4, §12.9                                               |
| ADR-006 | Observability Cardinality Policy                                                         | ✅ Accepted | Route templates in labels, bounded label sets, no PII; alerts on series count growth.                                                                | 2025-10-13    | TDD §5.4                                                      |
| ADR-007 | Idempotency Policy for Writes                                                            | ✅ Accepted | `Idempotency-Key` header; 24h storage; 409 on payload mismatch; deterministic replay.                                                                | 2025-10-13    | TDD §5.7, §7.14                                               |
| ADR-008 | Materialized Views for Analytics                                                         | ✅ Accepted | Use matviews for `session_summary`, `weekly_aggregates`; incremental refresh on writes + scheduled.                                                  | 2025-10-13    | TDD §4.5, §6.3                                                |
| ADR-009 | Global Exercise Library Ownership Model                                                  | ✅ Accepted | Admin-owned global records (`owner_id = NULL`); user-owned duplicates allowed via normalized uniqueness.                                             | 2025-10-13    | TDD §4.3, §6.2.6                                              |
| ADR-010 | Public/Link/Private Visibility Model                                                     | ✅ Accepted | Resource visibility enum with default **private**; link tokens revocable; public feed feature-flagged.                                               | 2025-10-13    | TDD §4.7, §7.8                                                |
| ADR-011 | Internationalization – Hybrid Model with MVP Static-Only Rollout                         | ✅ Accepted | Static UI catalogs (EN/DE) for MVP; feature-flagged AI translation for UGC with caching, PII redaction, and DSR purge.                               | 2025-10-14    | [ADR-011](./ADR-011-internationalization-hybrid-approach.md)  |
| ADR-012 | Monorepo Structure, Tooling, and Governance                                              | ✅ Accepted | pnpm workspaces + optional Turbo; Dockerized CI; governance via CODEOWNERS, changesets, and feature flags.                                           | 2025-10-14    | [ADR-012](./ADR-012-monorepo-structure.md)                    |
| ADR-013 | Modular Backend Architecture (Router → Service → Repository)                             | ✅ Accepted | Three-layer modules (router/service/repo); strict authz, audit, caching seams; Knex migrations.                                                      | 2025-10-14    | [ADR-013](./ADR-013-modular-backend-architecture.md)          |
| ADR-014 | Technology Stack & Runtime Standards                                                     | ✅ Accepted | Node/Express, React/Vite, Postgres + Knex, object storage for media, strong headers/CSRF/RBAC; OpenAPI in CI.                                        | 2025-10-14    | [ADR-014](./ADR-014-technology-stack.md)                      |
| ADR-015 | API Design & Internationalization (Hybrid) – MVP Static, UGC Translation Feature-Flagged | ✅ Accepted | REST/JSON `/v1`, RFC7807 errors, idempotency, cursor pagination; i18n hybrid at API with feature flag.                                               | 2025-10-14    | [ADR-015](./ADR-015-api-design-and-i18n-hybrid.md)            |
| ADR-016 | Security Middleware & Audit Logging                                                      | ✅ Accepted | CSP/HSTS/Referrer/Permissions, CSRF, RBAC; PII-free audit logs with correlation IDs and tamper-evidence.                                             | 2025-10-14    | [ADR-016](./ADR-016-audit-logging-and-security-middleware.md) |
| ADR-017 | Avatar Handling & Media Storage (Object Storage + AV Scan)                               | ✅ Accepted | Server-mediated uploads; AV scan; EXIF strip; derivatives; signed URLs; private-by-default.                                                          | 2025-10-14    | [ADR-017](./ADR-017-avatar-handling-base64.md)                |
| ADR-018 | CI/CD with GitHub Actions and GHCR                                                       | ✅ Accepted | GitHub Actions with quality gates; GHCR images with SBOM/provenance; OIDC, signed releases, manual prod gate.                                        | 2025-10-14    | [ADR-018](./ADR-018-ci-cd-github-ghcr.md)                     |
| ADR-019 | Caching & Performance Strategy                                                           | ✅ Accepted | Layered caching with explicit invalidation; API p95 < 300 ms; LCP < 2.5 s; fail on >10% regression.                                                  | 2025-10-14    | [ADR-019](./ADR-019-caching-and-performance-strategy.md)      |
| ADR-020 | Accessibility Compliance (WCAG 2.1 AA) & Inclusive UX                                    | ✅ Accepted | Semantics-first components, keyboard flows, contrast, alt text; Lighthouse/axe in CI with ≥90 score.                                                 | 2025-10-14    | [ADR-020](./ADR-020-accessibility-compliance.md)              |
| ADR-021 | Standardize Backend Test Runner on Jest 30 + @swc/jest                                   | ✅ Accepted | Adopt _Jest 30_ with _@swc/jest_ for the backend test runner (unit + integration with Supertest), replacing ts-jest.                                 | 2025-10-14    | [ADR-021](./ADR-021-test-runner-backend-jest30-sw.md)         |

> When an ADR is **Accepted**, update the `Status` column and add its file path in the Links cell (e.g., `docs/adr/ADR-001-api-versioning.md`).

---

## 15.3 Reference Documents (Repository Canon)

| Doc                                       | Purpose                                  | Path                                            |
| ----------------------------------------- | ---------------------------------------- | ----------------------------------------------- |
| **PRD** - Product Requirements Document   | WHAT & WHY                               | `docs/1. Product Requirements Document.md`      |
| **TDD** - Technical Design Document       | HOW (architecture, data, APIs)           | `docs/2. Technical Design Document.md`          |
| **QA Plan** - Testing & Quality Assurance | HOW WELL (tests, gates, RTM)             | `docs/3. Testing and Quality Assurance Plan.md` |
| **SECURITY** - Security & Privacy Policy  | Normative security posture, GDPR anchors | `docs/SECURITY.md` (planned)                    |
| **Tasks.md / Roadmap**                    | Delivery planning, milestones            | `docs/Tasks.md`                                 |
| **Changelog**                             | User-visible changes per release         | `CHANGELOG.md`                                  |
| **Contributing**                          | Repo standards, coding guide             | `CONTRIBUTING.md`                               |

---

## 15.4 How to Add a New ADR (Checklist)

1. **Create file** `docs/adr/ADR-XYZ-title.md` from the template in §15.1.1.
2. Fill **Context → Decision → Consequences → Alternatives**.
3. Cross-link affected sections in PRD/TDD/QA.
4. Add to table in §15.2 with `Proposed` status.
5. Submit PR; on approval, set status to `Accepted` and add decision date.
6. If superseding a prior ADR, update both records' headers accordingly.
7. Ensure related **tests/gates** are updated (coverage, perf, a11y, security).

---

## 15.5 Governance & Review Cadence

- **Owner** approves ADRs; complex ones can include an optional design review meeting.
- ADRs that impact external contracts (APIs, data retention, privacy) require **explicit mention** in the release notes.
- Conduct a **quarterly sweep** to retire deprecated ADRs and confirm no drift between ADRs and implementation.

---

**Outcome**: With ADRs rigorously maintained and referenced here, architectural intent stays **explicit, auditable, and synchronized** with the PRD, TDD, and QA Plan.

---

- See also [Tech Stack](./2a.Technical_Design_Document_TechStack.md)
- See also [Modules](./2b.Technical_Design_Document_Modules.md)
- See also [Data](./2c.Technical_Design_Document_Data.md)
- See also [Design & Architecture](./2d.Technical_Design_Document_APIDesign.md)
