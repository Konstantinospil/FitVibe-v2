---
title: "FitVibe Technical Design Document (TDD): Tech Stack"
version: "v2.0"
status: "Accepted"
owner: "Konstantinos Pilpilidis (Dr.)"
date: "2025-10-21"
links:
  - PRD: docs/1.Product_Requirements_Document.md
  - QA: docs/3.Testing_and_Quality_Assurance_Plan.md
  - ADR Index: docs/adr/README.md
license: "MIT"
---

# 0. Introduction

## 0.1 Purpose & Scope

This TDD specifies **how** the FitVibe system will implement the features and constraints defined in the [PRD](.\1.Product_Requirements_Document.md) (WHAT/WHY) and satisfy the [QA Plan](4.%20Testing_and_Quality_Assurance_Plan.md) (HOW WELL).

## 0.2 Audience & Reading Guide

- **Engineers** implement according to specs, contracts, and runbooks.
- **QA** uses RTM links to derive tests and quality gates.
- **Security/Compliance** verifies controls, data classification, GDPR flows.
- **Product/Design** confirms that behavior matches PRD intent.

## 0.3 Assumptions & Constraints

- Monorepo with **pnpm** workspaces; Node.js 20 LTS; React 18; PostgreSQL ≥ 14 (target 16-18 locally).
- All external calls (email) are **adapterized** and mockable for tests.
- Privacy-by-design: **private-by-default** content, explicit consent for public sharing.
- Deployments run behind **TLS** with reverse proxy (NGINX) and **Let's Encrypt** certificates.

## 0.4 Versioning & Changelog

- **Change policy:** Any change to interfaces, schema, or security controls must update TDD and the related ADR, and link into QA RTM.

---

# 1. Traceability & Scope Mapping

This section provides a **mini RTM** that maps PRD **FR/NFR** - **TDD sections** (where the design lives) - **QA** acceptance and gates (where it is verified). The full RTM remains in the QA Plan; this table ensures the TDD is self-contained.

## 1.1 Mini RTM (FR focus)

| PRD FR | Summary              | TDD Sections (design anchors)                             | QA References (tests/gates)                        |
| ------ | -------------------- | --------------------------------------------------------- | -------------------------------------------------- |
| FR-1   | Auth & Authorization | §3 (standards), §4.1 (modules), §5.1 (security), §7 (API) | Login/Reg/Verify, 2FA, lockout, brute-force limits |
| FR-2   | Users & Profiles     | §4.2, §6 (schema), §7 (API)                               | Profile CRUD, alias uniqueness, privacy defaults   |
| FR-3   | Exercise Library     | §4.3, §6 (schema & indexing), §7 (API)                    | Owner/global admin library, search/perf            |
| FR-4   | Planning & Sessions  | §4.4, §6 (relations), §7                                  | Create/plan/log, recurrence, idempotency           |
| FR-5   | Progress & Analytics | §4.5, §6 (views/matlzd), §7                               | Aggregations accuracy/perf budgets                 |
| FR-6   | Points & Badges      | §4.6, §6, §7                                              | Deterministic rules, anti-cheat                    |
| FR-7   | Feed & Sharing       | §4.7, §5.1/§5.2, §7                                       | Privacy-by-default, link sharing                   |
| FR-8   | i18n (static MVP)    | §4.8, §3.5, §5.5                                          | Locale switch, fallback, token coverage            |

## 1.2 Mini RTM (NFR focus)

| NFR           | Target                                      | Design Anchor                      | QA Gate                                 |
| ------------- | ------------------------------------------- | ---------------------------------- | --------------------------------------- |
| Performance   | API p95 < 300 ms; LCP < 2.5 s               | §5.3 perf, §6 indexes, §2 topology | k6 thresholds; Lighthouse budget        |
| Security      | RS256 JWT, refresh rotation, CSRF, CSP/HSTS | §5.1                               | ZAP/OWASP checks; headers verified      |
| Privacy/GDPR  | DSR export/delete; log redaction            | §5.2; §12 runbooks (later)         | DSR E2E tests; retention checks         |
| Observability | Logs, metrics, tracing                      | §5.4                               | Prometheus alerts, sampling/cardinality |
| Accessibility | WCAG 2.1 AA                                 | §5.5                               | Automated checks (CI)                   |
| Reliability   | Backups; RPO≤24h, RTO≤4h                    | §9 (later), §12 (runbooks later)   | DR drill scripts                        |

## 1.3 In/Out of Scope (MVP)

- **In:**
  - static i18n;
  - basic media upload with AV scan;
  - RBAC roles (user/admin);
  - email delivery;
  - feed with privacy controls;
  - social interactions (likes, bookmarks, comments);
  - follow/unfollow;
  - leaderboards (points weekly/monthly).
- **Out:**
  - dynamic AI translation;
  - wearable sync;
  - nutrition;
  - heavy real-time comments;
  - org/multi-tenant features.

---

# 2. System Architecture

## 2.1 Context Diagram

The [Context Diagramm](./diagrams/tdd-2-1-context-diagram.mmd) can be found in the diagrams.

**Rationale:**

- Reverse proxy terminates TLS and enforces security headers.
- Stateless BE with JWT; DB as single write authority.
- Observability collects logs/metrics/traces; no PII in labels or logs.

## 2.2 Container / Runtime View

The [Container / Runtime Diagram](.\diagrams\tdd-2-2-container-runtime-view.mmd) can be found in the documentation.

**Key responsibilities**

- **NGINX:** TLS, rate-limiting at edge, CSP/HSTS, gzip/brotli.
- **API:** REST, RBAC, validation, idempotency, audit logging.
- **Worker:** async tasks (email, cleanup, aggregation), scheduled with cron-like triggers.
- **DB:** normalized schema; partitions for large tables; materialized views for analytics.

## 2.3 Deployment Topology & Environments

- **Local:** Docker Compose (API, DB, NGINX, MailHog), seeded demo data.
- **Staging:** Same composition; points to staging SMTP; feature flags enabled for preview.
- **Production:** NGINX at edge with TLS; API behind private network; managed or self-hosted PostgreSQL with automated backups; Prometheus/Grafana/Loki stack.

**Ports & ingress**

- 443 (HTTPS) at edge; 80 only for ACME challenge; internal service ports not exposed publicly.
  **Certificates** via Let's Encrypt (auto-renew).

## 2.4 Principal Data Flows

- **Auth:** Email verification → Login (access + refresh) → Refresh rotation & revoke on use.
- **Sessions:** Client submits planned/actual session; server validates DTO → writes transactional rowset; idempotency key avoids duplicates.
- **Media Upload:** Client → API → AV scan → object stored (disk or S3-compatible) → metadata row; reject on malware.
- **Telemetry:** Structured logs and metrics emitted; correlation IDs propagate across layers.

---

# 3. Technology

The technology stack is summarized in the Table.
The high-level architecture is illustrated in [High Level Architecture](.\diagrams\prd-high-level-architecture.mmd).

This section describes the technology choices that underpin **FitVibe's architecture**.
It is divided into four subsections for clarity and separation of concerns:

1. **Backend Technology** - Application runtime, frameworks, libraries, and server-side logic.
2. **Frontend Technology** - User interface stack, styling, and accessibility libraries.
3. **Data Technology** - Database engine, schema design, and persistence tooling.
4. **Infrastructure Technology** - Deployment, CI/CD, monitoring, and scaling.

The objective is to define a **developer-ready technology baseline**, ensuring consistency across the stack, maintainability, and scalability.

## 3.1 Technology → Purpose Map (canonical)

### Technology Stack (Master Table)

| Category                          | Technologies & Details                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Frontend (Runtime & UI)**       | - **React 18 + Vite** (SPA shell, fast dev/prod builds)<br>- **React Router DOM** (client routing)<br>- **Axios** with interceptor (`401 → /auth/refresh`)<br>- **State Management**: Zustand (lightweight) or Redux (global orchestration); optional React Query for caching & background refetch<br>- **TailwindCSS** (design system, theming tokens)<br>- **Recharts** (charts for dashboards)<br>- **Lucide React** (icons)<br>- **Accessibility**: WCAG 2.1 AA, ARIA, keyboard navigation<br>- **Internationalization (future)**: EN/DE tokens |
| **Backend (Runtime & Framework)** | - **Node.js 20 LTS + Express** with modular routers (`auth`, `users`, `exercises`, `sessions`, `progress`, `points`, `feed`)<br>- **Knex.js** for SQL queries, migrations, seeds<br>- **bcryptjs** for password hashing<br>- **jsonwebtoken (RS256)** for short-lived access tokens<br>- **Refresh tokens**: server-stored, rotated by `jti`, revocable on logout<br>- Optional **TOTP 2FA** with backup codes                                                                                                                                      |
| **Authentication & Security**     | - **Helmet** for HTTP headers<br>- **CORS allowlist** (env-configured)<br>- **express-rate-limit** (per-IP & per-account throttling, optional CAPTCHA)<br>- **CSRF protection** middleware<br>- **httpOnly Secure cookies** for refresh/session<br>- **compression** for gzip responses                                                                                                                                                                                                                                                             |
| **Validation & Config**           | - **zod** for request DTO and environment schema validation<br>- **dotenv** for environment variables<br>- Strict schema enforcement (`NODE_ENV`, `DATABASE_URL`, `JWT_PRIVATE_KEY`, etc.)                                                                                                                                                                                                                                                                                                                                                          |
| **Database & Persistence**        | - **PostgreSQL 18** (primary relational datastore)<br>- **Knex.js** migrations (`YYYYMMDDHHMM__*.ts`)<br>- Constraints & indexes (e.g., `lower(username)`, partial indexes, FK cascades)<br>- Soft deletes (`deleted_at`, `archived_at`)<br>- **Backups**: daily encrypted, RPO ≤ 24h, RTO ≤ 4h<br>- **Retention policies** per entity, optional anonymization for analytics                                                                                                                                                                        |
| **File & Media Storage**          | - Local `/uploads` in dev<br>- Cloud storage (**AWS S3 / GCS**) in production<br>- Excluded from Git/Docker<br>- Optional virus scanning hook<br>- Future: avatar uploads, media constraints (JPEG/PNG/WebP ≤ 5 MB)                                                                                                                                                                                                                                                                                                                                 |
| **Email & Notifications**         | - Provider-agnostic mailer abstraction (**SMTP, SES, SendGrid, etc.**)<br>- Used for verification, password reset<br>- Backlog: unified notification system (email + push)                                                                                                                                                                                                                                                                                                                                                                          |
| **Background Jobs & Caching**     | - **Redis** (or LRU fallback in dev) for caching + rate-limit counters (Phase 2+)<br>- **BullMQ / Temporal.io** for async jobs (emails, reports, recalculations, imports)<br>- Retry handling for transient failures with exponential backoff                                                                                                                                                                                                                                                                                                       |
| **Testing Framework**             | **Jest + ts-jest** - unit and integration testing framework for backend and shared packages. Optional Cypress/Playwright for E2E in staging.                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Logging & Monitoring**          | - **pino** or **winston** for structured logs<br>- **morgan** for HTTP request logs<br>- Correlation/request IDs propagated FE→BE<br>- GDPR-compliant (exclude PII)<br>- **Metrics dashboards** (latency p95/p99, auth failures, DB saturation)<br>- **Alerting** on 5xx spikes, auth failures<br>- Tracing enabled                                                                                                                                                                                                                                 |
| **Infrastructure & DevOps**       | - **NGINX** reverse proxy (static assets, HTTPS redirect, HSTS)<br>- **Certbot (Let's Encrypt)** TLS automation & renewal<br>- **Docker / Docker Compose** (multi-stage builds, reproducible dev/prod)<br>- **GitHub Actions CI**: checkout → install (pnpm) → lint → test → build → Docker push (GHCR)<br>- **GitHub Actions CD**: manual approval → SSH deploy → `docker compose up -d`                                                                                                                                                           |
| **Environments**                  | - **Local (dev):** hot reload, verbose logs, seeded demo data<br>- **Staging (optional):** mirrors prod, pre-release validation<br>- **Production:** optimized builds, strict CORS, reduced logs, monitoring enabled                                                                                                                                                                                                                                                                                                                                |
| **Build & Release**               | - **Versioning:** `/api/v1` base path with deprecation policy<br>- **Artifacts:** Docker images tagged with commit SHA + semver<br>- **Rollback:** compose retains last good image<br>- **Static assets:** frontend built assets served by NGINX with cache headers                                                                                                                                                                                                                                                                                 |
| **Data Protection & Privacy**     | - **GDPR compliance**: DSR endpoints (export/delete), privacy notice, minimization<br>- **Cookies:** httpOnly, Secure, SameSite=Lax<br>- Upload scanning optional, user-controlled data management                                                                                                                                                                                                                                                                                                                                                  |
| **Monorepo Tooling**              | - **pnpm workspaces** for dependency mgmt<br>- **turbo** (optional) for task caching & parallelism<br>- **ESLint & Prettier** configs at root<br>- **TypeScript** base config (`tsconfig.base.json`)                                                                                                                                                                                                                                                                                                                                                |

---

## 3.2 Rationale

- **DevSecOps Tools**: **Snyk**, **Trivy/Grype**: Chosen to provide continuous dependency and container vulnerability scanning. Their integration into CI/CD ensures rapid detection of security risks in the supply chain and image builds, reducing the chance of deploying vulnerable components.
- **Secrets Management**: **Vault/AWS Secrets Manager**: Centralized secrets storage and rotation improves operational security and auditability. These systems eliminate plaintext secrets from repositories or CI environments and provide fine-grained access control with traceability.
- **Database Performance**:
  - **pg_stat_statements**: Enables continuous query performance monitoring directly within PostgreSQL. This supports evidence-based tuning and early detection of inefficient queries.
  - **GIN/JSONB**: Selected to accelerate searches in tag arrays and semi-structured data fields without compromising schema normalization.
  - **Table partitioning**: Ensures scalable query performance for time-series data such as user sessions and history logs by minimizing index bloat and query scope.
- **Transport Security**:
  - **TLS 1.3 + OCSP Stapling**: Adopted for best-in-class transport security, forward secrecy, and certificate validity verification at the edge.
  - Strict **Content Security Policy (CSP)** at edge: Mitigates cross-site scripting and data injection risks by controlling allowed origins and resource types in client browsers.
- **Node.js 20 + Express**: Chosen for maturity, wide ecosystem support, and straightforward modularization. Express offers fine-grained control, which is preferable over heavier frameworks for a project emphasizing separation of concerns.
- **Knex.js over full ORM**: Provides SQL flexibility and performance without ORM abstraction overhead. It ensures maintainability via migrations and seeds while keeping developers close to SQL.
- **PostgreSQL 18**: Selected for its robustness, JSONB support (for flexible fields), and strong community support. The latest version ensures long-term support.
- **JWT + refresh rotation**: Access tokens remain short-lived (≤15 min) to minimize compromise risk. Refresh tokens are stored server-side, rotated on each use, and revocable per `jti` to guard against theft.
- **bcryptjs**: A widely adopted password hashing algorithm with proven resilience against brute-force attacks.
- **TOTP 2FA**: Enhances account security with optional strong second-factor authentication.
- **zod**: Ensures runtime validation for API inputs and environment variables, reducing runtime errors and misconfigurations.
- **pino/winston + morgan**: Enable structured logs, traceability, and operational visibility. Logging is GDPR-aware (no PII storage).
- **Mailer abstraction**: Keeps email logic independent of provider (SMTP, AWS SES, SendGrid), allowing flexible deployments.
- **File storage abstraction**: Development uses local storage; production uses cloud object stores (S3/GCS). This separation ensures scalability without complicating dev workflows.
- **Redis + BullMQ/Temporal (backlog)**: Provide caching and asynchronous job execution.
- **Supporting libs**: cors, express-rate-limit, compression, uuid, and date/time utilities are battle-tested solutions for common API needs.

---

## 3.3 Frontend Stack

- **App shell & routing:** React + React Router DOM.
- **State & data:** Zustand/Redux; optional React Query for caching and background refetch.
- **HTTP:** Axios instance with interceptors (attach access token; handle 401 → refresh).
- **Styling:** TailwindCSS; component primitives (Navbar, Card, Button, AvatarUpload, Chart) per styling guide.
- **Charts:** Recharts (line/area, circular progress).
- **Accessibility:** WCAG 2.1 AA; semantic HTML; ARIA labels; keyboard navigation.
- **Internationalization (placeholder):** prepare for EN/DE labels (tokens-based).
- **Performance Enhancements:**
  - Code-splitting and lazy loading (`React.lazy`, `Suspense`) mandatory for all feature routes.
  - Critical CSS inlined in `index.html`; other styles loaded asynchronously.
  - Service worker for static asset caching (PWA baseline).
  - Use `react-query` for caching of idempotent GETs (feed, progress).
  - Lighthouse CI integrated into build; budgets enforced.
  - HTTP cache headers: `immutable, max-age=31536000` for static bundles; API ETags enabled.

---

## 3.4 Backend Stack

- **API:** Express with modular routers per domain (auth, users, exercises, sessions, progress, points, feed).
- **Security:** Helmet, CORS allowlist, rate limiting, CSRF protection, httpOnly `Secure` cookies.
- **Auth:** JWT (short-lived access) + **server-stored refresh** tokens with rotation and revocation by `jti`; optional TOTP 2FA with backup codes.
- **Data access:** Knex query builder; connection pooling; migrations & seeds.
- **Storage:** Local `/uploads` (dev) and pluggable S3/GCS provider (prod) via abstraction; uploads excluded from VCS and Docker build.
- **Email:** Verification/reset via provider-agnostic mailer (SMTP/SES/etc.).
- **Logging:** Structured logs (pino/winston) with correlation IDs; `morgan` for access logs.
- **Validation:** zod schemas for request DTOs and environment config.
- **Background jobs (future):** BullMQ/Temporal for async tasks (emails, reports, imports).
- **System utilities:** The system shall expose a `GET /health` endpoint for container health-checks and uptime monitoring. It shall return HTTP 200 OK with a JSON payload `{ status: 'ok', timestamp: <ISO8601> }`.
- **Performance Enhancements:**
  - Express compression (Brotli/gzip > 1 KB).
  - Global response size cap = 1 MB.
  - Route-level rate limiting with `X-RateLimit-*` headers.
  - Request timeout middleware (10 s).
  - Async translation and analytics jobs queued via BullMQ when runtime > 800 ms.
  - Cached endpoints (`GET /feed`, `GET /progress/*`) backed by Redis (or LRU fallback in dev) with 60 s TTL.
  - Performance middleware exporting per-route latency metrics to Prometheus.
- **Vault / AWS Secrets Manager:** Handles all sensitive configuration and credentials in production. Chosen for its integration with major cloud providers, secret rotation, and audit logging capabilities. This ensures compliance with least-privilege principles and GDPR data minimization.
- **Snyk / Trivy / Grype:** Implemented in the CI/CD pipeline to automatically detect vulnerable dependencies and container images. This supports the project's "security-first" objective by embedding checks early in development.
- **pg_stat_statements & Monitoring Stack:** Used to gather query performance metrics, enabling data-driven database optimization and early anomaly detection.
- **GIN / JSONB Indexing:** Provides the flexibility to store and query semi-structured data (e.g., tags, attributes) efficiently. Chosen to support future AI-driven search features.
- **Partitioned Tables:** Keeps database operations efficient as data grows by isolating recent records for faster access and simplifying archival.
- **Loki + Grafana Integration:** Added for structured log aggregation and visualization, ensuring unified observability across backend, frontend, and infrastructure layers.
- **Redis + BullMQ/Temporal:** Optional components planned for phase 2 to handle caching, job queues, and background task orchestration, ensuring scalable asynchronous operations.

## 3.5 Languages, Frameworks, Versions

- **Frontend:** TypeScript, React 18, Vite, React Router, i18n library.
- **Backend:** Node.js 20 LTS, TypeScript, Express, zod (validation), jose (JWT), nodemailer (email), rate-limiter-flexible.
- **Database:** PostgreSQL (target 16-18; minimum 14), pg, knex (migrations).
- **Infra/Dev:** Docker, Docker Compose, GitHub Actions, pnpm workspaces, Husky, ESLint/Prettier, Playwright, Jest, k6, Lighthouse, ZAP.
- **Observability:** Prometheus, Grafana, OpenTelemetry (traces), Loki (logs) or structured JSON logs to filebeat-compatible sink.

## 3.6 Coding Standards

- **TypeScript strict mode**; no `any` in public surfaces.
- ESLint (recommended + security plugins), Prettier formatting.
- Folder-by-module for BE (`/modules/<domain>`), co-locating routes, services, schemas, tests.
- FE feature-sliced architecture; UI components accessible by default (labels/ARIA).

## 3.7 API Style & Conventions

- **REST over HTTPS**, JSON bodies, camelCase in JSON, snake_case in DB.
- **Pagination:** `?page, ?limit` (default 20, max 100), response `{data, meta: {page, limit, total}}`.
- **Filtering/Sorting:** explicit allow-list; server rejects unknown filters.
- **Error Envelope:**
  ```json
  { "error": { "code": "E.AUTH.INVALID_CREDENTIALS", "message": "string", "details": {...}, "requestId": "uuid" } }
  ```
- **Idempotency:** Clients may send `Idempotency-Key` header for POST/PATCH on session creation, password reset, feed actions; server persists and deduplicates for 24h.
- **Rate Limits:** Per IP and per account; stricter on auth endpoints; `Retry-After` on limit breach.

## 3.8 API Versioning & Deprecation Policy

- Base path **`/api/v1`**.
- **Additive changes only** (new optional fields) within a major version.
- Breaking changes demand **new major** (e.g., `/api/v2`) with **2-release deprecation window** for the old version.
- Deprecations announced via `Deprecation` response header and release notes.

## 3.9 Time, IDs, Locale & Units

- **Time:** All server-side timestamps in **UTC**, RFC 3339; clients display in user's locale.
- **IDs:** ULIDs or UUIDv7 for time-sortable identifiers; no sequential IDs exposed.
- **Locale/i18n:** MVP ships **static tokens (EN/DE)**; `Accept-Language` and user settings negotiate locale; fallback to EN; dates/numbers formatted per locale on the client (server provides ISO values + hints where applicable).
- **Units:** Distances in meters/kilometers; weights in kilograms; durations in seconds; FE renders with locale-specific units/symbols.
- **i18n scope (MVP):** Only **static token catalogs (EN/DE)** are in scope.

## 3.10 Security & Privacy Baselines (Cross-reference)

- **JWT RS256** with refresh rotation and revocation; CSRF mitigated via same-site cookies (if used) + double-submit pattern for web; strict headers: **CSP**, **HSTS**, **Referrer-Policy**, **Permissions-Policy**.
- **Secrets management**: env schema validation at boot; rotation procedure via JWKS; no secrets in logs or client bundles.
- **Uploads:** AV scanning (e.g., clamd) before persistence; size/type allow-list.
- **Logs/Metrics:** PII never logged; metric label cardinality limited; correlation IDs required.

---

- See also [Modules](./2b.Technical_Design_Document_Modules.md)
- See also [Data](./2c.Technical_Design_Document_Data.md)
- See also [Design & Architecture](./2d.Technical_Design_Document_APIDesign.md)
- See also [Other](./2e.Technical_Design_Document_misc.md)
